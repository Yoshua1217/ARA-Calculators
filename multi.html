<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ARA Multi-Trunk Circumference Calculator</title>
  <style>
    :root { --radius:12px; --dark:#111; --light:#f2f2f2; }
    .card, .card * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:24px; }
    .card { max-width: 720px; margin:0 auto; padding:20px; border:1px solid #ddd; border-radius:var(--radius); }
    h1 { margin:0 0 10px; font-size:1.6rem; }
    .sub { margin:0 0 16px; color:#555; }
    .note { width:100%; background:#f7f7f7; padding:10px 12px; border-radius:var(--radius); border:1px solid #e7e7e7; margin-bottom:16px; }

    .help { margin:8px 0 6px; color:#444; font-size:.95rem; }
    .unit-toggle { display:flex; gap:8px; margin:0 0 12px; }
    .toggle-btn { padding:8px 12px; border:1px solid #ccc; border-radius:8px; background:var(--light); cursor:pointer; user-select:none; }
    .toggle-btn.active { background:var(--dark); color:#fff; border-color:var(--dark); }
    .toggle-btn:focus-visible { outline:2px solid var(--dark); outline-offset:2px; }

    label { display:block; margin:10px 0 6px; font-weight:600; }
    input[type="number"] {
      width:100%; display:block; padding:10px; border:1px solid #ccc; border-radius:8px; font-size:1rem;
    }
    input.error { border-color:#e11900; box-shadow:0 0 0 3px rgba(225,25,0,.15); outline:none; }

    .row { display:grid; grid-template-columns: 1fr; gap:6px; align-items:start; }
    .trunks { display:flex; flex-direction:column; gap:10px; }

    .btn-row { display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; }
    button { padding:10px 14px; border:0; border-radius:8px; cursor:pointer; }
    .btn-primary { background:var(--dark); color:#fff; }
    .btn-secondary { background:#e9e9e9; color:#111; }
    button[disabled]{ opacity:.6; cursor:not-allowed; }

    .hint { font-size:.86rem; color:#b2271a; display:none; }
    .hint.show { display:block; }
    .largest-label { font-weight:800; }
    .badge { display:inline-block; margin-left:8px; padding:2px 8px; border-radius:999px; background:#111; color:#fff; font-size:.75rem; vertical-align:middle; }
    .badge.hide { display:none; }

    .result { margin-top:16px; font-size:1.05rem; }
    .result p { margin:6px 0; }
    .foot { margin-top:18px; font-size:.9rem; color:#666; line-height:1.35; }
    form { margin:0; }
    code { background:#f2f2f2; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>ARA Multi-Trunk Circumference Calculator</h1>
    <p class="sub">Ancient Roots Alberta</p>

    <div class="note">
      <strong>Method:</strong> Convert each trunk’s <em>circumference → diameter</em> (<code>D = C / π</code>).
      Let the largest diameter be <code>Dmax</code>. Combined diameter =
      <code>Dmax + 0.5 × sum(other D)</code>. Equivalent circumference =
      <code>π × combined diameter</code>.
    </div>

    <p class="help"><strong>Input units:</strong> applies to each trunk’s <em>circumference</em>.</p>
    <div class="unit-toggle" role="group" aria-label="Input units">
      <button type="button" id="unit-m"  class="toggle-btn active" aria-pressed="true">Meters (m)</button>
      <button type="button" id="unit-ft" class="toggle-btn" aria-pressed="false">Feet (ft)</button>
    </div>

    <form id="form" action="#">
      <div class="trunks" id="trunk-list">
        <!-- rows injected here -->
      </div>

      <div class="btn-row" style="margin-top:10px;">
        <button type="button" id="add"    class="btn-secondary">Add trunk</button>
        <button type="button" id="remove" class="btn-secondary">Remove last</button>
      </div>

      <div class="btn-row" style="margin-top:14px;">
        <button type="submit"  class="btn-primary">Calculate</button>
        <button type="button" id="copy"   class="btn-secondary" disabled title="Copies equivalent circumference in meters only">Copy result (m)</button>
        <button type="reset"  id="reset"  class="btn-secondary">Reset</button>
      </div>
    </form>

    <div class="result" id="out">
      <p><strong>Equivalent circumference:</strong> <span id="ceq">—</span></p>
      <p><strong>Equivalent diameter:</strong> <span id="deq">—</span></p>
      <p id="used">—</p>
    </div>

    <div class="foot">
      Outputs show both meters and feet, rounded to 2 decimals. For ARA nominations, paste <strong>pure numbers in meters</strong> (no units) — use the Copy button above.
    </div>
  </div>

  <script>
    const PI = Math.PI, FT_PER_M = 3.28084, M_PER_FT = 0.3048;
    const $ = s => document.querySelector(s);

    const form = $('#form');
    const list = $('#trunk-list');
    const addBtn = $('#add');
    const remBtn = $('#remove');
    const copyBtn = $('#copy');
    const outC = $('#ceq');
    const outD = $('#deq');
    const outUsed = $('#used');
    const unitM = $('#unit-m');
    const unitFt = $('#unit-ft');

    let inputUnit = 'm';     // 'm' or 'ft'
    let lastMetersCirc = ''; // for Copy (m)
    let trunkCount = 0;
    const MAX_TRUNKS = 30;

    function fmt2(x){ return Number.isFinite(x) ? x.toFixed(2) : '—'; }

    function addTrunk(value=''){
      if (trunkCount >= MAX_TRUNKS) return;
      trunkCount++;
      const row = document.createElement('div');
      row.className = 'row';
      row.dataset.index = String(trunkCount);

      const labelWrap = document.createElement('div');
      const label = document.createElement('label');
      label.htmlFor = `c-${trunkCount}`;
      label.className = 'trunk-label';
      label.textContent = `Trunk ${trunkCount} circumference (${inputUnit})`;

      const badge = document.createElement('span');
      badge.className = 'badge hide';
      badge.textContent = 'Largest';

      labelWrap.appendChild(label);
      labelWrap.appendChild(badge);

      const inp = document.createElement('input');
      inp.id = `c-${trunkCount}`;
      inp.type = 'number';
      inp.step = '0.01';
      inp.inputMode = 'decimal';
      inp.placeholder = inputUnit === 'm' ? 'e.g. 1.75' : 'e.g. 5.74';
      if (value !== '') inp.value = value;

      const hint = document.createElement('div');
      hint.className = 'hint';
      hint.textContent = ''; // filled dynamically

      row.appendChild(labelWrap);
      row.appendChild(inp);
      row.appendChild(hint);
      list.appendChild(row);

      // Clear red + hint on input
      inp.addEventListener('input', () => {
        inp.classList.remove('error');
        hideHint(hint);
      });
      // Soft hints on blur for outliers
      inp.addEventListener('blur', () => {
        const v = parseFloat(inp.value);
        if (Number.isFinite(v) && v > 0) {
          maybeOutlierHint(v, hint);
        } else {
          hideHint(hint);
        }
      });
    }

    function removeTrunk(){
      if (trunkCount <= 1) return;
      list.lastElementChild?.remove();
      trunkCount--;
    }

    function setUnit(newUnit){
      if (newUnit === inputUnit) return;

      // Convert existing numeric values to the new unit (circumference)
      const inputs = getInputs();
      inputs.forEach(inp => {
        const v = parseFloat(inp.value);
        if (!Number.isNaN(v)) {
          const m = (inputUnit === 'm') ? v : v * M_PER_FT; // old -> meters
          const out = (newUnit === 'm') ? m : m * FT_PER_M; // meters -> new
          inp.value = out.toFixed(2);
        }
      });

      inputUnit = newUnit;

      const isM = inputUnit === 'm';
      unitM.classList.toggle('active', isM);
      unitFt.classList.toggle('active', !isM);
      unitM.setAttribute('aria-pressed', String(isM));
      unitFt.setAttribute('aria-pressed', String(!isM));

      // Update labels & placeholders
      Array.from(list.querySelectorAll('.trunk-label')).forEach((lab, i) => {
        lab.textContent = `Trunk ${i+1} circumference (${inputUnit})`;
      });
      inputs.forEach(inp => {
        inp.placeholder = isM ? 'e.g. 1.75' : 'e.g. 5.74';
      });
    }

    function getInputs(){
      return Array.from(list.querySelectorAll('input[type="number"]'));
    }

    function showHint(hintEl, msg){
      hintEl.textContent = msg;
      hintEl.classList.add('show');
    }
    function hideHint(hintEl){
      hintEl.textContent = '';
      hintEl.classList.remove('show');
    }

    function maybeOutlierHint(val, hintEl){
      // Gentle nudges; still included in calc
      if (inputUnit === 'm') {
        if (val < 0.20) showHint(hintEl, 'This seems unusually small — check units/decimal?');
        else if (val > 12) showHint(hintEl, 'This seems unusually large — check units?');
        else hideHint(hintEl);
      } else {
        if (val < 0.66) showHint(hintEl, 'This seems unusually small — check units/decimal?');
        else if (val > 40) showHint(hintEl, 'This seems unusually large — check units?');
        else hideHint(hintEl);
      }
    }

    function clearLargestHighlights(){
      list.querySelectorAll('.largest-label').forEach(el => el.classList.remove('largest-label'));
      list.querySelectorAll('.badge').forEach(b => b.classList.add('hide'));
    }

    function calculate(e){
      e.preventDefault();
      clearLargestHighlights();

      const inputs = getInputs();
      let anyInvalid = false;

      // Build list of usable circumferences (positive numbers), keep mapping to rows
      const rows = inputs.map(inp => {
        const row = inp.closest('.row');
        const hint = row.querySelector('.hint');
        const val = parseFloat(inp.value);
        // Reset immediate errors
        inp.classList.remove('error');
        hideHint(hint);

        if (Number.isNaN(val)) return { inp, row, val: NaN, ok:false };

        if (val <= 0) {
          inp.classList.add('error');
          showHint(hint, 'Enter a positive number.');
          anyInvalid = true;
          return { inp, row, val, ok:false };
        }

        // Optional outlier hints (not invalid)
        maybeOutlierHint(val, hint);

        return { inp, row, val, ok:true };
      });

      const valid = rows.filter(r => r.ok);
      if (valid.length === 0) {
        // No usable values at all
        inputs[0]?.classList.add('error');
        outC.textContent = '—';
        outD.textContent = '—';
        outUsed.textContent = 'Please enter at least one circumference.';
        copyBtn.disabled = true;
        lastMetersCirc = '';
        return;
      }

      // Convert circumference -> diameter (in meters)
      const withDiam = valid.map((r, i) => {
        const cMeters = (inputUnit === 'm') ? r.val : r.val * M_PER_FT;
        const dMeters = cMeters / PI;
        return { ...r, cMeters, dMeters, idx: i };
      });

      // Find maxima (allow tiny epsilon for ties)
      const eps = 1e-9;
      const dmax = Math.max(...withDiam.map(x => x.dMeters));
      const maxRows = withDiam.filter(x => Math.abs(x.dMeters - dmax) < eps);

      // Sum others (one of the max set counts fully; others half)
      const sumAll = withDiam.reduce((acc, x) => acc + x.dMeters, 0);
      const dEqM = dmax + 0.5 * (sumAll - dmax);
      const cEqM = dEqM * PI;

      const dEqFt = dEqM * FT_PER_M;
      const cEqFt = cEqM * FT_PER_M;

      outC.textContent = `${cEqM.toFixed(2)} m (${cEqFt.toFixed(2)} ft)`;
      outD.textContent = `${dEqM.toFixed(2)} m (${dEqFt.toFixed(2)} ft)`;

      // Highlight largest trunk(s)
      maxRows.forEach(r => {
        const lab = r.row.querySelector('.trunk-label');
        const badge = r.row.querySelector('.badge');
        if (lab) lab.classList.add('largest-label');
        if (badge) badge.classList.remove('hide');
      });

      // Explain usage
      if (maxRows.length === 1) {
        outUsed.textContent = `Trunks used: ${withDiam.length}. Largest trunk is bolded and counted fully; all others counted at 50%.`;
      } else {
        outUsed.textContent = `Trunks used: ${withDiam.length}. Multiple trunks tie for largest (bolded); one is counted fully, the rest at 50%.`;
      }

      lastMetersCirc = cEqM.toFixed(2);
      copyBtn.disabled = false;
      copyBtn.textContent = 'Copy result (m)';
    }

    async function copyMeters(){
      if (!lastMetersCirc) return;
      try {
        await navigator.clipboard.writeText(lastMetersCirc);
        copyBtn.textContent = 'Copied ✓';
        setTimeout(() => { copyBtn.textContent = 'Copy result (m)'; }, 1200);
      } catch {
        const tmp = document.createElement('input');
        tmp.value = lastMetersCirc;
        document.body.appendChild(tmp);
        tmp.select();
        document.execCommand('copy');
        document.body.removeChild(tmp);
        copyBtn.textContent = 'Copied ✓';
        setTimeout(() => { copyBtn.textContent = 'Copy result (m)'; }, 1200);
      }
    }

    function resetAll(){
      setTimeout(() => {
        // Clear rows and re-add two blanks
        list.innerHTML = '';
        trunkCount = 0;
        addTrunk();
        addTrunk();
        lastMetersCirc = '';
        copyBtn.disabled = true;
        copyBtn.textContent = 'Copy result (m)';
        outC.textContent = '—';
        outD.textContent = '—';
        outUsed.textContent = '—';
        clearLargestHighlights();
      }, 0);
    }

    // Init with two inputs
    addTrunk();
    addTrunk();

    // Events
    form.addEventListener('submit', calculate);
    form.addEventListener('reset', resetAll);
    addBtn.addEventListener('click', () => addTrunk());
    remBtn.addEventListener('click', () => { if (trunkCount > 1) removeTrunk(); });
    unitM.addEventListener('click', () => setUnit('m'));
    unitFt.addEventListener('click', () => setUnit('ft'));
    $('#copy').addEventListener('click', copyMeters);
  </script>
</body>
</html>
