<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ARA Field Tools</title>
<style>
  :root{
    /* Dark blue palette */
    --bg:#0d1b2a;
    --bg-elev:#0f2236;
    --panel:#14253d;
    --panel-2:#172a47;
    --text:#e8eef6;
    --muted:#a9b7c7;
    --accent:#2ea3ff;
    --accent-2:#4db2ff;
    --ok:#1fa37a;
    --danger:#d93c3c;
    --border:#1f3553;
    --radius:14px;
    --gap:14px;
  }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg); color:var(--text);
  }

  /* Fixed header */
  .topbar{
    position:sticky; top:0; z-index:50;
    background:linear-gradient(180deg, #0d1b2a, #0f2236);
    border-bottom:1px solid var(--border);
    padding:10px 14px;
  }
  .topbar .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .brand{ font-weight:800; letter-spacing:.2px; font-size:1.05rem; color:#eaf3ff; }

  .inline-controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .toggle-btn{
    padding:8px 12px; border:1px solid var(--border); border-radius:999px;
    background:var(--panel); color:var(--text); cursor:pointer;
  }
  .toggle-btn.active{ background:var(--accent); color:#001528; border-color:transparent; font-weight:700; }
  .toggle-label{ color:var(--muted); font-size:.9rem; margin-left:6px; }

  /* Tabs */
  .tabs{
    position:sticky; top:56px; z-index:45;
    background:var(--bg-elev); border-bottom:1px solid var(--border);
    overflow:auto; white-space:nowrap;
  }
  .tabs-inner{ display:flex; gap:8px; padding:8px 12px; }
  .tab{
    padding:10px 14px; border-radius:999px;
    background:var(--panel); border:1px solid var(--border); color:var(--text);
    cursor:pointer; user-select:none;
  }
  .tab.active{ background:var(--accent-2); color:#001528; border-color:transparent; font-weight:800; }

  /* Main content */
  .content{ padding:14px; max-width:1000px; margin:0 auto; }
  .card{
    background:var(--panel); border:1px solid var(--border);
    border-radius:var(--radius); margin-bottom:var(--gap);
  }
  .card .block{ padding:16px 18px; }
  h2{ margin:0 0 8px; font-size:1.2rem; }
  h3{ margin:0 0 8px; font-size:1.05rem; color:#d6e6ff; }
  label{ display:block; font-weight:700; margin:10px 0 6px; }
  input[type="text"],input[type="number"],select,textarea{
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border);
    background:var(--panel-2); color:var(--text); font-size:1rem;
  }
  textarea{ min-height:88px; resize:none; overflow:hidden; }
  .row{ display:grid; grid-template-columns:1fr 1fr; gap:var(--gap); }
  @media (max-width:780px){ .row{ grid-template-columns:1fr } }

  .note{
    background:#0b1a2f; border:1px solid #1f3553; color:#cfe0ff;
    border-radius:12px; padding:10px 12px;
  }

  /* Buttons */
  .btn-row{ display:flex; flex-wrap:wrap; gap:10px; }
  button,.btn{
    padding:10px 14px; border:0; border-radius:10px; cursor:pointer; color:#001528;
    background:var(--accent-2); font-weight:700;
  }
  .btn-ghost{ background:var(--panel-2); color:var(--text); border:1px solid var(--border); }
  .btn-dim{ background:#113158; color:#bcd8ff; border:1px solid var(--border); }
  .btn-danger{ background:var(--danger); color:#fff; }
  .btn-ok{ background:var(--ok); color:#00180f; }
  button[disabled]{ opacity:.6; cursor:not-allowed; }

  /* Multi-trunk minor styles */
  .mt-label{font-weight:700}
  .badge{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;background:#1b6cff;color:#001528;font-size:.75rem;vertical-align:middle}
  .badge.hide{display:none}
  .hint{font-size:.86rem;color:#ffc0c0;display:none}
  .hint.show{display:block}

  /* Bulk textarea monospace for consistency */
  .mono{ font-family: "JetBrains Mono","SFMono-Regular","Courier New",monospace; }

  /* Clinometer (grid removed, angle top-right) */
  .clino-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .clino-wrap{
    position:relative; height:180px; border:1px solid var(--border);
    border-radius:12px; background:#0b1a2f; margin:10px 0; overflow:hidden;
    display:flex; align-items:center; justify-content:center;
  }
  .clino-angle{
    position:absolute; right:10px; top:10px;
    font-weight:800; font-size:1.2rem; color:#001528;
    background:#cfe0ff; padding:6px 10px; border-radius:8px; border:1px solid var(--border);
  }
  .clino-lock{
    width:140px; height:140px; border-radius:999px; border:0; cursor:pointer;
    background:#cfe0ff; color:#001528; font-weight:900; font-size:1.15rem;
  }
  .clino-lock:active{ transform:scale(.98); }
  .clino-controls{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }

  /* Results */
  .results{
    background:#0b1a2f; border:1px solid var(--border);
    border-radius:12px; padding:12px;
  }
  .results p{ margin:6px 0 }
  .muted{ color:var(--muted) }
  .tiny{ font-size:.86rem; color:var(--muted) }
  .unit-tag{ color:#cfe0ff; font-weight:800 }

  /* Tabs content visibility */
  .tabpane{ display:none }
  .tabpane.active{ display:block }
</style>
</head>
<body>

<!-- Top bar (tree name removed) -->
<div class="topbar">
  <div class="row">
    <div class="brand">ARA Field Tools</div>
    <div class="inline-controls" aria-label="Global controls">
      <span class="toggle-label">Units:</span>
      <button type="button" id="unit-m"  class="toggle-btn active" aria-pressed="true">m</button>
      <button type="button" id="unit-ft" class="toggle-btn" aria-pressed="false">ft</button>
      <span class="toggle-label">Calc:</span>
      <button type="button" id="mode-manual" class="toggle-btn active" aria-pressed="true">Manual</button>
      <button type="button" id="mode-auto"   class="toggle-btn" aria-pressed="false">Auto</button>
    </div>
  </div>
</div>

<!-- Tabs -->
<div class="tabs">
  <div class="tabs-inner">
    <div class="tab active" data-tab="gen">General</div>
    <div class="tab" data-tab="loc">Location</div>
    <div class="tab" data-tab="circ">Circumference</div>
    <div class="tab" data-tab="height">Height</div>
    <div class="tab" data-tab="canopy">Canopy</div>
    <div class="tab" data-tab="results">Results</div>
  </div>
</div>

<!-- Content -->
<div class="content">

  <!-- General -->
  <section id="pane-gen" class="tabpane active">
    <div class="card">
      <div class="block">
        <h2>General</h2>

        <label for="treeName">Tree name</label>
        <input id="treeName" type="text" placeholder="Tree name (e.g., Rossdale Poplar)">

        <div class="row" style="margin-top:8px;">
          <div>
            <label for="species">Species</label>
            <input id="species" type="text" placeholder="e.g., Populus balsamifera">
          </div>
          <div>
            <label for="condition">Condition</label>
            <select id="condition">
              <option value="">— optional —</option>
              <option>Excellent</option><option>Good</option><option>Fair</option><option>Poor</option><option>Dead</option>
            </select>
          </div>
        </div>

        <label for="notes" style="margin-top:10px;">Notes</label>
        <textarea id="notes" placeholder="Observations, access notes, landmarks, hazards…"></textarea>
        <div class="tiny">Notes appear in the generated description.</div>
      </div>
    </div>
  </section>

  <!-- Location (placeholder) -->
  <section id="pane-loc" class="tabpane">
    <div class="card">
      <div class="block">
        <h2>Location</h2>
        <div class="note">Leave blank for now — we’ll paste in your GPS app data later.</div>
      </div>
    </div>
  </section>

  <!-- Circumference -->
  <section id="pane-circ" class="tabpane">
    <div class="card">
      <div class="block">
        <h2>Circumference</h2>

        <label for="treeType">Tree type</label>
        <select id="treeType">
          <option value="">— select —</option>
          <option>Single trunk tree</option>
          <option>Multi trunked tree</option>
          <option>Grove</option>
          <option>Forest</option>
          <option>Clonal aspen</option>
        </select>

        <!-- Single trunk -->
        <div id="single-circ-block" style="display:none;margin-top:10px;">
          <label for="singleC">Circumference (<span class="unit-tag">m</span>)</label>
          <input id="singleC" type="number" step="0.01" inputmode="decimal" placeholder="e.g. 3.10">
          <div class="btn-row" style="margin-top:8px;">
            <button type="button" id="single-update" class="btn-dim">Update circumference</button>
          </div>
          <div class="tiny">Diameter is calculated automatically (D = C / π).</div>
        </div>

        <!-- Multi-trunk -->
        <div id="multi-block" style="display:none;margin-top:10px;">
          <div class="note" style="margin-bottom:10px;">
            <strong>Multi-trunk entry:</strong> add each trunk’s <em>circumference</em>. * Largest trunk counts 100%, others 50%.
          </div>
          <div id="mt-list" style="display:flex;flex-direction:column;gap:10px;"></div>
          <div class="btn-row" style="margin-top:8px;">
            <button type="button" id="mt-add"    class="btn-dim">Add trunk</button>
            <button type="button" id="mt-remove" class="btn-dim">Remove last</button>
            <button type="button" id="mt-sort"   class="btn-ghost" title="Sort by diameter (desc)">Sort by diameter</button>
            <button type="button" id="mt-calc"   class="btn-dim">Calculate multi-trunk</button>
          </div>

          <label for="mt-bulk" style="margin-top:12px;">Bulk paste (numbers + repeaters)</label>
          <textarea id="mt-bulk" class="mono" placeholder="Examples:
1.72, 0.98 1.10
12x0.78   (12 repeats of 0.78)
3×1.50    (× also works)"></textarea>
          <div class="tiny">
            Uses current unit (<span class="unit-tag">m</span>). Ignores text; keeps positive numbers only.
            Supports <strong>NxVALUE</strong> like <strong>12x0.78</strong> or <strong>3×1.5</strong>.
          </div>
          <div class="btn-row" style="margin-top:8px;">
            <button type="button" id="mt-fill"  class="btn-ghost">Fill from bulk</button>
            <button type="button" id="mt-clear" class="btn-ghost">Clear bulk</button>
          </div>

          <div id="mt-result" class="tiny" style="margin-top:8px;color:#cfe0ff;">—</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Height -->
  <section id="pane-height" class="tabpane">
    <div class="card">
      <div class="block">
        <div class="clino-head">
          <h2>Height</h2>
          <div id="clino-angle" class="clino-angle">—°</div>
        </div>

        <label for="h-angle">Angle to top of the tree (degrees)</label>
        <input id="h-angle" type="number" step="0.1" inputmode="decimal" placeholder="e.g. 37.5">

        <div class="row">
          <div>
            <label for="h-dist">Distance to trunk (<span class="unit-tag">m</span>)</label>
            <input id="h-dist" type="number" step="0.01" inputmode="decimal" placeholder="e.g. 23.40">
          </div>
          <div>
            <label for="h-eye">Eye height (<span class="unit-tag">m</span>)</label>
            <input id="h-eye" type="number" step="0.01" inputmode="decimal" placeholder="e.g. 1.62">
          </div>
        </div>

        <div class="btn-row" style="margin-top:10px;">
          <button type="button" id="h-calc" class="btn-dim">Calculate height</button>
        </div>

        <!-- Clinometer -->
        <div class="card" id="clino-card" style="margin-top:12px;background:#10253f;">
          <div class="block">
            <div class="btn-row" aria-label="Clinometer power">
              <button type="button" id="clino-enable" class="toggle-btn small">Start</button>
              <button type="button" id="clino-disable" class="toggle-btn small">Stop</button>
            </div>

            <div class="clino-wrap">
              <!-- angle readout lives top-right; lock fills the space -->
              <button type="button" id="clino-lock" class="clino-lock">Lock</button>
            </div>

            <div class="clino-controls">
              <button type="button" id="clino-zero"  class="btn-ghost">Zero (calibrate)</button>
              <button type="button" id="clino-reset" class="btn-ghost">Reset sensor</button>
            </div>
            <div class="tiny" id="clino-status">Sensor: idle</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Canopy -->
  <section id="pane-canopy" class="tabpane">
    <div class="card">
      <div class="block">
        <h2>Canopy</h2>
        <div class="row">
          <div>
            <label for="spreadMajor">Major axis (<span class="unit-tag">m</span>)</label>
            <input id="spreadMajor" type="number" step="0.01" inputmode="decimal" placeholder="e.g. 30.00">
          </div>
          <div>
            <label for="spreadMinor">Minor axis (<span class="unit-tag">m</span>)</label>
            <input id="spreadMinor" type="number" step="0.01" inputmode="decimal" placeholder="e.g. 20.00">
          </div>
        </div>
        <div class="btn-row" style="margin-top:10px;">
          <button type="button" id="spread-calc" class="btn-dim">Calculate canopy spread</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Results -->
  <section id="pane-results" class="tabpane">
    <div class="card">
      <div class="block">
        <h2>Results</h2>
        <div class="results">
          <p id="res-height">Height: —</p>
          <p id="res-eqcirc">Equivalent / Entered circumference: —</p>
          <p id="res-avgcirc" style="display:none;">Average circumference (multi): —</p>
          <p id="res-spread">Final canopy spread: —</p>
        </div>
      </div>
      <div class="block">
        <h3>Quick copy <span class="tiny">(ARA form pure numbers in meters)</span></h3>
        <div class="btn-row">
          <button type="button" id="copyHeight"  class="btn-ghost" disabled>Copy Height (m)</button>
          <button type="button" id="copyEqCirc"  class="btn-ghost" disabled>Copy Eq. Circ (m)</button>
          <button type="button" id="copyAvgCirc" class="btn-ghost" disabled>Copy Avg Circ (m)</button>
          <button type="button" id="copySpread"  class="btn-ghost" disabled>Copy Canopy (m)</button>
        </div>
      </div>
      <div class="block">
        <h3>Description</h3>
        <div class="btn-row">
          <button type="button" id="genDesc"  class="btn-dim">Generate description</button>
          <button type="button" id="copyDesc" class="btn-ghost" disabled>Copy description</button>
          <button type="button" id="shareLink" class="btn-ghost" disabled>Copy share link</button>
          <a id="emailBtn" class="btn btn-ghost" href="#" aria-disabled="true">Open email (optional)</a>
        </div>
        <div id="desc" class="results" style="margin-top:10px;">—</div>
        <div class="tiny" style="margin-top:6px;">Timestamp uses local 24-hour time.</div>
      </div>
    </div>
  </section>

</div>

<script>
/* ====== Helpers & globals ====== */
const PI=Math.PI, FT_PER_M=3.28084, M_PER_FT=0.3048;
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const tanDeg=d=>Math.tan(d*Math.PI/180);
const fmt2=x=>Number.isFinite(x)?x.toFixed(2):'—', fmt1=x=>Number.isFinite(x)?x.toFixed(1):'—';
const toM=(v,u)=>u==='m'?v:v*M_PER_FT, mToFt=m=>m*FT_PER_M;
const nowLocal24=()=>{const d=new Date();const p=n=>String(n).padStart(2,'0');return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`};
const escapeHtml=s=>String(s??'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

/* State */
let inputUnit='m', calcMode='manual';
let lastSingle=null, lastMulti=null, lastHeight=null, lastSpread=null;

/* Header controls */
const unitM=$('#unit-m'), unitFt=$('#unit-ft');
const modeManualBtn=$('#mode-manual'), modeAutoBtn=$('#mode-auto');
const unitTags=$$('.unit-tag');

function setUnit(u){
  if(u===inputUnit) return;
  const conv=inp=>{ const v=parseFloat(inp.value); if(!Number.isNaN(v)){ const m=toM(v,inputUnit); inp.value=(u==='m'?m:m*FT_PER_M).toFixed(2); } };
  [$('#singleC'), $('#h-dist'), $('#h-eye'), $('#spreadMajor'), $('#spreadMinor')].forEach(el=>el&&conv(el));
  $$('#mt-list input[type="number"]').forEach(conv);
  inputUnit=u;
  const isM=u==='m';
  unitM.classList.toggle('active',isM); unitFt.classList.toggle('active',!isM);
  unitM.setAttribute('aria-pressed',String(isM)); unitFt.setAttribute('aria-pressed',String(!isM));
  unitTags.forEach(t=>t.textContent=isM?'m':'ft');
  if(calcMode==='auto'){ if($('#treeType').value==='Single trunk tree') recomputeSingle(); if($('#treeType').value==='Multi trunked tree') calcMulti(); calcHeight(); calcSpread(); }
  updateResultsPanel(); updateCopyButtons();
}
unitM.onclick=()=>setUnit('m'); unitFt.onclick=()=>setUnit('ft');

function setCalcMode(m){ calcMode=m; const man=m==='manual';
  modeManualBtn.classList.toggle('active',man); modeAutoBtn.classList.toggle('active',!man);
  modeManualBtn.setAttribute('aria-pressed',String(man)); modeAutoBtn.setAttribute('aria-pressed',String(!man));
}
modeManualBtn.onclick=()=>setCalcMode('manual'); modeAutoBtn.onclick=()=>setCalcMode('auto');

/* ====== Tabs ====== */
$$('.tab').forEach(tab=>{
  tab.addEventListener('click', ()=>{
    $$('.tab').forEach(t=>t.classList.remove('active'));
    tab.addClass?.('active') ?? tab.classList.add('active');
    const id = tab.dataset.tab;
    $$('.tabpane').forEach(p=>p.classList.remove('active'));
    $('#pane-' + id).classList.add('active');
    window.scrollTo({top:0,behavior:'smooth'});
  });
});

/* ====== General ====== */
const notesEl = $('#notes');
function autoGrow(el){ el.style.height='auto'; el.style.height=(el.scrollHeight+2)+'px'; }
notesEl.addEventListener('input',()=>autoGrow(notesEl));

/* ====== Circumference: single vs multi ====== */
const treeType=$('#treeType'), singleBlock=$('#single-circ-block'), singleC=$('#singleC');
const singleUpdateBtn = $('#single-update');

const mtBlock=$('#multi-block'), mtList=$('#mt-list'), mtAdd=$('#mt-add'), mtRemove=$('#mt-remove'),
      mtSort=$('#mt-sort'), mtCalc=$('#mt-calc'), mtBulk=$('#mt-bulk'), mtFill=$('#mt-fill'),
      mtClear=$('#mt-clear'), mtResult=$('#mt-result');

function updateTypeVisibility(){
  const t=treeType.value;
  singleBlock.style.display=(t==='Single trunk tree')?'':'none';
  mtBlock.style.display=(t==='Multi trunked tree')?'':'none';
  if (t==='Multi trunked tree' && mtList.children.length===0){ addMtRow(); addMtRow(); }
  updateResultsPanel(); updateCopyButtons();
}
treeType.onchange=updateTypeVisibility;

/* Single trunk */
function recomputeSingle(){
  const v=parseFloat(singleC.value);
  if(Number.isFinite(v)&&v>0){ const cM=toM(v,inputUnit); const dM=cM/PI; lastSingle={cM,cFt:mToFt(cM),dM,dFt:mToFt(dM)}; }
  else lastSingle=null;
  updateResultsPanel(); updateCopyButtons();
}
singleC.addEventListener('input',()=>{ if(calcMode==='auto') recomputeSingle(); });
singleUpdateBtn.addEventListener('click',recomputeSingle);

/* Multi-trunk block (batch) */
let mtCount=0; const MT_MAX=60;
function addMtRow(val=''){
  if(mtCount>=MT_MAX) return;
  mtCount++;
  const row=document.createElement('div'); row.className='row'; row.style.gridTemplateColumns='1fr'; row.dataset.index=String(mtCount);
  const top=document.createElement('div'); top.style.display='flex'; top.style.alignItems='center';
  const lab=document.createElement('label'); lab.className='mt-label'; lab.htmlFor=`mt-${mtCount}`; lab.textContent=`Trunk ${mtCount} circumference (${inputUnit})`;
  const badge=document.createElement('span'); badge.className='badge hide'; badge.textContent='Largest';
  const inp=document.createElement('input'); inp.id=`mt-${mtCount}`; inp.type='number'; inp.step='0.01'; inp.inputMode='decimal'; if(val!=='') inp.value=val;
  const hint=document.createElement('div'); hint.className='hint';
  top.appendChild(lab); top.appendChild(badge);
  row.appendChild(top); row.appendChild(inp); row.appendChild(hint);
  mtList.appendChild(row);
  inp.addEventListener('input',()=>{hint.classList.remove('show'); if(calcMode==='auto') calcMulti();});
  inp.addEventListener('blur',()=>maybeMtOutlierHint(parseFloat(inp.value),hint));
}
function maybeMtOutlierHint(val,h){
  if(!Number.isFinite(val)||val<=0){h.classList.remove('show');return}
  if(inputUnit==='m'){ if(val<0.20){h.textContent='Unusually small — check units/decimal?';h.classList.add('show');}
    else if(val>12){h.textContent='Unusually large — check units?';h.classList.add('show');} else h.classList.remove('show');}
  else{ if(val<0.66){h.textContent='Unusually small — check units/decimal?';h.classList.add('show');}
    else if(val>40){h.textContent='Unusually large — check units?';h.classList.add('show');} else h.classList.remove('show');}
}
function removeMtRow(){ if(mtCount<=1) return; mtList.lastElementChild?.remove(); mtCount--; renumberMtLabels(); if(calcMode==='auto') calcMulti(); }
function renumberMtLabels(){ $$('#mt-list .mt-label').forEach((lab,i)=>lab.textContent=`Trunk ${i+1} circumference (${inputUnit})`); }
function parseMtBulk(text,limit=MT_MAX){
  const vals=[]; if(!text) return vals; let s=String(text).replace(/[×X]/g,'x');
  const repRE=/(\d+)\s*x\s*([-+]?\d*\.?\d+)/g;
  s=s.replace(repRE,(_,nStr,vStr)=>{const n=parseInt(nStr,10), v=parseFloat(vStr); if(Number.isFinite(n)&&n>0&&Number.isFinite(v)&&v>0){for(let i=0;i<n&&vals.length<limit;i++) vals.push(v);} return ' ';});
  const singles=s.match(/[-+]?\d*\.?\d+/g)||[];
  for(const m of singles){ if(vals.length>=limit) break; const v=parseFloat(m); if(Number.isFinite(v)&&v>0) vals.push(v); }
  return vals;
}
function mtFillFromBulk(){ const vals=parseMtBulk(mtBulk.value,MT_MAX); if(vals.length===0)return; mtList.innerHTML=''; mtCount=0; vals.forEach(v=>addMtRow(v.toFixed(2))); mtResult.textContent='—'; if(calcMode==='auto') calcMulti(); }
function mtSortByDiameter(){
  const rows=Array.from(mtList.children); const valid=[], invalid=[];
  rows.forEach(row=>{ const inp=row.querySelector('input'); const v=parseFloat(inp.value); if(Number.isFinite(v)&&v>0){const cM=toM(v,inputUnit), dM=cM/PI; valid.push({row,dM});} else invalid.push(row);});
  if(valid.length<2) return;
  valid.sort((a,b)=>b.dM-a.dM);
  const frag=document.createDocumentFragment(); valid.forEach(v=>frag.appendChild(v.row)); invalid.forEach(r=>frag.appendChild(r));
  mtList.innerHTML=''; mtList.appendChild(frag); renumberMtLabels(); clearMtLargest();
  if(calcMode==='auto') calcMulti();
}
function clearMtLargest(){ mtList.querySelectorAll('.mt-label').forEach(el=>el.classList.remove('largest-label')); mtList.querySelectorAll('.badge').forEach(b=>{b.classList.add('hide'); b.textContent='Largest';}); }
function calcMulti(){
  clearMtLargest();
  const items=Array.from(mtList.querySelectorAll('input'));
  const valid=items.map(inp=>({inp,val:parseFloat(inp.value),row:inp.closest('.row')})).filter(o=>Number.isFinite(o.val)&&o.val>0);
  if(valid.length===0){ lastMulti=null; mtResult.textContent='Enter at least one trunk circumference.'; updateResultsPanel(); updateCopyButtons(); return; }
  const withD=valid.map((r,i)=>{const cM=toM(r.val,inputUnit); const dM=cM/PI; return {row:r.row,cM,dM,idx:i+1};});
  const eps=1e-9; const dmax=Math.max(...withD.map(x=>x.dM)); const maxRows=withD.filter(x=>Math.abs(x.dM-dmax)<eps); const sumAll=withD.reduce((a,x)=>a+x.dM,0);
  const dEqM=dmax+0.5*(sumAll-dmax); const cEqM=dEqM*PI; const cAvgM=withD.reduce((a,x)=>a+x.cM,0)/withD.length;
  const badgeText=(maxRows.length>1)?'Tied for largest':'Largest';
  maxRows.forEach(r=>{const lab=r.row.querySelector('.mt-label'); const badge=r.row.querySelector('.badge'); lab?.classList.add('largest-label'); if(badge){badge.textContent=badgeText; badge.classList.remove('hide');}});
  lastMulti={ trunks:withD.map(t=>({index:t.idx,cM:t.cM,cFt:mToFt(t.cM),dM:t.dM,dFt:mToFt(t.dM),isLargest:Math.abs(t.dM-dmax)<eps})), dEqM,cEqM,dEqFt:mToFt(dEqM),cEqFt:mToFt(cEqM), cAvgM,cAvgFt:mToFt(cAvgM), tie:maxRows.length>1 };
  mtResult.textContent=`Calculated ${withD.length} trunk${withD.length>1?'s':''}.`;
  updateResultsPanel(); updateCopyButtons();
}
mtAdd.onclick=()=>addMtRow();
mtRemove.onclick=()=>removeMtRow();
mtSort.onclick=mtSortByDiameter;
mtCalc.onclick=calcMulti;
mtFill.onclick=mtFillFromBulk;
mtClear.onclick=()=>{ mtBulk.value=''; };

/* ====== Height ====== */
const hAngle=$('#h-angle'), hDist=$('#h-dist'), hEye=$('#h-eye'), hCalc=$('#h-calc');
function calcHeight(){
  const a=parseFloat(hAngle.value), d=parseFloat(hDist.value), e=parseFloat(hEye.value);
  if(!Number.isFinite(a)||!Number.isFinite(d)||!Number.isFinite(e)){ lastHeight=null; updateResultsPanel(); updateCopyButtons(); return; }
  const dM=toM(d,inputUnit), eM=toM(e,inputUnit); const hM=tanDeg(a)*dM+eM;
  lastHeight={hM,hFt:mToFt(hM),angleDeg:Number(a.toFixed(1)),dM,eM};
  updateResultsPanel(); updateCopyButtons();
}
hCalc.onclick=calcHeight;
[hAngle,hDist,hEye].forEach(inp=>inp.addEventListener('input',()=>{ if(calcMode==='auto') calcHeight();}));

/* ====== Clinometer ====== */
let clinoOn = false, zeroOffsetRad = 0, locked=false;
const elEnable=$('#clino-enable'), elDisable=$('#clino-disable'), elAngle=$('#clino-angle');
const elLock=$('#clino-lock'), elZero=$('#clino-zero'), elReset=$('#clino-reset'), elStatus=$('#clino-status');
const toDeg=rad=>rad*180/Math.PI, clamp=(x,a,b)=>Math.min(b,Math.max(a,x));
function buzz(ms=30){ if(navigator.vibrate) try{navigator.vibrate(ms);}catch{} }
async function requestIOSPermissionIfNeeded(){
  const any=window.DeviceOrientationEvent; if(!any) return true;
  if(typeof any.requestPermission==='function'){ try{ const res=await any.requestPermission(); return res==='granted'; }catch{ return false; } }
  return true;
}
function computePitchFromEvent(ev){ const beta=typeof ev.beta==='number'?ev.beta:0; const rad=(beta*Math.PI/180)-zeroOffsetRad; return clamp(toDeg(rad),-89.9,89.9); }
let onOrientation=null;
function startClinometer(){
  if(clinoOn) return; clinoOn=true; elStatus.textContent='Sensor: running';
  elEnable.classList.add('active'); elDisable.classList.remove('active');
  requestIOSPermissionIfNeeded().then(ok=>{
    if(!ok){ elStatus.textContent='Sensor: permission denied'; clinoOn=false; return; }
    onOrientation=(ev)=>{ if(!clinoOn||locked) return; const deg=computePitchFromEvent(ev); elAngle.textContent=`${fmt1(deg)}°`; };
    window.addEventListener('deviceorientation', onOrientation, {passive:true});
  });
}
function stopClinometer(){
  if(!clinoOn) return; clinoOn=false; elEnable.classList.remove('active'); elDisable.classList.add('active');
  elStatus.textContent='Sensor: stopped'; if(onOrientation){ window.removeEventListener('deviceorientation', onOrientation); onOrientation=null; }
}
function lockAngle(){
  // Toggle lock; when locking, write current angle to the input field
  if(!locked){
    locked=true; elLock.textContent='Locked'; elLock.classList.add('active'); buzz(40);
    const txt=elAngle.textContent.replace('°',''); const current=parseFloat(txt);
    if(Number.isFinite(current)){ hAngle.value=current.toFixed(1); if(calcMode==='auto') calcHeight(); }
  } else {
    locked=false; elLock.textContent='Lock'; elLock.classList.remove('active');
  }
}
function zeroCalibrate(){ const txt=elAngle.textContent.replace('°',''); const current=parseFloat(txt); if(!Number.isFinite(current)) return; zeroOffsetRad += (current*Math.PI/180); elStatus.textContent='Zeroed at current angle'; buzz(20); }
function resetSensor(){ locked=false; elLock.textContent='Lock'; elLock.classList.remove('active'); zeroOffsetRad=0; elAngle.textContent='—°'; elStatus.textContent='Sensor: idle'; buzz(10); }
elEnable?.addEventListener('click', startClinometer);
elDisable?.addEventListener('click', stopClinometer);
elLock?.addEventListener('click', lockAngle);
elZero?.addEventListener('click', zeroCalibrate);
elReset?.addEventListener('click', resetSensor);
document.addEventListener('visibilitychange', ()=>{ if(document.hidden) stopClinometer(); });

/* ====== Canopy ====== */
const spreadMajor=$('#spreadMajor'), spreadMinor=$('#spreadMinor'), spreadCalc=$('#spread-calc');
function calcSpread(){
  const maj=parseFloat(spreadMajor.value), min=parseFloat(spreadMinor.value);
  const haveMaj=Number.isFinite(maj), haveMin=Number.isFinite(min);
  if(!haveMaj && !haveMin){ lastSpread=null; updateResultsPanel(); updateCopyButtons(); return; }
  const mMaj=haveMaj?toM(maj,inputUnit):null, mMin=haveMin?toM(min,inputUnit):null;
  const meanM=((mMaj??0)+(mMin??0))/((haveMaj?1:0)+(haveMin?1:0));
  lastSpread={majorM:mMaj,minorM:mMin,meanM,meanFt:mToFt(meanM)};
  updateResultsPanel(); updateCopyButtons();
}
spreadCalc.onclick=calcSpread;
[spreadMajor,spreadMinor].forEach(inp=>inp.addEventListener('input',()=>{ if(calcMode==='auto') calcSpread(); }));

/* ====== Results & Quick Copy ====== */
const resHeight=$('#res-height'), resEqCirc=$('#res-eqcirc'), resAvgCirc=$('#res-avgcirc'), resSpread=$('#res-spread');
function updateResultsPanel(){
  resHeight.textContent = lastHeight ? `Height: ${fmt2(lastHeight.hM)} m (${fmt2(lastHeight.hFt)} ft)` : 'Height: —';
  const t=treeType.value;
  if(t==='Multi trunked tree' && lastMulti){
    resEqCirc.textContent=`Equivalent circumference: ${fmt2(lastMulti.cEqM)} m (${fmt2(lastMulti.cEqFt)} ft)`;
    resAvgCirc.style.display=''; resAvgCirc.textContent=`Average circumference (multi): ${fmt2(lastMulti.cAvgM)} m (${fmt2(lastMulti.cAvgFt)} ft)`;
  } else if(t==='Single trunk tree' && lastSingle){
    resEqCirc.textContent=`Entered circumference: ${fmt2(lastSingle.cM)} m (${fmt2(lastSingle.cFt)} ft)`;
    resAvgCirc.style.display='none'; resAvgCirc.textContent='Average circumference (multi): —';
  } else {
    resEqCirc.textContent='Equivalent / Entered circumference: —';
    resAvgCirc.style.display=(t==='Multi trunked tree')?'':'none';
    resAvgCirc.textContent='Average circumference (multi): —';
  }
  resSpread.textContent = lastSpread ? `Final canopy spread: ${fmt2(lastSpread.meanM)} m (${fmt2(lastSpread.meanFt)} ft)` : 'Final canopy spread: —';
}
const copyHeight=$('#copyHeight'), copyEqCirc=$('#copyEqCirc'), copyAvgCirc=$('#copyAvgCirc'), copySpread=$('#copySpread');
function updateCopyButtons(){
  copyHeight.disabled=!(lastHeight&&Number.isFinite(lastHeight.hM));
  if(treeType.value==='Multi trunked tree'){ copyEqCirc.disabled=!(lastMulti&&Number.isFinite(lastMulti.cEqM)); copyAvgCirc.disabled=!(lastMulti&&Number.isFinite(lastMulti.cAvgM)); }
  else if(treeType.value==='Single trunk tree'){ copyEqCirc.disabled=!(lastSingle&&Number.isFinite(lastSingle.cM)); copyAvgCirc.disabled=true; }
  else { copyEqCirc.disabled=true; copyAvgCirc.disabled=true; }
  copySpread.disabled=!(lastSpread&&Number.isFinite(lastSpread.meanM));
}
async function copyText(txt,btn){
  try{ await navigator.clipboard.writeText(txt); const o=btn.textContent; btn.textContent='Copied ✓'; setTimeout(()=>btn.textContent=o,1200); }
  catch{ const t=document.createElement('input'); t.value=txt; document.body.appendChild(t); t.select(); document.execCommand('copy'); t.remove(); const o=btn.textContent; btn.textContent='Copied ✓'; setTimeout(()=>btn.textContent=o,1200); }
}
copyHeight.onclick=()=>{ if(lastHeight) copyText(fmt2(lastHeight.hM),copyHeight); };
copyEqCirc.onclick=()=>{ const t=treeType.value; if(t==='Multi trunked tree'&&lastMulti) copyText(fmt2(lastMulti.cEqM),copyEqCirc); if(t==='Single trunk tree'&&lastSingle) copyText(fmt2(lastSingle.cM),copyEqCirc); };
copyAvgCirc.onclick=()=>{ if(lastMulti) copyText(fmt2(lastMulti.cAvgM),copyAvgCirc); };
copySpread.onclick=()=>{ if(lastSpread) copyText(fmt2(lastSpread.meanM),copySpread); };

/* ====== Description / Email / Share ====== */
const treeNameInput=$('#treeName'), species=$('#species'), condition=$('#condition');
const descBox=$('#desc'), genDesc=$('#genDesc'), copyDesc=$('#copyDesc'), shareBtn=$('#shareLink'), emailBtn=$('#emailBtn');

function ensureOnDemand(){
  if(treeType.value==='Multi trunked tree'){ const any=$$('#mt-list input').some(i=>Number.isFinite(parseFloat(i.value))); if(any && !lastMulti) calcMulti(); }
  const a=parseFloat(hAngle.value), d=parseFloat(hDist.value), e=parseFloat(hEye.value); if(Number.isFinite(a)&&Number.isFinite(d)&&Number.isFinite(e)&&!lastHeight) calcHeight();
  if(!lastSpread && (Number.isFinite(parseFloat(spreadMajor.value))||Number.isFinite(parseFloat(spreadMinor.value)))) calcSpread();
  if(treeType.value==='Single trunk tree' && !lastSingle && Number.isFinite(parseFloat(singleC.value))) recomputeSingle();
}
function buildDescription(){
  const parts=[]; const name=treeNameInput.value?.trim(), sp=species.value?.trim(), cond=condition.value?.trim(), type=treeType.value?.trim();
  const head=document.createElement('div');
  if(name) head.innerHTML+=`<p><strong>Tree</strong>: ${escapeHtml(name)}</p>`;
  if(sp)   head.innerHTML+=`<p><strong>Species</strong>: ${escapeHtml(sp)}</p>`;
  if(cond) head.innerHTML+=`<p><strong>Condition</strong>: ${escapeHtml(cond)}</p>`;
  if(type) head.innerHTML+=`<p><strong>Type</strong>: ${escapeHtml(type)}</p>`;
  if(head.innerHTML) parts.push(head);

  const meas=document.createElement('div'); let has=false;

  if(type==='Single trunk tree' && lastSingle){
    has=true;
    const p1=document.createElement('p'); p1.innerHTML='<strong>Measurements</strong>';
    const ul=document.createElement('ul');
    const li=document.createElement('li');
    li.textContent=`Circumference: ${fmt2(lastSingle.cM)} m (${fmt2(lastSingle.cFt)} ft) → Diameter: ${fmt2(lastSingle.dM)} m (${fmt2(lastSingle.dFt)} ft)`;
    ul.appendChild(li); meas.appendChild(p1); meas.appendChild(ul);
  }

  if(type==='Multi trunked tree' && lastMulti){
    has=true;
    const p1=document.createElement('p'); p1.innerHTML='<strong>Individual trunks (circumference → diameter)</strong>';
    const ul1=document.createElement('ul');
    lastMulti.trunks.forEach(t=>{
      const txt=`T${t.index}: ${fmt2(t.cM)} m (${fmt2(t.cFt)} ft) → ${fmt2(t.dM)} m (${fmt2(t.dFt)} ft)`;
      const li=document.createElement('li');
      if(t.isLargest){ li.innerHTML=`<strong>${txt}</strong>`; } else { li.textContent=txt; }
      ul1.appendChild(li);
    });
    const p2=document.createElement('p'); p2.innerHTML='<strong>Full Tree Circumference (circumference → diameter)</strong>';
    const ul2=document.createElement('ul');
    const liC=document.createElement('li'); liC.textContent=`Equivalent circumference: ${fmt2(lastMulti.cEqM)} m (${fmt2(lastMulti.cEqFt)} ft) → ${fmt2(lastMulti.dEqM)} m (${fmt2(lastMulti.dEqFt)} ft)`;
    const dAvgM=lastMulti.cAvgM/PI, dAvgFt=mToFt(dAvgM);
    const liA=document.createElement('li'); liA.textContent=`Average circumference: ${fmt2(lastMulti.cAvgM)} m (${fmt2(lastMulti.cAvgFt)} ft) → ${fmt2(dAvgM)} m (${fmt2(dAvgFt)} ft)`;
    ul2.appendChild(liC); ul2.appendChild(liA);
    meas.appendChild(p1); meas.appendChild(ul1); meas.appendChild(p2); meas.appendChild(ul2);
  }

  if(lastHeight){
    has=true;
    const p=document.createElement('p'); p.innerHTML='<strong>Height</strong>';
    const ul=document.createElement('ul');
    const liH=document.createElement('li'); liH.textContent=`Tree height: ${fmt2(lastHeight.hM)} m (${fmt2(lastHeight.hFt)} ft)`;
    const liF=document.createElement('li'); liF.textContent=`height = tan(${fmt1(lastHeight.angleDeg)}°) × ${fmt2(lastHeight.dM)} m + ${fmt2(lastHeight.eM)} m = ${fmt2(lastHeight.hM)} m (${fmt2(lastHeight.hFt)} ft)`;
    ul.appendChild(liH); ul.appendChild(liF); meas.appendChild(p); meas.appendChild(ul);
  }

  if(lastSpread){
    has=true;
    const p=document.createElement('p'); p.innerHTML='<strong>Canopy spread</strong>';
    const ul=document.createElement('ul');
    if(Number.isFinite(lastSpread.majorM)){ const li=document.createElement('li'); li.textContent=`Major: ${fmt2(lastSpread.majorM)} m (${fmt2(mToFt(lastSpread.majorM))} ft)`; ul.appendChild(li); }
    if(Number.isFinite(lastSpread.minorM)){ const li=document.createElement('li'); li.textContent=`Minor: ${fmt2(lastSpread.minorM)} m (${fmt2(mToFt(lastSpread.minorM))} ft)`; ul.appendChild(li); }
    const liMean=document.createElement('li'); liMean.innerHTML=`<strong>Final canopy spread: ${fmt2(lastSpread.meanM)} m (${fmt2(lastSpread.meanFt)} ft)</strong>`; ul.appendChild(liMean);
    meas.appendChild(p); meas.appendChild(ul);
  }

  if(has) parts.push(meas);

  const nTxt=notesEl.value.trim();
  if(nTxt){
    const n=document.createElement('div');
    n.innerHTML='<p><strong>Notes</strong></p>';
    const ul=document.createElement('ul');
    nTxt.split(/\n+/).forEach(line=>{ const li=document.createElement('li'); li.textContent=line; ul.appendChild(li); });
    n.appendChild(ul); parts.push(n);
  }

  const obs=document.createElement('div');
  obs.innerHTML=`<p><strong>Observation</strong></p><ul><li>Recorded: ${nowLocal24()}</li></ul>`;
  parts.push(obs);

  const out=document.createElement('div'); parts.forEach(p=>out.appendChild(p)); return out.innerHTML;
}
function extractPlainText(container){
  const items=Array.from(container.querySelectorAll('li')).map(li=>`- ${li.innerText}`);
  const paras=Array.from(container.querySelectorAll('p')).map(p=>p.innerText);
  return [...paras,...items].join('\n').trim();
}
function generateDescription(){
  ensureOnDemand();
  const html=buildDescription(); descBox.innerHTML=html||'—'; copyDesc.disabled=!html; shareBtn.disabled=!html;
  if(html){
    const text=extractPlainText(descBox); const nm=$('#treeName').value?.trim();
    const subject=`ARA Field Nomination${nm?' – '+nm:''}`;
    emailBtn.href=`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(text)}`;
    emailBtn.removeAttribute('aria-disabled');
  } else { emailBtn.setAttribute('aria-disabled','true'); emailBtn.href='#'; }
}
$('#genDesc').onclick=generateDescription;

$('#copyDesc').onclick=async ()=>{ const html=descBox.innerHTML.trim(); if(!html||html==='—') return; const text=extractPlainText(descBox);
  if(navigator.clipboard && window.ClipboardItem){ try{
    await navigator.clipboard.write([new ClipboardItem({'text/html':new Blob([html],{type:'text/html'}),'text/plain':new Blob([text],{type:'text/plain'})})]);
    const o=$('#copyDesc').textContent; $('#copyDesc').textContent='Copied ✓'; setTimeout(()=>$('#copyDesc').textContent=o,1200); return;
  }catch{} }
  const tmp=document.createElement('div'); tmp.contentEditable='true'; tmp.style.position='fixed'; tmp.style.left='-9999px'; tmp.innerHTML=html; document.body.appendChild(tmp);
  const r=document.createRange(); r.selectNodeContents(tmp); const s=window.getSelection(); s.removeAllRanges(); s.addRange(r); document.execCommand('copy'); s.removeAllRanges(); tmp.remove();
  const o=$('#copyDesc').textContent; $('#copyDesc').textContent='Copied ✓'; setTimeout(()=>$('#copyDesc').textContent=o,1200);
};

/* Share link for the current form */
function getFormState(){
  return {
    inputUnit, calcMode,
    basics:{ name: $('#treeName').value||'', species: $('#species').value||'', condition: $('#condition').value||'', type: $('#treeType').value||'' },
    singleC: $('#singleC').value||'',
    height:{ angle: $('#h-angle').value||'', dist: $('#h-dist').value||'', eye: $('#h-eye').value||'' },
    spread:{ major: $('#spreadMajor').value||'', minor: $('#spreadMinor').value||'' },
    notes: $('#notes').value||'',
    multi: { values: $$('#mt-list input').map(i=>i.value||'') },
    desc: descBox.innerHTML && descBox.innerHTML!=='—' ? descBox.innerHTML : ''
  };
}
function encodeShare(state){ const json=JSON.stringify(state); const b64=btoa(unescape(encodeURIComponent(json))); return location.origin+location.pathname+'#data='+b64; }
function decodeShare(hash){ try{ const b64=hash.replace(/^#?data=/,''); const json=decodeURIComponent(escape(atob(b64))); return JSON.parse(json);}catch{ return null; } }
$('#shareLink').onclick=async ()=>{ const url=encodeShare(getFormState()); if(url.length>2000) alert('Heads up: long link. Some apps may truncate it.'); await navigator.clipboard.writeText(url); const o=$('#shareLink').textContent; $('#shareLink').textContent='Link copied ✓'; setTimeout(()=>$('#shareLink').textContent=o,1200); };

/* Load from link on boot */
(function boot(){
  try{
    const hashData = location.hash.startsWith('#data=') ? decodeShare(location.hash) : null;
    if(hashData){
      inputUnit = (hashData.inputUnit==='ft')?'ft':'m'; setUnit(inputUnit);
      setCalcMode(hashData.calcMode==='auto'?'auto':'manual');
      $('#treeName').value = hashData.basics?.name??''; $('#species').value=hashData.basics?.species??''; $('#condition').value=hashData.basics?.condition??''; $('#treeType').value=hashData.basics?.type??'';
      updateTypeVisibility();
      $('#singleC').value=hashData.singleC??'';
      $('#h-angle').value=hashData.height?.angle??''; $('#h-dist').value=hashData.height?.dist??''; $('#h-eye').value=hashData.height?.eye??'';
      $('#spreadMajor').value=hashData.spread?.major??''; $('#spreadMinor').value=hashData.spread?.minor??'';
      $('#notes').value=hashData.notes??''; autoGrow($('#notes'));
      mtList.innerHTML=''; mtCount=0; const arr=Array.isArray(hashData.multi?.values)?hashData.multi.values:[]; if(arr.length>0) arr.forEach(v=>addMtRow(v)); else { if($('#treeType').value==='Multi trunked tree'){ addMtRow(); addMtRow(); } }
      if(hashData.desc){ descBox.innerHTML=hashData.desc; $('#copyDesc').disabled=false; $('#shareLink').disabled=false; }
    }
  }catch(e){ console.warn('Init issue', e); }
})();
</script>
</body>
</html>
