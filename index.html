<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ARA Field Tools</title>
<style>
  :root{
    /* Dark blue palette */
    --bg:#0d1b2a;
    --bg-elev:#0f2236;
    --panel:#14253d;
    --panel-2:#172a47;
    --text:#e8eef6;
    --muted:#a9b7c7;
    --accent:#2ea3ff;
    --accent-2:#4db2ff;
    --ok:#1fa37a;
    --danger:#d93c3c;
    --border:#1f3553;
    --radius:14px;
    --gap:14px;
  }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg); color:var(--text);
  }

  /* Fixed header */
  .topbar{
    position:sticky; top:0; z-index:50;
    background:linear-gradient(180deg, #0d1b2a, #0f2236);
    border-bottom:1px solid var(--border);
    padding:10px 14px;
  }
  .topbar .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .brand{ font-weight:800; letter-spacing:.2px; font-size:1.05rem; color:#eaf3ff; }

  .inline-controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .toggle-btn{
    padding:8px 12px; border:1px solid var(--border); border-radius:999px;
    background:var(--panel); color:var(--text); cursor:pointer;
  }
  .toggle-btn.active{ background:var(--accent); color:#001528; border-color:transparent; font-weight:700; }
  .toggle-label{ color:var(--muted); font-size:.9rem; margin-left:6px; }

  /* Tabs */
  .tabs{
    position:sticky; top:56px; z-index:45;
    background:var(--bg-elev); border-bottom:1px solid var(--border);
    overflow:auto; white-space:nowrap;
  }
  .tabs-inner{ display:flex; gap:8px; padding:8px 12px; }
  .tab{
    padding:10px 14px; border-radius:999px;
    background:var(--panel); border:1px solid var(--border); color:var(--text);
    cursor:pointer; user-select:none;
  }
  .tab.active{ background:var(--accent-2); color:#001528; border-color:transparent; font-weight:800; }

  /* Main content */
  .content{ padding:14px; max-width:1000px; margin:0 auto; }
  .card{
    background:var(--panel); border:1px solid var(--border);
    border-radius:var(--radius); margin-bottom:var(--gap);
  }
  .card .block{ padding:16px 18px; }
  h2{ margin:0 0 8px; font-size:1.2rem; }
  h3{ margin:0 0 8px; font-size:1.05rem; color:#d6e6ff; }
  label{ display:block; font-weight:700; margin:10px 0 6px; }
 /* Use the same monospace font for all form fields */
/* Consistent system font for all entry fields */
input[type="text"], input[type="number"], select, textarea {
  width: 100%;
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--panel-2);
  color: var(--text);
  font-size: 1rem;
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  letter-spacing: 0.01em;
}

/* Make placeholders inherit the same font */
input::placeholder,
textarea::placeholder{
  font-family: inherit;
}
  textarea{ min-height:88px; resize:none; overflow:hidden; }
  .row{ display:grid; grid-template-columns:1fr 1fr; gap:var(--gap); }
  @media (max-width:780px){ .row{ grid-template-columns:1fr } }

  .note{
    background:#0b1a2f; border:1px solid #1f3553; color:#cfe0ff;
    border-radius:12px; padding:10px 12px;
  }

  /* Buttons */
  .btn-row{ display:flex; flex-wrap:wrap; gap:10px; }
  button,.btn{
    padding:10px 14px; border:0; border-radius:10px; cursor:pointer; color:#001528;
    background:var(--accent-2); font-weight:700;
  }
  .btn-ghost{ background:var(--panel-2); color:var(--text); border:1px solid var(--border); }
  .btn-dim{ background:#113158; color:#bcd8ff; border:1px solid var(--border); }
  .btn-danger{ background:var(--danger); color:#fff; }
  .btn-ok{ background:var(--ok); color:#00180f; }
  button[disabled]{ opacity:.6; cursor:not-allowed; }

  /* Multi-trunk minor styles */
  .mt-label{font-weight:700}
  .badge{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;background:#1b6cff;color:#001528;font-size:.75rem;vertical-align:middle}
  .badge.hide{display:none}
  .hint{font-size:.86rem;color:#ffc0c0;display:none}
  .hint.show{display:block}

  input::placeholder,
textarea::placeholder {
  font-family: inherit;
  color: #99a5b8;
}


  /* Clinometer (grid removed, angle top-right) */
  .clino-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .clino-wrap{
    position:relative; height:180px; border:1px solid var(--border);
    border-radius:12px; background:#0b1a2f; margin:10px 0; overflow:hidden;
    display:flex; align-items:center; justify-content:center;
  }
  .clino-angle{
    position:absolute; right:10px; top:10px;
    font-weight:800; font-size:1.2rem; color:#001528;
    background:#cfe0ff; padding:6px 10px; border-radius:8px; border:1px solid var(--border);
  }
  .clino-lock{
    width:140px; height:140px; border-radius:999px; border:0; cursor:pointer;
    background:#cfe0ff; color:#001528; font-weight:900; font-size:1.15rem;
  }
  .clino-lock:active{ transform:scale(.98); }
  .clino-controls{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }

  /* Results */
  .results{
    background:#0b1a2f; border:1px solid var(--border);
    border-radius:12px; padding:12px;
  }
  .results p{ margin:6px 0 }
  .muted{ color:var(--muted) }
  .tiny{ font-size:.86rem; color:var(--muted) }
  .unit-tag{ color:#cfe0ff; font-weight:800 }

  /* Tabs content visibility */
  .tabpane{ display:none }
  .tabpane.active{ display:block }

  /* Accuracy pill colors for location tab*/
.acc-chip{
  display:inline-block; padding:2px 8px; border-radius:999px; font-weight:600;
}
.acc-grey { background:#404957; color:#d7dee8; }
.acc-amber{ background:#7a5a15; color:#ffe2a8; }
.acc-green{ background:#1b5e2b; color:#c6f1cf; }

/* Running state for the Start/Stop toggle */
#loc-toggle.running{
  background:#0b3b82; /* dark blue when running */
  color:#fff;
}
/* Reset Form Button visual feedback */
#resetFormResults {
  background: #0e1f3f;          /* dark blue default */
  color: #fff;
  border: 1px solid #1c366b;
  transition: background 0.2s, transform 0.1s;
}

#resetFormResults:hover {
  background: #c62828;          /* red on hover */
  border-color: #b71c1c;
  transform: scale(1.02);
}

#resetFormResults:active {
  background: #8e0000;          /* darker red when pressed */
  transform: scale(0.98);
}

</style>
</head>
<body>
  


<!-- Top bar (tree name removed) -->
<div class="topbar">
  <div class="row">
    <div class="brand">ARA Field Tools</div>
    <div class="inline-controls" aria-label="Global controls">
      <span class="toggle-label">Units:</span>
      <button type="button" id="unit-m"  class="toggle-btn active" aria-pressed="true">m</button>
      <button type="button" id="unit-ft" class="toggle-btn" aria-pressed="false">ft</button>
      <span class="toggle-label">Calc:</span>
      <button type="button" id="mode-manual" class="toggle-btn active" aria-pressed="true">Manual</button>
      <button type="button" id="mode-auto"   class="toggle-btn" aria-pressed="false">Auto</button>
    </div>
  </div>
</div>

<!-- Tabs -->
<div class="tabs">
  <div class="tabs-inner">
    <div class="tab active" data-tab="gen">General</div>
    <div class="tab" data-tab="loc">Location</div>
    <div class="tab" data-tab="circ">Circumference</div>
    <div class="tab" data-tab="height">Height</div>
    <div class="tab" data-tab="canopy">Canopy</div>
    <div class="tab" data-tab="results">Results</div>
  </div>
</div>

<!-- Content -->
<div class="content">

  <!-- General -->
  <section id="pane-gen" class="tabpane active">
    <div class="card">
      <div class="block">
        <h2>General</h2>

        <label for="treeName">Tree name</label>
        <input id="treeName" type="text" placeholder="Tree name (e.g., Rossdale Poplar)">

        <div class="row" style="margin-top:8px;">
          <div>
            <label for="species">Species</label>
            <input id="species" type="text" placeholder="e.g., Populus balsamifera">
          </div>
          <div>
            <label for="condition">Condition</label>
            <select id="condition">
              <option value="">— optional —</option>
              <option>Excellent</option><option>Good</option><option>Fair</option><option>Poor</option><option>Dead</option>
            </select>
          </div>
        </div>

        <label for="notes" style="margin-top:10px;">Notes</label>
        <textarea id="notes" placeholder="Observations, access notes, landmarks, hazards…"></textarea>
        <div class="tiny">Notes appear in the generated description.</div>
      </div>
    </div>
  </section>

  <!-- Location  -->
 <section id="pane-loc" class="tabpane">
  <div class="card">
    <div class="block">
      <h2>Location</h2>

      <!-- Controls row -->
      <div class="unit-toggle" style="flex-wrap:wrap; gap:8px;">
        <button type="button" id="loc-toggle" class="btn-primary">Start tracking</button>
        <button type="button" id="loc-hiacc"  class="toggle-btn" aria-pressed="false" title="Request highest accuracy">High accuracy</button>
        <button type="button" id="loc-saver"  class="toggle-btn" aria-pressed="false" title="Reduce update rate to save battery">Battery saver</button>
      </div>

      <!-- Recent fix -->
      <div class="results" style="margin-top:10px;">
        <h3 style="margin:0 0 6px;">Recent fix</h3>
        <p id="loc-recent-dd">DD: —</p>
        <p>Altitude: <span id="loc-recent-alt">—</span></p>
        <p>
          Accuracy: <span id="loc-recent-acc" class="acc-chip acc-grey">—</span>
        </p>
        <p>Age: <span id="loc-recent-age">—</span></p>
        <p class="tiny" style="margin-top:6px;">Samples: <span id="loc-samples">0</span></p>
      </div>

      <!-- Best fix -->
      <div class="results" style="margin-top:10px;">
        <h3 style="margin:0 0 6px;">Best so far <span id="loc-best-badge" class="badge" style="display:none;">new</span></h3>
        <p id="loc-best-dd">DD: —</p>
        <p>Altitude: <span id="loc-best-alt">—</span></p>
        <p>
          Accuracy: <span id="loc-best-acc" class="acc-chip acc-grey">—</span>
        </p>
        <p>Time: <span id="loc-best-time">—</span></p>
      </div>

      <!-- Action buttons BELOW the best panel -->
      <div class="unit-toggle" style="margin-top:10px;">
        <button type="button" id="loc-use-recent" class="btn-ghost" disabled>Save recent</button>
        <button type="button" id="loc-use-best"   class="btn-ghost" disabled>Save best</button>
        <button type="button" id="loc-reset"      class="btn-ghost danger">Reset location</button>
      </div>

      <!-- Hidden storage for description/builders (keep IDs so existing code works) -->
      <input type="hidden" id="lat">
      <input type="hidden" id="lng">
      <input type="hidden" id="acc">
      <span id="loc-saved-alt" data-val="" style="display:none;"></span>
      <span id="loc-saved-ts" data-ts="" style="display:none;"></span>
    </div>
  </div>
</section>

  <!-- Circumference -->
  <section id="pane-circ" class="tabpane">
    <div class="card">
      <div class="block">
        <h2>Circumference</h2>

        <label for="treeType">Tree type</label>
        <select id="treeType">
          <option value="">— select —</option>
          <option>Single trunk tree</option>
          <option>Multi trunked tree</option>
          <option>Grove</option>
          <option>Forest</option>
          <option>Clonal aspen</option>
        </select>

        <!-- Single trunk -->
        <div id="single-circ-block" style="display:none;margin-top:10px;">
          <label for="singleC">Circumference (<span class="unit-tag">m</span>)</label>
          <input id="singleC" type="number" step="0.01" inputmode="decimal" placeholder="e.g. 3.10">
          <div class="btn-row" style="margin-top:8px;">
            <button type="button" id="single-update" class="btn-dim">Update circumference</button>
          </div>
          <div class="tiny">Diameter is calculated automatically (D = C / π).</div>
        </div>

        <!-- Multi-trunk -->
        <div id="multi-block" style="display:none;margin-top:10px;">
          <div class="note" style="margin-bottom:10px;">
            <strong>Multi-trunk entry:</strong> add each trunk’s <em>circumference</em>. * Largest trunk counts 100%, others 50%.
          </div>
          <div id="mt-list" style="display:flex;flex-direction:column;gap:10px;"></div>
          <div class="btn-row" style="margin-top:8px;">
            <button type="button" id="mt-add"    class="btn-dim">Add trunk</button>
            <button type="button" id="mt-remove" class="btn-dim">Remove last</button>
            <button type="button" id="mt-sort"   class="btn-ghost" title="Sort by diameter (desc)">Sort by diameter</button>
            <button type="button" id="mt-calc"   class="btn-dim">Calculate multi-trunk</button>
          </div>

          <label for="mt-bulk" style="margin-top:12px;">Bulk paste (numbers + repeaters)</label>
          <textarea id="mt-bulk" class="mono" placeholder="Examples:
1.72, 0.98 1.10
12x0.78   (12 repeats of 0.78)
3×1.50    (× also works)"></textarea>
          <div class="tiny">
            Uses current unit (<span class="unit-tag">m</span>). Ignores text; keeps positive numbers only.
            Supports <strong>NxVALUE</strong> like <strong>12x0.78</strong> or <strong>3×1.5</strong>.
          </div>
          <div class="btn-row" style="margin-top:8px;">
            <button type="button" id="mt-fill"  class="btn-ghost">Fill from bulk</button>
            <button type="button" id="mt-clear" class="btn-ghost">Clear bulk</button>
          </div>

          <div id="mt-result" class="tiny" style="margin-top:8px;color:#cfe0ff;">—</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Height -->
  <section id="pane-height" class="tabpane">
    <div class="card">
      <div class="block">
        <div class="clino-head">
          <h2>Height</h2>
          <div id="clino-angle" class="clino-angle">—°</div>
        </div>

        <label for="h-angle">Angle to top of the tree (degrees)</label>
        <input id="h-angle" type="number" step="0.1" inputmode="decimal" placeholder="e.g. 37.5">

        <div class="row">
          <div>
            <label for="h-dist">Distance to trunk (<span class="unit-tag">m</span>)</label>
            <input id="h-dist" type="number" step="0.01" inputmode="decimal" placeholder="e.g. 23.40">
          </div>
          <div>
            <label for="h-eye">Eye height (<span class="unit-tag">m</span>)</label>
            <input id="h-eye" type="number" step="0.01" inputmode="decimal" placeholder="e.g. 1.62">
          </div>
        </div>

        <div class="btn-row" style="margin-top:10px;">
          <button type="button" id="h-calc" class="btn-dim">Calculate height</button>
        </div>

        <!-- Clinometer -->
        <div class="card" id="clino-card" style="margin-top:12px;background:#10253f;">
          <div class="block">
            <div class="btn-row" aria-label="Clinometer power">
              <button type="button" id="clino-enable" class="toggle-btn small">Start</button>
              <button type="button" id="clino-disable" class="toggle-btn small">Stop</button>
            </div>

            <div class="clino-wrap">
              <!-- angle readout lives top-right; lock fills the space -->
              <button type="button" id="clino-lock" class="clino-lock">Lock</button>
            </div>

            <div class="clino-controls">
              <button type="button" id="clino-zero"  class="btn-ghost">Zero (calibrate)</button>
              <button type="button" id="clino-reset" class="btn-ghost">Reset sensor</button>
            </div>
            <div class="tiny" id="clino-status">Sensor: idle</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Canopy -->
  <section id="pane-canopy" class="tabpane">
    <div class="card">
      <div class="block">
        <h2>Canopy</h2>
        <div class="row">
          <div>
            <label for="spreadMajor">Major axis (<span class="unit-tag">m</span>)</label>
            <input id="spreadMajor" type="number" step="0.01" inputmode="decimal" placeholder="e.g. 30.00">
          </div>
          <div>
            <label for="spreadMinor">Minor axis (<span class="unit-tag">m</span>)</label>
            <input id="spreadMinor" type="number" step="0.01" inputmode="decimal" placeholder="e.g. 20.00">
          </div>
        </div>
        <div class="btn-row" style="margin-top:10px;">
          <button type="button" id="spread-calc" class="btn-dim">Calculate canopy spread</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Results -->
  <section id="pane-results" class="tabpane">
    <div class="card">
      <div class="block">
        <h2>Final measurements</h2>
        <div class="results">
          <p id="res-height">Height: —</p>
          <p id="res-eqcirc">Equivalent / Entered circumference: —</p>
          <p id="res-avgcirc" style="display:none;">Average circumference (multi): —</p>
          <p id="res-spread">Final canopy spread: —</p>
        </div>
      </div>
      <div class="block">
        <h3>Quick copy <span class="tiny">(ARA form pure numbers in meters)</span></h3>
        <div class="btn-row">
          <button type="button" id="copyHeight"  class="btn-ghost" disabled>Copy Height (m)</button>
          <button type="button" id="copyEqCirc"  class="btn-ghost" disabled>Copy Eq. Circ (m)</button>
          <button type="button" id="copyAvgCirc" class="btn-ghost" disabled>Copy Avg Circ (m)</button>
          <button type="button" id="copySpread"  class="btn-ghost" disabled>Copy Canopy (m)</button>
        </div>
        <div class="unit-toggle" style="margin-top:8px;">

      </div>
      <div class="block">
        <h3>Description</h3>
        <div class="btn-row">
          <button type="button" id="genDesc"  class="btn-dim">Generate description</button>
          <button type="button" id="copyDesc" class="btn-ghost" disabled>Copy description</button>
          <button type="button" id="shareLink" class="btn-ghost" disabled>Copy share link</button>
          <a id="emailBtn" class="btn btn-ghost" href="#" aria-disabled="true">Open email (optional)</a>
        </div>
        <div id="desc" class="results" style="margin-top:10px;">—</div>
        <div class="tiny" style="margin-top:6px;">Timestamp uses local 24-hour time.</div>
      </div>
          <button type="button" id="resetFormResults" class="btn-ghost danger" title="Reset the form (does not clear the log)">Reset form</button>
</div>
    </div>
  </section>

</div>

<script>
  
  // Global guard to prevent autosave during a deliberate reset
window.ARA_RESETTING = false;

  // Decimal degrees -> DMS string (global helper)
function toDMS(dec, isLat){
  if (!Number.isFinite(dec)) return '—';
  const hemi = dec >= 0 ? (isLat ? 'N' : 'E') : (isLat ? 'S' : 'W');
  let v = Math.abs(dec);
  const d = Math.floor(v); v = (v - d) * 60;
  const m = Math.floor(v); const s = (v - m) * 60;
  return `${d}° ${m}' ${s.toFixed(2)}" ${hemi}`;
}

/* ====== Helpers & globals ====== */
const PI=Math.PI, FT_PER_M=3.28084, M_PER_FT=0.3048;
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const tanDeg=d=>Math.tan(d*Math.PI/180);
const fmt2=x=>Number.isFinite(x)?x.toFixed(2):'—', fmt1=x=>Number.isFinite(x)?x.toFixed(1):'—';
const toM=(v,u)=>u==='m'?v:v*M_PER_FT, mToFt=m=>m*FT_PER_M;
const nowLocal24=()=>{const d=new Date();const p=n=>String(n).padStart(2,'0');return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`};
const escapeHtml=s=>String(s??'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

/* State */
let inputUnit='m', calcMode='manual';
let lastSingle=null, lastMulti=null, lastHeight=null, lastSpread=null;

/* Header controls */
const unitM=$('#unit-m'), unitFt=$('#unit-ft');
const modeManualBtn=$('#mode-manual'), modeAutoBtn=$('#mode-auto');
const unitTags=$$('.unit-tag');

function setUnit(u){
  if(u===inputUnit) return;
  const conv=inp=>{ const v=parseFloat(inp.value); if(!Number.isNaN(v)){ const m=toM(v,inputUnit); inp.value=(u==='m'?m:m*FT_PER_M).toFixed(2); } };
  [$('#singleC'), $('#h-dist'), $('#h-eye'), $('#spreadMajor'), $('#spreadMinor')].forEach(el=>el&&conv(el));
  $$('#mt-list input[type="number"]').forEach(conv);
  inputUnit=u;
  const isM=u==='m';
  unitM.classList.toggle('active',isM); unitFt.classList.toggle('active',!isM);
  unitM.setAttribute('aria-pressed',String(isM)); unitFt.setAttribute('aria-pressed',String(!isM));
  unitTags.forEach(t=>t.textContent=isM?'m':'ft');
  renumberTrunks();
  if(calcMode==='auto'){ if($('#treeType').value==='Single trunk tree') recomputeSingle(); if($('#treeType').value==='Multi trunked tree') calcMulti(); calcHeight(); calcSpread(); }
  updateResultsPanel(); updateCopyButtons();
}
unitM.onclick=()=>setUnit('m'); unitFt.onclick=()=>setUnit('ft');

function setCalcMode(m){ calcMode=m; const man=m==='manual';
  modeManualBtn.classList.toggle('active',man); modeAutoBtn.classList.toggle('active',!man);
  modeManualBtn.setAttribute('aria-pressed',String(man)); modeAutoBtn.setAttribute('aria-pressed',String(!man));
}
modeManualBtn.onclick=()=>setCalcMode('manual'); modeAutoBtn.onclick=()=>setCalcMode('auto');

/* ====== Tabs ====== */
$$('.tab').forEach(tab=>{
  tab.addEventListener('click', ()=>{
    $$('.tab').forEach(t=>t.classList.remove('active'));
    tab.addClass?.('active') ?? tab.classList.add('active');
    const id = tab.dataset.tab;
    $$('.tabpane').forEach(p=>p.classList.remove('active'));
    $('#pane-' + id).classList.add('active');
    window.scrollTo({top:0,behavior:'smooth'});
  });
});

/* ====== General ====== */
const notesEl = $('#notes');
function autoGrow(el){ el.style.height='auto'; el.style.height=(el.scrollHeight+2)+'px'; }
notesEl.addEventListener('input',()=>autoGrow(notesEl));

/* ====== Circumference: single vs multi ====== */
const treeType=$('#treeType'), singleBlock=$('#single-circ-block'), singleC=$('#singleC');
const singleUpdateBtn = $('#single-update');

const mtBlock=$('#multi-block'), mtList=$('#mt-list'), mtAdd=$('#mt-add'), mtRemove=$('#mt-remove'),
      mtSort=$('#mt-sort'), mtCalc=$('#mt-calc'), mtBulk=$('#mt-bulk'), mtFill=$('#mt-fill'),
      mtClear=$('#mt-clear'), mtResult=$('#mt-result');

function updateTypeVisibility(){
  const t=treeType.value;
  singleBlock.style.display=(t==='Single trunk tree')?'':'none';
  mtBlock.style.display=(t==='Multi trunked tree')?'':'none';
  if (t==='Multi trunked tree' && mtList.children.length===0){ addMtRow(); addMtRow(); }
  updateResultsPanel(); updateCopyButtons();
}
treeType.onchange=updateTypeVisibility;

/* Single trunk */
function recomputeSingle(){
  const v=parseFloat(singleC.value);
  if(Number.isFinite(v)&&v>0){ const cM=toM(v,inputUnit); const dM=cM/PI; lastSingle={cM,cFt:mToFt(cM),dM,dFt:mToFt(dM)}; }
  else lastSingle=null;
  updateResultsPanel(); updateCopyButtons();
}
singleC.addEventListener('input',()=>{ if(calcMode==='auto') recomputeSingle(); });
singleUpdateBtn.addEventListener('click',recomputeSingle);

/* Multi-trunk block (batch) */
let mtCount=0; const MT_MAX=60;

function maybeMtOutlierHint(val,h){
  if(!Number.isFinite(val)||val<=0){h.classList.remove('show');return}
  if(inputUnit==='m'){ if(val<0.20){h.textContent='Unusually small — check units/decimal?';h.classList.add('show');}
    else if(val>12){h.textContent='Unusually large — check units?';h.classList.add('show');} else h.classList.remove('show');}
  else{ if(val<0.66){h.textContent='Unusually small — check units/decimal?';h.classList.add('show');}
    else if(val>40){h.textContent='Unusually large — check units?';h.classList.add('show');} else h.classList.remove('show');}
}

// ---------- Multi-trunk DOM helpers (single source of truth) ----------
function getMtRows(){ return Array.from(mtList.querySelectorAll('.mt-row')); }

function renumberTrunks(){
  const rows = getMtRows();
  rows.forEach((row, i) => {
    const idx = i + 1;
    row.dataset.index = String(idx);

    const lab = row.querySelector('.mt-label');
    const inp = row.querySelector('input[type="number"]');

    if (inp) inp.id = `mt-${idx}`;
    if (lab) {
      lab.htmlFor = `mt-${idx}`;
      lab.textContent = `Trunk ${idx} circumference (${inputUnit})`;
    }
  });
}

function addMtRow(val=''){
  if (getMtRows().length >= MT_MAX) return;

  const row = document.createElement('div');
  row.className = 'row mt-row';
  row.style.gridTemplateColumns = '1fr';

  const top = document.createElement('div');
  top.style.display = 'flex';
  top.style.alignItems = 'center';

  const lab   = document.createElement('label');
  lab.className = 'mt-label';

  const badge = document.createElement('span');
  badge.className = 'badge hide';
  badge.textContent = 'Largest';

  const inp = document.createElement('input');
  inp.type = 'number';
  inp.step = '0.01';
  inp.inputMode = 'decimal';
  if (val !== '') inp.value = val;

  const hint = document.createElement('div');
  hint.className = 'hint';

  top.appendChild(lab);
  top.appendChild(badge);
  row.appendChild(top);
  row.appendChild(inp);
  row.appendChild(hint);
  mtList.appendChild(row);

  // listeners
  inp.addEventListener('input', () => {
    hint.classList.remove('show');
    if (calcMode === 'auto') calcMulti();
  });
  inp.addEventListener('blur', () => maybeMtOutlierHint(parseFloat(inp.value), hint));

  renumberTrunks();
}

function removeMtRow(){
  const rows = getMtRows();
  if (rows.length <= 1) return;
  rows[rows.length - 1].remove();
  clearMtLargest();
  renumberTrunks();
  if (calcMode === 'auto') calcMulti();
}

function parseMtBulk(text,limit=MT_MAX){
  const vals=[]; if(!text) return vals; let s=String(text).replace(/[×X]/g,'x');
  const repRE=/(\d+)\s*x\s*([-+]?\d*\.?\d+)/g;
  s=s.replace(repRE,(_,nStr,vStr)=>{const n=parseInt(nStr,10), v=parseFloat(vStr); if(Number.isFinite(n)&&n>0&&Number.isFinite(v)&&v>0){for(let i=0;i<n&&vals.length<limit;i++) vals.push(v);} return ' ';});
  const singles=s.match(/[-+]?\d*\.?\d+/g)||[];
  for(const m of singles){ if(vals.length>=limit) break; const v=parseFloat(m); if(Number.isFinite(v)&&v>0) vals.push(v); }
  return vals;
}
function mtFillFromBulk(){ const vals=parseMtBulk(mtBulk.value,MT_MAX); if(vals.length===0)return; mtList.innerHTML=''; mtCount=0; vals.forEach(v=>addMtRow(v.toFixed(2))); mtResult.textContent='—'; if(calcMode==='auto') calcMulti(); 
                         renumberTrunks();
                         }
function mtSortByDiameter(){
  // Collect rows into "valid" (has a number) and "invalid" (empty/bad)
  const rows = Array.from(mtList.children);
  const valid = [];
  const invalid = [];

  rows.forEach(row => {
    const inp = row.querySelector('input[type="number"]');
    const v = parseFloat(inp?.value);
    if (Number.isFinite(v) && v > 0) {
      const cM = toM(v, inputUnit);
      const dM = cM / PI;
      valid.push({ row, dM });
    } else {
      invalid.push(row);
    }
  });

  if (valid.length < 2) {
    // not enough to sort—just ensure labels are correct
    renumberTrunks();
    return;
  }

  // Sort by diameter (desc)
  valid.sort((a, b) => b.dM - a.dM);

  // Rebuild DOM: valid rows first (sorted), then invalid
  const frag = document.createDocumentFragment();
  valid.forEach(v => frag.appendChild(v.row));
  invalid.forEach(r => frag.appendChild(r));
  mtList.innerHTML = '';
  mtList.appendChild(frag);

  // Clear any previous "Largest" styling, renumber, and (optionally) recalc
  clearMtLargest();
  renumberTrunks();
  if (calcMode === 'auto') calcMulti();
}

function clearMtLargest(){ mtList.querySelectorAll('.mt-label').forEach(el=>el.classList.remove('largest-label')); mtList.querySelectorAll('.badge').forEach(b=>{b.classList.add('hide'); b.textContent='Largest';}); }
function calcMulti(){
  clearMtLargest();
  const items=Array.from(mtList.querySelectorAll('input'));
  const valid=items.map(inp=>({inp,val:parseFloat(inp.value),row:inp.closest('.row')})).filter(o=>Number.isFinite(o.val)&&o.val>0);
  if(valid.length===0){ lastMulti=null; mtResult.textContent='Enter at least one trunk circumference.'; updateResultsPanel(); updateCopyButtons(); return; }
  const withD=valid.map((r,i)=>{const cM=toM(r.val,inputUnit); const dM=cM/PI; return {row:r.row,cM,dM,idx:i+1};});
  const eps=1e-9; const dmax=Math.max(...withD.map(x=>x.dM)); const maxRows=withD.filter(x=>Math.abs(x.dM-dmax)<eps); const sumAll=withD.reduce((a,x)=>a+x.dM,0);
  const dEqM=dmax+0.5*(sumAll-dmax); const cEqM=dEqM*PI; const cAvgM=withD.reduce((a,x)=>a+x.cM,0)/withD.length;
  const badgeText=(maxRows.length>1)?'Tied for largest':'Largest';
  maxRows.forEach(r=>{const lab=r.row.querySelector('.mt-label'); const badge=r.row.querySelector('.badge'); lab?.classList.add('largest-label'); if(badge){badge.textContent=badgeText; badge.classList.remove('hide');}});
  lastMulti={ trunks:withD.map(t=>({index:t.idx,cM:t.cM,cFt:mToFt(t.cM),dM:t.dM,dFt:mToFt(t.dM),isLargest:Math.abs(t.dM-dmax)<eps})), dEqM,cEqM,dEqFt:mToFt(dEqM),cEqFt:mToFt(cEqM), cAvgM,cAvgFt:mToFt(cAvgM), tie:maxRows.length>1 };
  mtResult.textContent=`Calculated ${withD.length} trunk${withD.length>1?'s':''}.`;
  updateResultsPanel(); updateCopyButtons();
}
mtAdd.onclick=()=>addMtRow();
mtRemove.onclick=()=>removeMtRow();
mtSort.onclick=mtSortByDiameter;
mtCalc.onclick=calcMulti;
mtFill.onclick=mtFillFromBulk;
mtClear.onclick=()=>{ mtBulk.value=''; };

/* ====== Height ====== */
const hAngle=$('#h-angle'), hDist=$('#h-dist'), hEye=$('#h-eye'), hCalc=$('#h-calc');
function calcHeight(){
  const a=parseFloat(hAngle.value), d=parseFloat(hDist.value), e=parseFloat(hEye.value);
  if(!Number.isFinite(a)||!Number.isFinite(d)||!Number.isFinite(e)){ lastHeight=null; updateResultsPanel(); updateCopyButtons(); return; }
  const dM=toM(d,inputUnit), eM=toM(e,inputUnit); const hM=tanDeg(a)*dM+eM;
  lastHeight={hM,hFt:mToFt(hM),angleDeg:Number(a.toFixed(1)),dM,eM};
  updateResultsPanel(); updateCopyButtons();
}
hCalc.onclick=calcHeight;
[hAngle,hDist,hEye].forEach(inp=>inp.addEventListener('input',()=>{ if(calcMode==='auto') calcHeight();}));

/* ====== Clinometer ====== */
let clinoOn = false, zeroOffsetRad = 0, locked=false;
// Clinometer DOM refs (safe)
const elEnable = document.querySelector('#clino-enable') || null;
const elDisable = document.querySelector('#clino-disable') || null;
const elAngle  = document.querySelector('#clino-angle')  || null;
const elLock   = document.querySelector('#clino-lock')   || null;
const elZero   = document.querySelector('#clino-zero')   || null;
const elReset  = document.querySelector('#clino-reset')  || null; // ensures it's defined
const elStatus = document.querySelector('#clino-status') || null;
  const toDeg=rad=>rad*180/Math.PI, clamp=(x,a,b)=>Math.min(b,Math.max(a,x));
function buzz(ms=30){ if(navigator.vibrate) try{navigator.vibrate(ms);}catch{} }
async function requestIOSPermissionIfNeeded(){
  const any=window.DeviceOrientationEvent; if(!any) return true;
  if(typeof any.requestPermission==='function'){ try{ const res=await any.requestPermission(); return res==='granted'; }catch{ return false; } }
  return true;
}
function computePitchFromEvent(ev){ const beta=typeof ev.beta==='number'?ev.beta:0; const rad=(beta*Math.PI/180)-zeroOffsetRad; return clamp(toDeg(rad),-89.9,89.9); }
let onOrientation=null;
function startClinometer(){
  if(clinoOn) return; clinoOn=true; elStatus.textContent='Sensor: running';
  elEnable.classList.add('active'); elDisable.classList.remove('active');
  requestIOSPermissionIfNeeded().then(ok=>{
    if(!ok){ elStatus.textContent='Sensor: permission denied'; clinoOn=false; return; }
    onOrientation=(ev)=>{ if(!clinoOn||locked) return; const deg=computePitchFromEvent(ev); elAngle.textContent=`${fmt1(deg)}°`; };
    window.addEventListener('deviceorientation', onOrientation, {passive:true});
  });
}
function stopClinometer(){
  if(!clinoOn) return; clinoOn=false; elEnable.classList.remove('active'); elDisable.classList.add('active');
  elStatus.textContent='Sensor: stopped'; if(onOrientation){ window.removeEventListener('deviceorientation', onOrientation); onOrientation=null; }
}
function lockAngle(){
  // Toggle lock; when locking, write current angle to the input field
  if(!locked){
    locked=true; elLock.textContent='Locked'; elLock.classList.add('active'); buzz(40);
    const txt=elAngle.textContent.replace('°',''); const current=parseFloat(txt);
    if(Number.isFinite(current)){ hAngle.value=current.toFixed(1); if(calcMode==='auto') calcHeight(); }
  } else {
    locked=false; elLock.textContent='Lock'; elLock.classList.remove('active');
  }
}
function zeroCalibrate(){ const txt=elAngle.textContent.replace('°',''); const current=parseFloat(txt); if(!Number.isFinite(current)) return; zeroOffsetRad += (current*Math.PI/180); elStatus.textContent='Zeroed at current angle'; buzz(20); }
function resetSensor(){ locked=false; elLock.textContent='Lock'; elLock.classList.remove('active'); zeroOffsetRad=0; elAngle.textContent='—°'; elStatus.textContent='Sensor: idle'; buzz(10); }
elEnable?.addEventListener('click', startClinometer);
elDisable?.addEventListener('click', stopClinometer);
elLock?.addEventListener('click', lockAngle);
elZero?.addEventListener('click', zeroCalibrate);
elReset?.addEventListener('click', resetSensor);
document.addEventListener('visibilitychange', ()=>{ if(document.hidden) stopClinometer(); });

/* ====== Canopy ====== */
const spreadMajor=$('#spreadMajor'), spreadMinor=$('#spreadMinor'), spreadCalc=$('#spread-calc');
function calcSpread(){
  const maj=parseFloat(spreadMajor.value), min=parseFloat(spreadMinor.value);
  const haveMaj=Number.isFinite(maj), haveMin=Number.isFinite(min);
  if(!haveMaj && !haveMin){ lastSpread=null; updateResultsPanel(); updateCopyButtons(); return; }
  const mMaj=haveMaj?toM(maj,inputUnit):null, mMin=haveMin?toM(min,inputUnit):null;
  const meanM=((mMaj??0)+(mMin??0))/((haveMaj?1:0)+(haveMin?1:0));
  lastSpread={majorM:mMaj,minorM:mMin,meanM,meanFt:mToFt(meanM)};
  updateResultsPanel(); updateCopyButtons();
}
spreadCalc.onclick=calcSpread;
[spreadMajor,spreadMinor].forEach(inp=>inp.addEventListener('input',()=>{ if(calcMode==='auto') calcSpread(); }));

/* ====== Results & Quick Copy ====== */
const resHeight=$('#res-height'), resEqCirc=$('#res-eqcirc'), resAvgCirc=$('#res-avgcirc'), resSpread=$('#res-spread');
function updateResultsPanel(){
  resHeight.textContent = lastHeight ? `Height: ${fmt2(lastHeight.hM)} m (${fmt2(lastHeight.hFt)} ft)` : 'Height: —';
  const t=treeType.value;
  if(t==='Multi trunked tree' && lastMulti){
    resEqCirc.textContent=`Equivalent circumference: ${fmt2(lastMulti.cEqM)} m (${fmt2(lastMulti.cEqFt)} ft)`;
    resAvgCirc.style.display=''; resAvgCirc.textContent=`Average circumference (multi): ${fmt2(lastMulti.cAvgM)} m (${fmt2(lastMulti.cAvgFt)} ft)`;
  } else if(t==='Single trunk tree' && lastSingle){
    resEqCirc.textContent=`Entered circumference: ${fmt2(lastSingle.cM)} m (${fmt2(lastSingle.cFt)} ft)`;
    resAvgCirc.style.display='none'; resAvgCirc.textContent='Average circumference (multi): —';
  } else {
    resEqCirc.textContent='Equivalent / Entered circumference: —';
    resAvgCirc.style.display=(t==='Multi trunked tree')?'':'none';
    resAvgCirc.textContent='Average circumference (multi): —';
  }
  resSpread.textContent = lastSpread ? `Final canopy spread: ${fmt2(lastSpread.meanM)} m (${fmt2(lastSpread.meanFt)} ft)` : 'Final canopy spread: —';
}
const copyHeight=$('#copyHeight'), copyEqCirc=$('#copyEqCirc'), copyAvgCirc=$('#copyAvgCirc'), copySpread=$('#copySpread');
function updateCopyButtons(){
  copyHeight.disabled=!(lastHeight&&Number.isFinite(lastHeight.hM));
  if(treeType.value==='Multi trunked tree'){ copyEqCirc.disabled=!(lastMulti&&Number.isFinite(lastMulti.cEqM)); copyAvgCirc.disabled=!(lastMulti&&Number.isFinite(lastMulti.cAvgM)); }
  else if(treeType.value==='Single trunk tree'){ copyEqCirc.disabled=!(lastSingle&&Number.isFinite(lastSingle.cM)); copyAvgCirc.disabled=true; }
  else { copyEqCirc.disabled=true; copyAvgCirc.disabled=true; }
  copySpread.disabled=!(lastSpread&&Number.isFinite(lastSpread.meanM));
}
async function copyText(txt,btn){
  try{ await navigator.clipboard.writeText(txt); const o=btn.textContent; btn.textContent='Copied ✓'; setTimeout(()=>btn.textContent=o,1200); }
  catch{ const t=document.createElement('input'); t.value=txt; document.body.appendChild(t); t.select(); document.execCommand('copy'); t.remove(); const o=btn.textContent; btn.textContent='Copied ✓'; setTimeout(()=>btn.textContent=o,1200); }
}
copyHeight.onclick=()=>{ if(lastHeight) copyText(fmt2(lastHeight.hM),copyHeight); };
copyEqCirc.onclick=()=>{ const t=treeType.value; if(t==='Multi trunked tree'&&lastMulti) copyText(fmt2(lastMulti.cEqM),copyEqCirc); if(t==='Single trunk tree'&&lastSingle) copyText(fmt2(lastSingle.cM),copyEqCirc); };
copyAvgCirc.onclick=()=>{ if(lastMulti) copyText(fmt2(lastMulti.cAvgM),copyAvgCirc); };
copySpread.onclick=()=>{ if(lastSpread) copyText(fmt2(lastSpread.meanM),copySpread); };

/* ====== Description / Email / Share ====== */
const treeNameInput=$('#treeName'), species=$('#species'), condition=$('#condition');
const descBox=$('#desc'), genDesc=$('#genDesc'), copyDesc=$('#copyDesc'), shareBtn=$('#shareLink'), emailBtn=$('#emailBtn');

function ensureOnDemand(){
  if(treeType.value==='Multi trunked tree'){ const any=$$('#mt-list input').some(i=>Number.isFinite(parseFloat(i.value))); if(any && !lastMulti) calcMulti(); }
  const a=parseFloat(hAngle.value), d=parseFloat(hDist.value), e=parseFloat(hEye.value); if(Number.isFinite(a)&&Number.isFinite(d)&&Number.isFinite(e)&&!lastHeight) calcHeight();
  if(!lastSpread && (Number.isFinite(parseFloat(spreadMajor.value))||Number.isFinite(parseFloat(spreadMinor.value)))) calcSpread();
  if(treeType.value==='Single trunk tree' && !lastSingle && Number.isFinite(parseFloat(singleC.value))) recomputeSingle();
}
function buildDescription(){
  const parts=[]; const name=treeNameInput.value?.trim(), sp=species.value?.trim(), cond=condition.value?.trim(), type=treeType.value?.trim();
  const head=document.createElement('div');
  if(name) head.innerHTML+=`<p><strong>Tree</strong>: ${escapeHtml(name)}</p>`;
  if(sp)   head.innerHTML+=`<p><strong>Species</strong>: ${escapeHtml(sp)}</p>`;
  if(cond) head.innerHTML+=`<p><strong>Condition</strong>: ${escapeHtml(cond)}</p>`;
  if(type) head.innerHTML+=`<p><strong>Type</strong>: ${escapeHtml(type)}</p>`;
  if(head.innerHTML) parts.push(head);

  const meas=document.createElement('div'); let has=false;

  if(type==='Single trunk tree' && lastSingle){
    has=true;
    const p1=document.createElement('p'); p1.innerHTML='<strong>Measurements</strong>';
    const ul=document.createElement('ul');
    const li=document.createElement('li');
    li.textContent=`Circumference: ${fmt2(lastSingle.cM)} m (${fmt2(lastSingle.cFt)} ft) → Diameter: ${fmt2(lastSingle.dM)} m (${fmt2(lastSingle.dFt)} ft)`;
    ul.appendChild(li); meas.appendChild(p1); meas.appendChild(ul);
  }

  if(type==='Multi trunked tree' && lastMulti){
    has=true;
    const p1=document.createElement('p'); p1.innerHTML='<strong>Individual trunks (circumference → diameter)</strong>';
    const ul1=document.createElement('ul');
    lastMulti.trunks.forEach(t=>{
      const txt=`T${t.index}: ${fmt2(t.cM)} m (${fmt2(t.cFt)} ft) → ${fmt2(t.dM)} m (${fmt2(t.dFt)} ft)`;
      const li=document.createElement('li');
      if(t.isLargest){ li.innerHTML=`<strong>${txt}</strong>`; } else { li.textContent=txt; }
      ul1.appendChild(li);
    });
    const p2=document.createElement('p'); p2.innerHTML='<strong>Full Tree Circumference (circumference → diameter)</strong>';
    const ul2=document.createElement('ul');
    const liC=document.createElement('li'); liC.textContent=`Equivalent circumference: ${fmt2(lastMulti.cEqM)} m (${fmt2(lastMulti.cEqFt)} ft) → ${fmt2(lastMulti.dEqM)} m (${fmt2(lastMulti.dEqFt)} ft)`;
    const dAvgM=lastMulti.cAvgM/PI, dAvgFt=mToFt(dAvgM);
    const liA=document.createElement('li'); liA.textContent=`Average circumference: ${fmt2(lastMulti.cAvgM)} m (${fmt2(lastMulti.cAvgFt)} ft) → ${fmt2(dAvgM)} m (${fmt2(dAvgFt)} ft)`;
    ul2.appendChild(liC); ul2.appendChild(liA);
    meas.appendChild(p1); meas.appendChild(ul1); meas.appendChild(p2); meas.appendChild(ul2);
  }

  if(lastHeight){
    has=true;
    const p=document.createElement('p'); p.innerHTML='<strong>Height</strong>';
    const ul=document.createElement('ul');
    const liH=document.createElement('li'); liH.textContent=`Tree height: ${fmt2(lastHeight.hM)} m (${fmt2(lastHeight.hFt)} ft)`;
    const liF=document.createElement('li'); liF.textContent=`height = tan(${fmt1(lastHeight.angleDeg)}°) × ${fmt2(lastHeight.dM)} m + ${fmt2(lastHeight.eM)} m = ${fmt2(lastHeight.hM)} m (${fmt2(lastHeight.hFt)} ft)`;
    ul.appendChild(liH); ul.appendChild(liF); meas.appendChild(p); meas.appendChild(ul);
  }

  if(lastSpread){
    has=true;
    const p=document.createElement('p'); p.innerHTML='<strong>Canopy spread</strong>';
    const ul=document.createElement('ul');
    if(Number.isFinite(lastSpread.majorM)){ const li=document.createElement('li'); li.textContent=`Major: ${fmt2(lastSpread.majorM)} m (${fmt2(mToFt(lastSpread.majorM))} ft)`; ul.appendChild(li); }
    if(Number.isFinite(lastSpread.minorM)){ const li=document.createElement('li'); li.textContent=`Minor: ${fmt2(lastSpread.minorM)} m (${fmt2(mToFt(lastSpread.minorM))} ft)`; ul.appendChild(li); }
    const liMean=document.createElement('li'); liMean.innerHTML=`<strong>Final canopy spread: ${fmt2(lastSpread.meanM)} m (${fmt2(lastSpread.meanFt)} ft)</strong>`; ul.appendChild(liMean);
    meas.appendChild(p); meas.appendChild(ul);
  }

  if(has) parts.push(meas);

  const nTxt=notesEl.value.trim();
  if(nTxt){
    const n=document.createElement('div');
    n.innerHTML='<p><strong>Notes</strong></p>';
    const ul=document.createElement('ul');
    nTxt.split(/\n+/).forEach(line=>{ const li=document.createElement('li'); li.textContent=line; ul.appendChild(li); });
    n.appendChild(ul); parts.push(n);
  }

// ---- Location section (if saved) ----
const latIn = parseFloat(document.querySelector('#lat')?.value);
const lngIn = parseFloat(document.querySelector('#lng')?.value);
if (Number.isFinite(latIn) && Number.isFinite(lngIn)) {
  const accIn = parseFloat(document.querySelector('#acc')?.value);
  const altSavedEl = document.querySelector('#loc-saved-alt');
  const tsSavedEl  = document.querySelector('#loc-saved-ts');

  const altSaved = altSavedEl?.dataset?.val ? parseFloat(altSavedEl.dataset.val) : NaN;
  const tsSaved  = tsSavedEl?.dataset?.ts ? parseInt(tsSavedEl.dataset.ts, 10) : NaN;

  const locWhen = Number.isFinite(tsSaved)
    ? new Date(tsSaved).toLocaleString()
    : nowLocal24();

  const loc = document.createElement('div');
  loc.innerHTML = '<p><strong>Location</strong></p>';
  const ul = document.createElement('ul');

  const li1 = document.createElement('li');
  li1.textContent = `DD: ${latIn.toFixed(6)}, ${lngIn.toFixed(6)}`;
  ul.appendChild(li1);

  const li2 = document.createElement('li');
  li2.textContent = `DMS: ${toDMS(latIn, true)}  |  ${toDMS(lngIn, false)}`;
  ul.appendChild(li2);

  const li3 = document.createElement('li');
  li3.textContent = `Altitude: ${Number.isFinite(altSaved) ? altSaved.toFixed(1) + ' m' : '—'}`;
  ul.appendChild(li3);

  const li4 = document.createElement('li');
  li4.textContent = `Accuracy: ${Number.isFinite(accIn) ? '±' + accIn.toFixed(1) + ' m' : '±—'}`;
  ul.appendChild(li4);

  const li5 = document.createElement('li');
  li5.textContent = `Recorded: ${locWhen}`;
  ul.appendChild(li5);

  loc.appendChild(ul);
  parts.push(loc);
}

  
  const obs=document.createElement('div');
  obs.innerHTML=`<p><strong>Observation</strong></p><ul><li>Recorded: ${nowLocal24()}</li></ul>`;
  parts.push(obs);

  const out=document.createElement('div'); parts.forEach(p=>out.appendChild(p)); return out.innerHTML;
}
function extractPlainText(container){
  const items=Array.from(container.querySelectorAll('li')).map(li=>`- ${li.innerText}`);
  const paras=Array.from(container.querySelectorAll('p')).map(p=>p.innerText);
  return [...paras,...items].join('\n').trim();
}
function generateDescription(){
  ensureOnDemand();
  const html=buildDescription(); descBox.innerHTML=html||'—'; copyDesc.disabled=!html; shareBtn.disabled=!html;
  if(html){
    const text=extractPlainText(descBox); const nm=$('#treeName').value?.trim();
    const subject=`ARA Field Nomination${nm?' – '+nm:''}`;
    emailBtn.href=`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(text)}`;
    emailBtn.removeAttribute('aria-disabled');
  } else { emailBtn.setAttribute('aria-disabled','true'); emailBtn.href='#'; }
  saveState();
}
$('#genDesc').onclick=generateDescription;

$('#copyDesc').onclick=async ()=>{ const html=descBox.innerHTML.trim(); if(!html||html==='—') return; const text=extractPlainText(descBox);
  if(navigator.clipboard && window.ClipboardItem){ try{
    await navigator.clipboard.write([new ClipboardItem({'text/html':new Blob([html],{type:'text/html'}),'text/plain':new Blob([text],{type:'text/plain'})})]);
    const o=$('#copyDesc').textContent; $('#copyDesc').textContent='Copied ✓'; setTimeout(()=>$('#copyDesc').textContent=o,1200); return;
  }catch{} }
  const tmp=document.createElement('div'); tmp.contentEditable='true'; tmp.style.position='fixed'; tmp.style.left='-9999px'; tmp.innerHTML=html; document.body.appendChild(tmp);
  const r=document.createRange(); r.selectNodeContents(tmp); const s=window.getSelection(); s.removeAllRanges(); s.addRange(r); document.execCommand('copy'); s.removeAllRanges(); tmp.remove();
  const o=$('#copyDesc').textContent; $('#copyDesc').textContent='Copied ✓'; setTimeout(()=>$('#copyDesc').textContent=o,1200);
};





// ------- Location Tracker (compact, no sparkline) -------
(() => {
  const el = s => document.querySelector(s);

  // Controls
  const bToggle = el('#loc-toggle');   // single Start/Stop button
  const tHiAcc  = el('#loc-hiacc');
  const tSaver  = el('#loc-saver');

  // Recent readouts
  const outDD   = el('#loc-recent-dd');
  const outAcc  = el('#loc-recent-acc');
  const outAlt  = el('#loc-recent-alt');
  const outAge  = el('#loc-recent-age');
  const outCnt  = el('#loc-samples');

  // Best readouts
  const bestDD    = el('#loc-best-dd');
  const bestAcc   = el('#loc-best-acc');
  const bestAlt   = el('#loc-best-alt');
  const bestTime  = el('#loc-best-time');
  const bestBadge = el('#loc-best-badge');

  // Action buttons
  const bUseRecent = el('#loc-use-recent');
  const bUseBest   = el('#loc-use-best');
  const bReset     = el('#loc-reset');

  // Hidden storage (keeps your description logic working)
  const latEl = el('#lat'), lngEl = el('#lng'), accEl = el('#acc');
  const savedAlt = el('#loc-saved-alt');
  const savedTs  = el('#loc-saved-ts');

  // State
  let watchId = null;
  let saver = false;
  let hiacc = false;
  let lastTick = 0;
  let samples = 0;
  let recent = null;         // {lat,lng,acc,alt,ts}
  let best = null;           // minimal acc
  let ageTimer = null;

  // Utilities
  const fmt6 = v => Number.isFinite(v) ? v.toFixed(6) : '—';
  const fmt1 = v => Number.isFinite(v) ? v.toFixed(1) : '—';
  const accClass = m =>
    !Number.isFinite(m) ? 'acc-grey' :
    m >= 20 ? 'acc-grey' : (m > 5 ? 'acc-amber' : 'acc-green');

  function setRunningUI(running){
    if (running){
      bToggle.textContent = 'Stop tracking';
      bToggle.classList.add('running');
    } else {
      bToggle.textContent = 'Start tracking';
      bToggle.classList.remove('running');
    }
  }

  function updateRecentUI() {
    if (recent){
      outDD.textContent  = `DD: ${fmt6(recent.lat)}, ${fmt6(recent.lng)}`;
      outAcc.textContent = `${fmt1(recent.acc)} m`;
      outAcc.className   = `acc-chip ${accClass(recent.acc)}`;
      outAlt.textContent = Number.isFinite(recent.alt) ? `${fmt1(recent.alt)} m` : '—';

      if (ageTimer) clearInterval(ageTimer);
      ageTimer = setInterval(() => {
        const secs = Math.max(0, (Date.now() - recent.ts)/1000);
        outAge.textContent = `${secs.toFixed(1)} s`;
      }, 200);

      bUseRecent.disabled = false;
    } else {
      outDD.textContent  = 'DD: —';
      outAcc.textContent = '—';
      outAcc.className   = 'acc-chip acc-grey';
      outAlt.textContent = '—';
      outAge.textContent = '—';
      bUseRecent.disabled = true;
    }
    outCnt.textContent = String(samples);
  }

  function updateBestUI(isNew=false) {
    if (best){
      bestDD.textContent  = `DD: ${fmt6(best.lat)}, ${fmt6(best.lng)}`;
      bestAcc.textContent = `${fmt1(best.acc)} m`;
      bestAcc.className   = `acc-chip ${accClass(best.acc)}`;
      bestAlt.textContent = Number.isFinite(best.alt) ? `${fmt1(best.alt)} m` : '—';
      bestAlt.dataset.val = Number.isFinite(best.alt) ? String(best.alt) : '';
      bestTime.textContent= new Date(best.ts).toLocaleString();
      bestTime.dataset.ts = String(best.ts);
      bUseBest.disabled = false;
    } else {
      bestDD.textContent  = 'DD: —';
      bestAcc.textContent = '—';
      bestAcc.className   = 'acc-chip acc-grey';
      bestAlt.textContent = '—';
      bestAlt.dataset.val = '';
      bestTime.textContent= '—';
      bestTime.dataset.ts = '';
      bUseBest.disabled = true;
    }
    bestBadge.style.display = isNew ? '' : 'none';
    if (isNew) setTimeout(()=>bestBadge.style.display='none', 1200);
  }

  function handlePosition(pos) {
    const c = pos.coords;
    const now = Date.now();
    if (saver && now - lastTick < 1500) return; // throttle in saver mode
    lastTick = now;

    const fix = {
      lat: c.latitude,
      lng: c.longitude,
      acc: c.accuracy,
      alt: Number.isFinite(c.altitude) ? c.altitude : null,
      ts: now
    };
    samples++;
    recent = fix;
    updateRecentUI();

    if (!best || (Number.isFinite(fix.acc) && fix.acc < best.acc)) {
      best = {...fix};
      updateBestUI(true);
    }
  }

  function handleError(err) {
    console.warn('Geolocation error', err);
    // User can try again or just save what they have
  }

  function start() {
    if (watchId != null) return;
    const opts = { enableHighAccuracy: hiacc, maximumAge: 0, timeout: 20000 };
    watchId = (navigator.geolocation && navigator.geolocation.watchPosition)
      ? navigator.geolocation.watchPosition(handlePosition, handleError, opts)
      : null;
    setRunningUI(true);
  }

  function stop() {
    if (watchId != null && navigator.geolocation && navigator.geolocation.clearWatch) {
      navigator.geolocation.clearWatch(watchId);
    }
    watchId = null;
    setRunningUI(false);
  }

  function resetAll() {
    stop();
    samples = 0;
    recent = null; best = null;
    if (ageTimer) { clearInterval(ageTimer); ageTimer=null; }
    updateRecentUI(); updateBestUI(false);
  }

  function applyFixToHidden(fix){
    if (!fix) return;
    latEl.value = fix.lat.toFixed(6);
    lngEl.value = fix.lng.toFixed(6);
    accEl.value = Number.isFinite(fix.acc) ? fix.acc.toFixed(1) : '';
    savedAlt.dataset.val = Number.isFinite(fix.alt) ? String(fix.alt) : '';
    savedTs.dataset.ts   = String(fix.ts || Date.now());
    if (typeof saveState === 'function') saveState();
  }

  // Wire up controls
  bToggle.addEventListener('click', () => {
    if (watchId == null) start(); else stop();
  });

  tSaver.addEventListener('click', () => {
    saver = !saver;
    tSaver.classList.toggle('active', saver);
    tSaver.setAttribute('aria-pressed', String(saver));
  });

  tHiAcc.addEventListener('click', () => {
    hiacc = !hiacc;
    tHiAcc.classList.toggle('active', hiacc);
    tHiAcc.setAttribute('aria-pressed', String(hiacc));
    if (watchId != null) { stop(); start(); }
  });

  bUseRecent.addEventListener('click', () => applyFixToHidden(recent));
  bUseBest  .addEventListener('click', () => applyFixToHidden(best));
  bReset    .addEventListener('click', resetAll);

  // Initialize UI
  setRunningUI(false);
  updateRecentUI();
  updateBestUI(false);
})();

// ===== Autosave core (place above the debounced listeners) =====
const SAVE_KEY = 'ara_field_v1';

function getFormState(){
  return {
    // unit/mode
    inputUnit,
    calcMode,
    // basics
    basics: {
      name:      $('#treeName')?.value || '',
      species:   $('#species')?.value || '',
      condition: $('#condition')?.value || '',
      type:      $('#treeType')?.value || ''
    },
    // circumference
    singleC: $('#singleC')?.value || '',
    multi:   { values: $$('#mt-list input[type="number"]').map(i=>i.value || '') },
    // height
    height: {
      angle: $('#h-angle')?.value || '',
      dist:  $('#h-dist')?.value  || '',
      eye:   $('#h-eye')?.value   || ''
    },
    // canopy
    spread: {
      major: $('#spreadMajor')?.value || '',
      minor: $('#spreadMinor')?.value || ''
    },
    // notes
    notes: $('#notes')?.value || '',
    // location (hidden fields populated by “Save recent/best”)
    location: {
      lat: $('#lat')?.value || '',
      lng: $('#lng')?.value || '',
      acc: $('#acc')?.value || '',
      alt: $('#loc-saved-alt')?.dataset?.val || '',
      ts:  $('#loc-saved-ts')?.dataset?.ts  || ''
    },
    // description html
    desc: ($('#desc')?.innerHTML && $('#desc').innerHTML !== '—') ? $('#desc').innerHTML : ''
  };
}

function setFormState(st){
  if(!st) return;

  // unit & mode
  if(st.inputUnit && st.inputUnit !== inputUnit) setUnit(st.inputUnit);
  if(st.calcMode  && st.calcMode  !== calcMode)  setCalcMode(st.calcMode);

  // basics
  if($('#treeName'))  $('#treeName').value  = st.basics?.name ?? '';
  if($('#species'))   $('#species').value   = st.basics?.species ?? '';
  if($('#condition')) $('#condition').value = st.basics?.condition ?? '';
  if($('#treeType'))  $('#treeType').value  = st.basics?.type ?? '';
  updateTypeVisibility();

  // circumference
  if($('#singleC')) $('#singleC').value = st.singleC ?? '';
  if($('#mt-list')){
    const list = $('#mt-list');
    list.innerHTML = '';
    let count = 0;
    const vals = Array.isArray(st.multi?.values) ? st.multi.values : [];
    if(vals.length){
      vals.forEach(v => { addMtRow(v); count++; });
    }
    if(count === 0){ addMtRow(); addMtRow(); }
  }

  // height
  if($('#h-angle')) $('#h-angle').value = st.height?.angle ?? '';
  if($('#h-dist'))  $('#h-dist').value  = st.height?.dist  ?? '';
  if($('#h-eye'))   $('#h-eye').value   = st.height?.eye   ?? '';

  // canopy
  if($('#spreadMajor')) $('#spreadMajor').value = st.spread?.major ?? '';
  if($('#spreadMinor')) $('#spreadMinor').value = st.spread?.minor ?? '';

  // notes
  if($('#notes')) { $('#notes').value = st.notes ?? ''; autoGrow($('#notes')); }

  // location
  if(st.location){
    if($('#lat')) $('#lat').value = st.location.lat || '';
    if($('#lng')) $('#lng').value = st.location.lng || '';
    if($('#acc')) $('#acc').value = st.location.acc || '';
    if($('#loc-saved-alt')) $('#loc-saved-alt').dataset.val = st.location.alt || '';
    if($('#loc-saved-ts'))  $('#loc-saved-ts').dataset.ts  = st.location.ts  || '';
  }

  // description
  if($('#desc')){
    if(st.desc){ $('#desc').innerHTML = st.desc; $('#copyDesc')?.removeAttribute('disabled'); $('#shareLink')?.removeAttribute('disabled'); }
    else { $('#desc').innerHTML = '—'; $('#copyDesc')?.setAttribute('disabled', ''); $('#shareLink')?.setAttribute('disabled', ''); }
  }

  // refresh computed UI
  updateResultsPanel();
  updateCopyButtons();
}

function saveState(){
  try{
    localStorage.setItem(SAVE_KEY, JSON.stringify(getFormState()));
  }catch(e){ console.warn('saveState failed', e); }
}

function loadState(){
  try{
    const raw = localStorage.getItem(SAVE_KEY);
    if(!raw){
      // First load: ensure multi has 2 rows if needed
      if($('#treeType')?.value === 'Multi trunked tree' && $('#mt-list')?.children.length === 0){
        addMtRow(); addMtRow();
      }
      return;
    }
    const st = JSON.parse(raw);
    setFormState(st);
  }catch(e){ console.warn('loadState failed', e); }
}
  
// Debounced autosave for any field change
let _asTimer = null;

function autoSaveSoon(){
  if (_asTimer) clearTimeout(_asTimer);
  _asTimer = setTimeout(() => {
    if (!window.ARA_RESETTING) {
      try { saveState(); } catch {}
    }
  }, 250);
}

document.addEventListener('input',  autoSaveSoon, {capture:true});
document.addEventListener('change', autoSaveSoon, {capture:true});
window.addEventListener('beforeunload', () => {
  if (!window.ARA_RESETTING) {
    try { saveState(); } catch {}
  }
});

// hydrate form on load
loadState();
  
// --- Reset Form Button (Results tab) ---
const resetFormResults = $('#resetFormResults');
if (resetFormResults){
  resetFormResults.onclick = () => {
    // 1) Tell autosave to back off
    window.ARA_RESETTING = true;

    // 2) Stop any queued autosave timers
    if (typeof _asTimer !== 'undefined' && _asTimer) {
      clearTimeout(_asTimer);
    }

    // 3) Keep current measurement unit + mode
    try {
      localStorage.setItem(SAVE_KEY, JSON.stringify({ inputUnit, calcMode }));
    } catch {}

    // 4) Reload cleanly (no history restore)
    location.replace(location.href);
  };
}
// === ARA safe autosave + reset shim (drop-in, non-destructive) ===
(function(){
  // Keep existing flag if present
  window.ARA_RESETTING = !!window.ARA_RESETTING;

  // Fallback for $ if not already defined
  const $ = window.$ || (s => document.querySelector(s));

  // Use existing SAVE_KEY if defined
  const SAVE_KEY = window.SAVE_KEY || 'ara_field_v1';

  // Install autosave listeners once (guarded)
  if (!window.__ARA_AUTOSAVE_INSTALLED__) {
    window.__ARA_AUTOSAVE_INSTALLED__ = true;

    let _asTimer = null;
    function autoSaveSoon(){
      if (_asTimer) clearTimeout(_asTimer);
      _asTimer = setTimeout(() => {
        if (!window.ARA_RESETTING && typeof window.saveState === 'function') {
          try { window.saveState(); } catch {}
        }
      }, 250);
    }

    // Global input/change autosave
    document.addEventListener('input',  autoSaveSoon, {capture:true});
    document.addEventListener('change', autoSaveSoon, {capture:true});

    // Save on navigate away (unless resetting)
    window.addEventListener('beforeunload', () => {
      if (!window.ARA_RESETTING && typeof window.saveState === 'function') {
        try { window.saveState(); } catch {}
      }
    });

    // Hydrate on load if you have loadState()
    if (typeof window.loadState === 'function') {
      try { window.loadState(); } catch {}
    }

    // Expose timer so reset can cancel it
    window.__ARA_AS_TIMER__ = _asTimer;
  }

  // Wire Reset Form button safely (once)
  const resetBtn = $('#resetFormResults');
  if (resetBtn && !resetBtn.__wired) {
    resetBtn.__wired = true;
    resetBtn.addEventListener('click', () => {
      // 1) Tell autosave to back off
      window.ARA_RESETTING = true;

      // 2) Kill any pending debounced save
      if (window.__ARA_AS_TIMER__) {
        clearTimeout(window.__ARA_AS_TIMER__);
        window.__ARA_AS_TIMER__ = null;
      }

      // 3) Preserve unit/mode if available
      try {
        const unit = window.inputUnit || 'm';
        const mode = window.calcMode || 'manual';
        localStorage.setItem(SAVE_KEY, JSON.stringify({ inputUnit: unit, calcMode: mode }));
      } catch {}

      // 4) Hard reload without bfcache history restore
      location.replace(location.href);
    });
  }
})();

</script>
</body>
</html>
