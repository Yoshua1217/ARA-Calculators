<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ARA Field Tools – Field notes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root{
      --bg-main:#020b16;
      --bg-card:#071727;
      --bg-card-soft:#0b2235;
      --border-soft:#12263a;
      --text-main:#e5edf7;
      --text-muted:#9caac3;
      --accent:#3b82f6;
      --accent-soft:#60a5fa;
      --danger:#b91c1c;
      --danger-soft:#f97373;
      --chip-bg:#0e2436;
      --shadow-card:0 14px 35px rgba(0,0,0,0.45);
      --radius-card:18px;
    }

    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg-main);
      color:var(--text-main);
      -webkit-font-smoothing:antialiased;
    }

    .app-shell{
      max-width: 720px;
      margin: 0 auto;
      padding: 12px 12px 32px;
    }

    .app-header{
      padding: 8px 4px 12px;
    }
    .app-title{
      font-weight: 650;
      font-size: 1.15rem;
    }
    .app-subtitle{
      font-size:0.85rem;
      color:var(--text-muted);
      margin-top:2px;
    }

    .card{
      background:var(--bg-card);
      border-radius:var(--radius-card);
      box-shadow:var(--shadow-card);
      border:1px solid var(--border-soft);
      padding:16px 14px 14px;
      margin-top:14px;
    }
    .card-title{
      font-size:0.95rem;
      font-weight:600;
      margin:0 0 8px;
    }
    .hint{
      font-size:0.78rem;
      color:var(--text-muted);
      margin:4px 0 0;
    }

    textarea{
      width:100%;
      min-height:120px;
      resize:none;
      border-radius:14px;
      border:1px solid var(--border-soft);
      background:#0b2235;
      color:var(--text-main);
      padding:10px 11px;
      font-size:0.9rem;
      line-height:1.45;
    }
    textarea:focus{
      outline:none;
      border-color:var(--accent-soft);
      box-shadow:0 0 0 1px rgba(59,130,246,0.65);
    }

    .field-label{
      font-size:0.85rem;
      font-weight:500;
      margin-bottom:4px;
      display:block;
    }

    .btn-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }

    .btn-primary,
    .btn-ghost,
    .btn-danger-outline{
      border-radius:999px;
      border:1px solid transparent;
      font-size:0.85rem;
      padding:7px 14px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      white-space:nowrap;
      background:transparent;
      color:var(--text-main);
    }

    .btn-primary{
      background:var(--accent);
      border-color:var(--accent);
      color:#f9fbff;
    }
    .btn-primary:disabled{
      opacity:0.4;
      cursor:default;
    }

    .btn-ghost{
      background:var(--chip-bg);
      border-color:var(--border-soft);
      color:var(--text-main);
    }
    .btn-ghost:disabled{
      opacity:0.4;
      cursor:default;
    }
    .btn-ghost-link{
      text-decoration:none;
    }

    .btn-danger-outline{
      border-color:var(--danger);
      color:var(--danger-soft);
      background:transparent;
    }

    .btn-danger-outline.flash{
      animation:flash-red 250ms ease-out;
    }
    @keyframes flash-red{
      0%{box-shadow:0 0 0 0 rgba(248,113,113,0.0);}
      50%{box-shadow:0 0 0 3px rgba(248,113,113,0.5);}
      100%{box-shadow:0 0 0 0 rgba(248,113,113,0.0);}
    }

    .btn-small{
      font-size:0.78rem;
      padding:5px 10px;
    }

    .file-input-hidden{
      display:none;
    }

    .photo-actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:6px;
    }

    .photo-grid{
      margin-top:10px;
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(96px,1fr));
      gap:8px;
    }
    .photo-thumb{
      position:relative;
      border-radius:12px;
      overflow:hidden;
      background:#020b16;
      border:1px solid var(--border-soft);
      cursor:pointer;
    }
    .photo-thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .photo-remove{
      position:absolute;
      top:4px;
      right:4px;
      background:rgba(15,23,42,0.82);
      border-radius:999px;
      width:20px;
      height:20px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:13px;
      color:#e5edf7;
      border:1px solid rgba(148,163,184,0.7);
      cursor:pointer;
    }

    /* Image overlay */
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(8,15,26,0.9);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .overlay.hidden{
      display:none;
    }
    .overlay-inner{
      max-width:92vw;
      max-height:88vh;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .overlay-inner img{
      max-width:92vw;
      max-height:70vh;
      border-radius:16px;
      border:1px solid var(--border-soft);
      box-shadow:0 18px 40px rgba(0,0,0,0.7);
      background:#020b16;
      object-fit:contain;
    }
    .overlay-actions{
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }

    .divider{
      height:1px;
      background:rgba(15,23,42,0.9);
      margin:10px 0;
    }

    .bottom-section{
      margin-top:16px;
    }
    .bottom-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:8px;
    }

    .tiny-note{
      font-size:0.72rem;
      color:var(--text-muted);
    }

    /* Audio UI */
    .audio-bar-wrap{
      margin-top:8px;
    }
    .audio-bar{
      padding:8px 12px;
      border-radius:999px;
      background:var(--bg-card-soft);
      border:1px solid rgba(148,163,184,0.35);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .audio-bar.recording{
      border-color:var(--danger-soft);
    }
    .audio-circle-btn{
      width:32px;
      height:32px;
      border-radius:999px;
      border:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
      cursor:pointer;
      background:var(--accent);
      color:#f9fafb;
      flex-shrink:0;
    }
    .audio-bar.recording .audio-circle-btn{
      background:var(--danger);
    }
    .audio-wave-placeholder{
      flex:1 1 auto;
      height:18px;
      border-radius:999px;
      background:
        linear-gradient(
          to right,
          rgba(148,163,184,0.18) 0%,
          rgba(148,163,184,0.55) 8%,
          rgba(148,163,184,0.18) 16%,
          rgba(148,163,184,0.55) 24%,
          rgba(148,163,184,0.18) 32%,
          rgba(148,163,184,0.55) 40%,
          rgba(148,163,184,0.18) 48%,
          rgba(148,163,184,0.55) 56%,
          rgba(148,163,184,0.18) 64%,
          rgba(148,163,184,0.55) 72%,
          rgba(148,163,184,0.18) 80%,
          rgba(148,163,184,0.55) 88%,
          rgba(148,163,184,0.18) 96%
        );
      opacity:0.85;
    }
    .audio-time{
      font-variant-numeric:tabular-nums;
      font-size:0.85rem;
      color:rgba(226,232,240,0.9);
    }
    .audio-delete-btn{
      border:none;
      background:transparent;
      color:var(--danger-soft);
      font-size:18px;
      margin-left:2px;
      cursor:pointer;
    }
    .hidden{
      display:none;
    }

    /* Reset confirm modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.60);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:60;
    }
    .modal{
      background:var(--bg-card);
      border-radius:18px;
      padding:16px 16px 12px;
      border:1px solid var(--border-soft);
      width:90%;
      max-width:340px;
      box-shadow:0 18px 40px rgba(0,0,0,0.7);
    }
    .modal-title{
      font-size:0.98rem;
      font-weight:600;
      margin:0 0 4px;
    }
    .modal-body{
      font-size:0.82rem;
      color:var(--text-muted);
      margin-bottom:12px;
    }
    .modal-actions{
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="app-title">ARA Field Tools</div>
      <div class="app-subtitle">Field notes (beta)</div>
    </header>

    <!-- NOTES -->
    <section class="card">
      <h2 class="card-title">Note</h2>
      <label for="noteText" class="field-label">Field note</label>
      <textarea id="noteText" placeholder="Quick notes, observations, hazards, landmarks…"></textarea>
      <p class="hint">This note stays on this device and can be copied or emailed out.</p>
    </section>

    <!-- PHOTOS -->
    <section class="card">
      <h2 class="card-title">Photos</h2>
      <div class="photo-actions">
        <label class="btn-ghost btn-small" for="photoDevice">
          Choose from device
          <input id="photoDevice" class="file-input-hidden" type="file" accept="image/*" multiple>
        </label>
        <label class="btn-ghost btn-small" for="photoCamera">
          Take photo
          <input id="photoCamera" class="file-input-hidden" type="file" accept="image/*" capture="environment">
        </label>
      </div>

      <div id="photoGrid" class="photo-grid"></div>
      <p class="hint">Images don’t transfer automatically in email – you’ll need to attach them separately.</p>
    </section>

    <!-- AUDIO -->
    <section class="card">
      <h2 class="card-title">Audio note</h2>
      <p class="hint">Optional quick voice note for this entry. This version is a visual prototype (no real recording yet).</p>

      <div class="btn-row">
        <button type="button" id="audioStart" class="btn-primary">Start recording</button>
      </div>

      <div class="audio-bar-wrap hidden" id="audioBarWrap">
        <div class="audio-bar" id="audioBar">
          <button type="button" id="audioCircle" class="audio-circle-btn" aria-label="Play audio">
            ►
          </button>
          <div class="audio-wave-placeholder"></div>
          <span id="audioTime" class="audio-time">00:00</span>
          <button type="button" id="audioDelete" class="audio-delete-btn" aria-label="Delete audio note">
            ×
          </button>
        </div>
      </div>

      <p class="hint">Audio length is saved locally, but no sound is recorded yet.</p>
    </section>

    <!-- BOTTOM ACTIONS -->
    <section class="card bottom-section">
      <h2 class="card-title">Share / manage</h2>
      <div class="bottom-row">
        <button type="button" id="copyNoteBtn" class="btn-ghost">Copy note text</button>
        <a id="emailBtn" class="btn-ghost btn-ghost-link" href="#" aria-disabled="true">Open email</a>
        <button type="button" id="saveNotebookBtn" class="btn-ghost" disabled>Save to notebook</button>
      </div>

      <div class="divider"></div>

      <div class="bottom-row">
        <button type="button" id="resetBtn" class="btn-danger-outline">Reset form</button>
      </div>
      <p class="tiny-note">Autosave is local to this device. Reset clears this page and its autosave.</p>
    </section>
  </div>

  <!-- Image overlay -->
  <div id="imageOverlay" class="overlay hidden" aria-hidden="true">
    <div class="overlay-inner">
      <img id="overlayImg" alt="Expanded field note photo">
      <div class="overlay-actions">
        <button type="button" id="overlayClose" class="btn-ghost btn-small">Close</button>
        <a id="overlayDownload" class="btn-ghost btn-small btn-ghost-link" href="#" download="field-note-photo.jpg">Download image</a>
      </div>
    </div>
  </div>

  <!-- Reset confirm modal -->
  <div id="resetModal" class="modal-backdrop hidden" aria-hidden="true">
    <div class="modal">
      <h3 class="modal-title">Reset this note?</h3>
      <p class="modal-body">This clears the text, photos, audio state, and the autosaved copy on this device.</p>
      <div class="modal-actions">
        <button type="button" id="resetCancel" class="btn-ghost btn-small">Cancel</button>
        <button type="button" id="resetConfirm" class="btn-danger-outline btn-small">Reset</button>
      </div>
    </div>
  </div>

  <script>
    /* ---------- Small helpers ---------- */
    function byId(id){ return document.getElementById(id); }
    function nowLocalPretty(){
      const d=new Date();
      const pad=n=>String(n).padStart(2,'0');
      return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+' '+pad(d.getHours())+':'+pad(d.getMinutes());
    }
    function fmtTime(ms){
      const total = Math.floor(ms/1000);
      const m = Math.floor(total/60);
      const s = total%60;
      return String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
    }
    function copyToClipboard(txt){
      if(navigator.clipboard && navigator.clipboard.writeText){
        return navigator.clipboard.writeText(txt);
      }
      return new Promise(function(resolve){
        const t=document.createElement('textarea');
        t.value=txt;
        t.style.position='fixed';
        t.style.opacity='0';
        document.body.appendChild(t);
        t.select();
        document.execCommand('copy');
        t.remove();
        resolve();
      });
    }

    /* ---------- Autosave core ---------- */
    const SAVE_KEY = 'ara_field_notes_v1';
    let _saveTimer = null;

    function getState(){
      try{
        return {
          note: byId('noteText').value || '',
          audio: {
            hasClip: audioDurationMs > 0,
            durationMs: audioDurationMs
          }
          // photos intentionally not persisted (would require blobs/base64)
        };
      }catch(e){
        console.warn('getState failed', e);
        return null;
      }
    }

    function saveStateSoon(){
      try{
        if(_saveTimer) clearTimeout(_saveTimer);
        _saveTimer = setTimeout(saveState, 250);
      }catch(e){ console.warn('saveStateSoon failed', e); }
    }

    function saveState(){
      try{
        const st = getState();
        if(st) localStorage.setItem(SAVE_KEY, JSON.stringify(st));
      }catch(e){
        console.warn('saveState failed', e);
      }
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(SAVE_KEY);
        if(!raw) return;
        const st = JSON.parse(raw);
        if(st.note) byId('noteText').value = st.note;
        autoGrowNote();
        if(st.audio && st.audio.hasClip && st.audio.durationMs){
          audioDurationMs = st.audio.durationMs;
          setAudioState('playback');
          updateAudioTimer(audioDurationMs);
        }
        updateShareButtons();
      }catch(e){
        console.warn('loadState failed', e);
      }
    }

    function clearState(){
      try{
        localStorage.removeItem(SAVE_KEY);
      }catch(e){}
    }

    /* ---------- Note auto-grow ---------- */
    const noteEl = byId('noteText');
    function autoGrowNote(){
      if(!noteEl) return;
      noteEl.style.height = 'auto';
      noteEl.style.height = (noteEl.scrollHeight+2)+'px';
    }
    noteEl.addEventListener('input', function(){
      autoGrowNote();
      saveStateSoon();
      updateShareButtons();
    });
    autoGrowNote();

    /* ---------- Photos (no autosave of blobs) ---------- */
    const photoDevice = byId('photoDevice');
    const photoCamera = byId('photoCamera');
    const photoGrid   = byId('photoGrid');

    let photos = []; // {id, url, fromCamera}

    function addFiles(fileList, fromCamera){
      if(!fileList || !fileList.length) return;
      Array.prototype.forEach.call(fileList, function(file){
        if(!file.type || !file.type.startsWith('image/')) return;
        const url = URL.createObjectURL(file);
        const id  = 'p'+Date.now()+Math.random().toString(16).slice(2);
        photos.push({id, url, fromCamera: !!fromCamera});
        renderPhotos();
      });
      updateShareButtons();
    }

    function renderPhotos(){
      photoGrid.innerHTML = '';
      photos.forEach(function(ph){
        const div = document.createElement('div');
        div.className = 'photo-thumb';
        div.dataset.id = ph.id;

        const img = document.createElement('img');
        img.src = ph.url;
        img.alt = 'Field note photo';

        const x = document.createElement('button');
        x.type = 'button';
        x.className = 'photo-remove';
        x.textContent = '×';

        x.addEventListener('click', function(ev){
          ev.stopPropagation();
          removePhoto(ph.id);
        });

        div.addEventListener('click', function(){
          openOverlay(ph);
        });

        div.appendChild(img);
        div.appendChild(x);
        photoGrid.appendChild(div);
      });
    }

    function removePhoto(id){
      photos = photos.filter(p => p.id !== id);
      renderPhotos();
      updateShareButtons();
    }

    photoDevice.addEventListener('change', function(e){
      addFiles(e.target.files, false);
      photoDevice.value = '';
    });
    photoCamera.addEventListener('change', function(e){
      addFiles(e.target.files, true);
      photoCamera.value = '';
    });

    /* ---------- Image overlay ---------- */
    const overlay = byId('imageOverlay');
    const overlayImg = byId('overlayImg');
    const overlayClose = byId('overlayClose');
    const overlayDownload = byId('overlayDownload');
    let currentOverlayPhoto = null;

    function openOverlay(photo){
      currentOverlayPhoto = photo;
      overlayImg.src = photo.url;
      overlay.classList.remove('hidden');
      overlay.setAttribute('aria-hidden','false');

      if(photo.fromCamera){
        overlayDownload.style.display = '';
        overlayDownload.href = photo.url;
      }else{
        overlayDownload.style.display = 'none';
      }
    }

    function closeOverlay(){
      overlay.classList.add('hidden');
      overlay.setAttribute('aria-hidden','true');
      overlayImg.src = '';
      currentOverlayPhoto = null;
    }

    overlayClose.addEventListener('click', closeOverlay);
    overlay.addEventListener('click', function(e){
      if(e.target === overlay) closeOverlay();
    });

    /* ---------- Audio dummy UI ---------- */
    const audioStartBtn = byId('audioStart');
    const audioBarWrap  = byId('audioBarWrap');
    const audioBar      = byId('audioBar');
    const audioCircle   = byId('audioCircle');
    const audioTime     = byId('audioTime');
    const audioDelete   = byId('audioDelete');

    let audioState = 'idle';      // 'idle' | 'recording' | 'playback' | 'playing'
    let audioDurationMs = 0;
    let recordStart = 0;
    let playStart = 0;
    let recordTimer = null;
    let playTimer = null;

    function clearAudioTimers(){
      if(recordTimer){ clearInterval(recordTimer); recordTimer=null; }
      if(playTimer){ clearInterval(playTimer); playTimer=null; }
    }

    function updateAudioTimer(ms){
      audioTime.textContent = fmtTime(ms);
    }

    function setAudioState(state){
      audioState = state;
      if(state === 'idle'){
        audioBarWrap.classList.add('hidden');
        audioBar.classList.remove('recording');
        audioCircle.textContent = '►';
        audioStartBtn.textContent = 'Start recording';
      }else if(state === 'recording'){
        audioBarWrap.classList.remove('hidden');
        audioBar.classList.add('recording');
        audioCircle.textContent = '●';
        audioStartBtn.textContent = 'Stop recording';
        audioDelete.style.display = 'none';
      }else if(state === 'playback'){
        audioBarWrap.classList.remove('hidden');
        audioBar.classList.remove('recording');
        audioCircle.textContent = '►';
        audioStartBtn.textContent = 'Start new recording';
        audioDelete.style.display = '';
      }else if(state === 'playing'){
        audioBarWrap.classList.remove('hidden');
        audioBar.classList.remove('recording');
        audioCircle.textContent = '❚❚';
        audioStartBtn.textContent = 'Start new recording';
        audioDelete.style.display = '';
      }
      updateShareButtons();
    }

    function startRecording(){
      clearAudioTimers();
      audioDurationMs = 0;
      recordStart = Date.now();
      updateAudioTimer(0);
      setAudioState('recording');
      recordTimer = setInterval(function(){
        audioDurationMs = Date.now() - recordStart;
        updateAudioTimer(audioDurationMs);
      }, 200);
      saveStateSoon();
    }

    function stopRecording(){
      if(audioState !== 'recording') return;
      clearAudioTimers();
      if(audioDurationMs < 500) audioDurationMs = 500;
      updateAudioTimer(audioDurationMs);
      setAudioState('playback');
      saveStateSoon();
    }

    function startPlayback(){
      if(audioState !== 'playback' || audioDurationMs <= 0) return;
      clearAudioTimers();
      playStart = Date.now();
      updateAudioTimer(0);
      setAudioState('playing');
      playTimer = setInterval(function(){
        let elapsed = Date.now() - playStart;
        if(elapsed >= audioDurationMs){
          elapsed = audioDurationMs;
          clearAudioTimers();
          setAudioState('playback');
        }
        updateAudioTimer(elapsed);
      }, 200);
      saveStateSoon();
    }

    function stopPlayback(){
      if(audioState !== 'playing') return;
      clearAudioTimers();
      setAudioState('playback');
      // keep whatever time was showing
      saveStateSoon();
    }

    function deleteAudio(){
      clearAudioTimers();
      audioDurationMs = 0;
      updateAudioTimer(0);
      setAudioState('idle');
      saveStateSoon();
    }

    audioStartBtn.addEventListener('click', function(){
      if(audioState === 'recording'){
        stopRecording();
      }else{
        // starting fresh recording from any other state
        deleteAudio();
        startRecording();
      }
    });

    audioCircle.addEventListener('click', function(){
      if(audioState === 'playback'){
        startPlayback();
      }else if(audioState === 'playing'){
        stopPlayback();
      }
    });

    audioDelete.addEventListener('click', function(){
      deleteAudio();
    });

    setAudioState('idle');

    /* ---------- Share / email ---------- */
    const copyNoteBtn = byId('copyNoteBtn');
    const emailBtn = byId('emailBtn');

    function buildPlainText(){
      const parts = [];
      const note = noteEl.value.trim();
      if(note){
        parts.push('Field note ('+nowLocalPretty()+')');
        parts.push('');
        parts.push(note);
        parts.push('');
      }
      if(photos.length){
        parts.push('Photos: '+photos.length+' image(s) – not attached, stored on device.');
      }
      if(audioDurationMs > 0){
        parts.push('Audio note: '+fmtTime(audioDurationMs)+' – not attached, stored on device.');
      }
      if(!parts.length){
        parts.push('Field note (empty)');
      }
      return parts.join('\n');
    }

    function updateShareButtons(){
      const hasContent =
        (noteEl.value && noteEl.value.trim().length>0) ||
        photos.length>0 ||
        audioDurationMs>0;

      copyNoteBtn.disabled = !hasContent;
      if(hasContent){
        const body = encodeURIComponent(buildPlainText());
        const subject = encodeURIComponent('ARA Field Note');
        emailBtn.href = 'mailto:?subject='+subject+'&body='+body;
        emailBtn.setAttribute('aria-disabled','false');
      }else{
        emailBtn.href = '#';
        emailBtn.setAttribute('aria-disabled','true');
      }
    }

    copyNoteBtn.addEventListener('click', function(){
      const txt = buildPlainText();
      copyToClipboard(txt).then(function(){
        const old = copyNoteBtn.textContent;
        copyNoteBtn.textContent = 'Copied ✓';
        setTimeout(() => copyNoteBtn.textContent = old, 1000);
      });
    });

    /* ---------- Reset form + modal ---------- */
    const resetBtn = byId('resetBtn');
    const resetModal = byId('resetModal');
    const resetCancel = byId('resetCancel');
    const resetConfirm = byId('resetConfirm');

    function showResetModal(){
      resetModal.classList.remove('hidden');
      resetModal.setAttribute('aria-hidden','false');
    }
    function hideResetModal(){
      resetModal.classList.add('hidden');
      resetModal.setAttribute('aria-hidden','true');
    }

    resetBtn.addEventListener('click', function(){
      resetBtn.classList.remove('flash');
      // reflow to restart animation
      void resetBtn.offsetWidth;
      resetBtn.classList.add('flash');
      showResetModal();
    });

    resetCancel.addEventListener('click', hideResetModal);
    resetModal.addEventListener('click', function(e){
      if(e.target === resetModal) hideResetModal();
    });

    resetConfirm.addEventListener('click', function(){
      hideResetModal();
      // Clear text
      noteEl.value = '';
      autoGrowNote();
      // Clear photos
      photos.forEach(p => URL.revokeObjectURL(p.url));
      photos = [];
      renderPhotos();
      // Clear audio
      deleteAudio();
      // Clear autosave
      clearState();
      updateShareButtons();
    });

    /* ---------- Initial load ---------- */
    document.addEventListener('DOMContentLoaded', function(){
      loadState();
      updateShareButtons();
    });
    // In case DOMContentLoaded has already fired (Capacitor sometimes injects differently)
    loadState();
    updateShareButtons();
  </script>
</body>
</html>
