<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ARA Field Tools ‚Äì Field notes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root{
      --bg-main:#020b16;
      --bg-card:#071727;
      --bg-card-soft:#0b2235;
      --border-soft:#12263a;
      --text-main:#e5edf7;
      --text-muted:#9caac3;
      --accent:#3b82f6;
      --accent-soft:#60a5fa;
      --danger:#b91c1c;
      --danger-soft:#f97373;
      --chip-bg:#0e2436;
      --shadow-card:0 14px 35px rgba(0,0,0,0.45);
      --radius-card:18px;
    }

    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg-main);
      color:var(--text-main);
      -webkit-font-smoothing:antialiased;
    }

    .app-shell{
      max-width: 720px;
      margin: 0 auto;
      padding: 12px 12px 32px;
    }

    .app-header{
      padding: 8px 4px 12px;
    }
    .app-title{
      font-weight: 650;
      font-size: 1.15rem;
    }
    .app-subtitle{
      font-size:0.85rem;
      color:var(--text-muted);
      margin-top:2px;
    }

    .card{
      background:var(--bg-card);
      border-radius:var(--radius-card);
      box-shadow:var(--shadow-card);
      border:1px solid var(--border-soft);
      padding:16px 14px 14px;
      margin-top:14px;
    }
    .card-title{
      font-size:0.95rem;
      font-weight:600;
      margin:0 0 8px;
    }
    .hint{
      font-size:0.78rem;
      color:var(--text-muted);
      margin:4px 0 0;
    }

    .field-label{
      font-size:0.85rem;
      font-weight:500;
      margin-bottom:4px;
      display:block;
    }

    .text-input,
    textarea{
      width:100%;
      border-radius:14px;
      border:1px solid var(--border-soft);
      background:#0b2235;
      color:var(--text-main);
      padding:9px 11px;
      font-size:0.9rem;
      line-height:1.4;
    }
    textarea{
      min-height:120px;
      resize:none;
    }
    .text-input:focus,
    textarea:focus{
      outline:none;
      border-color:var(--accent-soft);
      box-shadow:0 0 0 1px rgba(59,130,246,0.65);
    }

    .btn-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }

    .btn-primary,
    .btn-ghost,
    .btn-danger-outline{
      border-radius:999px;
      border:1px solid transparent;
      font-size:0.85rem;
      padding:7px 14px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      white-space:nowrap;
      background:transparent;
      color:var(--text-main);
    }

    /* Tag color tokens */
:root {
  --tag-microclimate: #a886ff;
  --tag-habitat:      #2f8f4e;
  --tag-species:      #4f7cff;
  --tag-landscape:    #c29b5a;
  --tag-moisture:     #2aa89a;
  --tag-wildlife:     #f3a53b;
  --tag-disturbance:  #ff6b4a;
  --tag-navigation:   #6f7b8f;
  --tag-weather:      #7b8aa4;
  --tag-photo:        #e08fb6;
}

/* Tag pill on main card */
.tag-pill {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 140px;
  padding-inline: 14px;
  border-radius: 999px;
}

.tag-current {
  font-size: 0.9rem;
}

.tag-none {
  opacity: 0.7;
}

/* Overlay shell */
.tag-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1500;
}

.tag-overlay.open {
  display: flex;
}

/* Panel */
.tag-panel {
  background: #061626;
  border-radius: 18px;
  padding: 16px 16px 12px;
  width: min(520px, 92vw);
  max-height: 80vh;
  box-shadow: 0 18px 40px rgba(0,0,0,0.75);
  border: 1px solid rgba(255,255,255,0.06);
  display: flex;
  flex-direction: column;
}

.tag-panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  margin-bottom: 4px;
}

.tag-panel-header h2 {
  font-size: 1.05rem;
  margin: 0;
}

.tag-panel-intro {
  margin: 0 0 10px;
  font-size: 0.85rem;
  opacity: 0.8;
}

/* Tag list */
.tag-list {
  list-style: none;
  margin: 0;
  padding: 0;
  overflow-y: auto;
  flex: 1;
}

.tag-option {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  padding: 8px 10px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.04);
  background: rgba(5,20,35,0.9);
  cursor: pointer;
  margin-bottom: 6px;
  transition: background 0.12s ease, border-color 0.12s ease, transform 0.08s ease;
}

.tag-option:hover {
  background: rgba(12,40,70,0.96);
  transform: translateY(-1px);
}

/* Color dot */
.tag-color-dot {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  margin-top: 2px;
  box-shadow: 0 0 8px rgba(0,0,0,0.7);
}

/* Individual dot colors + border tints */
.tag-microclimate { background: var(--tag-microclimate); }
.tag-habitat      { background: var(--tag-habitat); }
.tag-species      { background: var(--tag-species); }
.tag-landscape    { background: var(--tag-landscape); }
.tag-moisture     { background: var(--tag-moisture); }
.tag-wildlife     { background: var(--tag-wildlife); }
.tag-disturbance  { background: var(--tag-disturbance); }
.tag-navigation   { background: var(--tag-navigation); }
.tag-weather      { background: var(--tag-weather); }
.tag-photo        { background: var(--tag-photo); }

.tag-option[data-tag-id="microclimate"] { border-color: rgba(168,134,255,0.6); }
.tag-option[data-tag-id="habitat"]      { border-color: rgba(47,143,78,0.6); }
.tag-option[data-tag-id="species"]      { border-color: rgba(79,124,255,0.6); }
.tag-option[data-tag-id="landscape"]    { border-color: rgba(194,155,90,0.6); }
.tag-option[data-tag-id="moisture"]     { border-color: rgba(42,168,154,0.6); }
.tag-option[data-tag-id="wildlife"]     { border-color: rgba(243,165,59,0.6); }
.tag-option[data-tag-id="disturbance"]  { border-color: rgba(255,107,74,0.6); }
.tag-option[data-tag-id="navigation"]   { border-color: rgba(111,123,143,0.6); }
.tag-option[data-tag-id="weather"]      { border-color: rgba(123,138,164,0.6); }
.tag-option[data-tag-id="photo"]        { border-color: rgba(224,143,182,0.6); }

.tag-text {
  display: flex;
  flex-direction: column;
}

.tag-name {
  font-size: 0.9rem;
  font-weight: 600;
}

.tag-desc {
  font-size: 0.8rem;
  opacity: 0.8;
}

/* Footer */
.tag-panel-footer {
  margin-top: 8px;
  display: flex;
  justify-content: flex-end;
}


    .btn-primary{
      background:var(--accent);
      border-color:var(--accent);
      color:#f9fbff;
    }
    .btn-primary:disabled{
      opacity:0.4;
      cursor:default;
    }

    .btn-ghost{
      background:var(--chip-bg);
      border-color:var(--border-soft);
      color:var(--text-main);
    }
    .btn-ghost:disabled{
      opacity:0.4;
      cursor:default;
    }
    .btn-ghost-link{
      text-decoration:none;
    }

    .btn-danger-outline{
      border-color:var(--danger);
      color:var(--danger-soft);
      background:transparent;
    }
    .btn-danger-outline.flash{
      animation:flash-red 250ms ease-out;
    }
    @keyframes flash-red{
      0%{box-shadow:0 0 0 0 rgba(248,113,113,0.0);}
      50%{box-shadow:0 0 0 3px rgba(248,113,113,0.5);}
      100%{box-shadow:0 0 0 0 rgba(248,113,113,0.0);}
    }

    .btn-small{
      font-size:0.78rem;
      padding:5px 10px;
    }

    .file-input-hidden{ display:none; }

    .photo-actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:6px;
    }

    .photo-grid{
      margin-top:10px;
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(96px,1fr));
      gap:8px;
    }
    .photo-thumb{
      position:relative;
      border-radius:12px;
      overflow:hidden;
      background:#020b16;
      border:1px solid var(--border-soft);
      cursor:pointer;
    }
    .photo-thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .photo-remove{
      position:absolute;
      top:4px;
      right:4px;
      background:rgba(15,23,42,0.82);
      border-radius:999px;
      width:20px;
      height:20px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:13px;
      color:#e5edf7;
      border:1px solid rgba(148,163,184,0.7);
      cursor:pointer;
    }

    .overlay{
      position:fixed;
      inset:0;
      background:rgba(8,15,26,0.9);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .overlay-inner{
      max-width:92vw;
      max-height:88vh;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .overlay-inner img{
      max-width:92vw;
      max-height:70vh;
      border-radius:16px;
      border:1px solid var(--border-soft);
      box-shadow:0 18px 40px rgba(0,0,0,0.7);
      background:#020b16;
      object-fit:contain;
    }
    .overlay-actions{
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }

    .divider{
      height:1px;
      background:rgba(15,23,42,0.9);
      margin:10px 0;
    }

    .bottom-section{
      margin-top:16px;
    }
    .bottom-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:8px;
    }

    .tiny-note{
      font-size:0.72rem;
      color:var(--text-muted);
    }

    /* Reset modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.60);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:60;
    }
    .modal{
      background:var(--bg-card);
      border-radius:18px;
      padding:16px 16px 12px;
      border:1px solid var(--border-soft);
      width:90%;
      max-width:340px;
      box-shadow:0 18px 40px rgba(0,0,0,0.7);
    }
    .modal-title{
      font-size:0.98rem;
      font-weight:600;
      margin:0 0 4px;
    }
    .modal-body{
      font-size:0.82rem;
      color:var(--text-muted);
      margin-bottom:12px;
    }
    .modal-actions{
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }

    .hidden{ display:none !important; }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="app-title">ARA Field Tools</div>
      <div class="app-subtitle">Field notes (beta)</div>
    </header>

    <!-- NOTE -->
    <section class="card">
      <h2 class="card-title">Field Note Text</h2>

      <label for="noteTitle" class="field-label">Note Title</label>
      <input id="noteTitle" class="text-input" type="text"
             placeholder="e.g., Rossdale east bank scout, July 12">

      <div style="height:8px;"></div>

      <label for="noteText" class="field-label">Field note</label>
      <textarea id="noteText" placeholder="Quick notes, observations, hazards, landmarks‚Ä¶"></textarea>
      <p class="hint">This note stays on this device and can be copied or emailed out.</p>
    </section>

    <!-- Tag card -->
<section class="card">
  <header class="card-header">
    <h2 class="card-title">Tag</h2>
    <p class="card-subtitle">
      Optional label to categorize this note for your future Notebook view.
    </p>
  </header>
  <div class="card-body">
    <button type="button" id="tagPickerBtn" class="btn-ghost tag-pill">
      <span id="tagCurrentLabel" class="tag-current tag-none">No tag selected</span>
    </button>
    <p class="hint">
      Tap to choose a tag like ‚ÄúMicroclimate‚Äù, ‚ÄúHabitat‚Äù, or ‚ÄúTrail marker‚Äù.
    </p>
  </div>
</section>

    <!-- PHOTOS -->
    <section class="card">
      <h2 class="card-title">Photos</h2>
      <div class="photo-actions">
        <label class="btn-ghost btn-small" for="photoDevice">
          <span>üìÅ</span><span>Choose from gallery</span>
          <input id="photoDevice" class="file-input-hidden" type="file" accept="image/*" multiple>
        </label>
        <label class="btn-ghost btn-small" for="photoCamera">
          <span>üì∑</span><span>Take photo</span>
          <input id="photoCamera" class="file-input-hidden" type="file" accept="image/*" capture="environment">
        </label>
      </div>

      <div id="photoGrid" class="photo-grid"></div>
      <p class="hint">Images don‚Äôt transfer automatically in email ‚Äì you‚Äôll need to attach them separately.</p>
    </section>

    <!-- SHARE / MANAGE -->
    <section class="card bottom-section">
      <h2 class="card-title">Share / manage</h2>
      <div class="bottom-row">
        <button type="button" id="copyNoteBtn" class="btn-ghost">Copy note text</button>
        <a id="emailBtn" class="btn-ghost btn-ghost-link" href="#" aria-disabled="true">Open email</a>
        <button type="button" id="saveNotebookBtn" class="btn-ghost" disabled>Save to notebook</button>
      </div>

      <div class="divider"></div>

      <div class="bottom-row">
        <button type="button" id="resetBtn" class="btn-danger-outline">Reset form</button>
      </div>
      <p class="tiny-note">Autosave is local to this device. Reset clears this page and its autosave.</p>
    </section>
  </div>

  <!-- Image overlay -->
  <div id="imageOverlay" class="overlay hidden" aria-hidden="true">
    <div class="overlay-inner">
      <img id="overlayImg" alt="Expanded field note photo">
      <div class="overlay-actions">
        <button type="button" id="overlayClose" class="btn-ghost btn-small">Close</button>
        <a id="overlayDownload" class="btn-ghost btn-small btn-ghost-link" href="#" download="field-note-photo.jpg">Download image</a>
      </div>
    </div>
  </div>

  <!-- Reset confirm modal -->
  <div id="resetModal" class="modal-backdrop hidden" aria-hidden="true">
    <div class="modal">
      <h3 class="modal-title">Reset this note?</h3>
      <p class="modal-body">This clears the text, photos, and the autosaved copy on this device.</p>
      <div class="modal-actions">
        <button type="button" id="resetCancel" class="btn-ghost btn-small">Cancel</button>
        <button type="button" id="resetConfirm" class="btn-danger-outline btn-small">Reset</button>
      </div>
    </div>
  </div>
<!-- Tag selection overlay -->
<div id="tagOverlay" class="tag-overlay">
  <div class="tag-backdrop"></div>
  <div class="tag-panel">
    <header class="tag-panel-header">
      <h2>Choose a tag</h2>
      <button type="button" class="tag-close btn-ghost" id="tagCloseBtn">Close</button>
    </header>

    <p class="tag-panel-intro">
      Pick one tag for this note. You can change it anytime.
    </p>

    <ul class="tag-list" id="tagList">
      <!-- Microclimate -->
      <li class="tag-option"
          data-tag-id="microclimate"
          data-tag-name="Microclimate"
          data-tag-color="var(--tag-microclimate)">
        <span class="tag-color-dot tag-microclimate"></span>
        <div class="tag-text">
          <div class="tag-name">Microclimate</div>
          <div class="tag-desc">For pockets of unique temperature, moisture, or shelter.</div>
        </div>
      </li>

      <!-- Habitat -->
      <li class="tag-option"
          data-tag-id="habitat"
          data-tag-name="Habitat"
          data-tag-color="var(--tag-habitat)">
        <span class="tag-color-dot tag-habitat"></span>
        <div class="tag-text">
          <div class="tag-name">Habitat</div>
          <div class="tag-desc">For notes about understory, soil, and ecosystem type.</div>
        </div>
      </li>

      <!-- Species Observation -->
      <li class="tag-option"
          data-tag-id="species"
          data-tag-name="Species observation"
          data-tag-color="var(--tag-species)">
        <span class="tag-color-dot tag-species"></span>
        <div class="tag-text">
          <div class="tag-name">Species observation</div>
          <div class="tag-desc">For specific plants, trees, or interesting specimens.</div>
        </div>
      </li>

      <!-- Landscape Feature -->
      <li class="tag-option"
          data-tag-id="landscape"
          data-tag-name="Landscape feature"
          data-tag-color="var(--tag-landscape)">
        <span class="tag-color-dot tag-landscape"></span>
        <div class="tag-text">
          <div class="tag-name">Landscape feature</div>
          <div class="tag-desc">For slopes, ridges, gullies, terraces, and landforms.</div>
        </div>
      </li>

      <!-- Moisture / Hydrology -->
      <li class="tag-option"
          data-tag-id="moisture"
          data-tag-name="Moisture / hydrology"
          data-tag-color="var(--tag-moisture)">
        <span class="tag-color-dot tag-moisture"></span>
        <div class="tag-text">
          <div class="tag-name">Moisture / hydrology</div>
          <div class="tag-desc">For springs, seep lines, wet hollows, and drainage patterns.</div>
        </div>
      </li>

      <!-- Wildlife -->
      <li class="tag-option"
          data-tag-id="wildlife"
          data-tag-name="Wildlife"
          data-tag-color="var(--tag-wildlife)">
        <span class="tag-color-dot tag-wildlife"></span>
        <div class="tag-text">
          <div class="tag-name">Wildlife</div>
          <div class="tag-desc">For tracks, scat, nests, calls, or animal sign.</div>
        </div>
      </li>

      <!-- Condition / Disturbance -->
      <li class="tag-option"
          data-tag-id="disturbance"
          data-tag-name="Condition / disturbance"
          data-tag-color="var(--tag-disturbance)">
        <span class="tag-color-dot tag-disturbance"></span>
        <div class="tag-text">
          <div class="tag-name">Condition / disturbance</div>
          <div class="tag-desc">For fire scars, windthrow, beetle kill, or human impact.</div>
        </div>
      </li>

      <!-- Trail marker / Navigation -->
      <li class="tag-option"
          data-tag-id="navigation"
          data-tag-name="Trail marker / navigation"
          data-tag-color="var(--tag-navigation)">
        <span class="tag-color-dot tag-navigation"></span>
        <div class="tag-text">
          <div class="tag-name">Trail marker / navigation</div>
          <div class="tag-desc">For waypoints, landmarks, bike spots, or tricky turns.</div>
        </div>
      </li>

      <!-- Weather -->
      <li class="tag-option"
          data-tag-id="weather"
          data-tag-name="Weather"
          data-tag-color="var(--tag-weather)">
        <span class="tag-color-dot tag-weather"></span>
        <div class="tag-text">
          <div class="tag-name">Weather</div>
          <div class="tag-desc">For fog pockets, frost, wind, and local weather quirks.</div>
        </div>
      </li>

      <!-- Photo focus -->
      <li class="tag-option"
          data-tag-id="photo"
          data-tag-name="Photo focus"
          data-tag-color="var(--tag-photo)">
        <span class="tag-color-dot tag-photo"></span>
        <div class="tag-text">
          <div class="tag-name">Photo focus</div>
          <div class="tag-desc">For notes built mostly around photos and visuals.</div>
        </div>
      </li>
    </ul>

    <div class="tag-panel-footer">
      <button type="button" class="btn-ghost" id="tagClearBtn">Clear tag</button>
    </div>
  </div>
</div>

  <script>
    document.addEventListener('DOMContentLoaded', function(){
      function byId(id){ return document.getElementById(id); }
      function nowLocalPretty(){
        const d=new Date(); const pad=n=>String(n).padStart(2,'0');
        return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+' '+pad(d.getHours())+':'+pad(d.getMinutes());
      }

      function copyToClipboard(txt){
        if(navigator.clipboard && navigator.clipboard.writeText){
          return navigator.clipboard.writeText(txt);
        }
        return new Promise(function(resolve){
          const t=document.createElement('textarea');
          t.value=txt;
          t.style.position='fixed';
          t.style.opacity='0';
          document.body.appendChild(t);
          t.select();
          document.execCommand('copy');
          t.remove();
          resolve();
        });
      }

      const noteTitleEl   = byId('noteTitle');
      const noteEl        = byId('noteText');
      const photoDevice   = byId('photoDevice');
      const photoCamera   = byId('photoCamera');
      const photoGrid     = byId('photoGrid');

      const overlay       = byId('imageOverlay');
      const overlayImg    = byId('overlayImg');
      const overlayClose  = byId('overlayClose');
      const overlayDownload = byId('overlayDownload');

      const copyNoteBtn   = byId('copyNoteBtn');
      const emailBtn      = byId('emailBtn');

      const resetBtn      = byId('resetBtn');
      const resetModal    = byId('resetModal');
      const resetCancel   = byId('resetCancel');
      const resetConfirm  = byId('resetConfirm');

      const SAVE_KEY = 'ara_field_notes_v2';
      let _saveTimer = null;
      
/* ------------ Tag selection state ------------ */
let selectedTagId = null;

const tagPickerBtn   = document.getElementById('tagPickerBtn');
const tagCurrentLabel= document.getElementById('tagCurrentLabel');
const tagOverlay     = document.getElementById('tagOverlay');
const tagCloseBtn    = document.getElementById('tagCloseBtn');
const tagClearBtn    = document.getElementById('tagClearBtn');

function openTagOverlay(){
  if (!tagOverlay) return;
  tagOverlay.classList.add('open');
}

function closeTagOverlay(){
  if (!tagOverlay) return;
  tagOverlay.classList.remove('open');
}

/**
 * Apply a tag selection in UI + state.
 * @param {string|null} id 
 * @param {string} [name] 
 * @param {string} [color] 
 */
function applyTagSelection(id, name, color){
  selectedTagId = id || null;

  if (!tagCurrentLabel) return;

  if (!id){
    tagCurrentLabel.textContent = 'No tag selected';
    tagCurrentLabel.classList.add('tag-none');
    tagPickerBtn && (tagPickerBtn.style.borderColor = '');
  } else {
    tagCurrentLabel.textContent = name || 'Tagged';
    tagCurrentLabel.classList.remove('tag-none');
    if (tagPickerBtn && color){
      tagPickerBtn.style.borderColor = color;
      tagPickerBtn.style.boxShadow = '0 0 0 1px ' + color.replace('rgba','rgba').replace(')',',0.5)');
    }
  }

  // Nudge autosave if available
  if (typeof autoSaveSoon === 'function') autoSaveSoon();
}

      // photos = [{id, src, fromCamera}]
      let photos = [];
      let currentOverlayPhoto = null;

      /* ---------- autosave ---------- */
      function getState(){
        try{
          return {
            title: noteTitleEl.value || '',
            note:  noteEl.value || '',
            tagId: selectedTagId || '',
            photos: photos.map(p => ({ src:p.src, fromCamera: !!p.fromCamera }))
          };
        }catch(e){
          console.warn('getState failed', e);
          return null;
        }
      }
      function saveState(){
        try{
          const st=getState();
          if(st) localStorage.setItem(SAVE_KEY, JSON.stringify(st));
        }catch(e){
          console.warn('saveState failed', e);
        }
      }
      function saveStateSoon(){
        try{
          if(_saveTimer) clearTimeout(_saveTimer);
          _saveTimer = setTimeout(saveState, 250);
        }catch(e){}
      }
      function loadState(){
        try{
          const raw = localStorage.getItem(SAVE_KEY);
          if(!raw) return;
          const st = JSON.parse(raw);
          if(st.title){
            noteTitleEl.value = st.title;
          }
          if(st.note){
            noteEl.value = st.note;
            autoGrowNote();
          }
          if (st.tagId) {
  const opt = document.querySelector('.tag-option[data-tag-id="' + st.tagId + '"]');
  if (opt) {
    applyTagSelection(
      st.tagId,
      opt.dataset.tagName,
      opt.dataset.tagColor
    );
  }
} else {
  applyTagSelection(null);
}

          if(Array.isArray(st.photos)){
            photos = st.photos.map(p => ({
              id: 'p'+Date.now()+Math.random().toString(16).slice(2),
              src: p.src,
              fromCamera: !!p.fromCamera
            }));
            renderPhotos();
          }
          updateShareButtons();
        }catch(e){
          console.warn('loadState failed', e);
        }
      }
      function clearState(){
        try{ localStorage.removeItem(SAVE_KEY); }catch(e){}
      }

      /* ---------- note auto-grow ---------- */
      function autoGrowNote(){
        if(!noteEl) return;
        noteEl.style.height='auto';
        noteEl.style.height=(noteEl.scrollHeight+2)+'px';
      }
      noteEl.addEventListener('input', function(){
        autoGrowNote();
        saveStateSoon();
        updateShareButtons();
      });
      noteTitleEl.addEventListener('input', function(){
        saveStateSoon();
        updateShareButtons();
      });
      autoGrowNote();
// Open overlay when user taps the pill
if (tagPickerBtn) {
  tagPickerBtn.addEventListener('click', openTagOverlay);
}

// Close button
if (tagCloseBtn) {
  tagCloseBtn.addEventListener('click', closeTagOverlay);
}

// Click outside panel closes too
if (tagOverlay) {
  tagOverlay.addEventListener('click', function(e){
    if (e.target === tagOverlay) closeTagOverlay();
  });
}

// Clear tag
if (tagClearBtn) {
  tagClearBtn.addEventListener('click', function(){
    applyTagSelection(null);
    closeTagOverlay();
  });
}

// Tag option clicks
document.querySelectorAll('.tag-option').forEach(function(opt){
  opt.addEventListener('click', function(){
    const id    = opt.dataset.tagId;
    const name  = opt.dataset.tagName;
    const color = opt.dataset.tagColor;
    applyTagSelection(id, name, color);
    closeTagOverlay();
  });
});

      /* ---------- photos ---------- */
      function addPhotoFromDataUrl(dataUrl, fromCamera){
        const id='p'+Date.now()+Math.random().toString(16).slice(2);
        photos.push({id, src:dataUrl, fromCamera:!!fromCamera});
      }

      function handleFiles(fileList, fromCamera){
        if(!fileList || !fileList.length) return;
        const files = Array.prototype.slice.call(fileList);
        files.forEach(function(file){
          if(!file.type || !file.type.startsWith('image/')) return;
          const reader = new FileReader();
          reader.onload = function(e){
            addPhotoFromDataUrl(e.target.result, fromCamera);
            renderPhotos();
            updateShareButtons();
            saveStateSoon();
          };
          reader.readAsDataURL(file);
        });
      }

      function renderPhotos(){
        photoGrid.innerHTML='';
        photos.forEach(function(ph){
          const div=document.createElement('div');
          div.className='photo-thumb';
          div.dataset.id=ph.id;

          const img=document.createElement('img');
          img.src=ph.src;
          img.alt='Field note photo';

          const btn=document.createElement('button');
          btn.type='button';
          btn.className='photo-remove';
          btn.textContent='√ó';
          btn.addEventListener('click', function(ev){
            ev.stopPropagation();
            removePhoto(ph.id);
          });

          div.addEventListener('click', function(){
            openOverlay(ph);
          });

          div.appendChild(img);
          div.appendChild(btn);
          photoGrid.appendChild(div);
        });
      }

      function removePhoto(id){
        photos = photos.filter(p => p.id !== id);
        renderPhotos();
        updateShareButtons();
        saveStateSoon();
      }

      photoDevice.addEventListener('change', function(e){
        handleFiles(e.target.files, false);
        photoDevice.value='';
      });
      photoCamera.addEventListener('change', function(e){
        handleFiles(e.target.files, true);
        photoCamera.value='';
      });

      /* ---------- image overlay ---------- */
      function openOverlay(photo){
        currentOverlayPhoto = photo;
        overlayImg.src = photo.src;
        overlay.classList.remove('hidden');
        overlay.setAttribute('aria-hidden','false');

        if(photo.fromCamera){
          overlayDownload.style.display='';
          overlayDownload.href = photo.src;
        }else{
          overlayDownload.style.display='none';
        }
      }
      function closeOverlay(){
        overlay.classList.add('hidden');
        overlay.setAttribute('aria-hidden','true');
        overlayImg.src='';
        currentOverlayPhoto=null;
      }
      overlayClose.addEventListener('click', closeOverlay);
      overlay.addEventListener('click', function(e){
        if(e.target === overlay) closeOverlay();
      });

      /* ---------- share / email ---------- */
      function buildPlainText(){
        const parts=[];
        const title = noteTitleEl.value.trim();
        const note  = noteEl.value.trim();

        if(title){
          parts.push('Note name: '+title,'');
        }
        if(note){
          parts.push('Field note ('+nowLocalPretty()+')','',note,'');
        }
        if(photos.length){
          parts.push('Photos: '+photos.length+' image(s) ‚Äì not attached, stored on device.');
        }
        if(!parts.length){
          parts.push('Field note (empty)');
        }
        return parts.join('\n');
      }

      function updateShareButtons(){
        const hasContent =
          (noteTitleEl.value && noteTitleEl.value.trim().length>0) ||
          (noteEl.value && noteEl.value.trim().length>0) ||
          photos.length>0;

        copyNoteBtn.disabled = !hasContent;
        if(hasContent){
          const body = encodeURIComponent(buildPlainText());
          const baseSubject = 'ARA Field Note';
          const title = noteTitleEl.value.trim();
          const subject = encodeURIComponent(title ? baseSubject+' ‚Äì '+title : baseSubject);
          emailBtn.href = 'mailto:?subject='+subject+'&body='+body;
          emailBtn.setAttribute('aria-disabled','false');
        }else{
          emailBtn.href = '#';
          emailBtn.setAttribute('aria-disabled','true');
        }
      }

      copyNoteBtn.addEventListener('click', function(){
        const txt = buildPlainText();
        copyToClipboard(txt).then(function(){
          const old = copyNoteBtn.textContent;
          copyNoteBtn.textContent='Copied ‚úì';
          setTimeout(()=>copyNoteBtn.textContent=old,1000);
        });
      });

      /* ---------- reset modal ---------- */
      function showResetModal(){
        resetModal.classList.remove('hidden');
        resetModal.setAttribute('aria-hidden','false');
      }
      function hideResetModal(){
        resetModal.classList.add('hidden');
        resetModal.setAttribute('aria-hidden','true');
      }

      if(resetBtn){
        resetBtn.addEventListener('click', function(){
          resetBtn.classList.remove('flash');
          void resetBtn.offsetWidth;
          resetBtn.classList.add('flash');
          showResetModal();
        });
      }
      if(resetCancel){
        resetCancel.addEventListener('click', hideResetModal);
      }
      if(resetModal){
        resetModal.addEventListener('click', function(e){
          if(e.target === resetModal) hideResetModal();
        });
      }
      if(resetConfirm){
        resetConfirm.addEventListener('click', function(){
          hideResetModal();
          // clear title + note
          noteTitleEl.value='';
          noteEl.value='';
          autoGrowNote();
          // clear photos
          photos=[];
          renderPhotos();
          // clear autosave
          clearState();
          updateShareButtons();
        });
      }

      /* ---------- initial load ---------- */
      loadState();
      updateShareButtons();
    });
  </script>
</body>
</html>
