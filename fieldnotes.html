<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ARA Field Tools – Field note location</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root{
      --bg-main:#020b16;
      --bg-top:#04101f;
      --bg-card:#071727;
      --bg-card-soft:#0b2235;
      --border-soft:#123054;
      --border-strong:#1f3c64;

      --text-main:#e5edf7;
      --text-muted:#9caac3;
      --accent:#3b82f6;
      --accent-soft:#60a5fa;
      --accent-dark:#1d4ed8;

      --danger:#ef4444;
      --danger-dark:#991b1b;

      --chip-bg:#0e2436;
      --shadow-card:0 16px 40px rgba(0,0,0,0.65);
      --radius-card:18px;

      --acc-grey:#4b5563;
      --acc-amber:#f59e0b;
      --acc-green:#16a34a;
    }

    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg-main);
      color:var(--text-main);
      -webkit-font-smoothing:antialiased;
    }

    .app-shell{
      max-width: 720px;
      margin: 0 auto;
      padding: 12px 12px 28px;
    }

    /* Top bar */
    .topbar{
      background:linear-gradient(180deg,var(--bg-top),#071523);
      border-bottom:1px solid var(--border-soft);
      padding:10px 12px 8px;
      margin:-12px -12px 8px;
    }
    .topbar-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .brand-block{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand{
      font-weight:700;
      letter-spacing:.02em;
      font-size:1rem;
    }
    .brand-sub{
      font-size:0.8rem;
      color:var(--text-muted);
    }

    .top-tabs{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .top-tab{
      border-radius:999px;
      padding:5px 12px;
      font-size:0.8rem;
      border:1px solid transparent;
      background:rgba(15,23,42,0.7);
      color:var(--text-muted);
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .top-tab span.dot{
      width:8px;
      height:8px;
      border-radius:50%;
      background:#4b5563;
    }
    .top-tab.active{
      background:var(--accent-soft);
      color:#020617;
      border-color:var(--accent-soft);
      font-weight:600;
    }
    .top-tab.active span.dot{
      background:#22c55e;
    }

    /* Cards */
    .card{
      background:var(--bg-card);
      border-radius:var(--radius-card);
      box-shadow:var(--shadow-card);
      border:1px solid var(--border-soft);
      padding:16px 14px 14px;
      margin-top:14px;
    }
    .card-title{
      font-size:0.98rem;
      font-weight:650;
      margin:0 0 10px;
    }
    .hint{
      font-size:0.78rem;
      color:var(--text-muted);
      margin:4px 0 0;
    }

    /* Button row + pills */
    .btn-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }

    button{
      font-family:inherit;
    }

    .pill-btn{
      border-radius:999px;
      border:1px solid var(--border-soft);
      font-size:0.85rem;
      padding:8px 14px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      white-space:nowrap;
      background:rgba(15,23,42,0.9);
      color:var(--text-main);
      transition:
        background 0.12s ease,
        color 0.12s ease,
        border-color 0.12s ease,
        transform 0.06s ease;
    }
    .pill-btn:active{
      transform:scale(0.97);
    }
    .pill-btn.primary{
      background:var(--accent);
      border-color:var(--accent);
      color:#020617;
      font-weight:600;
    }
    .pill-btn.primary.running{
      background:var(--accent-dark);
      border-color:var(--accent-soft);
      box-shadow:0 0 0 2px rgba(37,99,235,0.55);
    }
    .pill-btn.toggle.active{
      background:var(--accent-soft);
      border-color:var(--accent-soft);
      color:#020617;
      font-weight:600;
    }
    .pill-btn.danger{
      background:rgba(127,29,29,0.3);
      border-color:var(--danger);
      color:#fecaca;
    }
    .pill-btn.danger:active{
      background:var(--danger-dark);
    }

    .pill-btn.sm{
      font-size:0.8rem;
      padding:6px 12px;
    }

    /* Fix cards */
    .fix-card{
      background:var(--bg-card-soft);
      border-radius:16px;
      padding:12px 12px 10px;
      border:1px solid var(--border-strong);
      margin-top:10px;
    }
    .fix-title{
      margin:0 0 6px;
      font-weight:650;
      font-size:0.95rem;
    }
    .fix-line{
      margin:2px 0;
      font-size:0.86rem;
    }
    .fix-label-muted{
      color:var(--text-muted);
      font-size:0.8rem;
    }

    /* Accuracy chip */
    .acc-chip{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:2px 9px;
      border-radius:999px;
      font-size:0.78rem;
      font-weight:650;
      background:#111827;
      color:#e5e7eb;
    }
    .acc-grey{
      background:var(--acc-grey);
      color:#f9fafb;
    }
    .acc-amber{
      background:var(--acc-amber);
      color:#1f2933;
    }
    .acc-green{
      background:var(--acc-green);
      color:#e5fff4;
    }

    .saved-card{
      background:rgba(15,23,42,0.9);
      border-radius:14px;
      padding:10px 11px 8px;
      border:1px dashed rgba(148,163,184,0.65);
      margin-top:10px;
      font-size:0.82rem;
    }
    .saved-card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      margin-bottom:4px;
    }
    .saved-pill{
      border-radius:999px;
      padding:3px 9px;
      font-size:0.72rem;
      border:1px solid rgba(148,163,184,0.6);
      color:var(--text-muted);
    }
    .saved-pill.good{
      border-color:var(--acc-green);
      color:#bbf7d0;
    }

    .tiny{
      font-size:0.75rem;
      color:var(--text-muted);
      margin-top:8px;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="topbar">
      <div class="topbar-row">
        <div class="brand-block">
          <div class="brand">ARA Field Tools</div>
          <div class="brand-sub">Field note – Location</div>
        </div>
        <nav class="top-tabs" aria-label="Field note navigation">
          <a href="fieldnotes.html" class="top-tab">
            ← Note
          </a>
          <span class="top-tab active">
            Location
            <span class="dot"></span>
          </span>
        </nav>
      </div>
    </header>

    <!-- Location controls -->
    <section class="card">
      <h2 class="card-title">Location</h2>
      <div class="btn-row">
        <button type="button" id="locToggle" class="pill-btn primary">
          Start tracking
        </button>
        <button type="button" id="locHiAcc" class="pill-btn toggle sm">
          High accuracy
        </button>
        <button type="button" id="locSaver" class="pill-btn toggle sm">
          Battery saver
        </button>
      </div>
      <p class="hint">
        GPS runs only while this page is open. Saved coordinates sync back to your Field Note.
      </p>

      <!-- Recent fix -->
      <div class="fix-card" id="recentCard">
        <h3 class="fix-title">Recent fix</h3>
        <p class="fix-line" id="recentDD">DD: —</p>
        <p class="fix-line" id="recentAlt">Altitude: —</p>
        <p class="fix-line">
          Accuracy:
          <span id="recentAcc" class="acc-chip">—</span>
        </p>
        <p class="fix-line" id="recentAge">Age: —</p>
        <p class="fix-label-muted" id="recentSamples">Samples: 0</p>
      </div>

      <!-- Best fix -->
      <div class="fix-card" id="bestCard">
        <h3 class="fix-title">Best so far</h3>
        <p class="fix-line" id="bestDD">DD: —</p>
        <p class="fix-line" id="bestAlt">Altitude: —</p>
        <p class="fix-line">
          Accuracy:
          <span id="bestAcc" class="acc-chip">—</span>
        </p>
        <p class="fix-line" id="bestTime">Time: —</p>
      </div>

      <!-- Actions -->
      <div class="btn-row">
        <button type="button" id="saveRecentBtn" class="pill-btn sm" disabled>Save recent</button>
        <button type="button" id="saveBestBtn"   class="pill-btn sm" disabled>Save best</button>
        <button type="button" id="resetLocBtn"   class="pill-btn danger sm">Reset location</button>
      </div>

      <!-- Saved-to-note summary -->
      <div class="saved-card" id="savedSummary">
        <div class="saved-card-header">
          <span>Saved to Field Note</span>
          <span id="savedStatusPill" class="saved-pill">None yet</span>
        </div>
        <div id="savedDetails">
          No location has been stored for this note.
        </div>
      </div>

      <p class="tiny">
        Saved data: source (recent/best), latitude, longitude, altitude, accuracy, timestamp, and sample count.
      </p>
    </section>
  </div>

  <script>
    (function(){
      const SAVE_KEY = 'ara_field_notes_v2';

      function loadNoteState(){
        try{
          const raw = localStorage.getItem(SAVE_KEY);
          if(!raw) return {};
          return JSON.parse(raw) || {};
        }catch(e){
          console.warn('Failed to read state', e);
          return {};
        }
      }
      function saveNoteState(partial){
        try{
          const current = loadNoteState();
          const next = Object.assign({}, current, partial);
          localStorage.setItem(SAVE_KEY, JSON.stringify(next));
        }catch(e){
          console.warn('Failed to save state', e);
        }
      }

      // UI refs
      const locToggle = document.getElementById('locToggle');
      const locHiAcc  = document.getElementById('locHiAcc');
      const locSaver  = document.getElementById('locSaver');

      const recentDD   = document.getElementById('recentDD');
      const recentAlt  = document.getElementById('recentAlt');
      const recentAcc  = document.getElementById('recentAcc');
      const recentAge  = document.getElementById('recentAge');
      const recentSamples = document.getElementById('recentSamples');

      const bestDD   = document.getElementById('bestDD');
      const bestAlt  = document.getElementById('bestAlt');
      const bestAcc  = document.getElementById('bestAcc');
      const bestTime = document.getElementById('bestTime');

      const saveRecentBtn = document.getElementById('saveRecentBtn');
      const saveBestBtn   = document.getElementById('saveBestBtn');
      const resetLocBtn   = document.getElementById('resetLocBtn');

      const savedSummary    = document.getElementById('savedSummary');
      const savedStatusPill = document.getElementById('savedStatusPill');
      const savedDetails    = document.getElementById('savedDetails');

      // Runtime state
      let watchId = null;
      let useHiAcc = false;
      let useSaver = false;
      let samples = 0;
      let recent = null; // {lat,lng,acc,alt,ts}
      let best   = null;
      let ageTimer = null;

      function fmt6(v){ return Number.isFinite(v)? v.toFixed(6) : '—'; }
      function fmt1(v){ return Number.isFinite(v)? v.toFixed(1) : '—'; }

      function accClass(m){
        if(!Number.isFinite(m)) return 'acc-grey';
        if(m <= 5)  return 'acc-green';
        if(m <= 20) return 'acc-amber';
        return 'acc-grey';
      }

      function setAccChip(el, meters){
        if(!el) return;
        let cls = 'acc-chip ' + accClass(meters);
        el.className = cls;
        el.textContent = Number.isFinite(meters) ? '±'+fmt1(meters)+' m' : '±— m';
      }

      function setTrackingUI(running){
        if(!locToggle) return;
        if(running){
          locToggle.textContent = 'Stop tracking';
          locToggle.classList.add('running');
        }else{
          locToggle.textContent = 'Start tracking';
          locToggle.classList.remove('running');
        }
      }

      function updateRecentUI(){
        if(recent){
          recentDD.textContent  = 'DD: '+fmt6(recent.lat)+', '+fmt6(recent.lng);
          recentAlt.textContent = 'Altitude: '+(Number.isFinite(recent.alt)? fmt1(recent.alt)+' m' : '—');
          setAccChip(recentAcc, recent.acc);

          if(ageTimer) clearInterval(ageTimer);
          ageTimer = setInterval(function(){
            const age = (Date.now() - recent.ts)/1000;
            recentAge.textContent = 'Age: '+fmt1(age)+' s';
          }, 300);

          saveRecentBtn.disabled = false;
        }else{
          recentDD.textContent   = 'DD: —';
          recentAlt.textContent  = 'Altitude: —';
          setAccChip(recentAcc, NaN);
          recentAge.textContent  = 'Age: —';
          saveRecentBtn.disabled = true;
          if(ageTimer){ clearInterval(ageTimer); ageTimer=null; }
        }
        recentSamples.textContent = 'Samples: '+samples;
      }

      function updateBestUI(){
        if(best){
          bestDD.textContent  = 'DD: '+fmt6(best.lat)+', '+fmt6(best.lng);
          bestAlt.textContent = 'Altitude: '+(Number.isFinite(best.alt)? fmt1(best.alt)+' m' : '—');
          setAccChip(bestAcc, best.acc);
          bestTime.textContent = 'Time: '+ new Date(best.ts).toLocaleString();
          saveBestBtn.disabled = false;
        }else{
          bestDD.textContent  = 'DD: —';
          bestAlt.textContent = 'Altitude: —';
          setAccChip(bestAcc, NaN);
          bestTime.textContent = 'Time: —';
          saveBestBtn.disabled = true;
        }
      }

      function handlePosition(pos){
        const c = pos.coords;
        const now = Date.now();

        if(useSaver && recent && now - recent.ts < 1500){
          return; // throttle
        }

        const fix = {
          lat: c.latitude,
          lng: c.longitude,
          acc: c.accuracy,
          alt: Number.isFinite(c.altitude)? c.altitude : NaN,
          ts: now
        };
        samples++;
        recent = fix;
        updateRecentUI();

        if(!best || (Number.isFinite(fix.acc) && fix.acc < best.acc)){
          best = Object.assign({}, fix);
          updateBestUI();
        }
      }

      function handleError(err){
        console.warn('Geolocation error', err);
      }

      function startTracking(){
        if(watchId !== null) return;
        if(!navigator.geolocation){
          alert('Geolocation not available in this browser.');
          return;
        }
        const opts = {
          enableHighAccuracy: useHiAcc,
          maximumAge: useSaver ? 15000 : 0,
          timeout: useSaver ? 30000 : 20000
        };
        watchId = navigator.geolocation.watchPosition(handlePosition, handleError, opts);
        setTrackingUI(true);
      }

      function stopTracking(){
        if(watchId !== null && navigator.geolocation && navigator.geolocation.clearWatch){
          navigator.geolocation.clearWatch(watchId);
        }
        watchId = null;
        setTrackingUI(false);
      }

      function resetAll(){
        stopTracking();
        samples = 0;
        recent = null;
        best   = null;
        updateRecentUI();
        updateBestUI();
      }

      function storeLocationToNote(source, fix){
        if(!fix) return;
        const payload = {
          source,                   // 'recent' or 'best'
          lat: fix.lat,
          lng: fix.lng,
          acc: Number.isFinite(fix.acc)? fix.acc : null,
          alt: Number.isFinite(fix.alt)? fix.alt : null,
          ts:  fix.ts,
          samples
        };
        saveNoteState({ location: payload });
        refreshSavedSummary(payload);
      }

      function refreshSavedSummary(loc){
        if(!loc){
          savedStatusPill.textContent = 'None yet';
          savedStatusPill.className = 'saved-pill';
          savedDetails.textContent = 'No location has been stored for this note.';
          return;
        }
        const srcLabel = loc.source === 'best' ? 'Best fix' : 'Recent fix';
        savedStatusPill.textContent = srcLabel;
        savedStatusPill.className = 'saved-pill good';

        const parts = [];
        parts.push('DD: '+fmt6(loc.lat)+', '+fmt6(loc.lng));
        if(Number.isFinite(loc.alt)){
          parts.push('Altitude: '+fmt1(loc.alt)+' m');
        }
        if(Number.isFinite(loc.acc)){
          parts.push('Accuracy: ±'+fmt1(loc.acc)+' m');
        }
        if(loc.ts){
          parts.push('Time: '+new Date(loc.ts).toLocaleString());
        }
        parts.push('Samples: '+(loc.samples ?? 0));
        savedDetails.textContent = parts.join(' · ');
      }

      // Wire buttons
      if(locToggle){
        locToggle.addEventListener('click', function(){
          if(watchId === null) startTracking();
          else stopTracking();
        });
      }
      if(locHiAcc){
        locHiAcc.addEventListener('click', function(){
          useHiAcc = !useHiAcc;
          locHiAcc.classList.toggle('active', useHiAcc);
          if(watchId !== null){
            stopTracking();
            startTracking();
          }
        });
      }
      if(locSaver){
        locSaver.addEventListener('click', function(){
          useSaver = !useSaver;
          locSaver.classList.toggle('active', useSaver);
          if(watchId !== null){
            stopTracking();
            startTracking();
          }
        });
      }
      if(saveRecentBtn){
        saveRecentBtn.addEventListener('click', function(){
          if(recent) storeLocationToNote('recent', recent);
        });
      }
      if(saveBestBtn){
        saveBestBtn.addEventListener('click', function(){
          if(best) storeLocationToNote('best', best);
        });
      }
      if(resetLocBtn){
        resetLocBtn.addEventListener('click', function(){
          if(confirm('Reset all location data for this session?')){
            resetAll();
          }
        });
      }

      // Initial: load any saved loc for summary
      const state = loadNoteState();
      if(state.location){
        refreshSavedSummary(state.location);
      }else{
        refreshSavedSummary(null);
      }

      // On unload, stop tracking cleanly
      window.addEventListener('beforeunload', stopTracking);
    })();
  </script>
</body>
</html>
