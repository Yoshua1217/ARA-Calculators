<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ARA Field Tools</title>
<style>
  :root{
    /* New dark palette from fieldnotes */
    --bg:#020b16;
    --panel:#071727;
    --panel-2:#0b2235;
    --border:#12263a;
    --text:#e5edf7;
    --muted:#9caac3;
    --accent:#3b82f6;
    --accent-2:#60a5fa;
    --ok:#16a34a; /* A suitable green */
    --danger:#b91c1c;
    --radius:18px;
    --gap:14px;

    /* Category colors */
    --cat-champion: #f59e0b;Â  Â  /* Orange-gold */
    --cat-centurion: #eab308;Â  Â /* Yellow */
    --cat-storyteller: #ef4444; /* Red */
    --cat-ancient: #8b5cf6;Â  Â  Â /* Purple */
    --cat-unique-growth: #a78bfa; /* Light purple */
    --cat-tall: #22c55e;Â  Â  Â  Â  /* Green */
    --cat-large-circ: #84cc16;Â  /* Light green */
    --cat-past: #16a34a;Â  Â  Â  Â  /* Green (ring) */
    --cat-gathering: #14b8a6;Â  Â /* Teal */
    --cat-edible: #3b82f6;Â  Â  Â  /* Blue */
    --cat-prime: #10b981;Â  Â  Â  Â /* Green (starburst) */
    --cat-unique-loc: #a855f7;Â  /* Purple (triangle) */

    /* Condition colors */
    --cond-healthy: #22c55e;Â  Â /* Green */
    --cond-decline: #f59e0b;Â  Â /* Amber */
    --cond-damaged: #ef4444;Â  Â /* Red */
    --cond-dead: #6b7280;Â  Â  Â  /* Grey */
    --cond-fallen: #4b5563;Â  Â  /* Darker Grey */
  }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg); color:var(--text);
  }

  /* Fixed header */
  .topbar{
    position:sticky; top:0; z-index:50;
    background:var(--bg); /* Keep solid background */
    border-bottom:1px solid var(--border); /* Restore border for a clean bottom edge */
    padding:10px 14px;
  }

.topbar .row{
  display:flex;
  flex-direction:column;Â  Â  Â  /* stack title over controls */
  align-items:flex-start;Â  Â  Â /* left edges line up */
  gap:8px;
}

.brand {
  font-weight: 800;
  letter-spacing: .2px;
  font-size: 1.05rem;
  color: #eaf3ff;
  line-height: 1.1;
  padding-left: 2px; /* alignment fix */
}
.inline-controls {
  display: flex;
  align-items: center;
  flex-wrap: nowrap;
  overflow-x: auto;
  white-space: nowrap;
  scrollbar-width: none; /* hide scrollbars on Firefox */
  gap: 4px; /* tighter gap between buttons */
  margin-left: -5px; /* pulls Units: text left to match title */
  padding-left: 0;
}

.inline-controls::-webkit-scrollbar {
  display: none; /* hide scrollbars on Chrome/Safari */
}

.inline-controls .acc-pill {
  margin-left: -1px;
  flex-shrink: 0;
}

Â  /* small-screen fit: slightly tighter paddings/fonts */
@media (max-width: 420px){
  .inline-controls{ gap:6px; }
  .toggle-btn{ padding:6px 10px; }Â  Â  Â  Â  /* was 8px 12px */
  .acc-pill{ font-size:.85rem; padding:3px 8px; }
}
  .toggle-btn{
    padding:8px 12px; border:1px solid var(--border); border-radius:999px;
    background:var(--panel); color:var(--text); cursor:pointer;
  }
  .toggle-btn.active{ background:var(--accent); color:#001528; border-color:transparent; font-weight:700; }
  /* Specific active colors for location buttons */
  #loc-hiacc.active {
    background: var(--ok); /* Green for high accuracy */
    color: #e6fff2;
  }
  #loc-saver.active {
    background: var(--cond-decline); /* Amber for battery saver */
    color: #2b1a00;
  }

  .toggle-label{ color:var(--muted); font-size:.9rem; margin-left:6px; }

  /* Tabs */
  .tabs{
    /* No longer sticky; it's inside the sticky topbar now */
    overflow:auto; white-space:nowrap;
    margin: 8px -14px -10px; /* Use negative margins to span full width */
    border-top: 1px solid var(--border);
  }
  .tabs-inner{ display:flex; gap:8px; padding:8px 12px; }
  /* Fix for mobile tab bar overflow - make it take full width and scroll */
  .tabs-inner {
    width: 100%; /* Ensure it takes up the container width */
    overflow-x: auto;
    -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
    -ms-overflow-style: none; /* Hide scrollbar on IE/Edge */
    scrollbar-width: none; /* Hide scrollbar on Firefox */
  }
  .tabs-inner::-webkit-scrollbar { display: none; } /* Hide scrollbar on Chrome/Safari */
  .tab{
    padding:10px 14px; border-radius:999px;
    background:var(--panel); border:1px solid var(--border); color:var(--text);
    cursor:pointer; user-select:none;
  }
  /* Fix for location dot wrapping on mobile */
  .tab[data-tab="loc"] {
    display: inline-flex; /* Use flex to keep text and dot on one line */
    align-items: center;Â  Â /* Vertically align them */
    gap: 6px;Â  Â  Â  Â  Â  Â  Â  /* Add a small space between */
    white-space: nowrap;Â  Â /* Prevent wrapping */
  }
  .tab-icon {
    padding: 10px; /* Make it squarer */
    flex-shrink: 0; /* Prevent it from shrinking */
  }
  .tab-icon i {
    font-size: 20px;
    line-height: 1;
  }
  .tab.active{ background:var(--accent-2); color:#001528; border-color:transparent; font-weight:800; }

  /* Main content */
  .content{
    padding:14px;
    max-width:1000px;
    margin:0 auto; }
  .card{
    background:var(--panel); border:1px solid var(--border);
    border-radius:var(--radius); margin-bottom:var(--gap);
  }
  .card .block{ padding:16px 18px; }
  h2{ margin:0 0 8px; font-size:1.2rem; }
  h3{ margin:0 0 8px; font-size:1.05rem; color:#d6e6ff; }
  label{ display:block; font-weight:700; margin:10px 0 6px; }

  /* Consistent system font for all entry fields */
  input[type="text"], input[type="number"], select, textarea {
    width: 100%;
    padding: 10px 12px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: var(--panel-2);
    color: var(--text);
    font-size: 1rem;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    letter-spacing: 0.01em;
  }
  input::placeholder, textarea::placeholder{ font-family:inherit; color:#99a5b8; }
  textarea{ min-height:88px; resize:none; overflow:hidden; }

  .row{ display:grid; grid-template-columns:1fr 1fr; gap:var(--gap); }
  @media (max-width:780px){ .row{ grid-template-columns:1fr } }

  .note{
    background:#0b1a2f; border:1px solid #1f3553; color:#cfe0ff;
    border-radius:12px; padding:10px 12px;
  }

  /* Buttons */
  .btn-row{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    align-items: center; /* This will vertically align all buttons in the row */
  }
  button,.btn{
    display: inline-flex; /* Use flexbox for internal alignment */
    align-items: center;Â  Â  /* Vertically center content */
    justify-content: center;/* Horizontally center content */
    padding:10px 14px; border:0; border-radius:10px; cursor:pointer;
    gap: 6px; /* Add a small gap between icon and text */
  }
  button svg, .btn svg {
    width: 1em; height: 1em;
  }
  .btn-ghost{ background:var(--panel-2); color:var(--text); border:1px solid var(--border); }
  .btn-dim{ background:#113158; color:#bcd8ff; border:1px solid var(--border); }
  .btn-danger{ background:var(--danger); color:#fff; }
  .btn-ok{ background:var(--ok); color:#00180f; }
  button[disabled]{ opacity:.6; cursor:not-allowed; }

  /* â€œSelectableâ€ (light by default, dark when chosen) */
  .btn-select{
    background: var(--panel-2);
    color: var(--text);
    border: 1px solid var(--border);
  }
  .btn-select.active{
    background: var(--accent-2);
    color: #001528;
    border-color: transparent;
    box-shadow: 0 0 0 1px rgba(0,0,0,.06) inset;
  }

  /* Allow ghost buttons to darken when we set .active in JS */
  .btn-ghost.active{
    background: var(--accent-2);
    color:#001528;
    border-color: transparent;
  }

.btn-ghost,
.btn-ghost:link,
.btn-ghost:visited {
  font-size: 0.85rem;Â  Â /* match whatever your small buttons use */
  padding: 6px 10px;
  display: inline-block; /* forces <a> to size like a button */
  text-decoration: none; /* removes underline browsers sometimes force */
}

Â  /* Match "Open email (optional)" button to others */
#emailBtn {
  display: inline-block;
  padding: 10px 14px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--panel-2);
  color: var(--text);
  font-weight: 700;
  text-decoration: none;
  text-align: center;
  transition: background 0.2s, color 0.2s, transform 0.1s;
}

#emailBtn:hover:not([aria-disabled="true"]) {
  background: var(--accent-2);
  color: #001528;
}

#emailBtn:active:not([aria-disabled="true"]) {
  background: #1b6cff;
  color: #fff;
  transform: scale(0.98);
}

#emailBtn[aria-disabled="true"] {
  opacity: 0.5;
  pointer-events: none;
}


Â  /* Multi-trunk minor styles */
  .mt-label{font-weight:700}
  .badge{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;background:#1b6cff;color:#001528;font-size:.75rem;vertical-align:middle}
  .badge.hide{display:none}
  .hint{font-size:.86rem;color:#ffc0c0;display:none}
  .hint.show{display:block}

  /* Clinometer (angle pill + lock in light blue) */
  .clino-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .clino-wrap{
    position:relative; height:180px; border:1px solid var(--border);
    border-radius:12px; background:#0b1a2f; margin:10px 0; overflow:hidden;
    display:flex; align-items:center; justify-content:center;
  }

  /* Clinometer lock button (no border when idle) */
  .clino-lock{
    width:140px; height:140px;
    border:0; /* no border when not locked */
    border-radius:999px;
    background:#cfe0ff; /* light blue */
    color:#0b2250;Â  Â  Â  /* dark navy text */
    font-weight:900; font-size:1.15rem; cursor:pointer;
    box-shadow:0 2px 8px rgba(0,0,0,.25) inset;
  }
/* Lock button: darker blue when locked (less neon) */
.clino-lock.active {
  background: #2b66d6;Â  Â  Â  Â  Â  /* deeper blue */
  color: #e8f0ff;
  border: 2px solid #1b4ca3;Â  Â  /* slightly darker border */
}
  .clino-lock:active{ transform:scale(.98); }

/* Live angle box - dark blue like the clinometer card */
.clino-readout {
  background: #0f2236;Â  Â  Â  Â  Â  Â  Â  Â /* matches card background */
  color: #cfe0ff;
  border: 1px solid #1f3553;
  border-radius: 12px;
  padding: 10px 12px;
  margin: 10px 0 12px;
}
.clino-readout .angle {
  font-weight: 900;
  font-size: 2rem;
  line-height: 1.1;
}
.clino-readout .status {
  color: #99b8ff;
  font-size: 0.92rem;
  margin-top: 4px;
}
/* Calculate height button: lighter â€œactiveâ€ state */
#h-calc.active {
  background: #4db2ff;Â  Â  Â  Â  Â  /* lighter blue flash */
  color: #001528;
  transition: background 0.25s, color 0.25s;
}
  /* Results */
  .results{
    background:#0b1a2f; border:1px solid var(--border);
    border-radius:12px; padding:12px;
  }
  .results p{ margin:6px 0 }
  .muted{ color:var(--muted) }
  .tiny{ font-size:.86rem; color:var(--muted) }
  .unit-tag{ color:#cfe0ff; font-weight:800 }

  /* Spacing between generated description sections */
.desc-section {Â 
  margin: 12px 0 10px;
}

  /* Tabs content visibility */
  .tabpane{ display:none }
  .tabpane.active{ display:block }

  /* Location accuracy chips */
  .acc-chip{ display:inline-block; padding:2px 8px; border-radius:999px; font-weight:600; }
Â .acc-grey, .acc-pill.acc-grey, .acc-dot.acc-grey {
  background:#46505e;Â  Â  Â  /* neutral grey */
  color:#e2e8f0;
  }
  .acc-amber, .acc-pill.acc-amber, .acc-dot.acc-amber {
    background:#ffb300;Â  Â  Â  /* bright golden yellow */
    color:#2b1a00;Â  Â  Â  Â  Â  Â /* dark text for contrast */
  }
  .acc-green, .acc-pill.acc-green, .acc-dot.acc-green {
    background:#1b5e2b;Â 
    color:#e6fff2;Â 
  }
  .acc-red, .acc-pill.acc-red, .acc-dot.acc-red {
    background:#7a2020;Â 
    color:#ffdede;Â 
  }

Â .acc-pill {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.9rem;
    padding: 4px 10px;
    border-radius: 999px;
    line-height: 1;
    margin-left: 8px;
    vertical-align: middle;
}
  /* Running state for the Start/Stop toggle */
  #loc-toggle.running{ background:#0b3b82; color:#fff; }

  /* Reset Form Button â€” bright red fill by default, thicker border */
  #resetFormResults{
    background:#e53935;
    color:#fff;
    border:3px solid #6b0e0e;
    border-radius:10px;
    transition:background .15s, transform .1s, border-color .15s;
  }
  #resetFormResults:hover{
    background:#d32f2f;
    border-color:#8e0000;
    transform:scale(1.02);
  }
  #resetFormResults:active{
    background:#8e0000;
    border-color:#5c0000;
    transform:scale(.98);
  }

  /* Save to Log button (darker, leaf green) */
  .btn-save {
    background: #1E5631; /* Dark leaf green */
    color: #fff;
    border: 3px solid #12351e; /* Even darker border */
    border-radius: 10px;
    transition: background .15s, transform .1s, border-color .15s;
  }
  .btn-save:hover {
    background: #287240;
    border-color: #1a4a2a;
    transform: scale(1.02);
  }
  .btn-save:active {
    background: #12351e;
    border-color: #0a2012;
    transform: scale(.98);
  }
  .btn-save.saved { background: #12351e; border-color: #0a2012; }

  /* Style for View Log button to match Home button */
  #viewLogBtn {
    background: var(--panel-2);
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px 14px;
    font-weight: 700;
    text-decoration: none;
    display: inline-block;
    transition: background .15s, transform .1s, border-color .15s;
  }
  #viewLogBtn:hover {
    background: var(--accent-2);
    color:#001528;
    transform: scale(1.02);
  }
  #viewLogBtn:active {
    background:#1b6cff;
    color:#fff;
    transform: scale(.98);
  }

  /* Map space (+ small gap above) */
  #loc-map { height: 300px; border-radius: 12px; overflow: hidden; margin-top:12px; }
  .map-actions { display:flex; gap:8px; margin:8px 0 0; flex-wrap:wrap; }

/* Global small pill in the header */
.acc-pill{
  display:inline-flex; align-items:center; justify-content:center;
  padding:6px 10px; margin-left:8px;
  border-radius:999px; font-weight:800; font-size:.95rem;
  border:1px solid var(--border);
  background:#404957; color:#d7dee8;Â  /* default (grey) */
}


/* Tiny status dot next to the Location tab */
.acc-dot{
  display:inline-block; width:10px; height:10px; margin-left:6px;
  border-radius:50%;
  border:1px solid rgba(0,0,0,.25);
  vertical-align:middle;
}
Â Â 
/* Connectivity card (medium border) */
.conn-card{
  border: 2px solid var(--border);Â  Â /* medium thickness */
  border-radius: var(--radius);
  background: var(--panel);
}
.conn-card .topline{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  margin-bottom:8px;
}
.conn-card .status{
  font-weight:800;
}
.conn-card .tiny{
  color: var(--muted);
}

/* State colors */
.conn-online{ border-color: var(--ok); }
.conn-offline{ border-color: var(--danger); }

/* Location tab buttons */
#loc-toggle {
  background: var(--panel);
  border: 1px solid var(--border);
  color: var(--text);
}
.unit-toggle .toggle-btn,
.unit-toggle .btn-ghost {
  background: var(--panel-2);
  color: var(--text);
  border: 1px solid var(--border);
}

#conn-recheck{ margin-top:8px; }

/* Map offline callout card below the map */
#map-offline-card{ display:none; }

Â  /* Home button on Results page */
#homeBtn {
  background: var(--panel-2);
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 10px 14px;
  font-weight: 700;
  text-decoration: none;
  display: inline-block;
  transition: background .15s, transform .1s, border-color .15s;
}

#homeBtn:hover {
  background: var(--accent-2);
  color:#001528;
  transform: scale(1.02);
}

#homeBtn:active {
  background:#1b6cff;
  color:#fff;
  transform: scale(.98);
}

/* --- Category Picker (adapted from fieldnotes tags) --- */
.category-pill {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 160px;
  padding: 10px 14px;
  border-radius: 10px;
  font-weight: 700;
  cursor: pointer;
}
.category-current {
  font-size: 0.95rem;
}
.category-none {
  opacity: 0.8;
}

/* Category Overlay */
.category-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1500;
}
.category-overlay.open {
  display: flex;
}
.category-panel {
  background: var(--panel);
  border-radius: var(--radius);
  padding: 16px 16px 12px;
  width: min(520px, 92vw);
  max-height: 80vh;
  box-shadow: 0 18px 40px rgba(0,0,0,0.75);
  border: 1px solid var(--border);
  display: flex;
  flex-direction: column;
}
.category-panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  margin-bottom: 4px;
}
.category-panel-header h2 {
  font-size: 1.1rem;
  margin: 0;
}
.category-panel-intro {
  margin: 0 0 10px;
  font-size: 0.9rem;
  color: var(--muted);
}
.category-list {
  list-style: none;
  margin: 0;
  padding: 0;
  overflow-y: auto;
  flex: 1;
}
.category-option {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: var(--panel-2);
  cursor: pointer;
  margin-bottom: 8px;
  transition: background 0.12s ease, border-color 0.12s ease, transform 0.08s ease;
}
.category-option:hover {
  background: var(--panel-2);
  transform: translateY(-1px);
}
.category-text { display: flex; flex-direction: column; }
.category-name { font-size: 0.95rem; font-weight: 700; color: var(--text); }
.category-desc { font-size: 0.8rem; color: var(--muted); margin-top: 2px; }
.category-panel-footer { margin-top: 8px; display: flex; justify-content: flex-end; }
.circ-type-picker {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-top: 10px;
}

/* --- Season Picker Styles --- */
.season-pill {
  display: flex; /* Use flex to align content */
  align-items: center;
  justify-content: center;
  width: 100%;
}
.category-text { display: flex; flex-direction: column; }
.category-name { font-size: 0.95rem; font-weight: 700; color: var(--text); }
.category-desc { font-size: 0.8rem; color: var(--muted); margin-top: 2px; }
.category-panel-footer { margin-top: 8px; display: flex; justify-content: flex-end; }

/* --- Photos Tab Styles --- */
.photo-controls {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border);
}
.photo-controls > div:first-child {
  flex-grow: 1;
}
.photo-section {
  margin-bottom: 20px;
}
.photo-section-header {
  font-size: 1.05rem;
  font-weight: 700;
  color: #d6e6ff;
  margin: 0 0 10px;
  padding-bottom: 6px;
  border-bottom: 1px solid var(--border);
}
.photo-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  gap: 10px;
  min-height: 50px; /* Drop zone affordance */
  padding: 8px;
  border-radius: 12px;
  transition: background .2s, border-color .2s;
}
.photo-thumb {
  position: relative;
  aspect-ratio: 1 / 1;
  border-radius: 10px;
  overflow: hidden;
  background: var(--bg);
  border: 1px solid var(--border);
  cursor: grab;
}
.photo-thumb img {
  width: 100%; height: 100%;
  object-fit: cover;
  display: block;
}
.photo-thumb.dragging {
  opacity: 0.4;
}
.photo-thumb:active {
  cursor: grabbing;
}
.photo-remove {
  position: absolute;
  top: 4px; right: 4px;
  background: rgba(15,23,42,0.85);
  border-radius: 999px;
  width: 22px; height: 22px;
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; color: #e5edf7;
  border: 1px solid rgba(148,163,184,0.7);
  cursor: pointer;
  z-index: 2;
}

/* Drag & Drop Styles */
.drag-mode .photo-grid {
  border: 2px dashed var(--border);
}
.drag-mode .photo-grid.drag-over {
  background: var(--panel-2);
  border-color: var(--accent);
}
.drag-mode .photo-thumb {
  cursor: grab;
}
.drag-mode .photo-thumb:active {
  cursor: grabbing;
}

/* Hidden file inputs */
.file-input-hidden { display: none; }

/* Image overlay (copied from fieldnotes) */
.image-overlay{ position:fixed; inset:0; background:rgba(8,15,26,0.9); display:none; align-items:center; justify-content:center; z-index:1000; }
.image-overlay.visible{ display:flex; }
.image-overlay-inner{ max-width:92vw; max-height:88vh; display:flex; flex-direction:column; gap:8px; }
.image-overlay-inner img{ max-width:92vw; max-height:70vh; border-radius:16px; border:1px solid var(--border); box-shadow:0 18px 40px rgba(0,0,0,0.75); background:var(--bg); object-fit:contain; }
.image-overlay-actions{ display:flex; justify-content:flex-end; gap:8px; }
.image-overlay-caption {
  text-align: center;
  color: var(--muted);
  font-weight: 600;
  margin: 4px 0 0;
}
.hidden { display: none !important; }
.category-text { display: flex; flex-direction: column; }
.category-name { font-size: 0.95rem; font-weight: 700; color: var(--text); }
.category-desc { font-size: 0.8rem; color: var(--muted); margin-top: 2px; }
.category-panel-footer { margin-top: 8px; display: flex; justify-content: flex-end; }

/* --- Confirmation Modal Styles (copied from view-entry) --- */
.modal-backdrop{
  position:fixed; inset:0;
  background:rgba(0,0,0,0.65);
  display:none; align-items:center; justify-content:center;
  z-index:1100;
}
.modal-backdrop.visible{ display:flex; }
.modal{
  background:var(--panel); border-radius:var(--radius); padding:16px 18px 14px;
  border:1px solid var(--border); width:90%; max-width:360px;
  box-shadow:0 10px 30px rgba(0,0,0,0.5);
}
.modal-title{ font-size:1.1rem; font-weight:700; margin:0 0 6px; color:#eaf3ff; }
.modal-body{ font-size:0.9rem; color:var(--muted); margin-bottom:16px; line-height:1.4; }
.modal-actions{ display:flex; justify-content:flex-end; gap:10px; }
.btn-small{ font-size: 0.85rem; padding: 6px 10px; }
.btn-danger-solid { background: #e53935; color: #fff; border: 1px solid #6b0e0e; }

Â /* New smaller measurement box style */
.measurement-box {
  margin-top: 12px;
  background: #0b1a2f;
  padding: 10px 14px;
  border-radius: 12px;
}
.measurement-box h3 { margin: 0 0 6px; font-size: 0.9rem; color: var(--muted); }
.measurement-box p { margin: 2px 0; font-size: 1rem; font-weight: 600; }

/* --- Leaflet Control Styles (Working Dark Theme) --- */

/* Main Layer Control Panel Container: Forces dark background */
.leaflet-control-layers {
Â  Â  background: var(--panel-2) !important; /* !! Use !important here to override leaflet defaults !! */
Â  Â  border: 1px solid var(--border);
Â  Â  border-radius: 8px;
Â  Â  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
Â  Â  padding: 6px;Â 
Â  Â  color: var(--text);Â 
Â  Â  font-size: 0.9rem;
}
/* Round the corners of the radio buttons */
.leaflet-control-layers-selector {
Â  Â  border-radius: 4px; /* Adjust as needed for desired roundness */
}
/* Layer Labels (Text and Radio Buttons) */
.leaflet-control-layers-base label,Â 
.leaflet-control-layers-overlays label {
Â  Â  /* Ensure text is light and uses the browser's default radio layout */
Â  Â  color: var(--text);
Â  Â  padding: 4px 0;
}

/* Layer Control Separator Line */
.leaflet-control-layers-separator {Â 
Â  Â  border-top: 1px solid var(--border);Â 
Â  Â  margin: 6px 0;Â 
}
</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<script defer src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
</head>
<body>

<div class="topbar">
Â  <div class="row">
Â  Â  <div class="brand">ARA Field Tools</div>
Â  Â  <div class="inline-controls" aria-label="Global controls">
Â  Â  Â  <span class="toggle-label">Units:</span>
Â  Â  Â  <button type="button" id="unit-m"Â  class="toggle-btn active" aria-pressed="true">m</button>
Â  Â  Â  <button type="button" id="unit-ft" class="toggle-btn" aria-pressed="false">ft</button>

Â  Â  Â  <span id="acc-pill-global"
Â  Â  Â  class="acc-pill acc-red"
Â  Â  Â  aria-live="polite"
Â  Â  Â  title="Best location accuracy">
Â  Â±â€” m
</span>

Â  Â  </div>
Â  Â  <div class="tabs-inner">
Â  Â  Â  <a href="index.html" class="tab tab-icon" aria-label="Home">
Â  Â  Â  Â  <i class="fas fa-home"></i>
Â  Â  Â  </a>
Â  Â  Â  <div class="tab active" data-tab="gen">General</div>
Â  Â  Â  <div class="tab" data-tab="loc">
Â  Â  Â  Â  Location
Â  Â  Â  Â  <span id="loc-tab-dot" class="acc-dot acc-red" title="Location accuracy status"></span>
Â  Â  Â  </div>
Â  Â  Â  <div class="tab" data-tab="photos">Photos</div>
Â  Â  Â  <div class="tab" data-tab="circ">Circumference</div>
Â  Â  Â  <div class="tab" data-tab="height">Height</div>
Â  Â  Â  <div class="tab" data-tab="canopy">Canopy</div>
Â  Â  Â  <div class="tab" data-tab="results">Results</div>
Â  Â  </div>
Â  </div>
</div>

<div class="content">

Â  Â  <section id="pane-gen" class="tabpane active">
Â  Â  <div class="card">
Â  Â  Â  <div class="block">
Â  Â  Â  Â  <h2>General</h2>

Â  Â  Â  Â  <label for="treeName">Tree name</label>
Â  Â  Â  Â  <input id="treeName" type="text" placeholder="Tree name (e.g., Rossdale Poplar)">

Â  Â  Â  Â  <div class="row" style="margin-top:8px;">
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label for="species">Species</label>
Â  Â  Â  Â  Â  Â  <button type="button" id="speciesPickerBtn" class="btn-ghost category-pill">
Â  Â  Â  Â  Â  Â  Â  <span id="speciesCurrentLabel" class="category-current category-none">â€” select species â€”</span>
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label for="condition">Condition</label>
Â  Â  Â  Â  Â  Â  <button type="button" id="conditionPickerBtn" class="btn-ghost category-pill">
Â  Â  Â  Â  Â  Â  Â  <span id="conditionCurrentLabel" class="category-current category-none">â€” optional â€”</span>
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="margin-top:10px;">
Â  Â  Â  Â  Â  <label for="categoryPickerBtn">Tree Category</label>
Â  Â  Â  Â  Â  <button type="button" id="categoryPickerBtn" class="btn-ghost category-pill">
Â  Â  Â  Â  Â  Â  <span id="categoryCurrentLabel" class="category-current category-none">No category selected</span>
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  <div class="tiny">
Â  Â  Â  Â  Â  Â  Optional: Choose a category for this tree.
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <label for="notes" style="margin-top:10px;">Notes</label>
Â  Â  Â  Â  <textarea id="notes" placeholder="Observations, access notes, landmarks, hazardsâ€¦"></textarea>
Â  Â  Â  Â  <div class="tiny">Notes appear in the generated description.</div>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  Â  Â  Â Â  Â  Â  <div id="conn-card" class="card conn-card conn-online" style="margin-top:12px;">
Â  Â  Â  Â  <div class="block">
Â  Â  Â  Â  Â  <div class="topline">
Â  Â  Â  Â  Â  Â  <h3 style="margin:0;">Connectivity</h3>
Â  Â  Â  Â  Â  Â  <div class="tiny">Last checked: <span id="conn-checked">â€”</span></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <p id="conn-label" class="status">Youâ€™re online. Map tiles stream normally and email/share are enabled.</p>
Â  Â  Â  Â  Â  <div class="tiny">Autosave is local and safe.</div>
Â  Â  Â  Â  Â  <div class="btn-row" style="margin-top:8px;">
Â  Â  Â  Â  Â  Â  <button type="button" id="conn-recheck" class="btn-ghost">Re-check</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  </section>
Â  Â  <section id="pane-photos" class="tabpane">
Â  Â  <div class="card">
Â  Â  Â  <div class="block">
Â  Â  Â  Â  <div class="photo-controls btn-row">
Â  Â  Â  Â  Â  <button type="button" id="photoDeviceBtn" class="btn btn-ghost">
Â  Â  Â  Â  Â  Â  <span>ğŸ“ Add from Gallery</span>
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  <button type="button" id="photoCameraBtn" class="btn btn-ghost">
Â  Â  Â  Â  Â  Â  <span>ğŸ“· Use Camera</span>
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  <button type="button" id="dragToggleBtn" class="btn btn-ghost">
Â  Â  Â  Â  Â  Â  <span>ğŸ–ï¸</span>
Â  Â  Â  Â  Â  Â  <span>Enable Drag & Drop</span>
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  <input id="photoCamera" class="file-input-hidden" type="file" accept="image/*" capture="environment">
Â  Â  Â  Â  Â  <input id="photoDevice" class="file-input-hidden" type="file" accept="image/*" multiple>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="photo-controls">
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label for="seasonPickerBtn">Season</label>
Â  Â  Â  Â  Â  Â  <button type="button" id="seasonPickerBtn" class="btn-ghost category-pill season-pill">
Â  Â  Â  Â  Â  Â  Â  <span id="seasonCurrentLabel" class="category-current category-none">Not specified</span>
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  <p id="seasonHint" class="tiny" style="text-align: center; margin-top: 6px; margin-bottom: 0;">Select a season to see photo suggestions.</p>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="photoSectionsContainer">
Â  Â  Â  Â  Â  <div class="photo-section" data-section-id="unorganized">
Â  Â  Â  Â  Â  Â  <h3 class="photo-section-header">Unorganized Photos</h3>
Â  Â  Â  Â  Â  Â  <div class="photo-grid"></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="photo-section" data-section-id="whole_tree"><h3 class="photo-section-header">Whole Tree</h3><div class="photo-grid"></div></div>
Â  Â  Â  Â  Â  <div class="photo-section" data-section-id="leaves"><h3 class="photo-section-header">Leaves</h3><div class="photo-grid"></div></div>
Â  Â  Â  Â  Â  <div class="photo-section" data-section-id="canopy"><h3 class="photo-section-header">Canopy</h3><div class="photo-grid"></div></div>
Â  Â  Â  Â  Â  <div class="photo-section" data-section-id="bark"><h3 class="photo-section-header">Bark</h3><div class="photo-grid"></div></div>
Â  Â  Â  Â  Â  <div class="photo-section" data-section-id="flowers"><h3 class="photo-section-header">Flowers</h3><div class="photo-grid"></div></div>
Â  Â  Â  Â  Â  <div class="photo-section" data-section-id="seeds"><h3 class="photo-section-header">Seeds</h3><div class="photo-grid"></div></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </section>
Â  Â  <section id="pane-loc" class="tabpane">
Â  Â  <div class="card">
Â  Â  Â  <div class="block">
Â  Â  Â  Â  <h2>Location</h2>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="btn-row" style="flex-wrap:wrap; gap:8px;">
Â  Â  Â  Â  Â  <button type="button" id="loc-toggle" class="toggle-btn btn-primary">Start tracking</button>
Â  Â  Â  Â  Â  <button type="button" id="loc-hiacc"Â  class="toggle-btn" aria-pressed="false" title="Request highest accuracy">High accuracy</button>
Â  Â  Â  Â  Â  <button type="button" id="loc-saver"Â  class="toggle-btn" aria-pressed="false" title="Reduce update rate to save battery">Battery saver</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="results" style="margin-top:10px;">
Â  Â  Â  Â  Â  <h3 style="margin:0 0 6px;">Recent fix</h3>
Â  Â  Â  Â  Â  <p id="loc-recent-dd">DD: â€”</p>
Â  Â  Â  Â  Â  <p>Altitude: <span id="loc-recent-alt">â€”</span></p>
Â  Â  Â  Â  Â  <p>Accuracy: <span id="loc-recent-acc" class="acc-chip acc-grey">â€”</span></p>
Â  Â  Â  Â  Â  <p>Age: <span id="loc-recent-age">â€”</span></p>
Â  Â  Â  Â  Â  <p class="tiny" style="margin-top:6px;">Samples: <span id="loc-samples">0</span></p>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="results" style="margin-top:10px;">
Â  Â  Â  Â  Â  <h3 style="margin:0 0 6px;">Best so far <span id="loc-best-badge" class="badge" style="display:none;">new</span></h3>
Â  Â  Â  Â  Â  <p id="loc-best-dd">DD: â€”</p>
Â  Â  Â  Â  Â  <p>Altitude: <span id="loc-best-alt">â€”</span></p>
Â  Â  Â  Â  Â  <p>Accuracy: <span id="loc-best-acc" class="acc-chip acc-grey">â€”</span></p>
Â  Â  Â  Â  Â  <p>Time: <span id="loc-best-time">â€”</span></p>
Â  Â  Â  Â  </div>

Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="unit-toggle" style="margin-top:10px;">
Â  Â  Â  Â  Â  <button type="button" id="loc-use-recent" class="btn-ghost btn-select" disabled>Save recent</button>
Â  Â  Â  Â  Â  <button type="button" id="loc-use-best"Â  Â class="btn-ghost btn-select" disabled>Save best</button>
Â  Â  Â  Â  Â  <button type="button" id="loc-reset"Â  Â  Â  class="btn-ghost danger">Reset location</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" id="lat"><input type="hidden" id="lng"><input type="hidden" id="acc">
Â  Â  Â  Â  <span id="loc-saved-alt" data-val="" style="display:none;"></span>
Â  Â  Â  Â  <span id="loc-saved-ts" data-ts="" style="display:none;"></span>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="loc-map"></div>
Â  Â  Â  Â  <div class="map-actions">
Â  Â  Â  Â  Â  <button type="button" id="map-to-recent" class="btn-ghost">Recenter to recent</button>
Â  Â  Â  Â  Â  <button type="button" id="map-to-best"Â  Â class="btn-ghost">Recenter to best</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="map-offline-card" class="card" style="margin-top:10px; display:none;">
Â  <div class="block">
Â  Â  <h3 style="margin:0 0 6px;">Map is offline</h3>
Â  Â  <p>Tiles may not load. Areas you viewed earlier might still appear from cache.</p>
Â  </div>
</div>

Â  Â  Â  </div>
Â  Â  </div>
Â  </section>

Â  Â  <section id="pane-circ" class="tabpane">
Â  Â  <div class="card">
Â  Â  Â  <div class="block">
Â  Â  Â  Â  <h2>Circumference</h2>

Â  Â  Â  Â  <div class="circ-type-picker">
Â  Â  Â  Â  Â  <label for="treeTypePickerBtn">Tree type</label>
Â  Â  Â  Â  Â  <button type="button" id="treeTypePickerBtn" class="btn-ghost category-pill">
Â  Â  Â  Â  Â  Â  <span id="treeTypeCurrentLabel" class="category-current category-none">â€” select â€”</span>
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <select id="treeType" class="hidden">
Â  Â  Â  Â  Â  <option value="">â€” select â€”</option>
Â  Â  Â  Â  Â  <option>Single trunk tree</option>
Â  Â  Â  Â  Â  <option>Multi trunked tree</option>
Â  Â  Â  Â  Â  <option>Grove</option>
Â  Â  Â  Â  Â  <option>Forest</option>
Â  Â  Â  Â  Â  <option>Single trunk on a slope</option>
Â  Â  Â  Â  Â  <option>Clonal aspen</option>
Â  Â  Â  Â  </select>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="single-circ-block" style="display:none;margin-top:10px;">
Â  Â  Â  Â  Â  <label for="singleC">Circumference (<span class="unit-tag">m</span>)</label>
Â  Â  Â  Â  Â  <input id="singleC" type="number" step="0.01" inputmode="decimal" placeholder="e.g. 3.10">
Â  Â  Â  Â  Â  <div class="measurement-box">
Â  Â  Â  Â  Â  Â  Â  <h3>Calculated Measurement</h3>
Â  Â  Â  Â  Â  Â  Â  <p id="single-circ-result">Circumference: â€”</p>
Â  Â  Â  Â  Â  Â  Â  <p id="single-diam-result">Diameter: â€”</p>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="tiny">Diameter is calculated automatically (D = C / Ï€).</div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="slope-circ-block" style="display:none;margin-top:10px;">
Â  Â  Â  Â  Â  <div style="display: flex; flex-direction: column; gap: var(--gap);">
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <label for="slopeUpperC">Upper slope circumference (<span class="unit-tag">m</span>)</label>
Â  Â  Â  Â  Â  Â  Â  <input id="slopeUpperC" type="number" step="0.01" inputmode="decimal" placeholder="e.g. 3.15">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <label for="slopeLowerC">Lower slope circumference (<span class="unit-tag">m</span>)</label>
Â  Â  Â  Â  Â  Â  Â  <input id="slopeLowerC" type="number" step="0.01" inputmode="decimal" placeholder="e.g. 3.05">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="measurement-box">
Â  Â  Â  Â  Â  Â  Â  <h3>Calculated Measurement</h3>
Â  Â  Â  Â  Â  Â  Â  <p id="slope-circ-result">Avg. Circumference: â€”</p>
Â  Â  Â  Â  Â  Â  Â  <p id="slope-diam-result">Avg. Diameter: â€”</p>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="tiny">The average of the two circumferences is used for the final calculation.</div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="multi-block" style="display:none;margin-top:10px;">
Â  Â  Â  Â  Â  <div class="note" style="margin-bottom:10px;">
Â  Â  Â  Â  Â  Â  <strong>Multi-trunk entry:</strong> add each trunkâ€™s <em>circumference</em>. * Largest trunk counts 100%, others 50%.
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div id="mt-list" style="display:flex;flex-direction:column;gap:10px;"></div>
Â  Â  Â  Â  Â  <div class="btn-row" style="margin-top:8px;">
Â  Â  Â  Â  Â  Â  <button type="button" id="mt-add"Â  Â  class="btn-dim">Add trunk</button>
Â  Â  Â  Â  Â  Â  <button type="button" id="mt-remove" class="btn-dim">Remove last</button>
Â  Â  Â  Â  Â  Â  <button type="button" id="mt-sort"Â  Â class="btn-ghost" title="Sort by diameter (desc)">Sort by diameter</button>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <label for="mt-bulk" style="margin-top:12px;">Bulk paste (numbers + repeaters)</label>
Â  Â  Â  Â  Â  <textarea id="mt-bulk" class="mono" placeholder="Examples:
1.72, 0.98 1.10
12x0.78Â  Â (12 repeats of 0.78)
3Ã—1.50Â  Â  (Ã— also works)"></textarea>
Â  Â  Â  Â  Â  <div class="tiny">
Â  Â  Â  Â  Â  Â  Uses current unit (<span class="unit-tag">m</span>). Ignores text; keeps positive numbers only.
Â  Â  Â  Â  Â  Â  Supports <strong>NxVALUE</strong> like <strong>12x0.78</strong> or <strong>3Ã—1.5</strong>.
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="btn-row" style="margin-top:8px;">
Â  Â  Â  Â  Â  Â  <button type="button" id="mt-fill"Â  class="btn-ghost">Fill from bulk</button>
Â  Â  Â  Â  Â  Â  <button type="button" id="mt-clear" class="btn-ghost">Clear bulk</button>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div id="mt-result" class="tiny" style="margin-top:8px;color:#cfe0ff;">â€”</div>

Â  Â  Â  Â  Â  <div class="measurement-box">
Â  Â  Â  Â  Â  Â  Â  <h3>Calculated Measurement</h3>
Â  Â  Â  Â  Â  Â  Â  <p id="multi-circ-result">Equiv. Circumference: â€”</p>
Â  Â  Â  Â  Â  Â  Â  <p id="multi-diam-result">Equiv. Diameter: â€”</p>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </section>

Â  Â  <section id="pane-height" class="tabpane">
Â  Â  <div class="card">
Â  Â  Â  <div class="block">

Â  Â  Â  Â  <div class="clino-head">
Â  Â  Â  Â  Â  <h2>Height</h2>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <label for="h-angle">Angle to top of the tree (degrees)</label>
Â  Â  Â  Â  <input id="h-angle" type="number" step="0.1" inputmode="decimal" placeholder="e.g. 37.5">

Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label for="h-dist">Distance to trunk (<span class="unit-tag">m</span>)</label>
Â  Â  Â  Â  Â  Â  <input id="h-dist" type="number" step="0.01" inputmode="decimal" placeholder="e.g. 23.40">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label for="h-eye">Eye height (<span class="unit-tag">m</span>)</label>
Â  Â  Â  Â  Â  Â  <input id="h-eye" type="number" step="0.01" inputmode="decimal" placeholder="e.g. 1.62">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="measurement-box">
Â  Â  Â  Â  Â  Â  <h3>Calculated Height</h3>
Â  Â  Â  Â  Â  Â  <p id="height-result-m" style="font-size: 1.2rem;">â€” m</p>
Â  Â  Â  Â  Â  Â  <p id="height-result-ft" class="muted" style="margin-top: 2px; font-weight: normal;">â€” ft</p>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="card" id="clino-card" style="margin-top:12px;background:#10253f;">
Â  <div class="block">

Â  Â  <div class="clino-readout" id="clino-readout">
Â  <h3 style="margin:0 0 6px;">Live angle</h3>
Â  <p id="clino-live-angle" class="angle" style="margin:0;">â€”Â°</p>
Â  <p id="clino-live-status" class="status">Sensor: idle Â· Cal: 0.0Â°</p>
</div>

Â  Â  Â  Â  <div class="clino-wrap" style="margin-top:12px;">
Â  Â  Â  <button type="button" id="clino-lock" class="clino-lock">Start Clinometer</button>
Â  Â  </div>

Â  Â  Â  Â  <div class="clino-controls" style="margin-top:10px;">
Â  Â  Â  <button type="button" id="clino-zero"Â  class="btn-ghost">Zero (calibrate)</button>
Â  Â  Â  <button type="button" id="clino-reset" class="btn-ghost">Reset sensor</button>
Â  Â  </div>

Â  </div>
</div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div class="card">
Â  Â  Â  <div class="block">
Â  Â  Â  Â  <div class="tiny">
Â  Â  Â  Â  Â  Height formula: <strong>height = tan(angle) Ã— distance + eye height</strong>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </section>

Â  Â  <section id="pane-canopy" class="tabpane">
Â  Â  <div class="card">
Â  Â  Â  <div class="block">
Â  Â  Â  Â  <h2>Canopy</h2>
Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label for="spreadMajor">Major axis (<span class="unit-tag">m</span>)</label>
Â  Â  Â  Â  Â  Â  <input id="spreadMajor" type="number" step="0.01" inputmode="decimal" placeholder="e.g. 30.00">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label for="spreadMinor">Minor axis (<span class="unit-tag">m</span>)</label>
Â  Â  Â  Â  Â  Â  <input id="spreadMinor" type="number" step="0.01" inputmode="decimal" placeholder="e.g. 20.00">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="measurement-box">
Â  Â  Â  Â  Â  Â  <h3>Calculated Canopy Spread</h3>
Â  Â  Â  Â  Â  Â  <p id="canopy-result-m" style="font-size: 1.2rem;">â€” m</p>
Â  Â  Â  Â  Â  Â  <p id="canopy-result-ft" class="muted" style="margin-top: 2px; font-weight: normal;">â€” ft</p>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </section>

<section id="pane-results" class="tabpane">
Â  <div class="card">
Â  Â  <div class="block">
Â  Â  Â  <h2 id="results-title">Results</h2>

Â  Â  Â  Â  Â  Â  <div class="results" id="key-measurements" style="margin-top:6px;">
Â  Â  Â  Â  <p id="km-circ">Circumference: â€”</p>
Â  Â  Â  Â  <p id="km-height">Height: â€”</p>
Â  Â  Â  Â  <p id="km-canopy">Canopy spread: â€”</p>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="block">
Â  Â  Â  <h3>Tree description</h3>
Â  Â  Â  <div id="desc" class="results" style="margin-top:10px;">â€”</div>
Â  Â  Â  <div class="tiny" style="margin-top:6px;">Timestamp uses local 24-hour time.</div>
Â  Â  Â  Â  Â  </div>
Â  Â Â 
Â  Â  <div class="block">
Â  Â  Â  <h3>Photos</h3>
Â  Â  Â  <div id="results-photos-container" style="margin-top:6px;"></div>
Â  Â  </div>

Â  Â  <div class="block">
Â  Â  Â  <h3>Share & copy</h3>
Â  Â  Â  <div class="btn-row">
Â  Â  Â  Â  <button type="button" id="copyDesc" class="btn-ghost" disabled>Copy description</button>
Â  Â  Â  Â  <a id="emailBtn" class="btn-ghost" href="#" aria-disabled="true">Open email</a>
Â  Â  Â  </div>
Â  Â  Â  <div id="photos-note" class="tiny" style="margin-top:8px; display:none;">
Â  Â  Â  Â  <strong>Note:</strong> Photos are not included in the copied text or email and can only be viewed in the app.
Â  Â  Â  </div>
Â  Â  </div>

<div class="block">
Â  <h3>Logbook</h3>
Â  <div class="btn-row">
Â  Â  <button type="button" id="saveToLogBtn" class="btn-save">Save to Log</button>
Â  Â  <a href="logbook.html" id="viewLogBtn" class="btn-ghost">View Log</a>
Â  </div>
</div>

<div class="block">
Â  <div class="btn-row">
Â  Â  <button
Â  Â  Â  type="button"
Â  Â  Â  id="resetFormResults"
Â  Â  Â  class="btn-ghost danger"
Â  Â  Â  title="Reset the form (does not clear the log)">
Â  Â  Â  Reset form
Â  Â  </button>
Â  </div>
</div>


Â  </div>
</section>


<script>
Â  // --- Photo Overlay (copied from fieldnotes) ---
Â  (function(){
Â  Â  const overlayHTML = `
Â  Â  Â  <div id="imageOverlay" class="image-overlay" aria-hidden="true">
Â  Â  Â  Â  <div class="image-overlay-inner">
Â  Â  Â  Â  Â  <img id="overlayImg" alt="Expanded photo">
Â  Â  Â  Â  Â  <p id="overlayCaption" class="image-overlay-caption"></p>
Â  Â  Â  Â  Â  <div class="image-overlay-actions">
Â  Â  Â  Â  Â  Â  <button type="button" id="overlayClose" class="btn-ghost btn-small">Close</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  `;
Â  Â  document.body.insertAdjacentHTML('beforeend', overlayHTML);

Â  Â  const overlay = document.getElementById('imageOverlay');
Â  Â  const closeBtn = document.getElementById('overlayClose');

Â  Â  function closeOverlay() {
Â  Â  Â  overlay.classList.remove('visible');
Â  Â  Â  overlay.setAttribute('aria-hidden', 'true');
Â  Â  }

Â  Â  closeBtn.addEventListener('click', closeOverlay);
Â  Â  overlay.addEventListener('click', (e) => {
Â  Â  Â  if (e.target === overlay) closeOverlay();
Â  Â  });

Â  Â  window.openPhotoOverlay = function(src, sectionId) {
Â  Â  Â  const img = document.getElementById('overlayImg');
Â  Â  Â  const caption = document.getElementById('overlayCaption');
Â  Â  Â  img.src = src;

Â  Â  Â  const sectionNames = {
Â  Â  Â  Â  unorganized: 'Unorganized Photo',
Â  Â  Â  Â  whole_tree: 'Whole Tree',
Â  Â  Â  Â  leaves: 'Leaves',
Â  Â  Â  Â  canopy: 'Canopy',
Â  Â  Â  Â  bark: 'Bark',
Â  Â  Â  Â  flowers: 'Flowers',
Â  Â  Â  Â  seeds: 'Seeds'
Â  Â  Â  };
Â  Â  Â  caption.textContent = sectionNames[sectionId] || '';

Â  Â  Â  overlay.classList.add('visible');
Â  Â  Â  overlay.setAttribute('aria-hidden', 'false');
Â  Â  }
Â  })();

Â  // This is a new script block for the category picker
Â  (function(){
Â  Â  const categoryData = [
Â  Â  Â  { id: 'champion', name: 'Champion', desc: 'Tree recognized as the largest or most outstanding of its species.', color: 'var(--cat-champion)' },
Â  Â  Â  { id: 'centurion', name: 'Centurion', desc: 'An exceptionally old tree that has lived for a century or more.', color: 'var(--cat-centurion)' },
Â  Â  Â  { id: 'storyteller', name: 'Storyteller', desc: 'A tree connected to local history, legends, or meaningful community stories.', color: 'var(--cat-storyteller)' },
Â  Â  Â  { id: 'ancient', name: 'Ancient Trees', desc: 'Very old trees that show age through form, bark, or growth history.', color: 'var(--cat-ancient)' },
Â  Â  Â  { id: 'unique-growth', name: 'Unique Growth Pattern', desc: 'A tree with unusual shapes, fusions, twists, or structural quirks.', color: 'var(--cat-unique-growth)' },
Â  Â  Â  { id: 'tall', name: 'Tall Trees', desc: 'Specimens notable for extraordinary height.', color: 'var(--cat-tall)' },
Â  Â  Â  { id: 'large-circ', name: 'Large Circumference', desc: 'Trees that have exceptionally thick or massive trunks.', color: 'var(--cat-large-circ)' },
Â  Â  Â  { id: 'past', name: 'Tree of the Past', desc: 'Dead, fallen, or remnant trees that still have ecological or historical value.', color: 'var(--cat-past)' },
Â  Â  Â  { id: 'gathering', name: 'Gathering Information', desc: 'Trees that act as meeting points, landmarks, or research anchors.', color: 'var(--cat-gathering)' },
Â  Â  Â  { id: 'edible', name: 'Edible Fruit', desc: 'Trees known for producing fruit eaten by people or wildlife.', color: 'var(--cat-edible)' },
Â  Â  Â  { id: 'prime', name: 'Prime Species Example', desc: 'A tree that perfectly represents the typical traits of its species.', color: 'var(--cat-prime)' },
Â  Â  Â  { id: 'unique-loc', name: 'Unique Growth Location', desc: 'Trees growing in rare, surprising, or harsh environments.', color: 'var(--cat-unique-loc)' }
Â  Â  ];

Â  Â  // Create the overlay and inject it into the body
Â  Â  const overlayHTML = `
Â  Â  Â  <div id="categoryOverlay" class="category-overlay">
Â  Â  Â  Â  <div class="category-panel">
Â  Â  Â  Â  Â  <header class="category-panel-header">
Â  Â  Â  Â  Â  Â  <h2>Choose a category</h2>
Â  Â  Â  Â  Â  Â  <button type="button" class="btn-ghost" id="categoryCloseBtn">Close</button>
Â  Â  Â  Â  Â  </header>
Â  Â  Â  Â  Â  <p class="category-panel-intro">Pick one category for this tree. You can change it anytime.</p>
Â  Â  Â  Â  Â  <ul class="category-list" id="categoryList"></ul>
Â  Â  Â  Â  Â  <div class="category-panel-footer">
Â  Â  Â  Â  Â  Â  <button type="button" class="btn-ghost" id="categoryClearBtn">Clear category</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  `;
Â  Â  document.body.insertAdjacentHTML('beforeend', overlayHTML);

Â  Â  const categoryList = document.getElementById('categoryList');
Â  Â  categoryData.forEach(cat => {
Â  Â  Â  const li = document.createElement('li');
Â  Â  Â  li.className = 'category-option';
Â  Â  Â  li.dataset.categoryId = cat.id;
Â  Â  Â  li.dataset.categoryName = cat.name;
Â  Â  Â  li.dataset.categoryColor = cat.color;
Â  Â  Â  li.style.borderColor = cat.color;
Â  Â  Â  li.innerHTML = `
Â  Â  Â  Â  <div class="category-text">
Â  Â  Â  Â  Â  <div class="category-name">${cat.name}</div>
Â  Â  Â  Â  Â  <div class="category-desc">${cat.desc}</div>
Â  Â  Â  Â  </div>
Â  Â  Â  `;
Â  Â  Â  categoryList.appendChild(li);
Â  Â  });

Â  Â  // Expose a map of categories for easy lookup elsewhere
Â  Â  const categoryMap = new Map(categoryData.map(c => [c.id, c]));
Â  Â  window.ARA_CATEGORY_MAP = categoryMap;
Â  })();

Â  // --- Photo Remove Confirmation Modal ---
Â  (function(){
Â  Â  const modalHTML = `
Â  Â  Â  <div id="photoRemoveModal" class="modal-backdrop">
Â  Â  Â  Â  <div class="modal">
Â  Â  Â  Â  Â  <h3 class="modal-title">Remove photo?</h3>
Â  Â  Â  Â  Â  <div class="modal-body" style="text-align: center;">
Â  Â  Â  Â  Â  Â  <img id="photoRemovePreview" src="" style="max-width: 100%; max-height: 150px; border-radius: 8px; margin-bottom: 12px;">
Â  Â  Â  Â  Â  Â  <p>Are you sure you want to remove this photo? This cannot be undone.</p>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="modal-actions">
Â  Â  Â  Â  Â  Â  <button type="button" id="photoRemoveCancelBtn" class="btn-ghost btn-small">Cancel</button>
Â  Â  Â  Â  Â  Â  <button type="button" id="photoRemoveConfirmBtn" class="btn-danger-solid btn-small">Remove</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>`;
Â  Â  document.body.insertAdjacentHTML('beforeend', modalHTML);
Â  })();
</script>
<script>
Â  // --- Species Picker Modal ---
Â  (function(){
Â  Â  const modalHTML = `
Â  Â  Â  <div id="speciesOverlay" class="modal-backdrop">
Â  Â  Â  Â  <div class="modal" style="max-width: 500px;">
Â  Â  Â  Â  Â  <h3 class="modal-title">Select Species</h3>
Â  Â  Â  Â  Â  <input id="speciesSearchInput" type="search" placeholder="Search species..." style="margin-bottom: 12px; width: 100%;">
Â  Â  Â  Â  Â  <div id="speciesList" style="max-height: 50vh; overflow-y: auto; padding-right: 8px;">
Â  Â  Â  Â  Â  Â  <div class="modal-body">Loading species...</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="modal-actions" style="margin-top: 12px;">
Â  Â  Â  Â  Â  Â  <button type="button" id="speciesCloseBtn" class="btn-ghost btn-small">Close</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>`;
Â  Â  document.body.insertAdjacentHTML('beforeend', modalHTML);
Â  })();
</script>
<script>
Â  if (window.Capacitor?.isNativePlatform?.()) {
Â  Â  window.Capacitor.Plugins?.StatusBar?.setOverlaysWebView?.({ overlay: false });
Â  }
</script>

<script>
/* -------- small helpers (no optional chaining) -------- */
window.ARA_RESETTING = false;
function $(s){ return document.querySelector(s); }
function $all(s){ return Array.prototype.slice.call(document.querySelectorAll(s)); }
function byId(id){ return document.getElementById(id); }
function has(el){ return !!el; }

/* ---------------- Core helpers ---------------- */
const PI=Math.PI, FT_PER_M=3.28084, M_PER_FT=0.3048;
const tanDeg=d=>Math.tan(d*Math.PI/180);
const fmt2=x=>Number.isFinite(x)?x.toFixed(2):'â€”', fmt1=x=>Number.isFinite(x)?x.toFixed(1):'â€”';
const toM=(v,u)=>u==='m'?v:v*M_PER_FT, mToFt=m=>m*FT_PER_M;
const nowLocal24=()=>{var d=new Date();var p=n=>String(n).padStart(2,'0');return d.getFullYear()+"-"+p(d.getMonth()+1)+"-"+p(d.getDate())+" "+p(d.getHours())+":"+p(d.getMinutes());};
const escapeHtml=s=>String(s||'').replace(/[&<>"']/g,function(c){return {'&':'&','<':'<','>':'>','"':'"',"'":'''}[c]});

/* DMS helper for description */
function toDMS(dec, isLat){
Â  if (!Number.isFinite(dec)) return 'â€”';
Â  var hemi = dec >= 0 ? (isLat ? 'N' : 'E') : (isLat ? 'S' : 'W');
Â  var v = Math.abs(dec);
Â  var d = Math.floor(v); v = (v - d) * 60;
Â  var m = Math.floor(v); var s = (v - m) * 60;
Â  return d+'Â° '+m+"' "+s.toFixed(2)+'" '+hemi;
}

Â  function updateKeyMeasurementsBox(){
Â  const title = byId('results-title');
Â  const nameÂ  = byId('treeName')?.value?.trim();

Â  const kmCircÂ  Â = byId('km-circ');
Â  const kmHeight = byId('km-height');
Â  const kmCanopy = byId('km-canopy');

Â  const t = byId('treeType')?.value || '';

Â  // Circumference line
Â  if ((t === 'Single trunk tree' || t === 'Single trunk on a slope') && lastSingle){
Â  Â  kmCirc && (kmCirc.textContent = `Circumference: ${fmt2(lastSingle.cM)} m (${fmt2(lastSingle.cFt)} ft)`);
Â  } else if (t === 'Multi trunked tree' && lastMulti){
Â  Â  kmCirc && (kmCirc.textContent = `Equivalent circumference: ${fmt2(lastMulti.cEqM)} m (${fmt2(lastMulti.cEqFt)} ft)`);
Â  } else {
Â  Â  kmCirc && (kmCirc.textContent = 'Circumference: â€”');
Â  }

Â  // Height
Â  kmHeight && (kmHeight.textContent =
Â  Â  lastHeight ? `Height: ${fmt2(lastHeight.hM)} m (${fmt2(lastHeight.hFt)} ft)` : 'Height: â€”'
Â  );

Â  // Canopy
Â  kmCanopy && (kmCanopy.textContent =
Â  Â  lastSpread ? `Canopy spread: ${fmt2(lastSpread.meanM)} m (${fmt2(lastSpread.meanFt)} ft)` : 'Canopy spread: â€”'
Â  );
}
function wireAutosaveInputs(){
Â  // Any input/change should schedule a (debounced) save.
Â  const selectors = 'input, select, textarea';
Â  document.querySelectorAll(selectors).forEach(el=>{
Â  Â  el.addEventListener('input', autoSaveSoon);
Â  Â  el.addEventListener('change', autoSaveSoon);
Â  });

Â  // OPTIONAL: live description refresh on *any* edit
Â  document.addEventListener('input', function(e){
Â  Â  // keep this lightweight â€” rebuild once per user edit
Â  Â  if (typeof refreshResultsView === 'function') refreshResultsView();
Â  });
}


function renderResultsPhotos() {
Â  const container = byId('results-photos-container');
Â  if (!container) return;

Â  const photosState = (typeof window.getPhotosState === 'function') ? window.getPhotosState() : null;
Â  const photos = photosState?.items || [];

Â  if (!photos || photos.length === 0) {
Â  Â  container.innerHTML = '<div class="note">No photos have been added.</div>';
Â  Â  return;
Â  }

Â  // Create a single 3-column grid for all photos
Â  let html = `<div class="photo-grid results-photo-grid">`;
Â  html += photos.map(p =>Â 
Â  Â  `<div class="photo-thumb" onclick="window.openPhotoOverlay('${p.src}', '${p.section}')">
Â  Â  Â  Â <img src="${p.src}" alt="Photo thumbnail">
Â  Â  Â </div>`
Â  ).join('');
Â  html += `</div>`;
Â  container.innerHTML = html;
}

function updateAllDisplays() {
Â  updateKeyMeasurementsBox(); // Updates the "Key Measurements" box on the Results tab.
Â  generateDescription();Â  Â  Â  // Generates the full text description for the Results tab.
Â  renderResultsPhotos();Â  Â  Â  // Renders photo thumbnails on the Results tab.
Â  updateCopyButtons();Â  Â  Â  Â  // Enables/disables copy buttons based on available data.
Â  autoSaveSoon();Â  Â  Â  Â  Â  Â  Â // Schedules an autosave to catch any other non-photo changes.
}

function computeMissingBits(){
Â  const missing = [];
Â  const t = byId('treeType')?.value || '';
Â  if (t === 'Single trunk tree'){
Â  Â  if (!lastSingle) missing.push('circumference (single trunk)');
Â  } else if (t === 'Single trunk on a slope'){
Â  Â  if (!lastSingle) missing.push('circumference (single trunk)');
Â  } else if (t === 'Multi trunked tree'){
Â  Â  if (!lastMulti) missing.push('multi-trunk entry / calculation');
Â  } else if (!t){
Â  Â  missing.push('tree type');
Â  }
Â  if (!lastHeight) missing.push('height');
Â  if (!lastSpread) missing.push('canopy spread');
Â  return missing;
}

/* ---------------- State ---------------- */
var inputUnit='m', calcMode='auto';
var lastSingle=null, lastMulti=null, lastHeight=null, lastSpread=null;

/* ---------------- Header controls ---------------- */
var unitM=byId('unit-m'), unitFt=byId('unit-ft');
var unitTags=$all('.unit-tag');

function setUnit(u){
Â  if(u===inputUnit) return;
Â  function conv(inp){ if(!inp) return; var v=parseFloat(inp.value); if(!Number.isNaN(v)){ var m=toM(v,inputUnit); inp.value=(u==='m'?m:m*FT_PER_M).toFixed(2); } }
Â  [byId('singleC'), byId('h-dist'), byId('h-eye'), byId('spreadMajor'), byId('spreadMinor')].forEach(conv);
Â  $all('#mt-list input[type="number"]').forEach(conv);
Â  inputUnit=u;
Â  var isM=u==='m';
Â  if(unitM){ unitM.classList.toggle('active',isM); unitM.setAttribute('aria-pressed',String(isM)); }
Â  if(unitFt){ unitFt.classList.toggle('active',!isM); unitFt.setAttribute('aria-pressed',String(!isM)); }
Â  unitTags.forEach(function(t){ t.textContent=isM?'m':'ft'; });
Â  renumberTrunks();
Â  var tt = byId('treeType') ? byId('treeType').value : '';
Â  if(tt==='Single trunk tree') recomputeSingle();
Â  if(tt==='Multi trunked tree') calcMulti();
Â  calcHeight();Â 
Â  calcSpread();
Â  updateAllDisplays();
}
if(unitM) unitM.onclick=function(){ setUnit('m'); };
if(unitFt) unitFt.onclick=function(){ setUnit('ft'); };

/* ---------------- Tabs ---------------- */
$all('.tab').forEach(function(tab){
Â  tab.addEventListener('click', function(){
Â  Â  $all('.tab').forEach(function(t){ t.classList.remove('active'); });
Â  Â  tab.classList.add('active');
Â  Â  var id = tab.getAttribute('data-tab');
Â  Â  $all('.tabpane').forEach(function(p){ p.classList.remove('active'); });
Â  Â  var pane = byId('pane-'+id); if(pane) pane.classList.add('active');
Â  Â  window.scrollTo({top:0,behavior:'smooth'});
Â  Â  if (id === 'loc' && typeof window.invalidateMapSize === 'function') window.invalidateMapSize();
Â  });
});

/* ---------------- General ---------------- */
var notesEl = byId('notes');
function autoGrow(el){ if(!el) return; el.style.height='auto'; el.style.height=(el.scrollHeight+2)+'px'; }
if(notesEl) notesEl.addEventListener('input',function(){ autoGrow(notesEl); });

/* ---------------- Circumference ---------------- */
var treeType=byId('treeType'), singleBlock=byId('single-circ-block'), singleC=byId('singleC');
var slopeBlock=byId('slope-circ-block'), slopeUpperC=byId('slopeUpperC'), slopeLowerC=byId('slopeLowerC');
var singleUpdateBtn = byId('single-update');

var mtBlock=byId('multi-block'), mtList=byId('mt-list'), mtAdd=byId('mt-add'), mtRemove=byId('mt-remove'),
Â  Â  mtSort=byId('mt-sort'), mtCalc=byId('mt-calc'), mtBulk=byId('mt-bulk'), mtFill=byId('mt-fill'),
Â  Â  mtClear=byId('mt-clear'), mtResult=byId('mt-result');

function updateTypeVisibility(){
Â  var t=treeType ? treeType.value : '';
Â  if(slopeBlock)Â  slopeBlock.style.display=(t==='Single trunk on a slope')?'':'none';
Â  if(singleBlock) singleBlock.style.display=(t==='Single trunk tree')?'':'none';
Â  if(mtBlock)Â  Â  Â mtBlock.style.display=(t==='Multi trunked tree')?'':'none';
Â  if (t==='Multi trunked tree' && mtList && mtList.children.length===0){ addMtRow(); addMtRow(); }
Â  updateAllDisplays();
}
if(treeType) treeType.onchange=updateTypeVisibility;

/* Single trunk */
function recomputeSingle(){
Â  var v=parseFloat(singleC && singleC.value);
Â  if(Number.isFinite(v)&&v>0){ var cM=toM(v,inputUnit); var dM=cM/PI; lastSingle={cM:cM,cFt:mToFt(cM),dM:dM,dFt:mToFt(dM)}; }
Â  else lastSingle=null;
Â  const circRes = byId('single-circ-result');
Â  const diamRes = byId('single-diam-result');
Â  if (circRes && diamRes) {
Â  Â  if (lastSingle) {
Â  Â  Â  circRes.innerHTML = `Circumference: ${fmt2(lastSingle.cM)} m (${fmt2(lastSingle.cFt)} ft)`;
Â  Â  Â  diamRes.innerHTML = `Diameter: ${fmt2(lastSingle.dM)} m (${fmt2(lastSingle.dFt)} ft)`;
Â  Â  } else {
Â  Â  Â  circRes.textContent = 'Circumference: â€”';
Â  Â  Â  diamRes.textContent = 'Diameter: â€”';
Â  Â  }
Â  }
Â  updateAllDisplays();
}
if(singleC) singleC.addEventListener('input', recomputeSingle);

/* Single trunk on slope */
function recomputeSlope(){
Â  var upperVal = parseFloat(slopeUpperC && slopeUpperC.value);
Â  var lowerVal = parseFloat(slopeLowerC && slopeLowerC.value);
Â  if(Number.isFinite(upperVal) && upperVal > 0 && Number.isFinite(lowerVal) && lowerVal > 0){
Â  Â  var avgC = (upperVal + lowerVal) / 2;
Â  Â  var cM = toM(avgC, inputUnit);
Â  Â  var dM = cM / PI;
Â  Â  lastSingle = {
Â  Â  Â  cM: cM, cFt: mToFt(cM), dM: dM, dFt: mToFt(dM),
Â  Â  Â  // Store the original slope values for the results page
Â  Â  Â  isSlope: true,
Â  Â  Â  upperM: toM(upperVal, inputUnit),
Â  Â  Â  lowerM: toM(lowerVal, inputUnit)
Â  Â  };
Â  } else { lastSingle = null; }
Â  const circRes = byId('slope-circ-result');
Â  const diamRes = byId('slope-diam-result');
Â  if (circRes && diamRes) {
Â  Â  if (lastSingle) {
Â  Â  Â  circRes.innerHTML = `Avg. Circumference: ${fmt2(lastSingle.cM)} m (${fmt2(lastSingle.cFt)} ft)`;
Â  Â  Â  diamRes.innerHTML = `Avg. Diameter: ${fmt2(lastSingle.dM)} m (${fmt2(lastSingle.dFt)} ft)`;
Â  Â  } else {
Â  Â  Â  circRes.textContent = 'Avg. Circumference: â€”';
Â  Â  Â  diamRes.textContent = 'Avg. Diameter: â€”';
Â  Â  }
Â  }
Â  updateAllDisplays();
}
if(slopeUpperC) slopeUpperC.addEventListener('input', recomputeSlope);
if(slopeLowerC) slopeLowerC.addEventListener('input', recomputeSlope);

/* Multi-trunk block */
var MT_MAX=60;
function getMtRows(){ return mtList ? Array.prototype.slice.call(mtList.querySelectorAll('.mt-row')) : []; }
function renumberTrunks(){
Â  var rows = getMtRows();
Â  rows.forEach(function(row, i){
Â  Â  var idx=i+1;
Â  Â  row.dataset.index=String(idx);
Â  Â  var lab=row.querySelector('.mt-label');
Â  Â  var inp=row.querySelector('input[type="number"]');
Â  Â  if (inp) inp.id='mt-'+idx;
Â  Â  if (lab){ lab.htmlFor='mt-'+idx; lab.textContent='Trunk '+idx+' circumference ('+inputUnit+')'; }
Â  });
}
function addMtRow(val){
Â  if(!mtList) return;
Â  if (getMtRows().length >= MT_MAX) return;
Â  var row=document.createElement('div');
Â  row.className='row mt-row'; row.style.gridTemplateColumns='1fr';
Â  var top=document.createElement('div');
Â  top.style.display='flex'; top.style.alignItems='center';
Â  var lab=document.createElement('label'); lab.className='mt-label';
Â  var badge=document.createElement('span'); badge.className='badge hide'; badge.textContent='Largest';
Â  var inp=document.createElement('input'); inp.type='number'; inp.step='0.01'; inp.inputMode='decimal'; if(val!==undefined && val!=='') inp.value=val;
Â  var hint=document.createElement('div'); hint.className='hint';
Â  top.appendChild(lab); top.appendChild(badge);
Â  row.appendChild(top); row.appendChild(inp); row.appendChild(hint);
Â  mtList.appendChild(row);
Â  inp.addEventListener('input',function(){ hint.classList.remove('show'); calcMulti(); });
Â  inp.addEventListener('blur',function(){ maybeMtOutlierHint(parseFloat(inp.value),hint); });
Â  renumberTrunks();
}
function removeMtRow(){
Â  var rows=getMtRows(); if(rows.length<=1) return;
Â  rows[rows.length-1].remove(); clearMtLargest(); renumberTrunks();
Â  calcMulti();
}
function maybeMtOutlierHint(val,h){
Â  if(!h) return;
Â  if(!Number.isFinite(val)||val<=0){h.classList.remove('show');return}
Â  if(inputUnit==='m'){
Â  Â  if(val<0.20){h.textContent='Unusually small â€” check units/decimal?';h.classList.add('show');}
Â  Â  else if(val>12){h.textContent='Unusually large â€” check units?';h.classList.add('show');}
Â  Â  else h.classList.remove('show');
Â  } else {
Â  Â  if(val<0.66){h.textContent='Unusually small â€” check units/decimal?';h.classList.add('show');}
Â  Â  else if(val>40){h.textContent='Unusually large â€” check units?';h.classList.add('show');}
Â  Â  else h.classList.remove('show');
Â  }
}
function parseMtBulk(text,limit){
Â  limit = limit||MT_MAX;
Â  var vals=[]; if(!text) return vals; var s=String(text).replace(/[Ã—X]/g,'x');
Â  var repRE=/(\d+)\s*x\s*([-+]?\d*\.?\d+)/g, m;
Â  s=s.replace(repRE,function(_,nStr,vStr){
Â  Â  var n=parseInt(nStr,10), v=parseFloat(vStr);
Â  Â  if(Number.isFinite(n)&&n>0&&Number.isFinite(v)&&v>0){ for(var i=0;i<n&&vals.length<limit;i++) vals.push(v); }
Â  Â  return ' ';
Â  });
Â  var singles=s.match(/[-+]?\d*\.?\d+/g)||[];
Â  for(var j=0;j<singles.length && vals.length<limit;j++){
Â  Â  var v=parseFloat(singles[j]); if(Number.isFinite(v)&&v>0) vals.push(v);
Â  }
Â  return vals;
}
function mtFillFromBulk(){
Â  if(!mtFill) return;
Â  mtFill.classList.add('active');
Â  var vals=parseMtBulk(mtBulk?mtBulk.value:'',MT_MAX);
Â  if(vals.length===0){ setTimeout(function(){ mtFill.classList.remove('active'); }, 500); return; }
Â  if(mtList) mtList.innerHTML='';
Â  vals.forEach(function(v){ addMtRow(v.toFixed(2)); });
Â  if(mtResult) mtResult.textContent='â€”';
Â  calcMulti();
Â  renumberTrunks();
Â  setTimeout(function(){ mtFill.classList.remove('active'); }, 900);
}
function mtSortByDiameter(){
Â  if(!mtList) return;
Â  var rows=Array.prototype.slice.call(mtList.children);
Â  var valid=[], invalid=[];
Â  rows.forEach(function(row){
Â  Â  var inp=row.querySelector('input[type="number"]'); var v=parseFloat(inp && inp.value);
Â  Â  if(Number.isFinite(v)&&v>0){ var cM=toM(v,inputUnit), dM=cM/PI; valid.push({row:row,dM:dM}); }
Â  Â  else invalid.push(row);
Â  });
Â  if(valid.length<2){ renumberTrunks(); return; }
Â  valid.sort(function(a,b){ return b.dM-a.dM; });
Â  var frag=document.createDocumentFragment(); valid.forEach(function(v){ frag.appendChild(v.row); }); invalid.forEach(function(r){ frag.appendChild(r); });
Â  mtList.innerHTML=''; mtList.appendChild(frag);
Â  clearMtLargest(); renumberTrunks();
Â  calcMulti();
}
function clearMtLargest(){
Â  if(!mtList) return;
Â  mtList.querySelectorAll('.mt-label').forEach(function(el){ el.classList.remove('largest-label'); });
Â  mtList.querySelectorAll('.badge').forEach(function(b){ b.classList.add('hide'); b.textContent='Largest'; });
}
function calcMulti(){
Â  clearMtLargest();
Â  var items=mtList ? Array.prototype.slice.call(mtList.querySelectorAll('input')) : [];
Â  var valid=items.map(function(inp){ return {inp:inp,val:parseFloat(inp.value),row:inp.closest('.row')} })
Â  Â  .filter(function(o){ return Number.isFinite(o.val)&&o.val>0; });
Â  if(valid.length===0){ lastMulti=null; if(mtResult) mtResult.textContent='Enter at least one trunk circumference.';
Â  updateAllDisplays();
Â return;
Â  }
Â  var withD=valid.map(function(r,i){ var cM=toM(r.val,inputUnit); var dM=cM/PI; return {row:r.row,cM:cM,dM:dM,idx:i+1}; });
Â  var eps=1e-9; var dmax=Math.max.apply(null,withD.map(function(x){return x.dM;}));
Â  var maxRows=withD.filter(function(x){ return Math.abs(x.dM-dmax)<eps; });
Â  var sumAll=withD.reduce(function(a,x){return a+x.dM;},0);
Â  var dEqM=dmax+0.5*(sumAll-dmax); var cEqM=dEqM*PI; var cAvgM=withD.reduce(function(a,x){return a+x.cM;},0)/withD.length;
Â  var badgeText=(maxRows.length>1)?'Tied for largest':'Largest';
Â  maxRows.forEach(function(r){
Â  Â  var lab=r.row.querySelector('.mt-label'); var badge=r.row.querySelector('.badge');
Â  Â  if(lab) lab.classList.add('largest-label'); if(badge){ badge.textContent=badgeText; badge.classList.remove('hide'); }
Â  });
Â  lastMulti={
Â  Â  trunks: withD.map(function(t){ return {index:t.idx,cM:t.cM,cFt:mToFt(t.cM),dM:t.dM,dFt:mToFt(t.dM),isLargest:Math.abs(t.dM-dmax)<eps}; }),
Â  Â  dEqM:dEqM, cEqM:cEqM, dEqFt:mToFt(dEqM), cEqFt:mToFt(cEqM),
Â  Â  cAvgM:cAvgM, cAvgFt:mToFt(cAvgM), tie:maxRows.length>1
Â  };
Â  if(mtResult) mtResult.textContent='Calculated '+withD.length+' trunk'+(withD.length>1?'s':'')+'.';
Â  const circRes = byId('multi-circ-result');
Â  const diamRes = byId('multi-diam-result');
Â  if (circRes && diamRes) {
Â  Â  if (lastMulti) {
Â  Â  Â  circRes.innerHTML = `Equiv. Circumference: ${fmt2(lastMulti.cEqM)} m (${fmt2(lastMulti.cEqFt)} ft)`;
Â  Â  Â  diamRes.innerHTML = `Equiv. Diameter: ${fmt2(lastMulti.dEqM)} m (${fmt2(lastMulti.dEqFt)} ft)`;
Â  Â  } else {
Â  Â  Â  circRes.textContent = 'Equiv. Circumference: â€”';
Â  Â  Â  diamRes.textContent = 'Equiv. Diameter: â€”';
Â  Â  }
Â  }
Â  updateAllDisplays();
}
if(mtAdd)Â  Â  mtAdd.onclick=function(){ addMtRow(); };
if(mtRemove) mtRemove.onclick=function(){ removeMtRow(); };
if(mtSort)Â  Â mtSort.onclick=mtSortByDiameter;
if(mtFill)Â  Â mtFill.onclick=mtFillFromBulk;
if(mtClear)Â  mtClear.onclick=function(){ if(mtBulk) mtBulk.value=''; };

/* ---------------- Height ---------------- */
var hAngle=byId('h-angle'), hDist=byId('h-dist'), hEye=byId('h-eye'), hCalc=byId('h-calc');
function calcHeight(){
Â  var a=parseFloat(hAngle && hAngle.value), d=parseFloat(hDist && hDist.value), e=parseFloat(hEye && hEye.value);
Â  if(!Number.isFinite(a)||!Number.isFinite(d)||!Number.isFinite(e)){
Â  Â  lastHeight=null;
Â  Â  byId('height-result-m').textContent = 'â€” m';
Â  Â  byId('height-result-ft').textContent = 'â€” ft';
Â  Â  updateAllDisplays(); return; }
Â  var dM = toM(d, inputUnit), eM = toM(e, inputUnit);
Â  var hM = tanDeg(a) * dM + eM;
Â  lastHeight = { hM: hM, hFt: mToFt(hM), angleDeg: Number(a.toFixed(1)), dM: dM, eM: eM };
Â  byId('height-result-m').textContent = `${fmt2(hM)} m`;
Â  byId('height-result-ft').textContent = `${fmt2(mToFt(hM))} ft`;
Â  updateAllDisplays();
}
[hAngle,hDist,hEye].forEach(function(inp){ if(inp) inp.addEventListener('input', calcHeight); });

Â  /* ---------------- Canopy ---------------- */
var spreadMajor = byId('spreadMajor'),
Â  Â  spreadMinor = byId('spreadMinor'),
Â  Â  spreadCalcBtn = byId('spread-calc');

function calcSpread(){
Â  var maj = parseFloat(spreadMajor && spreadMajor.value);
Â  var min = parseFloat(spreadMinor && spreadMinor.value);

Â  if (!Number.isFinite(maj) || !Number.isFinite(min) || maj <= 0 || min <= 0){
Â  Â  byId('canopy-result-m').textContent = 'â€” m';
Â  Â  byId('canopy-result-ft').textContent = 'â€” ft';
Â  Â  lastSpread = null;
Â  Â  updateAllDisplays();
Â  Â  return;
Â  }

Â  // Convert to meters if needed
Â  var majM = toM(maj, inputUnit);
Â  var minM = toM(min, inputUnit);
Â  var meanM = (majM + minM) / 2;

Â  lastSpread = {
Â  Â  majorM: majM,
Â  Â  minorM: minM,
Â  Â  meanM: meanM,
Â  Â  meanFt: mToFt(meanM)
Â  };
Â  byId('canopy-result-m').textContent = `${fmt2(lastSpread.meanM)} m`;
Â  byId('canopy-result-ft').textContent = `${fmt2(lastSpread.meanFt)} ft`;
Â  updateAllDisplays();
}

// Hook up events
[spreadMajor, spreadMinor].forEach(function(inp){
Â  if (inp) inp.addEventListener('input', function(){
Â  Â  calcSpread();
Â  });
});

const elLockÂ  Â  Â  Â = document.getElementById('clino-lock');
const elZeroÂ  Â  Â  Â = document.getElementById('clino-zero');
const elResetÂ  Â  Â  = document.getElementById('clino-reset');
const elReadAngleÂ  = document.getElementById('clino-live-angle');
const elReadStatus = document.getElementById('clino-live-status');

const toDeg = rad => rad * 180 / Math.PI;
/* ---------------- Clinometer (single-button start/lock) ---------------- */
let clinoOn = false, zeroOffsetRad = 0, locked = false;
let lastLiveDeg = NaN; // current live (unlocked) reading in degrees

const clamp = (x, a, b) => Math.min(b, Math.max(a, x));
function buzz(ms = 30){ if(navigator.vibrate) try{ navigator.vibrate(ms); }catch{} }

async function requestIOSPermissionIfNeeded(){
Â  const any = window.DeviceOrientationEvent;
Â  if(!any) return true;
Â  if(typeof any.requestPermission === 'function'){
Â  Â  try { return (await any.requestPermission()) === 'granted'; } catch { return false; }
Â  }
Â  return true;
}

function computePitchFromEvent(ev){
Â  const beta = typeof ev.beta === 'number' ? ev.beta : 0;
Â  const radÂ  = (beta * Math.PI/180) - zeroOffsetRad;
Â  return clamp(toDeg(rad), -89.9, 89.9);
}

function renderClinoReadout(deg){
Â  lastLiveDeg = deg; // store latest live value
Â  const txt = Number.isFinite(deg) ? fmt1(deg) + 'Â°' : 'â€”Â°';
Â  elReadAngle.textContent = locked ? `${txt} (locked)` : txt;
}

function renderClinoStatus(state){
Â  const label = state === 'running'Â  Â ? 'Sensor: running'
Â  Â  Â  Â  Â  Â  Â  : state === 'stopped'Â  Â ? 'Sensor: stopped'
Â  Â  Â  Â  Â  Â  Â  : state === 'permission'? 'Sensor: permission denied'
Â  Â  Â  Â  Â  Â  Â  :Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 'Sensor: idle';
Â  const calÂ  Â = fmt1(toDeg(zeroOffsetRad)) + 'Â°';
Â  elReadStatus.textContent = `${label} Â· Cal: ${cal}`;
}

function getAngleFromReadout(){
Â  // Parse the numeric part from "29.7Â°" or "29.7Â° (locked)"
Â  const m = String(elReadAngle.textContent).match(/-?\d+(?:\.\d+)?/);
Â  return m ? parseFloat(m[0]) : NaN;
}

let onOrientation = null;

function startClinometer(){
Â  if (clinoOn) return;
Â  clinoOn = true;
Â  renderClinoStatus('running');
Â  elLock.textContent = 'Lock';

Â  requestIOSPermissionIfNeeded().then(ok=>{
Â  Â  if(!ok){
Â  Â  Â  clinoOn = false;
Â  Â  Â  renderClinoStatus('permission');
Â  Â  Â  elLock.textContent = 'Start Clinometer';
Â  Â  Â  return;
Â  Â  }
Â  Â  onOrientation = ev => {
Â  Â  Â  if(!clinoOn || locked) return;
Â  Â  Â  const deg = computePitchFromEvent(ev);
Â  Â  Â  renderClinoReadout(deg);
Â  Â  };
Â  Â  window.addEventListener('deviceorientation', onOrientation, {passive:true});
Â  });
}

function stopClinometer(){
Â  if(!clinoOn) return;
Â  clinoOn = false;
Â  if(onOrientation) window.removeEventListener('deviceorientation', onOrientation);
Â  onOrientation = null;
Â  renderClinoStatus('stopped');
Â  elLock.textContent = 'Start Clinometer';
}

function zeroCalibrate(){
Â  const current = Number.isFinite(lastLiveDeg) ? lastLiveDeg : getAngleFromReadout();
Â  if(!Number.isFinite(current)) return;
Â  zeroOffsetRad += (current * Math.PI/180);
Â  renderClinoStatus(clinoOn ? 'running' : 'idle');
Â  buzz(20);
}

function resetSensor(){
Â  locked = false;
Â  zeroOffsetRad = 0;
Â  renderClinoReadout(NaN);
Â  if (clinoOn){
Â  Â  elLock.classList.remove('active');
Â  Â  elLock.textContent = 'Lock';
Â  Â  renderClinoStatus('running');
Â  } else {
Â  Â  elLock.classList.remove('active');
Â  Â  elLock.textContent = 'Start Clinometer';
Â  Â  renderClinoStatus('idle');
Â  }
Â  buzz(10);
}

function toggleLock(){
Â  // First click starts the sensor
Â  if(!clinoOn){
Â  Â  startClinometer();
Â  Â  buzz(50);
Â  Â  return;
Â  }
Â  // Toggle lock/unlock while running
Â  if(!locked){
Â  Â  locked = true;
Â  Â  elLock.textContent = 'Unlock';
Â  Â  elLock.classList.add('active');
Â  Â  const current = Number.isFinite(lastLiveDeg) ? lastLiveDeg : getAngleFromReadout();
Â  Â  if (Number.isFinite(current)) {
Â  Â  Â  document.getElementById('h-angle').value = current.toFixed(1);
Â  Â  Â  calcHeight();
Â  Â  }
Â  Â  renderClinoReadout(current);
Â  Â  buzz(40);
Â  } else {
Â  Â  locked = false;
Â  Â  elLock.textContent = 'Lock';
Â  Â  elLock.classList.remove('active');
Â  Â  // Immediately refresh readout from stored last value
Â  Â  renderClinoReadout(lastLiveDeg);
Â  }
}

elLock.addEventListener('click', toggleLock);
elZero.addEventListener('click', zeroCalibrate);
elReset.addEventListener('click', resetSensor);

// Stop sensor when tab goes to background
document.addEventListener('visibilitychange', ()=>{ if(document.hidden) stopClinometer(); });

// Initialize live box so it isnâ€™t blank
renderClinoStatus('idle');
renderClinoReadout(NaN);

function updateCopyButtons(){
Â  var t=treeType ? treeType.value : '';
Â  if(t==='Multi trunked tree'){
Â  } else if(t==='Single trunk tree'){
Â  } else {
Â  }
}
function copyText(txt,btn){
Â  (navigator.clipboard && navigator.clipboard.writeText ? navigator.clipboard.writeText(txt)
Â  Â  : new Promise(function(res){ var t=document.createElement('input'); t.value=txt; document.body.appendChild(t); t.select(); document.execCommand('copy'); t.remove(); res(); })
Â  ).then(function(){
Â  Â  var o=btn.textContent; btn.textContent='Copied âœ“'; setTimeout(function(){ btn.textContent=o; }, 1200);
Â  }).catch(function(){});}

/* ---------------- Description / Share ---------------- */
var treeNameInput=byId('treeName'), species=byId('species'), condition=byId('condition');
var descBox=byId('desc'), copyDesc=byId('copyDesc'), emailBtn=byId('emailBtn');

byId('treeName')?.addEventListener('input', function(){
Â  if (typeof updateKeyMeasurementsBox === 'function') updateKeyMeasurementsBox();
Â  Â  updateAllDisplays();Â  Â 
});

function ensureOnDemand(){
Â  if((treeType && treeType.value==='Multi trunked tree')){
Â  Â  var any=$all('#mt-list input').some(function(i){ return Number.isFinite(parseFloat(i.value)); });
Â  Â  if(any && !lastMulti) calcMulti();
Â  }
Â  var a=parseFloat(hAngle && hAngle.value), d=parseFloat(hDist && hDist.value), e=parseFloat(hEye && hEye.value);
Â  if(Number.isFinite(a)&&Number.isFinite(d)&&Number.isFinite(e)&&!lastHeight) calcHeight();
Â  if(!lastSpread && (Number.isFinite(parseFloat(spreadMajor && spreadMajor.value))||Number.isFinite(parseFloat(spreadMinor && spreadMinor.value)))) calcSpread();
Â  if(treeType && treeType.value==='Single trunk tree' && !lastSingle && Number.isFinite(parseFloat(singleC && singleC.value))) recomputeSingle();
}

Â  function buildDescription(){
Â  // helpers
Â  var parts = [];
Â  var add = (html) => { if(html && html.trim()) { var d=document.createElement('div'); d.className='desc-section'; d.innerHTML=html; parts.push(d); } };

Â  // current basics
Â  var name = byId('treeName')?.value?.trim() || '';
Â  const speciesBtn = byId('speciesPickerBtn');
Â  const speciesName = speciesBtn?.dataset.speciesName || '';
Â  const speciesSciName = speciesBtn?.dataset.speciesSciName || '';
Â  var sp = speciesName ? `${speciesName} (${speciesSciName})` : '';

Â  var cond = byId('conditionPickerBtn')?.dataset.selectedId || '';
Â  var type = (byId('treeType') && byId('treeType').value || '').trim();

Â  // ---------- 1) General ----------
Â  (function(){
Â  Â  var lines = [];
Â  Â  if (name) lines.push('<p><strong>Tree</strong>: '+escapeHtml(name)+'</p>');
Â  Â  if (sp)Â  Â lines.push('<p><strong>Species</strong>: '+escapeHtml(speciesName)+' (<em>'+escapeHtml(speciesSciName)+'</em>)</p>');

Â  Â  // Add Category
Â  Â  const catId = byId('categoryPickerBtn')?.dataset.selectedId;
Â  Â  if (catId && window.ARA_CATEGORY_MAP) {
Â  Â  Â  Â  const category = window.ARA_CATEGORY_MAP.get(catId);
Â  Â  Â  Â  if (category) {
Â  Â  Â  Â  Â  Â  lines.push('<p><strong>Category</strong>: '+escapeHtml(category.name)+'</p>');
Â  Â  Â  Â  }
Â  Â  }

Â  Â  if (cond) lines.push('<p><strong>Condition</strong>: '+escapeHtml(cond)+'</p>');
Â  Â  if (type) lines.push('<p><strong>Type</strong>: '+escapeHtml(type)+'</p>');
Â  Â  if (lines.length) add(lines.join(''));
Â  })();

Â  // ---------- 2) Location (if saved) ----------
Â  (function(){
Â  Â  var latEl=byId('lat'), lngEl=byId('lng'), accEl=byId('acc');
Â  Â  var latIn=parseFloat(latEl && latEl.value), lngIn=parseFloat(lngEl && lngEl.value);
Â  Â  if (!Number.isFinite(latIn) || !Number.isFinite(lngIn)) return;

Â  Â  var accIn=parseFloat(accEl && accEl.value);
Â  Â  var savedAlt=byId('loc-saved-alt');Â 
Â  Â  var savedTs =byId('loc-saved-ts');
Â  Â  var altSaved = (savedAlt && savedAlt.dataset && savedAlt.dataset.val) ? parseFloat(savedAlt.dataset.val) : NaN;
Â  Â  var tsSavedÂ  = (savedTsÂ  && savedTs.datasetÂ  && savedTs.dataset.ts ) ? parseInt(savedTs.dataset.ts,10) : NaN;
Â  Â  var locWhenÂ  = Number.isFinite(tsSaved) ? new Date(tsSaved).toLocaleString() : nowLocal24();

Â  Â  // make a copy-friendly, clickable Maps URL
Â  Â  var mapsURL = 'https://maps.google.com/?q=' + latIn.toFixed(6) + ',' + lngIn.toFixed(6);

Â  Â  var html = ''
Â  Â  Â  + '<p><strong>Location</strong></p>'
Â  Â  Â  + '<ul>'
Â  Â  Â  +Â  Â '<li>DD: 'Â  + latIn.toFixed(6) + ', ' + lngIn.toFixed(6) + '</li>'
Â  Â  Â  +Â  Â '<li>DMS: ' + toDMS(latIn, true) + 'Â  |Â  ' + toDMS(lngIn, false) + '</li>'
Â  Â  Â  +Â  Â '<li>Altitude: ' + (Number.isFinite(altSaved)? altSaved.toFixed(1)+' m' : 'â€”') + '</li>'
Â  Â  Â  +Â  Â '<li>Accuracy: ' + (Number.isFinite(accIn)? ('Â±'+accIn.toFixed(1)+' m') : 'Â±â€”') + '</li>'
Â  Â  Â  +Â  Â '<li>Recorded: ' + locWhen + '</li>'
Â  Â  Â  +Â  Â '<li>Google Maps: <a href="'+mapsURL+'" target="_blank" rel="noopener">'+mapsURL+'</a></li>'
Â  Â  Â  + '</ul>';
Â  Â  add(html);
Â  })();

Â  // ---------- 3) Circumference (Single / Multi) ----------
Â  (function(){
Â  Â  var html = '';
Â  Â  if ((type === 'Single trunk tree' || type === 'Single trunk on a slope') && lastSingle){
Â  Â  Â  const circTitle = lastSingle.isSlope ? 'Sloped Tree Circumference' : 'Circumference';
Â  Â  Â  html += `<p><strong>${circTitle}</strong></p>`
Â  Â  Â  Â  Â  Â +Â  '<ul>'
Â  Â  Â  Â  Â  Â +Â  Â  '<li>Circumference: '+fmt2(lastSingle.cM)+' m ('+fmt2(lastSingle.cFt)+' ft)'
Â  Â  Â  Â  Â  Â +Â  Â  ' â†’ Diameter: '+fmt2(lastSingle.dM)+' m ('+fmt2(lastSingle.dFt)+' ft)</li>'
Â  Â  Â  Â  Â  Â +Â  '</ul>';
Â  Â  Â  // If it's a slope measurement, add the breakdown
Â  Â  Â  if (lastSingle.isSlope) {
Â  Â  Â  Â  html += '<p><strong>Circumference Measurements</strong></p>'
Â  Â  Â  Â  Â  Â  Â +Â  '<ul>'
Â  Â  Â  Â  Â  Â  Â +Â  Â  '<li>Upper measurement: '+fmt2(lastSingle.upperM)+' m ('+fmt2(mToFt(lastSingle.upperM))+' ft)</li>'
Â  Â  Â  Â  Â  Â  Â +Â  Â  '<li>Lower measurement: '+fmt2(lastSingle.lowerM)+' m ('+fmt2(mToFt(lastSingle.lowerM))+' ft)</li>'
Â  Â  Â  Â  Â  Â  Â +Â  '</ul>';
Â  Â  Â  }
Â  Â  Â  Â  Â  Â +Â  '</ul>';
Â  Â  }
Â  Â  if (type === 'Multi trunked tree' && lastMulti){
Â  Â  Â  var items = lastMulti.trunks.map(function(t){
Â  Â  Â  Â  var inner = 'T'+t.index+': '+fmt2(t.cM)+' m ('+fmt2(t.cFt)+' ft) â†’ '+fmt2(t.dM)+' m ('+fmt2(t.dFt)+' ft)';
Â  Â  Â  Â  return '<li>'+(t.isLargest?('<strong>'+inner+'</strong>'):inner)+'</li>';
Â  Â  Â  }).join('');
Â  Â  Â  var dAvgM = lastMulti.cAvgM/PI, dAvgFt = mToFt(dAvgM);

Â  Â  Â  html += '<p><strong>Individual trunks (circumference â†’ diameter)</strong></p>'
Â  Â  Â  Â  Â  Â +Â  '<ul>'+items+'</ul>'
Â  Â  Â  Â  Â  Â +Â  '<p><strong>Full Tree Circumference (circumference â†’ diameter)</strong></p>'
Â  Â  Â  Â  Â  Â +Â  '<ul>'
Â  Â  Â  Â  Â  Â +Â  Â  '<li>Equivalent circumference: '+fmt2(lastMulti.cEqM)+' m ('+fmt2(lastMulti.cEqFt)+' ft)'
Â  Â  Â  Â  Â  Â +Â  Â  Â  ' â†’ '+fmt2(lastMulti.dEqM)+' m ('+fmt2(lastMulti.dEqFt)+' ft)</li>'
Â  Â  Â  Â  Â  Â +Â  Â  '<li>Average circumference: '+fmt2(lastMulti.cAvgM)+' m ('+fmt2(lastMulti.cAvgFt)+' ft)'
Â  Â  Â  Â  Â  Â +Â  Â  Â  ' â†’ '+fmt2(dAvgM)+' m ('+fmt2(dAvgFt)+' ft)</li>'
Â  Â  Â  Â  Â  Â +Â  '</ul>';
Â  Â  }
Â  Â  if (html) add(html);
Â  })();

Â  // ---------- 4) Height ----------
Â  (function(){
Â  Â  if (!lastHeight) return;
Â  Â  var html = ''
Â  Â  Â  + '<p><strong>Height</strong></p>'
Â  Â  Â  + '<ul>'
Â  Â  Â  +Â  Â '<li>Tree height: '+fmt2(lastHeight.hM)+' m ('+fmt2(lastHeight.hFt)+' ft)</li>'
Â  Â  Â  +Â  Â '<li>height = tan('+fmt1(lastHeight.angleDeg)+'Â°) Ã— '+fmt2(lastHeight.dM)+' m + '
Â  Â  Â  +Â  Â  Â  fmt2(lastHeight.eM)+' m = '+fmt2(lastHeight.hM)+' m ('+fmt2(lastHeight.hFt)+' ft)</li>'
Â  Â  Â  + '</ul>';
Â  Â  add(html);
Â  })();

Â  // ---------- 5) Canopy ----------
Â  (function(){
Â  Â  if (!lastSpread) return;
Â  Â  var html = ''
Â  Â  Â  + '<p><strong>Canopy spread</strong></p>'
Â  Â  Â  + '<ul>'
Â  Â  Â  +Â  Â (Number.isFinite(lastSpread.majorM) ? '<li>Major: '+fmt2(lastSpread.majorM)+' m ('+fmt2(mToFt(lastSpread.majorM))+' ft)</li>' : '')
Â  Â  Â  +Â  Â (Number.isFinite(lastSpread.minorM) ? '<li>Minor: '+fmt2(lastSpread.minorM)+' m ('+fmt2(mToFt(lastSpread.minorM))+' ft)</li>' : '')
Â  Â  Â  +Â  Â '<li><strong>Final canopy spread: '+fmt2(lastSpread.meanM)+' m ('+fmt2(lastSpread.meanFt)+' ft)</strong></li>'
Â  Â  Â  + '</ul>';
Â  Â  add(html);
Â  })();

Â  // ---------- 6) Notes ----------
Â  (function(){
Â  Â  var nTxt = (notesEl && notesEl.value || '').trim();
Â  Â  if (!nTxt) return;
Â  Â  var lines = nTxt.split(/\n+/).map(function(line){
Â  Â  Â  return '<li>'+escapeHtml(line)+'</li>';
Â  Â  }).join('');
Â  Â  add('<p><strong>Notes</strong></p><ul>'+lines+'</ul>');
Â  })();

Â  // ---------- 7) Observation ----------
Â  (function(){
Â  Â  add('<p><strong>Observation</strong></p><ul><li>Recorded: '+nowLocal24()+'</li></ul>');
Â  })();
Â  // ---------- 8) Missing data notice ----------
Â  (function(){
Â  Â  const catId = byId('categoryPickerBtn')?.dataset.selectedId;
Â  Â  if (catId && window.ARA_CATEGORY_MAP) {
Â  Â  Â  Â  const category = window.ARA_CATEGORY_MAP.get(catId);
Â  Â  Â  Â  if (category && category.desc) {
Â  Â  Â  Â  Â  Â  add('<p><strong>Category Details ('+escapeHtml(category.name)+')</strong></p><ul><li>'+escapeHtml(category.desc)+'</li></ul>');
Â  Â  Â  Â  }
Â  Â  }
Â  })();

Â  // ---------- 9) Missing data notice ----------
Â  (function(){
Â  Â  var miss = computeMissingBits();
Â  Â  if (!miss.length) return;
Â  Â  var html = '<p><strong>Missing</strong></p><ul>' +
Â  Â  Â  miss.map(m => '<li>' + escapeHtml(m) + '</li>').join('') +
Â  Â  Â  '</ul>';
Â  Â  add(html);
Â  })();

Â  // join & return
Â  var out = document.createElement('div');
Â  parts.forEach(function(p){ out.appendChild(p); });
Â  return out.innerHTML;
}

function extractPlainText(container){
Â  if (!container) return '';
Â  // clone so we can transform anchors without touching the live DOM
Â  var clone = container.cloneNode(true);

Â  // Convert <a> tags to "text â€“ URL" so the copied text includes links
Â  Array.prototype.slice.call(clone.querySelectorAll('a')).forEach(function(a){
Â  Â  var url = a.getAttribute('href') || '';
Â  Â  var txt = a.textContent || url;
Â  Â  var span = document.createElement('span');
Â  Â  span.textContent = txt + (url ? ' â€“ ' + url : '');
Â  Â  a.replaceWith(span);
Â  });

Â  // Gather bullets and paragraphs
Â  var items = Array.prototype.slice.call(clone.querySelectorAll('li'))
Â  Â  .map(function(li){ return '- ' + li.textContent; });
Â  var paras = Array.prototype.slice.call(clone.querySelectorAll('p'))
Â  Â  .map(function(p){ return p.textContent; });

Â  return items.concat(paras).join('\n').trim();
}

// Plain-text twin of buildDescription(), same order/spacing
function buildDescriptionText(){
Â  const p = [];
Â  const push = (s) => { if (s && s.trim()) p.push(s.trim()); };

Â  const name = byId('treeName')?.value?.trim() || '';
Â  const speciesName = speciesBtn?.dataset.speciesName || '';
Â  const speciesSciName = speciesBtn?.dataset.speciesSciName || '';
Â  const sp = speciesName ? `${speciesName} (${speciesSciName})` : '';
Â  const cond = (byId('conditionPickerBtn')?.dataset.selectedId || '').trim();
Â  const type = (byId('treeType')?.value || '').trim();

Â  // 1) General
Â  (function(){
Â  Â  const lines = [];
Â  Â  if (name) lines.push(`Tree: ${name}`);Â 
Â  Â  if (sp)Â  Â lines.push(`Species: ${sp}`); // This will now contain both common and scientific name
Â  Â  if (cond) lines.push(`Condition: ${cond}`);
Â  Â  if (type) lines.push(`Type: ${type}`);

Â  Â  // Add Category
Â  Â  const catId = byId('categoryPickerBtn')?.dataset.selectedId;
Â  Â  if (catId && window.ARA_CATEGORY_MAP) {
Â  Â  Â  Â  const category = window.ARA_CATEGORY_MAP.get(catId);
Â  Â  Â  Â  if (category) {
Â  Â  Â  Â  Â  Â  lines.push(`Category: ${category.name}`);
Â  Â  Â  Â  }
Â  Â  }
Â  Â  if (lines.length) push(lines.join('\n'));
Â  })();

Â  // 2) Location (if saved)
Â  (function(){
Â  Â  const lat = parseFloat(byId('lat')?.value);
Â  Â  const lng = parseFloat(byId('lng')?.value);
Â  Â  if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;

Â  Â  const accÂ  Â  = parseFloat(byId('acc')?.value);
Â  Â  const altTag = byId('loc-saved-alt')?.dataset?.val;
Â  Â  const altÂ  Â  = Number.isFinite(parseFloat(altTag)) ? parseFloat(altTag) : NaN;
Â  Â  const tsTagÂ  = byId('loc-saved-ts')?.dataset?.ts;
Â  Â  const whenÂ  Â = Number.isFinite(parseInt(tsTag,10)) ? new Date(parseInt(tsTag,10)).toLocaleString() : nowLocal24();
Â  Â  const mapsURL=Â 
Â  Â  Â  `https://maps.google.com/?q=${lat
Â  Â  Â  .toFixed(6)},${lng.toFixed(6)}`;

Â  Â  const lines = [
Â  Â  Â  `Location`,
Â  Â  Â  `- DD: ${lat.toFixed(6)}, ${lng.toFixed(6)}`,
Â  Â  Â  `- DMS: ${toDMS(lat,true)}Â  |Â  ${toDMS(lng,false)}`,
Â  Â  Â  `- Altitude: ${Number.isFinite(alt) ? alt.toFixed(1)+' m' : 'â€”'}`,
Â  Â  Â  `- Accuracy: ${Number.isFinite(acc) ? 'Â±'+acc.toFixed(1)+' m' : 'Â±â€”'}`,
Â  Â  Â  `- Recorded: ${when}`,
Â  Â  Â  `- Google Maps: ${mapsURL}`
Â  Â  ];
Â  Â  push(lines.join('\n'));
Â  })();

Â  // 3) Circumference
Â  (function(){
Â  Â  let lines = [];
Â  Â  if ((type === 'Single trunk tree' || type === 'Single trunk on a slope') && lastSingle){
Â  Â  Â  const circTitle = lastSingle.isSlope ? 'Sloped Tree Circumference' : 'Circumference';
Â  Â  Â  lines.push(circTitle);
Â  Â  Â  lines.push(`- Circumference: ${fmt2(lastSingle.cM)} m (${fmt2(lastSingle.cFt)} ft) â†’ Diameter: ${fmt2(lastSingle.dM)} m (${fmt2(lastSingle.dFt)} ft)`);
Â  Â  Â  if (lastSingle.isSlope) {
Â  Â  Â  Â  lines.push('Circumference Measurements');
Â  Â  Â  Â  lines.push(`- Upper measurement: ${fmt2(lastSingle.upperM)} m (${fmt2(mToFt(lastSingle.upperM))} ft)`);
Â  Â  Â  Â  lines.push(`- Lower measurement: ${fmt2(lastSingle.lowerM)} m (${fmt2(mToFt(lastSingle.lowerM))} ft)`);
Â  Â  Â  }
Â  Â  }
Â  Â  if (type === 'Multi trunked tree' && lastMulti){
Â  Â  Â  lines.push('Individual trunks (circumference â†’ diameter)');
Â  Â  Â  lastMulti.trunks.forEach(t=>{
Â  Â  Â  Â  const core = `T${t.index}: ${fmt2(t.cM)} m (${fmt2(t.cFt)} ft) â†’ ${fmt2(t.dM)} m (${fmt2(t.dFt)} ft)`;
Â  Â  Â  Â  lines.push(`- ${core}${t.isLargest ? ' (largest)' : ''}`);
Â  Â  Â  });
Â  Â  Â  const dAvgM = lastMulti.cAvgM/Math.PI, dAvgFt = mToFt(dAvgM);
Â  Â  Â  lines.push('Full Tree Circumference (circumference â†’ diameter)');
Â  Â  Â  lines.push(`- Equivalent circumference: ${fmt2(lastMulti.cEqM)} m (${fmt2(lastMulti.cEqFt)} ft) â†’ ${fmt2(lastMulti.dEqM)} m (${fmt2(lastMulti.dEqFt)} ft)`);
Â  Â  Â  lines.push(`- Average circumference: ${fmt2(lastMulti.cAvgM)} m (${fmt2(lastMulti.cAvgFt)} ft) â†’ ${fmt2(dAvgM)} m (${fmt2(dAvgFt)} ft)`);
Â  Â  }
Â  Â  if (lines.length) push(lines.join('\n'));
Â  })();

Â  // 4) Height
Â  (function(){
Â  Â  if (!lastHeight) return;
Â  Â  const lines = [
Â  Â  Â  'Height',
Â  Â  Â  `- Tree height: ${fmt2(lastHeight.hM)} m (${fmt2(lastHeight.hFt)} ft)`,
Â  Â  Â  `- height = tan(${fmt1(lastHeight.angleDeg)}Â°) Ã— ${fmt2(lastHeight.dM)} m + ${fmt2(lastHeight.eM)} m = ${fmt2(lastHeight.hM)} m (${fmt2(lastHeight.hFt)} ft)`
Â  Â  ];
Â  Â  push(lines.join('\n'));
Â  })();

Â  // 5) Canopy
Â  (function(){
Â  Â  if (!lastSpread) return;
Â  Â  const lines = ['Canopy spread'];
Â  Â  if (Number.isFinite(lastSpread.majorM)) lines.push(`- Major: ${fmt2(lastSpread.majorM)} m (${fmt2(mToFt(lastSpread.majorM))} ft)`);
Â  Â  if (Number.isFinite(lastSpread.minorM)) lines.push(`- Minor: ${fmt2(lastSpread.minorM)} m (${fmt2(mToFt(lastSpread.minorM))} ft)`);
Â  Â  lines.push(`- Final canopy spread: ${fmt2(lastSpread.meanM)} m (${fmt2(lastSpread.meanFt)} ft)`);
Â  Â  push(lines.join('\n'));
Â  })();

Â  // 6) Notes
Â  (function(){
Â  Â  const nTxt = (byId('notes')?.value || '').trim();
Â  Â  if (!nTxt) return;
Â  Â  const lines = ['Notes'].concat(
Â  Â  Â  nTxt.split(/\n+/).map(line => `- ${line}`)
Â  Â  );
Â  Â  push(lines.join('\n'));
Â  })();

Â  // 7) Observation
Â  (function(){
Â  Â  push(['Observation', `- Recorded: ${nowLocal24()}`].join('\n'));
Â  })();

Â  // 8) Category Description
Â  (function(){
Â  Â  const catId = byId('categoryPickerBtn')?.dataset.selectedId;
Â  Â  if (catId && window.ARA_CATEGORY_MAP) {
Â  Â  Â  Â  const category = window.ARA_CATEGORY_MAP.get(catId);
Â  Â  Â  Â  if (category && category.desc) {
Â  Â  Â  Â  Â  Â  push(`Category Details (${category.name})\n- ${category.desc}`);
Â  Â  Â  Â  }
Â  Â  }
Â  })();

Â  // 9) Photo Note
Â  (function(){
Â  Â  const photosState = (typeof window.getPhotosState === 'function') ? window.getPhotosState() : null;
Â  Â  if (photosState?.items?.length > 0) {
Â  Â  Â  push('Note: Photos are not included in the copied text and can only be viewed in the app.');
Â  Â  }
Â  })();

Â  // join sections with a blank line between
Â  return p.join('\n\n') + '\n';
}
Â Â 
function generateDescription(){
Â  ensureOnDemand();

Â  // 1) Build and render the HTML (what you see in-app)
Â  var html = buildDescription();
Â  if (descBox) descBox.innerHTML = html || 'â€”';

Â  // 2) Build the plain-text twin for email/copy (identical order & spacing)
Â  var text = buildDescriptionText();

Â  // Enable/disable controls
Â  var hasContent = !!html;
Â  if (copyDesc) copyDesc.disabled = !hasContent;

Â  // 3) Email: use the plain-text twin verbatim (mailto only supports plain text)
Â  if (emailBtn){
Â  Â  if (hasContent){
Â  Â  Â  // Show/hide the photo note
Â  Â  Â  const photosNote = byId('photos-note');
Â  Â  Â  if (photosNote) {
Â  Â  Â  Â  const photosState = (typeof window.getPhotosState === 'function') ? window.getPhotosState() : null;
Â  Â  Â  Â  photosNote.style.display = (photosState?.items?.length > 0) ? 'block' : 'none';
Â  Â  Â  }
Â  Â  Â  var nm = (byId('treeName')?.value || '').trim();
Â  Â  Â  var subject = 'ARA Field Nomination' + (nm ? ' â€“ ' + nm : '');
Â  Â  Â  emailBtn.href = 'mailto:?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(text);
Â  Â  Â  emailBtn.removeAttribute('aria-disabled');
Â  Â  } else {
Â  Â  Â  emailBtn.setAttribute('aria-disabled','true');
Â  Â  Â  emailBtn.href = '#';
Â  Â  }
Â  }Â Â 
}

if(copyDesc) copyDesc.onclick=function(){
Â  var html=descBox && descBox.innerHTML ? descBox.innerHTML.trim() : '';
Â  if(!html||html==='â€”') return;
Â  var text=buildDescriptionText(); // Use the clean, plain-text builder
Â  copyText(text, copyDesc);
};

Â  /* ---------- Global accuracy indicator helpers ---------- */
function accBucket(m){
Â  // returns one of: 'red' (off), 'grey' (low), 'amber' (medium), 'green' (high)
Â  if(!Number.isFinite(m)) return 'grey';Â  Â  Â  Â  Â  Â // use grey for "no fix yet" while running
Â  if(m <= 5)Â  Â return 'green';
Â  if(m < 20)Â  Â return 'amber';
Â  return 'grey';
}
function paintGlobalAcc(accMeters, opts){
Â  // opts: { state: 'off'|'nofix'|'ok' }Â  (controls red vs bucket color)
Â  var pill = document.getElementById('acc-pill-global');
Â  var dotÂ  = document.getElementById('loc-tab-dot');
Â  if(!pill || !dot) return;

Â  var state = (opts && opts.state) || 'ok';
Â  var textÂ  = 'Â±â€” m';
Â  var clsÂ  Â = 'acc-red'; // default to red only for 'off'

Â  if(state === 'off'){
Â  Â  text = 'Â±â€” m';
Â  Â  clsÂ  = 'acc-red';
Â  } else if(state === 'nofix'){
Â  Â  text = 'Â±â€” m';
Â  Â  clsÂ  = 'acc-grey';
Â  } else {
Â  Â  // ok â†’ bucket by value
Â  Â  var bucket = accBucket(accMeters);
Â  Â  cls = 'acc-' + bucket;
Â  Â  text = Number.isFinite(accMeters) ? ('Â±' + (accMeters.toFixed(1)) + ' m') : 'Â±â€” m';
Â  }

Â  // reset classes (keep base class)
Â  pill.className = 'acc-pill ' + cls;
Â  dot.classNameÂ  = 'acc-dot ' + cls;

Â  pill.textContent = text;

Â  // accessibility
Â  var label =
Â  Â  state === 'off'Â  Â ? 'Location accuracy: tracking off'
Â  : state === 'nofix' ? 'Location accuracy: no fix yet'
Â  : cls === 'acc-green' ? 'Location accuracy: high'
Â  : cls === 'acc-amber' ? 'Location accuracy: medium'
Â  : 'Location accuracy: low';
Â  dot.setAttribute('aria-label', label);
Â  pill.setAttribute('aria-label', label);
}

/* ---------------- Location tracker + map (scoped) ---------------- */
(function(){
Â  function el(s){ return document.querySelector(s); }

Â  // Controls
Â  var bToggle = el('#loc-toggle');
Â  var tHiAccÂ  = el('#loc-hiacc');
Â  var tSaverÂ  = el('#loc-saver');

Â  // Recent readouts
Â  var outDDÂ  Â = el('#loc-recent-dd');
Â  var outAccÂ  = el('#loc-recent-acc');
Â  var outAltÂ  = el('#loc-recent-alt');
Â  var outAgeÂ  = el('#loc-recent-age');
Â  var outCntÂ  = el('#loc-samples');

Â  // Best readouts
Â  var bestDDÂ  Â  = el('#loc-best-dd');
Â  var bestAccÂ  Â = el('#loc-best-acc');
Â  var bestAltÂ  Â = el('#loc-best-alt');
Â  var bestTimeÂ  = el('#loc-best-time');
Â  var bestBadge = el('#loc-best-badge');

Â  // Action buttons
Â  var bUseRecent = el('#loc-use-recent');
Â  var bUseBestÂ  Â = el('#loc-use-best');
Â  var bResetÂ  Â  Â = el('#loc-reset');

Â  // Hidden storage for description
Â  var latEl = el('#lat'), lngEl = el('#lng'), accEl = el('#acc');
Â  var savedAlt = el('#loc-saved-alt');
Â  var savedTsÂ  = el('#loc-saved-ts');

Â  // Map refs
Â  var map, tiles, recentMarker, bestMarker, accCircle;

Â  function ensureMap() {
Â  Â  // Expose a function to invalidate map size, which can be called when the tab is shown.
Â  Â  window.invalidateMapSize = function() {
Â  Â  Â  if (map) {
Â  Â  Â  Â  setTimeout(() => map.invalidateSize(), 10);
Â  Â  Â  }
Â  Â  };
Â  Â  if (map || !window.L) return;
Â  Â  map = L.map('loc-map', { zoomControl:true, attributionControl:false }).setView([53.5444, -113.4909], 11);
Â  Â Â 
Â  Â  const darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
Â  Â  Â  attribution: 'Â© CARTO', maxZoom: 20
Â  Â  });
Â  Â  const lightLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
Â  Â  Â  attribution: 'Â© CARTO', maxZoom: 20
Â  Â  });
Â  Â  const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
Â  Â  Â  attribution: 'Tiles Â© Esri'
Â  Â  });

Â  Â  const baseMaps = { "Dark": darkLayer, "Light": lightLayer, "Satellite": satelliteLayer };

Â  Â  L.control.layers(baseMaps).addTo(map);
Â  Â  darkLayer.addTo(map); // Default layer

Â  Â  tiles = darkLayer; // Keep a reference for the dimmer function
Â  }

Â  // Expose a safe dimmer for the tiles so other code can call it
window.mapSetDim = function(dim){
Â  try{
Â  Â  if (tiles && typeof tiles.setOpacity === 'function'){
Â  Â  Â  tiles.setOpacity(dim ? 0.4 : 1.0);
Â  Â  }
Â  }catch(e){}
};

Â  function updateRecentOnMap() {
Â  Â  if (!map) return;
Â  Â  if (!recent) {
Â  Â  Â  if (recentMarker) { map.removeLayer(recentMarker); recentMarker=null; }
Â  Â  Â  if (accCircle)Â  Â  { map.removeLayer(accCircle);Â  Â  accCircle=null; }
Â  Â  Â  return;
Â  Â  }
Â  Â  var latlng=[recent.lat,recent.lng];
Â  Â  if (!recentMarker) { recentMarker=L.marker(latlng,{title:'Recent fix'}).addTo(map); }
Â  Â  else { recentMarker.setLatLng(latlng); }
Â  Â  if (Number.isFinite(recent.acc)) {
Â  Â  Â  if (!accCircle) {
Â  Â  Â  Â  accCircle=L.circle(latlng,{radius:recent.acc,color:'#5aa0ff',fillColor:'#5aa0ff',fillOpacity:0.15,weight:1}).addTo(map);
Â  Â  Â  } else { accCircle.setLatLng(latlng).setRadius(recent.acc); }
Â  Â  } else if (accCircle) { map.removeLayer(accCircle); accCircle=null; }
Â  }
Â  function updateBestOnMap() {
Â  Â  if (!map) return;
Â  Â  if (!best) { if (bestMarker){ map.removeLayer(bestMarker); bestMarker=null; } return; }
Â  Â  var latlng=[best.lat,best.lng];
Â  Â  if (!bestMarker) { bestMarker=L.marker(latlng,{title:'Best fix'}).addTo(map); }
Â  Â  else { bestMarker.setLatLng(latlng); }
Â  }
Â  function fitToAny(){
Â  Â  if(!map) return;
Â  Â  var pts=[]; if(recent) pts.push([recent.lat,recent.lng]); if(best) pts.push([best.lat,best.lng]);
Â  Â  if(!pts.length) return;
Â  Â  if(pts.length===1) map.setView(pts[0],16); else map.fitBounds(pts,{padding:[24,24]});
Â  }

Â  // State
Â  var watchId = null;
Â  var saver = false;
Â  var hiacc = false;
Â  var lastTick = 0;
Â  var samples = 0;
Â  var recent = null; // {lat,lng,acc,alt,ts}
Â  var bestÂ  Â = null; // minimal acc
Â  var ageTimer = null;

Â  // Paint global indicator from "running but no best yet" vs "not running/no saved"
if (best && Number.isFinite(best.acc)){
Â  paintGlobalAcc(best.acc, { state: 'ok' });
} else {
Â  // no best yet
Â  if (watchId != null){
Â  Â  paintGlobalAcc(NaN, { state: 'nofix' });
Â  } else {
Â  Â  // if we have a saved best in autosave, the load phase handles it; otherwise off
Â  Â  var savedTs = (document.getElementById('loc-saved-ts') && document.getElementById('loc-saved-ts').dataset && document.getElementById('loc-saved-ts').dataset.ts) || '';
Â  Â  if (savedTs) {
Â  Â  Â  // leave as-is; set during load or best update will override
Â  Â  } else {
Â  Â  Â  paintGlobalAcc(NaN, { state: 'off' });
Â  Â  }
Â  }
}

Â  // --- export/import runtime for autosave ---
window.locExportRuntime = function () {
Â  return { recent, best, samples };
};
window.locImportRuntime = function (data) {
Â  if (!data) return;
Â  recentÂ  = data.recentÂ  || null;
Â  bestÂ  Â  = data.bestÂ  Â  || null;
Â  samples = data.samples || 0;
Â  updateRecentUI();
Â  updateBestUI(false);
Â  ensureMap(); fitToAny();
};

Â  // Utilities
Â  var fmt6 = function(v){ return Number.isFinite(v) ? v.toFixed(6) : 'â€”'; };
Â  var fmt1a = function(v){ return Number.isFinite(v) ? v.toFixed(1) : 'â€”'; };
Â  function accClass(m){ return !Number.isFinite(m) ? 'acc-grey' : (m>=20 ? 'acc-grey' : (m>5 ? 'acc-amber' : 'acc-green')); }

Â  function setRunningUI(running){
Â  Â  if (!bToggle) return;
Â  Â  if (running){ bToggle.textContent='Stop tracking'; bToggle.classList.add('running'); }
Â  Â  elseÂ  Â  Â  Â  { bToggle.textContent='Start tracking'; bToggle.classList.remove('running'); }
Â  }

Â  function setSaveChoice(which){ // 'recent' | 'best' | null
Â  Â  if (bUseRecent) bUseRecent.classList.toggle('active', which==='recent');
Â  Â  if (bUseBest)Â  Â bUseBest.classList.toggle('active', which==='best');
Â  }

Â  function updateRecentUI() {
Â  Â  if (recent){
Â  Â  Â  if(outDD)Â  outDD.textContentÂ  = 'DD: '+fmt6(recent.lat)+', '+fmt6(recent.lng);
Â  Â  Â  if(outAcc){
Â  Â  Â  Â  outAcc.textContent = 'Â±' + fmt1a(recent.acc) + ' m';
Â  Â  Â  Â  outAcc.className='acc-chip '+accClass(recent.acc);Â 
Â  Â  Â  }
Â  Â  Â  if(outAlt) outAlt.textContent = Number.isFinite(recent.alt) ? fmt1a(recent.alt)+' m' : 'â€”';

Â  Â  Â  if (ageTimer) clearInterval(ageTimer);
Â  Â  Â  ageTimer = setInterval(function(){
Â  Â  Â  Â  var secs = Math.max(0, (Date.now() - recent.ts)/1000);
Â  Â  Â  Â  if(outAge) outAge.textContent = secs.toFixed(1)+' s';
Â  Â  Â  }, 200);

Â  Â  Â  if(bUseRecent) bUseRecent.disabled = false;
Â  Â  } else {
Â  Â  Â  if(outDD)Â  outDD.textContentÂ  = 'DD: â€”';
Â  Â  Â  if(outAcc){ outAcc.textContent = 'â€”'; outAcc.className='acc-chip acc-grey'; }
Â  Â  Â  if(outAlt) outAlt.textContent = 'â€”';
Â  Â  Â  if(outAge) outAge.textContent = 'â€”';
Â  Â  Â  if(bUseRecent) bUseRecent.disabled = true;
Â  Â  }
Â  Â  if(outCnt) outCnt.textContent = String(samples);

Â  Â  ensureMap();
Â  Â  updateRecentOnMap();
Â  Â  fitToAny();
Â  }

Â  function updateBestUI(isNew){
Â  Â  if (best){
Â  Â  Â  if(bestDD)Â  bestDD.textContentÂ  = 'DD: '+fmt6(best.lat)+', '+fmt6(best.lng);
Â  Â  Â  if(bestAcc){Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  bestAcc.textContent = 'Â±' + fmt1a(best.acc) + ' m';
Â  Â  Â  Â  Â  Â  Â  Â  Â  bestAcc.className='acc-chip '+accClass(best.acc);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  if(bestAlt){ bestAlt.textContent = Number.isFinite(best.alt) ? fmt1a(best.alt)+' m' : 'â€”'; bestAlt.dataset.val = Number.isFinite(best.alt) ? String(best.alt) : ''; }
Â  Â  Â  if(bestTime){ bestTime.textContent=new Date(best.ts).toLocaleString(); bestTime.dataset.ts=String(best.ts); }
Â  Â  Â  if(bUseBest) bUseBest.disabled=false;
Â  Â  } else {
Â  Â  Â  if(bestDD)Â  bestDD.textContentÂ  = 'DD: â€”';
Â  Â  Â  if(bestAcc){ bestAcc.textContent = 'â€”'; bestAcc.className='acc-chip acc-grey'; }
Â  Â  Â  if(bestAlt){ bestAlt.textContent = 'â€”'; bestAlt.dataset.val = ''; }
Â  Â  Â  if(bestTime){ bestTime.textContent='â€”'; bestTime.dataset.ts=''; }
Â  Â  Â  if(bUseBest) bUseBest.disabled=true;
Â  Â  }
Â  Â  if(bestBadge) bestBadge.style.display = isNew ? '' : 'none';
Â  Â  if (isNew && bestBadge) setTimeout(function(){ bestBadge.style.display='none'; },1200);

Â  Â  ensureMap();
Â  Â  updateBestOnMap();
Â  Â  fitToAny();

Â  Â  // Update global header pill & tab dot based on BEST
if (best && Number.isFinite(best.acc)){
Â  paintGlobalAcc(best.acc, { state: 'ok' });
}

Â  }

Â  function handlePosition(pos) {
Â  Â  var c = pos.coords;
Â  Â  var now = Date.now();
Â  Â  // Throttle in saver mode, but ONLY if high accuracy is OFF.
Â  Â  if (saver && !hiacc && now - lastTick < 1500) return;
Â  Â  lastTick = now;

Â  Â  var fix = {
Â  Â  Â  lat: c.latitude,
Â  Â  Â  lng: c.longitude,
Â  Â  Â  acc: c.accuracy,
Â  Â  Â  alt: Number.isFinite(c.altitude) ? c.altitude : null,
Â  Â  Â  ts: now
Â  Â  };
Â  Â  samples++;
Â  Â  recent = fix;
Â  Â  updateRecentUI();

Â  Â  if (!best || (Number.isFinite(fix.acc) && fix.acc < best.acc)) {
Â  Â  Â  best = {lat:fix.lat,lng:fix.lng,acc:fix.acc,alt:fix.alt,ts:fix.ts};
Â  Â  Â  updateBestUI(true);
Â  Â  }
Â  }

Â  function handleError(err) { console.warn('Geolocation error', err); }

async function start() {
Â  Â  if (watchId != null) return;

Â  Â  const isNative = window.Capacitor?.isNativePlatform?.();
Â  Â  const geoPlugin = window.Capacitor?.Plugins?.Geolocation;

Â  Â  let opts = { enableHighAccuracy: hiacc };

Â  Â  if (isNative && geoPlugin) {
Â  Â  Â  Â  // NATIVE (Capacitor)
Â  Â  Â  Â  // If high accuracy is requested, set aggressive timeout/maxAge to force a fresh fix.
Â  Â  Â  Â  if (hiacc) {
Â  Â  Â  Â  Â  Â  opts.maximumAge = 0;
Â  Â  Â  Â  Â  Â  opts.timeout = 5000; // 5 second timeout for a high-quality fix
Â  Â  Â  Â  }
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  watchId = await geoPlugin.watchPosition(opts, (position, err) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (err) { handleError(err); return; }
Â  Â  Â  Â  Â  Â  Â  Â  if (position) handlePosition(position);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  handleError(e);
Â  Â  Â  Â  Â  Â  watchId = null;
Â  Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  Â  // WEB BROWSER
Â  Â  Â  Â  // High accuracy overrides battery saver.
Â  Â  Â  Â  // This logic is restored from the older, working version.
Â  Â  Â  Â  let webOpts = { enableHighAccuracy: hiacc };
Â  Â  Â  Â  if (hiacc) {
Â  Â  Â  Â  Â  Â  webOpts.maximumAge = 0;
Â  Â  Â  Â  Â  Â  webOpts.timeout = 5000;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  webOpts.maximumAge = saver ? 15000 : 0;
Â  Â  Â  Â  Â  Â  webOpts.timeout = saver ? 30000 : 20000;
Â  Â  Â  Â  }
Â  Â  Â  Â  if (navigator.geolocation && navigator.geolocation.watchPosition) {
Â  Â  Â  Â  Â  Â  watchId = navigator.geolocation.watchPosition(handlePosition, handleError, webOpts);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  watchId = null;
Â  Â  Â  Â  }
Â  Â  }

Â  setRunningUI(true);
Â  updateGlobalAccOnStateChange();
}

Â  async function stop() {
Â  Â  if (watchId == null) return;

Â  Â  const geoPlugin = window.Capacitor?.Plugins?.Geolocation;
Â  Â  if (geoPlugin && window.Capacitor?.isNativePlatform?.()) {
Â  Â  Â  try {
Â  Â  Â  Â  await geoPlugin.clearWatch({ id: watchId });
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  handleError(e);
Â  Â  Â  }
Â  Â  } else if (navigator.geolocation && navigator.geolocation.clearWatch) {
Â  Â  Â  navigator.geolocation.clearWatch(watchId);
Â  Â  }

Â  Â  watchId = null; // Reset after the watch is cleared
Â  Â  setRunningUI(false);
Â  Â  updateGlobalAccOnStateChange();
}

function updateGlobalAccOnStateChange() {
Â  Â  if (typeof paintGlobalAcc !== 'function') return;
Â  Â  if (watchId != null) { // Tracking is on
Â  Â  Â  Â  if (best && Number.isFinite(best.acc)) {
Â  Â  Â  Â  Â  Â  paintGlobalAcc(best.acc, { state: 'ok' });
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  paintGlobalAcc(NaN, { state: 'nofix' });
Â  Â  Â  Â  }
Â  Â  } else { // Tracking is off
Â  Â  Â  Â  paintGlobalAcc(best?.acc ?? NaN, { state: best ? 'ok' : 'off' });
Â  Â  }
}

Â  function resetAll() {
Â  Â  stop();
Â  Â  samples = 0;
Â  Â  recent = null; best = null;
Â  Â  if (ageTimer) { clearInterval(ageTimer); ageTimer=null; }
Â  Â  updateRecentUI(); updateBestUI(false);
Â  }

function applyFixToHidden(fix){
Â  if (!fix) return;
Â  if(latEl) latEl.value = fix.lat.toFixed(6);
Â  if(lngEl) lngEl.value = fix.lng.toFixed(6);
Â  if(accEl) accEl.value = Number.isFinite(fix.acc) ? fix.acc.toFixed(1) : '';
Â  if(savedAlt && savedAlt.dataset) savedAlt.dataset.val = Number.isFinite(fix.alt) ? String(fix.alt) : '';
Â  if(savedTsÂ  && savedTs.dataset)Â  savedTs.dataset.tsÂ  Â = String(fix.ts || Date.now());
Â  if (typeof saveState === 'function') saveState();

Â  // NEW: immediately rebuild description & key measurements
Â  if (typeof refreshResultsView === 'function') refreshResultsView();
}


Â  if(bToggle) bToggle.addEventListener('click', function(){ if (watchId == null) start(); else stop(); });
if(tHiAcc)Â  tHiAcc.addEventListener('click',Â  async function(){
Â  hiacc=!hiacc;
Â  tHiAcc.classList.toggle('active',hiacc);
Â  tHiAcc.setAttribute('aria-pressed',String(hiacc));

Â  if (typeof paintGlobalAcc === 'function') {
Â  Â  if (best && Number.isFinite(best.acc)) {
Â  Â  Â  paintGlobalAcc(best.acc, { state: 'ok' });
Â  Â  } else if (recent && Number.isFinite(recent.acc)) {
Â  Â  Â  paintGlobalAcc(recent.acc, { state: 'ok' });
Â  Â  } else {
Â  Â  Â  paintGlobalAcc(NaN, { state: 'off' }); // nothing saved yet
Â  Â  }
Â  }

Â  if (watchId != null) {
Â  Â  await stop();
Â  Â  start();
Â  }
});

Â  if (tSaver) tSaver.addEventListener('click', async function () {
Â  saver = !saver;
Â  tSaver.classList.toggle('active', saver);
Â  tSaver.setAttribute('aria-pressed', String(saver));

Â  if (watchId != null) {
Â  Â  await stop();
Â  Â  start();
Â  }

Â  // keep the pill/dot reflecting the best we know
Â  if (typeof paintGlobalAcc === 'function') {
Â  Â  if (best && Number.isFinite(best.acc)) {
Â  Â  Â  paintGlobalAcc(best.acc, { state: 'ok' });
Â  Â  } else if (recent && Number.isFinite(recent.acc)) {
Â  Â  Â  paintGlobalAcc(recent.acc, { state: 'ok' });
Â  Â  } else {
Â  Â  Â  // running but no fix yet (after restart)
Â  Â  Â  paintGlobalAcc(NaN, { state: 'nofix' });
Â  Â  }
Â  }
});

Â  if(bUseRecent) bUseRecent.addEventListener('click', function(){ applyFixToHidden(recent); setSaveChoice('recent'); });
Â  if(bUseBest)Â  Â bUseBestÂ  .addEventListener('click', function(){ applyFixToHidden(best);Â  Â setSaveChoice('best'); });
Â  if(bReset)Â  Â  Â bResetÂ  Â  .addEventListener('click', function(){ resetAll(); setSaveChoice(null); });

Â  var mtr = byId('map-to-recent'), mtb = byId('map-to-best');
Â  if(mtr) mtr.addEventListener('click', function(){ ensureMap(); if (recent) map.setView([recent.lat, recent.lng], 18); });
Â  if(mtb) mtb.addEventListener('click', function(){ ensureMap(); if (best)Â  Â map.setView([best.lat, best.lng], 18); });

Â  var locTab = document.querySelector('[data-tab="loc"]');
Â  if(locTab) locTab.addEventListener('click', ensureMap);

Â  setRunningUI(false);
Â  updateRecentUI();
Â  updateBestUI(false);
})();

Â  (function(){
Â  function goToLocationTab(){
Â  Â  var tabs = Array.prototype.slice.call(document.querySelectorAll('.tab'));
Â  Â  tabs.forEach(function(t){ t.classList.remove('active'); });
Â  Â  var locTab = document.querySelector('.tab[data-tab="loc"]');
Â  Â  if(locTab) locTab.classList.add('active');

Â  Â  Array.prototype.slice.call(document.querySelectorAll('.tabpane'))
Â  Â  Â  .forEach(function(p){ p.classList.remove('active'); });

Â  Â  var pane = document.getElementById('pane-loc');
Â  Â  if(pane) pane.classList.add('active');

Â  Â  window.scrollTo({top:0,behavior:'smooth'});
Â  }
Â  var pill = document.getElementById('acc-pill-global');
Â  var dotÂ  = document.getElementById('loc-tab-dot');
Â  if(pill) pill.addEventListener('click', goToLocationTab);
Â  if(dot)Â  dot.addEventListener('click', goToLocationTab);
})();

/* ---------------- Category Picker Logic ---------------- */
(function(){
Â  let selectedCategoryId = null;
Â  const pickerBtn = byId('categoryPickerBtn');
Â  const currentLabel = byId('categoryCurrentLabel');
Â  const overlay = byId('categoryOverlay');
Â  const closeBtn = byId('categoryCloseBtn');
Â  const clearBtn = byId('categoryClearBtn');

Â  if (!pickerBtn || !overlay) return;

Â  function openOverlay() { overlay.classList.add('open'); }
Â  function closeOverlay() { overlay.classList.remove('open'); }

Â  window.applyCategorySelection = function(id, name, color) {
Â  Â  selectedCategoryId = id || null;
Â  Â  if (!currentLabel) return;

Â  Â  if (!id) {
Â  Â  Â  currentLabel.textContent = 'No category selected';
Â  Â  Â  currentLabel.classList.add('category-none');
Â  Â  Â  pickerBtn.style.borderColor = '';
Â  Â  Â  pickerBtn.style.boxShadow = '';
Â  Â  } else {
Â  Â  Â  currentLabel.textContent = name || 'Categorized';
Â  Â  Â  currentLabel.classList.remove('category-none');
Â  Â  Â  if (color) {
Â  Â  Â  Â  pickerBtn.style.borderColor = color;
Â  Â  Â  Â  pickerBtn.style.boxShadow = '0 0 0 1px ' + color;
Â  Â  Â  }
Â  Â  }
Â  Â  if (typeof autoSaveSoon === 'function') autoSaveSoon();
Â  };

Â  pickerBtn.addEventListener('click', openOverlay);
Â  closeBtn.addEventListener('click', closeOverlay);
Â  overlay.addEventListener('click', e => { if (e.target === overlay) closeOverlay(); });
Â  clearBtn.addEventListener('click', () => { window.applyCategorySelection(null); closeOverlay(); });

Â  document.querySelectorAll('.category-option').forEach(opt => {
Â  Â  opt.addEventListener('click', () => {
Â  Â  Â  window.applyCategorySelection(opt.dataset.categoryId, opt.dataset.categoryName, opt.dataset.categoryColor);
Â  Â  Â  closeOverlay();
Â  Â  });
Â  });
})();

/* ---------------- Season Picker Logic ---------------- */
(function(){
Â  const seasonData = [
Â  Â  { id: 'spring', name: 'Spring', desc: 'Buds, new leaves, and flowers.', color: '#a3e635' },
Â  Â  { id: 'summer', name: 'Summer', desc: 'Full leaf canopy and growth.', color: '#facc15' },
Â  Â  { id: 'autumn', name: 'Autumn', desc: 'Changing leaf colors and fruit.', color: '#f97316' },
Â  Â  { id: 'winter', name: 'Winter', desc: 'Bare branches, snow, and dormancy.', color: '#7dd3fc' }
Â  ];

Â  const overlayHTML = `
Â  Â  <div id="seasonOverlay" class="category-overlay">
Â  Â  Â  <div class="category-panel">
Â  Â  Â  Â  <header class="category-panel-header">
Â  Â  Â  Â  Â  <h2>Choose a season</h2>
Â  Â  Â  Â  Â  <button type="button" class="btn-ghost" id="seasonCloseBtn">Close</button>
Â  Â  Â  Â  </header>
Â  Â  Â  Â  <p class="category-panel-intro">Select the season when the photos were taken.</p>
Â  Â  Â  Â  <ul class="category-list" id="seasonList"></ul>
Â  Â  Â  Â  <div class="category-panel-footer">
Â  Â  Â  Â  Â  <button type="button" class="btn-ghost" id="seasonClearBtn">Clear season</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  `;
Â  document.body.insertAdjacentHTML('beforeend', overlayHTML);

Â  const seasonList = byId('seasonList');
Â  seasonData.forEach(season => {
Â  Â  const li = document.createElement('li');
Â  Â  li.className = 'category-option';
Â  Â  li.dataset.seasonId = season.id;
Â  Â  li.dataset.seasonName = season.name;
Â  Â  li.dataset.seasonColor = season.color;
Â  Â  li.style.borderColor = season.color;
Â  Â  li.innerHTML = `
Â  Â  Â  <div class="category-text">
Â  Â  Â  Â  <div class="category-name">${season.name}</div>
Â  Â  Â  Â  <div class="category-desc">${season.desc}</div>
Â  Â  Â  </div>
Â  Â  `;
Â  Â  seasonList.appendChild(li);
Â  });

Â  const pickerBtn = byId('seasonPickerBtn');
Â  const currentLabel = byId('seasonCurrentLabel');
Â  const overlay = byId('seasonOverlay');
Â  const closeBtn = byId('seasonCloseBtn');
Â  const clearBtn = byId('seasonClearBtn');

Â  function openOverlay() { overlay.classList.add('open'); }
Â  function closeOverlay() { overlay.classList.remove('open'); }

Â  window.applySeasonSelection = function(id, name, color) {
Â  Â  pickerBtn.dataset.selectedId = id || '';
Â  Â  currentLabel.textContent = name || 'Not specified';
Â  Â  currentLabel.classList.toggle('category-none', !id);

Â  Â  const hintEl = byId('seasonHint');
Â  Â  if (hintEl) {
Â  Â  Â  const hints = {
Â  Â  Â  Â  spring: 'Spring: Photograph new leaves or blooms to record active growth.',
Â  Â  Â  Â  summer: 'Summer: Capture the full canopy to document maximum size.',
Â  Â  Â  Â  autumn: 'Autumn: Shoot the color change to display seasonal transformation.',
Â  Â  Â  Â  winter: 'Winter: Isolate bare branches to showcase structural architecture.'
Â  Â  Â  };
Â  Â  Â  hintEl.textContent = hints[id] || 'Select a season to see photo suggestions.';
Â  Â  }

Â  Â  if (color) {
Â  Â  Â  pickerBtn.style.borderColor = color;
Â  Â  Â  pickerBtn.style.borderWidth = '2px';
Â  Â  } else {
Â  Â  Â  pickerBtn.style.borderColor = '';
Â  Â  Â  pickerBtn.style.borderWidth = '';
Â  Â  }

Â  Â  if (typeof autoSaveSoon === 'function') autoSaveSoon();
Â  };

Â  pickerBtn.addEventListener('click', openOverlay);
Â  closeBtn.addEventListener('click', closeOverlay);
Â  overlay.addEventListener('click', e => { if (e.target === overlay) closeOverlay(); });
Â  clearBtn.addEventListener('click', () => { window.applySeasonSelection(null); closeOverlay(); });

Â  seasonList.querySelectorAll('.category-option').forEach(opt => {
Â  Â  opt.addEventListener('click', () => {
Â  Â  Â  window.applySeasonSelection(opt.dataset.seasonId, opt.dataset.seasonName, opt.dataset.seasonColor);
Â  Â  Â  closeOverlay();
Â  Â  });
Â  });
})();

/* ---------------- Photos Tab Logic ---------------- */
(function(){
Â  const photoDeviceBtn = byId('photoDeviceBtn');
Â  const photoDeviceInput = byId('photoDevice');
Â  const photoCameraInput = byId('photoCamera');
Â  const dragToggleBtn = byId('dragToggleBtn');
Â  const sectionsContainer = byId('photoSectionsContainer');

Â  // Modal elements for photo removal
Â  const photoRemoveModal = byId('photoRemoveModal');
Â  const photoRemovePreview = byId('photoRemovePreview');
Â  const photoRemoveCancelBtn = byId('photoRemoveCancelBtn');
Â  const photoRemoveConfirmBtn = byId('photoRemoveConfirmBtn');

Â  let photos = []; // { id, src, section }
Â  let isDragMode = false;
Â  let draggedItem = null;
Â  let photoIdToDelete = null;

Â  // SortableJS instances for each photo grid
Â  let sortableInstances = [];
Â  // A map to keep track of Sortable instances by section ID
Â  const sortableMap = new Map();

Â  photoRemoveCancelBtn.addEventListener('click', () => photoRemoveModal.classList.remove('visible'));
Â  photoRemoveConfirmBtn.addEventListener('click', confirmRemovePhoto);

Â  function generatePhotoId() {
Â  Â  return 'p' + Date.now() + Math.random().toString(16).slice(2);
Â  }

Â  function addPhoto(src, section = 'unorganized') {
Â  Â  const photo = { id: generatePhotoId(), src, section };
Â  Â  photos.push(photo);
Â  Â  renderPhotos();
Â  Â  autoSaveSoon();
Â  Â  if (typeof updateAllDisplays === 'function') updateAllDisplays();
Â  }

Â  function removePhoto(id) {
Â  Â  photos = photos.filter(p => p.id !== id);
Â  Â  renderPhotos();
Â  Â  autoSaveSoon();
Â  Â  if (typeof updateAllDisplays === 'function') updateAllDisplays();
Â  }

Â  function showRemovePhotoModal(id, src) {
Â  Â  photoIdToDelete = id;
Â  Â  photoRemovePreview.src = src;
Â  Â  photoRemoveModal.classList.add('visible');
Â  }

Â  function confirmRemovePhoto() {
Â  Â  if (photoIdToDelete) {
Â  Â  Â  removePhoto(photoIdToDelete);
Â  Â  }
Â  Â  photoRemoveModal.classList.remove('visible');
Â  }

Â  function movePhoto(id, newSection) {
Â  Â  const photo = photos.find(p => p.id === id);
Â  Â  if (photo) {
Â  Â  Â  photo.section = newSection;
Â  Â  Â  renderPhotos();
Â  Â  Â  autoSaveSoon();
Â  Â  Â  if (typeof updateAllDisplays === 'function') updateAllDisplays();
Â  Â  }
Â  }

Â  function createPhotoThumb(photo) {
Â  Â  const div = document.createElement('div');
Â  Â  div.className = 'photo-thumb';
Â  Â  div.dataset.photoId = photo.id;
Â  Â  div.draggable = isDragMode;

Â  Â  const img = document.createElement('img');
Â  Â  img.src = photo.src;
Â  Â  img.alt = 'Photo of ' + (byId('treeName')?.value || 'tree');

Â  Â  const removeBtn = document.createElement('button');
Â  Â  removeBtn.type = 'button';
Â  Â  removeBtn.className = 'photo-remove';
Â  Â  removeBtn.innerHTML = 'Ã—';
Â  Â  removeBtn.title = 'Remove photo';
Â  Â  removeBtn.addEventListener('click', (e) => {
Â  Â  Â  e.stopPropagation();
Â  Â  Â  showRemovePhotoModal(photo.id, photo.src);
Â  Â  });

Â  Â  div.appendChild(img);
Â  Â  div.appendChild(removeBtn);

Â  Â  div.addEventListener('click', () => window.openPhotoOverlay(photo.src, photo.section));

Â  Â  return div;
Â  }

Â  function renderPhotos() {
Â  Â  // Clear all grids first
Â  Â  sectionsContainer.querySelectorAll('.photo-grid').forEach(grid => grid.innerHTML = '');

Â  Â  // Distribute photos into their sections
Â  Â  photos.forEach(photo => {
Â  Â  Â  const sectionEl = sectionsContainer.querySelector(`.photo-section[data-section-id="${photo.section}"]`);
Â  Â  Â  if (sectionEl) {
Â  Â  Â  Â  const grid = sectionEl.querySelector('.photo-grid');
Â  Â  Â  Â  grid.appendChild(createPhotoThumb(photo));
Â  Â  Â  }
Â  Â  });
Â  }

Â  function handleFiles(fileList) {
Â  Â  if (!fileList || fileList.length === 0) return;
Â  Â  Array.from(fileList).forEach(file => {
Â  Â  Â  if (file.type.startsWith('image/')) {
Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  reader.onload = (e) => addPhoto(e.target.result);
Â  Â  Â  Â  reader.readAsDataURL(file);
Â  Â  Â  }
Â  Â  });
Â  }

Â  // Event Listeners
Â  photoDeviceInput.addEventListener('change', (e) => handleFiles(e.target.files));
Â  photoCameraInput.addEventListener('change', (e) => handleFiles(e.target.files));

Â  // Make the new gallery button trigger the hidden file input
Â  byId('photoDeviceBtn').addEventListener('click', () => photoDeviceInput.click());

Â  photoCameraBtn.addEventListener('click', async () => {
Â  Â  const camPlugin = window.Capacitor?.Plugins?.Camera;
Â  Â  if (camPlugin && window.Capacitor?.isNativePlatform?.()) {
Â  Â  Â  try {
Â  Â  Â  Â  const photo = await camPlugin.getPhoto({
Â  Â  Â  Â  Â  quality: 80, resultType: 'dataUrl', source: 'CAMERA', saveToGallery: true
Â  Â  Â  Â  });
Â  Â  Â  Â  if (photo && photo.dataUrl) addPhoto(photo.dataUrl);
Â  Â  Â  } catch (err) { console.warn('Camera error:', err); }
Â  Â  } else {
Â  Â  Â  photoCameraInput.click();
Â  Â  }
Â  });

Â  dragToggleBtn.addEventListener('click', () => {
Â  Â  isDragMode = !isDragMode;
Â  Â  sectionsContainer.classList.toggle('drag-mode', isDragMode);
Â  Â  const textSpan = dragToggleBtn.querySelectorAll('span')[1] || dragToggleBtn.querySelector('span');
Â  Â  if (textSpan) {
Â  Â  Â  textSpan.textContent = isDragMode ? 'Disable Drag & Drop' : 'Enable Drag & Drop';
Â  Â  } else {
Â  Â  Â  dragToggleBtn.textContent = isDragMode ? 'Disable Drag & Drop' : 'Enable Drag & Drop';
Â  Â  }
Â  Â  dragToggleBtn.classList.toggle('active', isDragMode);
Â  Â  renderPhotos(); // Re-render to set draggable attribute

Â  Â  // Initialize or destroy SortableJS instances
Â  Â  if (isDragMode) {
Â  Â  Â  sectionsContainer.querySelectorAll('.photo-grid').forEach(grid => {
Â  Â  Â  Â  const sectionId = grid.closest('.photo-section').dataset.sectionId;
Â  Â  Â  Â  if (!sortableMap.has(sectionId)) {
Â  Â  Â  Â  Â  const sortable = new Sortable(grid, {
Â  Â  Â  Â  Â  Â  group: 'photo-sort', // Allow dragging between grids
Â  Â  Â  Â  Â  Â  animation: 150,
Â  Â  Â  Â  Â  Â  ghostClass: 'dragging', // Use 'dragging' class for the placeholder
Â  Â  Â  Â  Â  Â  onEnd: function (evt) {
Â  Â  Â  Â  Â  Â  Â  const photoId = evt.item.dataset.photoId;
Â  Â  Â  Â  Â  Â  Â  const newSectionId = evt.to.closest('.photo-section').dataset.sectionId;
Â  Â  Â  Â  Â  Â  Â  movePhoto(photoId, newSectionId);
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  sortableMap.set(sectionId, sortable);
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  } else {
Â  Â  Â  sortableMap.forEach(sortable => sortable.destroy());
Â  Â  Â  sortableMap.clear();
Â  Â  }
Â  });

Â  // Expose for autosave
Â  window.getPhotosState = () => ({ season: byId('seasonPickerBtn')?.dataset.selectedId || '', items: photos });
Â  window.setPhotosState = function(state) {
Â  Â  if (state) {
Â  Â  Â  // This data is defined in the season picker script, so we need to access it from there.
Â  Â  Â  const seasonData = [
Â  Â  Â  Â  { id: 'spring', name: 'Spring', desc: 'Buds, new leaves, and flowers.', color: '#a3e635' },
Â  Â  Â  Â  { id: 'summer', name: 'Summer', desc: 'Full leaf canopy and growth.', color: '#facc15' },
Â  Â  Â  Â  { id: 'autumn', name: 'Autumn', desc: 'Changing leaf colors and fruit.', color: '#f97316' },
Â  Â  Â  Â  { id: 'winter', name: 'Winter', desc: 'Bare branches, snow, and dormancy.', color: '#7dd3fc' }
Â  Â  Â  ];
Â  Â  Â  const season = seasonData.find(s => s.id === state.season);
Â  Â  Â  if (typeof window.applySeasonSelection === 'function') window.applySeasonSelection(season?.id, season?.name, season?.color);
Â  Â  Â  photos = state.items || [];
Â  Â  Â  renderPhotos();
Â  Â  }
Â  };
})();

/* ---------------- Species Picker Logic ---------------- */
(function(){
Â  const SPECIES_PACK_URL = 'species-packs/Alberta Base Tree Species/Alberta-Tree-Species-Base-Pack.json';
Â  let allSpecies = [];

Â  const pickerBtn = byId('speciesPickerBtn');
Â  const currentLabel = byId('speciesCurrentLabel');
Â  const overlay = byId('speciesOverlay');
Â  const closeBtn = byId('speciesCloseBtn');
Â  const searchInput = byId('speciesSearchInput');
Â  const speciesListContainer = byId('speciesList');

Â  if (!pickerBtn || !overlay) return;

Â  function openOverlay() { overlay.classList.add('visible'); searchInput.focus(); }
Â  function closeOverlay() { overlay.classList.remove('visible'); }

Â  async function loadSpecies() {
Â  Â  try {
Â  Â  Â  const response = await fetch(SPECIES_PACK_URL);
Â  Â  Â  if (!response.ok) throw new Error('Failed to load species pack');
Â  Â  Â  const packData = await response.json();
Â  Â  Â  allSpecies = packData.rows.sort((a, b) => (a['Name'] || '').localeCompare(b['Name'] || ''));
Â  Â  Â  renderSpeciesList('');
Â  Â  } catch (error) {
Â  Â  Â  console.error('Error loading species:', error);
Â  Â  Â  speciesListContainer.innerHTML = '<div class="modal-body">Error loading species.</div>';
Â  Â  }
Â  }

Â  function renderSpeciesList(filter) {
Â  Â  const lowerFilter = filter.toLowerCase();
Â  Â  const filtered = allSpecies.filter(s =>
Â  Â  Â  (s['Name'] || '').toLowerCase().includes(lowerFilter) ||
Â  Â  Â  s['Scientific Name'].toLowerCase().includes(lowerFilter)
Â  Â  );

Â  Â  if (filtered.length === 0) {
Â  Â  Â  speciesListContainer.innerHTML = '<div class="modal-body">No species match your search.</div>';
Â  Â  Â  return;
Â  Â  }

Â  Â  speciesListContainer.innerHTML = filtered.map(s => `
Â  Â  Â  <div class="category-option" data-name="${escapeHtml(s['Name'])}" data-sci-name="${escapeHtml(s['Scientific Name'])}">
Â  Â  Â  Â  <div class="category-text">
Â  Â  Â  Â  Â  <div class="category-name">${s['Name']}</div>
Â  Â  Â  Â  Â  <div class="category-desc"><em>${s['Scientific Name']}</em></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  `).join('');
Â  }

Â  window.applySpeciesSelection = function(name, sciName) {
Â  Â  pickerBtn.dataset.speciesName = name || '';
Â  Â  pickerBtn.dataset.speciesSciName = sciName || '';
Â  Â  currentLabel.textContent = name || 'â€” select species â€”';
Â  Â  currentLabel.classList.toggle('category-none', !name);
Â  Â  if (typeof autoSaveSoon === 'function') autoSaveSoon();
Â  };

Â  pickerBtn.addEventListener('click', openOverlay);
Â  closeBtn.addEventListener('click', closeOverlay);
Â  overlay.addEventListener('click', e => { if (e.target === overlay) closeOverlay(); });
Â  searchInput.addEventListener('input', e => renderSpeciesList(e.target.value));
Â  speciesListContainer.addEventListener('click', e => {
Â  Â  const option = e.target.closest('.category-option');
Â  Â  if (option) {
Â  Â  Â  window.applySpeciesSelection(option.dataset.name, option.dataset.sciName);
Â  Â  Â  closeOverlay();
Â  Â  }
Â  });

Â  loadSpecies(); // Load data when the script runs
})();

/* ---------------- Logbook Integration ---------------- */
(function(){
Â  const LOG_STORAGE_KEY = 'ara_field_log_v1';
Â  const urlParams = new URLSearchParams(window.location.search);
Â  const loadedLogId = urlParams.get('logId');

Â  const saveBtn = byId('saveToLogBtn');
Â  if (!saveBtn) return;

Â  function getLog() {
Â  Â  let log = [];
Â  Â  try {
Â  Â  Â  const raw = localStorage.getItem(LOG_STORAGE_KEY);
Â  Â  Â  if (raw) log = JSON.parse(raw);
Â  Â  } catch (e) { console.error("Failed to parse log", e); }
Â  Â  return log;
Â  }

Â  function saveLog(log) {
Â  Â  localStorage.setItem(LOG_STORAGE_KEY, JSON.stringify(log));
Â  }

Â  function generateUUID() {
Â  Â  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
Â  Â  Â  const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
Â  Â  Â  return v.toString(16);
Â  Â  });
Â  }

Â  function handleSaveOrUpdate() {
Â  Â  const currentState = getFormState();
Â  Â  if (!currentState) {
Â  Â  Â  console.error("Could not get form state to save.");
Â  Â  Â  return;
Â  Â  }

Â  Â  let log = getLog();

Â  Â  if (loadedLogId) {
Â  Â  Â  // UPDATE existing entry
Â  Â  Â  const entryIndex = log.findIndex(e => e.logId === loadedLogId);
Â  Â  Â  if (entryIndex > -1) {
Â  Â  Â  Â  const originalEntry = log[entryIndex];
Â  Â  Â  Â  // Preserve original timestamp and ID, but update everything else
Â  Â  Â  Â  log[entryIndex] = {Â 
Â  Â  Â  Â  Â  ...currentState,Â 
Â  Â  Â  Â  Â  logId: loadedLogId,Â 
Â  Â  Â  Â  Â  logTimestamp: originalEntry.logTimestamp,
Â  Â  Â  Â  Â  lastModifiedTimestamp: Date.now() // Add/update modified timestamp
Â  Â  Â  Â  };
Â  Â  Â  } else {
Â  Â  Â  Â  // If ID not found, treat as a new save to be safe
Â  Â  Â  Â  currentState.logId = loadedLogId; // Keep the ID from the URL
Â  Â  Â  Â  currentState.logTimestamp = Date.now();
Â  Â  Â  Â  log.push(currentState);
Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  // CREATE new entry
Â  Â  Â  currentState.logId = generateUUID();
Â  Â  Â  currentState.logTimestamp = Date.now();
Â  Â  Â  log.push(currentState);
Â  Â  }

Â  Â  saveLog(log);

Â  Â  // Visual feedback
Â  Â  const originalText = saveBtn.textContent;
Â  Â  saveBtn.textContent = loadedLogId ? 'Updated âœ“' : 'Saved âœ“';
Â  Â  saveBtn.classList.add('saved');
Â  Â  setTimeout(() => { saveBtn.textContent = originalText; saveBtn.classList.remove('saved'); }, 1500);
Â  }

Â  // Change button text if we are in "update" mode
Â  if (loadedLogId) {
Â  Â  saveBtn.textContent = 'Update Log';
Â  }

Â  saveBtn.addEventListener('click', handleSaveOrUpdate);

Â  // Link category selection to the save state
Â  const catBtn = byId('categoryPickerBtn');
Â  if (catBtn) {
Â  Â  const originalApply = window.applyCategorySelection;
Â  Â  window.applyCategorySelection = function(id, name, color) {
Â  Â  Â  originalApply(id, name, color);
Â  Â  Â  catBtn.dataset.selectedId = id || '';
Â  Â  };
Â  }
})();
// Make the header accuracy pill and tab dot clickable (opens location tab)//

/* ---------------- Autosave (core, hardened) ---------------- */
var SAVE_KEY = 'ara_field_v1';

function getFormState(){
Â  try {
Â  Â  return {
Â  Â  Â  inputUnit: inputUnit,
Â  Â  Â  basics: {
Â  Â  Â  Â  name:Â  Â  Â  byId('treeName')?.value || '',
Â  Â  Â  Â  species:Â  Â byId('species')?.value || '',
Â  Â  Â  Â  // New species picker data
Â  Â  Â  Â  speciesName: byId('speciesPickerBtn')?.dataset.speciesName || '',
Â  Â  Â  Â  speciesSciName: byId('speciesPickerBtn')?.dataset.speciesSciName || '',
Â  Â  Â  Â  condition: byId('conditionPickerBtn')?.dataset.selectedId || '',Â 
Â  Â  Â  Â  type:Â  Â  Â  byId('treeType')?.value || '',
Â  Â  Â  Â  category:Â  byId('categoryPickerBtn')?.dataset.selectedId || null
Â  Â  Â  },
Â  Â  Â  singleC: byId('singleC')?.value || '',
Â  Â  Â  slopeC: {
Â  Â  Â  Â  upper: byId('slopeUpperC')?.value || '',
Â  Â  Â  Â  lower: byId('slopeLowerC')?.value || ''
Â  Â  Â  },
Â  Â  Â  multi:Â  Â { values: $all('#mt-list input[type="number"]').map(i => i.value || '') },
Â  Â  Â  height:Â  { angle: byId('h-angle')?.value || '', dist: byId('h-dist')?.value || '', eye: byId('h-eye')?.value || '' },
Â  Â  Â  spread:Â  { major: byId('spreadMajor')?.value || '', minor: byId('spreadMinor')?.value || '' },
Â  Â  Â  notes:Â  Â byId('notes')?.value || '',
Â  Â  Â  photos:Â  (typeof window.getPhotosState === 'function') ? window.getPhotosState() : null,
Â  Â  Â  location: {
Â  Â  Â  Â  lat: byId('lat')?.value || '',
Â  Â  Â  Â  lng: byId('lng')?.value || '',
Â  Â  Â  Â  acc: byId('acc')?.value || '',
Â  Â  Â  Â  alt: (byId('loc-saved-alt')?.dataset?.val) || '',
Â  Â  Â  Â  ts:Â  (byId('loc-saved-ts')?.dataset?.ts)Â  || ''
Â  Â  Â  },
Â  Â  Â  // NEW: persist the computed results as plain JSON
Â  Â  Â  results: {
Â  Â  Â  Â  lastHeight: lastHeight || null,
Â  Â  Â  Â  lastSingle: lastSingle || null,
Â  Â  Â  Â  lastMulti:Â  lastMultiÂ  || null,
Â  Â  Â  Â  lastSpread: lastSpread || null
Â  Â  Â  },
Â  Â  Â  // NEW: persist what the location cards/map show
Â  Â  Â  locRuntime: (typeof window.locExportRuntime === 'function') ? window.locExportRuntime() : null,
Â  Â  Â  desc: (byId('desc') && byId('desc').innerHTML && byId('desc').innerHTML !== 'â€”') ? byId('desc').innerHTML : ''
Â  Â  ,
Â  Â  Â  // If we loaded from a log, keep the ID
Â  Â  Â  logId: (new URLSearchParams(window.location.search)).get('logId') || null
Â  Â  };
Â  } catch(e){ console.warn('getFormState failed', e); return null; }
}

function setFormState(st){
Â  try{
Â  Â  if(!st) return;

Â  Â  // If loading from a log entry, the state object 'st' is the entry itself.
Â  Â  // If loading from autosave, the state object is from localStorage.
Â  Â  const loadedLogId = (new URLSearchParams(window.location.search)).get('logId');
Â  Â  if (loadedLogId && !st.logId) {
Â  Â  Â  // This means we're loading from a direct URL click, not from autosave.
Â  Â  Â  // We need to find the entry in the main log.
Â  Â  Â  const log = JSON.parse(localStorage.getItem('ara_field_log_v1') || '[]');
Â  Â  Â  const entryToLoad = log.find(e => e.logId === loadedLogId);
Â  Â  Â  if (entryToLoad) {
Â  Â  Â  Â  st = entryToLoad; // Replace the autosave state with the log entry state.
Â  Â  Â  } else {
Â  Â  Â  Â  return; // Log entry not found, do nothing.
Â  Â  Â  }
Â  Â  }

Â  Â  // Restore computed result objects for Results + Key measurements FIRST
Â  Â  // These global variables are the "source" for all displays.
Â  Â  if (st.results) {
Â  Â  Â  lastHeight = st.results.lastHeight ?? null;
Â  Â  Â  lastSingle = st.results.lastSingle ?? null;
Â  Â  Â  lastMultiÂ  = st.results.lastMultiÂ  ?? null;
Â  Â  Â  lastSpread = st.results.lastSpread ?? null;
Â  Â  }
Â  Â  // Restore unit + mode
Â  Â  if(st.inputUnit && st.inputUnit !== inputUnit) setUnit(st.inputUnit);

Â  Â  // Basics
Â  Â  byId('treeName')Â  && (byId('treeName').valueÂ  = st.basics?.name || '');
Â  Â  // byId('species')Â  Â && (byId('species').valueÂ  Â = st.basics?.species || ''); // Old input, no longer used

Â  Â  // New species picker
Â  Â  if (st.basics?.speciesName && typeof window.applySpeciesSelection === 'function') {
Â  Â  Â  window.applySpeciesSelection(st.basics.speciesName, st.basics.speciesSciName);
Â  Â  }

Â  Â  if (st.basics?.type && typeof window.applyTreeTypeSelection === 'function') {
Â  Â  Â  window.applyTreeTypeSelection(st.basics.type);
Â  Â  }
Â  Â Â 
Â  Â  // Category
Â  Â  if (st.basics?.category && typeof window.applyCategorySelection === 'function') {
Â  Â  Â  const catId = st.basics.category;
Â  Â  Â  const catOption = document.querySelector(`.category-option[data-category-id="${catId}"]`);
Â  Â  Â  if (catOption) {
Â  Â  Â  Â  window.applyCategorySelection(catId, catOption.dataset.categoryName, catOption.dataset.categoryColor);
Â  Â  Â  Â  byId('categoryPickerBtn').dataset.selectedId = catId;
Â  Â  Â  }
Â  Â  }

Â  Â  Â // Condition (restored for the new popup) - This now runs *after* the popup is created.
Â  Â  if (st.basics?.condition && typeof window.applyConditionSelection === 'function') {
Â  Â  Â  const condId = st.basics.condition;
Â  Â  Â  const condOption = document.querySelector(`#conditionList .category-option[data-condition-id="${condId}"]`);
Â  Â  Â  if (condOption) {
Â  Â  Â  Â  window.applyConditionSelection(condId, condOption.dataset.conditionName, condOption.dataset.conditionColor);
Â  Â  Â  }
Â  Â  }
Â  Â  updateTypeVisibility();

Â  Â  // Single circumference
Â  Â  if (byId('singleC')) byId('singleC').value = st.singleC || '';
Â  Â  recomputeSingle(); // Explicit call to update display

Â  Â  // Slope circumference
Â  Â  if (byId('slopeUpperC')) byId('slopeUpperC').value = st.slopeC?.upper || '';
Â  Â  if (byId('slopeLowerC')) byId('slopeLowerC').value = st.slopeC?.lower || ''; // Fixed typo
Â  Â  recomputeSlope(); // Explicit call to update display


Â  Â  // Multi-trunk list
Â  Â  if(byId('mt-list')){
Â  Â  Â  var list = byId('mt-list');
Â  Â  Â  list.innerHTML = '';
Â  Â  Â  var vals = (st.multi && Array.isArray(st.multi.values)) ? st.multi.values : [];
Â  Â  Â  if (vals.length){
Â  Â  Â  Â  vals.forEach(v => addMtRow(v));
Â  Â  Â  } else {
Â  Â  Â  Â  addMtRow();
Â  Â  Â  Â  addMtRow();
Â  Â  Â  }
Â  Â  Â  calcMulti(); // Explicit call to update display
Â  Â  }

Â  Â  // Height inputs
Â  Â  if (byId('h-angle')) byId('h-angle').value = st.height?.angle || '';
Â  Â  if (byId('h-dist'))Â  byId('h-dist').valueÂ  = st.height?.distÂ  || '';
Â  Â  if (byId('h-eye'))Â  Â byId('h-eye').valueÂ  Â = st.height?.eyeÂ  Â || '';
Â  Â  calcHeight(); // Explicit call to update display

Â  Â  // Canopy inputs
Â  Â  if (byId('spreadMajor')) byId('spreadMajor').value = st.spread?.major || '';
Â  Â  if (byId('spreadMinor')) byId('spreadMinor').value = st.spread?.minor || '';
Â  Â  calcSpread(); // Explicit call to update display

Â  Â  // Notes
Â  Â  if(byId('notes')){
Â  Â  Â  byId('notes').value = st.notes || '';
Â  Â  Â  autoGrow(byId('notes'));
Â  Â  }

Â  Â  // Photos
Â  Â  if (st.photos && typeof window.setPhotosState === 'function') {
Â  Â  Â  window.setPhotosState(st.photos);
Â  Â  }

Â  Â  // Location hidden fields
Â  Â  if(st.location){
Â  Â  Â  byId('lat') && (byId('lat').value = st.location.lat || '');
Â  Â  Â  byId('lng') && (byId('lng').value = st.location.lng || '');
Â  Â  Â  byId('acc') && (byId('acc').value = st.location.acc || '');
Â  Â  Â  var saÂ  = byId('loc-saved-alt');
Â  Â  Â  var stp = byId('loc-saved-ts');
Â  Â  Â  sa?.datasetÂ  && (sa.dataset.val = st.location.alt || '');
Â  Â  Â  stp?.dataset && (stp.dataset.tsÂ  = st.location.tsÂ  || '');
Â  Â  }

Â  Â  // Restore location runtime (cards + map) + global accuracy pill
Â  Â  if (st.locRuntime && typeof window.locImportRuntime === 'function') {
Â  Â  Â  window.locImportRuntime(st.locRuntime);

Â  Â  Â  if (typeof paintGlobalAcc === 'function') {
Â  Â  Â  Â  var b = st.locRuntime && st.locRuntime.best;
Â  Â  Â  Â  var r = st.locRuntime && st.locRuntime.recent;
Â  Â  Â  Â  if (b && Number.isFinite(b.acc)) {
Â  Â  Â  Â  Â  paintGlobalAcc(b.acc, { state:'ok' });
Â  Â  Â  Â  } else if (r && Number.isFinite(r.acc)) {
Â  Â  Â  Â  Â  paintGlobalAcc(r.acc, { state:'ok' });
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  paintGlobalAcc(NaN, { state:'off' });
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }

Â  Â  // Description + Copy Description button (moved after all calculations)
Â  Â  if (byId('desc')) {
Â  Â  Â  if (st.desc) {
Â  Â  Â  Â  byId('desc').innerHTML = st.desc;
Â  Â  Â  Â  copyDesc?.removeAttribute('disabled');
Â  Â  Â  } else {
Â  Â  Â  Â  byId('desc').innerHTML = 'â€”';
Â  Â  Â  Â  copyDesc?.setAttribute('disabled', '');
Â  Â  Â  }
Â  Â  }

Â  Â  // Refresh all the summary UI
Â  Â  updateAllDisplays();

Â  } catch(e){
Â  Â  console.warn('setFormState failed', e);
Â  }
}

function saveState(){
Â  try{
Â  Â  var st = getFormState();
Â  Â  if (st) localStorage.setItem(SAVE_KEY, JSON.stringify(st));
Â  }catch(e){ console.warn('saveState failed', e); }
}
function loadState(){
Â  try{
Â  Â  var raw = localStorage.getItem(SAVE_KEY);
Â  Â  if(!raw){
Â  Â  Â  if(byId('treeType')?.value==='Multi trunked tree' && byId('mt-list') && byId('mt-list').children.length===0){ addMtRow(); addMtRow(); }
Â  Â  Â  return;
Â  Â  }
Â  Â  setFormState(JSON.parse(raw));
Â  }catch(e){ console.warn('loadState failed', e); }
}

function loadStateFromLogOrAutosave() {
Â  try {
Â  Â  const urlParams = new URLSearchParams(window.location.search);
Â  Â  const logId = urlParams.get('logId');
Â  Â  // The setFormState function now contains the logic to prioritize a log entry
Â  Â  // if a logId is in the URL. So we just call loadState as usual.
Â  Â  loadState();
Â  }catch(e){ console.warn('loadState failed', e); }
}

var _asTimer = null;
function autoSaveSoon(){
Â  try{
Â  Â  if (_asTimer) clearTimeout(_asTimer);
Â  Â  _asTimer = setTimeout(function(){
Â  Â  Â  if (!window.ARA_RESETTING) saveState();
Â  Â  }, 250);
Â  }catch(e){ console.warn('autoSaveSoon failed', e); }
}
Â Â 
/* ---------------- Connectivity card (online/offline) ---------------- */
/* Paint â€œConnectivityâ€ card + map hint */
function connNowISO(){
Â  var d=new Date(); var p=n=>String(n).padStart(2,'0');
Â  return p(d.getHours())+':'+p(d.getMinutes());
}

function setConnUI(isOnline){
Â  var cardÂ  Â = document.getElementById('conn-card');
Â  var labelÂ  = document.getElementById('conn-label');
Â  var whenÂ  Â = document.getElementById('conn-checked');
Â  var mapWarn= document.getElementById('map-offline-card');

Â  if(!card || !label || !when) return;

Â  // Border color via state class
Â  card.classList.remove('conn-online','conn-offline');
Â  card.classList.add(isOnline ? 'conn-online' : 'conn-offline');

Â  // Text + timestamp
Â  when.textContent = connNowISO();
Â  if(isOnline){
Â  Â  label.textContent = 'Youâ€™re online. Map tiles stream normally and email/share are enabled.';
Â  }else{
Â  Â  label.textContent = 'Youâ€™re offline. GPS still works; map tiles youâ€™ve already viewed may still appear.';
Â  }

Â  // Map visual: dim tiles + show/hide offline card
Â  try{
Â  Â  if(typeof window.mapSetDim === 'function') window.mapSetDim(!isOnline);
Â  }catch(e){}

Â  if(mapWarn){
Â  Â  mapWarn.style.display = isOnline ? 'none' : '';
Â  }
}

/* --- Robust connectivity probe for Android WebView / airplane mode --- */
/* Lightweight image probe (CORS-free). If it loads within timeout, we're online. */
function probeOnline(timeout = 2500){
Â  return new Promise((resolve) => {
Â  Â  let settled = false;
Â  Â  const img = new Image();
Â  Â  const done = (ok) => {
Â  Â  Â  if (settled) return;
Â  Â  Â  settled = true;
Â  Â  Â  clearTimeout(t);
Â  Â  Â  img.onload = img.onerror = null;
Â  Â  Â  resolve(ok);
Â  Â  };
Â  Â  const t = setTimeout(() => done(false), timeout);
Â  Â  img.onloadÂ  = () => done(true);
Â  Â  img.onerror = () => done(false);
Â  Â  img.src = 'https://tile.openstreetmap.org/0/0/0.png?cb=' + Date.now(); // cache-buster
Â  });
}

/* Active check: consider ONLINE only if navigator.onLine AND probe say true */
async function checkConnectivity(_reason){
Â  const basic = (navigator.onLine === true);
Â  let probeOK = false;
Â  try { probeOK = await probeOnline(); } catch { probeOK = false; }
Â  const isOnline = basic && probeOK;
Â  setConnUI(isOnline);
Â  return isOnline;
}

/* Foreground polling control (paused when hidden) */
let _connTimer = null;
function startConnPolling(){
Â  if (_connTimer) return;
Â  _connTimer = setInterval(() => checkConnectivity('poll'), 15000);
}
function stopConnPolling(){
Â  if (_connTimer){ clearInterval(_connTimer); _connTimer = null; }
}

/* Single public init: call this ONCE from your existing DOMContentLoaded */
function initConnectivity(){
Â  // Button click
Â  var btn = document.getElementById('conn-recheck');
Â  if(btn) btn.addEventListener('click', function(){ checkConnectivity('manual'); });

Â  // OS/network events
Â  window.addEventListener('online',Â  function(){ checkConnectivity('online-event');Â  });
Â  window.addEventListener('offline', function(){ checkConnectivity('offline-event'); });

Â  // Pause/resume polling on tab visibility
Â  document.addEventListener('visibilitychange', function(){
Â  Â  if (document.hidden) stopConnPolling();
Â  Â  else { startConnPolling(); checkConnectivity('visible'); }
Â  });

Â  // First paint + start polling
Â  checkConnectivity('startup');
Â  startConnPolling();
}


Â  /* ---------------- Reset form (safe) ---------------- */
Â  var resetFormResults = byId('resetFormResults');
Â  if (resetFormResults){
Â  Â  resetFormResults.onclick = function(){
Â  Â  Â  window.ARA_RESETTING = true;
Â  Â  Â  try{
Â  Â  Â  Â  if (_asTimer) clearTimeout(_asTimer); // Prevent a final save
Â  Â  Â  Â  localStorage.removeItem(SAVE_KEY); // Clear the saved state
Â  Â  Â  }catch(e){ /* ignore */ }
Â  Â  Â  // Hard refresh to clear any transient runtime state
Â  Â  Â  location.replace(location.href.split('#')[0]);
Â  Â  };
Â  }
Â Â 
Â  // Connectivity: wire up events + initial check
initConnectivity();
Â  wireAutosaveInputs();

</script>
<script>
Â  // This script runs after the DOM is loaded to ensure elements exist.
Â  document.addEventListener('DOMContentLoaded', function() {
Â  Â  // --- Condition Picker Modal ---
Â  Â  (function(){
Â  Â  Â  const conditionData = [
Â  Â  Â  Â  { id: 'Healthy', name: 'Healthy', desc: 'Appears to be in good overall health.', color: 'var(--cond-healthy)' },
Â  Â  Â  Â  { id: 'In decline', name: 'In decline', desc: 'Showing signs of stress, disease, or reduced vitality.', color: 'var(--cond-decline)' },
Â  Â  Â  Â  { id: 'Damaged', name: 'Damaged', desc: 'Visible physical damage from weather, animals, or human activity.', color: 'var(--cond-damaged)' },
Â  Â  Â  Â  { id: 'Dead', name: 'Dead', desc: 'Standing, but with no signs of life.', color: 'var(--cond-dead)' },
Â  Â  Â  Â  { id: 'Fallen', name: 'Fallen', desc: 'The tree is no longer standing.', color: 'var(--cond-fallen)' }
Â  Â  Â  ];

Â  Â  Â  const overlayHTML = `
Â  Â  Â  Â  <div id="conditionOverlay" class="category-overlay">
Â  Â  Â  Â  Â  <div class="category-panel">
Â  Â  Â  Â  Â  Â  <header class="category-panel-header">
Â  Â  Â  Â  Â  Â  Â  <h2>Choose a condition</h2>
Â  Â  Â  Â  Â  Â  Â  <button type="button" class="btn-ghost" id="conditionCloseBtn">Close</button>
Â  Â  Â  Â  Â  Â  </header>
Â  Â  Â  Â  Â  Â  <p class="category-panel-intro">Select the overall condition of the tree.</p>
Â  Â  Â  Â  Â  Â  <ul class="category-list" id="conditionList"></ul>
Â  Â  Â  Â  Â  Â  <div class="category-panel-footer">
Â  Â  Â  Â  Â  Â  Â  <button type="button" class="btn-ghost" id="conditionClearBtn">Clear condition</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>`;
Â  Â  Â  document.body.insertAdjacentHTML('beforeend', overlayHTML);

Â  Â  Â  const conditionList = byId('conditionList');
Â  Â  Â  conditionData.forEach(cond => {
Â  Â  Â  Â  const li = document.createElement('li');
Â  Â  Â  Â  li.className = 'category-option';
Â  Â  Â  Â  li.dataset.conditionId = cond.id;
Â  Â  Â  Â  li.dataset.conditionName = cond.name;
Â  Â  Â  Â  li.dataset.conditionColor = cond.color;
Â  Â  Â  Â  li.style.borderColor = cond.color;
Â  Â  Â  Â  li.innerHTML = `<div class="category-text"><div class="category-name">${cond.name}</div><div class="category-desc">${cond.desc}</div></div>`;
Â  Â  Â  Â  conditionList.appendChild(li);
Â  Â  Â  });

Â  Â  Â  // --- Condition Picker Logic (moved here) ---
Â  Â  Â  const pickerBtn = byId('conditionPickerBtn'); // This is the button that opens the modal
Â  Â  Â  const currentLabel = byId('conditionCurrentLabel');
Â  Â  Â  const overlay = byId('conditionOverlay');
Â  Â  Â  const closeBtn = byId('conditionCloseBtn');
Â  Â  Â  const clearBtn = byId('conditionClearBtn');

Â  Â  Â  if (!pickerBtn || !overlay) return;

Â  Â  Â  function openOverlay() { overlay.classList.add('open'); }
Â  Â  Â  function closeOverlay() { overlay.classList.remove('open'); }

Â  Â  Â  window.applyConditionSelection = function(id, name, color) {
Â  Â  Â  Â  pickerBtn.dataset.selectedId = id || '';
Â  Â  Â  Â  currentLabel.textContent = name || 'â€” optional â€”';
Â  Â  Â  Â  currentLabel.classList.toggle('category-none', !id);

Â  Â  Â  Â  if (color) {
Â  Â  Â  Â  Â  pickerBtn.style.borderColor = color;
Â  Â  Â  Â  Â  pickerBtn.style.boxShadow = '0 0 0 1px ' + color;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  pickerBtn.style.borderColor = '';
Â  Â  Â  Â  Â  pickerBtn.style.boxShadow = '';
Â  Â  Â  Â  }
Â  Â  Â  Â  if (typeof autoSaveSoon === 'function') autoSaveSoon();
Â  Â  Â  Â  if (typeof updateAllDisplays === 'function') updateAllDisplays();
Â  Â  Â  };

Â  Â  Â  pickerBtn.addEventListener('click', openOverlay);
Â  Â  Â  closeBtn.addEventListener('click', closeOverlay);
Â  Â  Â  overlay.addEventListener('click', e => { if (e.target === overlay) closeOverlay(); });
Â  Â  Â  clearBtn.addEventListener('click', () => { window.applyConditionSelection(null); closeOverlay(); });

Â  Â  Â  byId('conditionList').querySelectorAll('.category-option').forEach(opt => {
Â  Â  Â  Â  opt.addEventListener('click', () => {
Â  Â  Â  Â  Â  window.applyConditionSelection(opt.dataset.conditionId, opt.dataset.conditionName, opt.dataset.conditionColor);
Â  Â  Â  Â  Â  closeOverlay();
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  })();

Â  Â  // --- Tree Type Picker Modal ---
Â  Â  (function(){
Â  Â  Â  const treeTypeData = [
Â  Â  Â  Â  { id: 'Single trunk tree', name: 'Single trunk tree', desc: 'A standard tree with one main trunk.' },
Â  Â  Â  Â  { id: 'Multi trunked tree', name: 'Multi trunked tree', desc: 'A tree that splits into multiple trunks at or near the ground.' },
Â  Â  Â  Â  { id: 'Single trunk on a slope', name: 'Single trunk on a slope', desc: 'A single tree growing on a significant incline.' },
Â  Â  Â  Â  { id: 'Grove', name: 'Grove', desc: 'A small group of trees growing closely together.' },
Â  Â  Â  Â  { id: 'Forest', name: 'Forest', desc: 'A large area covered chiefly with trees and undergrowth.' },
Â  Â  Â  Â  { id: 'Clonal aspen', name: 'Clonal aspen', desc: 'A group of aspen trees that are genetically identical and connected by a single root system.' }
Â  Â  Â  ];

Â  Â  Â  const overlayHTML = `
Â  Â  Â  Â  <div id="treeTypeOverlay" class="category-overlay">
Â  Â  Â  Â  Â  <div class="category-panel">
Â  Â  Â  Â  Â  Â  <header class="category-panel-header">
Â  Â  Â  Â  Â  Â  Â  <h2>Choose a tree type</h2>
Â  Â  Â  Â  Â  Â  Â  <button type="button" class="btn-ghost" id="treeTypeCloseBtn">Close</button>
Â  Â  Â  Â  Â  Â  </header>
Â  Â  Â  Â  Â  Â  <p class="category-panel-intro">Select the type that best describes the tree or group.</p>
Â  Â  Â  Â  Â  Â  <ul class="category-list" id="treeTypeList"></ul>
Â  Â  Â  Â  Â  Â  <div class="category-panel-footer">
Â  Â  Â  Â  Â  Â  Â  <button type="button" class="btn-ghost" id="treeTypeClearBtn">Clear selection</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>`;
Â  Â  Â  document.body.insertAdjacentHTML('beforeend', overlayHTML);

Â  Â  Â  const treeTypeList = byId('treeTypeList');
Â  Â  Â  treeTypeData.forEach(type => {
Â  Â  Â  Â  const li = document.createElement('li');
Â  Â  Â  Â  li.className = 'category-option';
Â  Â  Â  Â  li.dataset.typeId = type.id;
Â  Â  Â  Â  li.innerHTML = `<div class="category-text"><div class="category-name">${type.name}</div><div class="category-desc">${type.desc}</div></div>`;
Â  Â  Â  Â  treeTypeList.appendChild(li);
Â  Â  Â  });

Â  Â  Â  const pickerBtn = byId('treeTypePickerBtn');
Â  Â  Â  const currentLabel = byId('treeTypeCurrentLabel');
Â  Â  Â  const hiddenSelect = byId('treeType');
Â  Â  Â  const overlay = byId('treeTypeOverlay');
Â  Â  Â  const closeBtn = byId('treeTypeCloseBtn');
Â  Â  Â  const clearBtn = byId('treeTypeClearBtn');

Â  Â  Â  function openOverlay() { overlay.classList.add('open'); }
Â  Â  Â  function closeOverlay() { overlay.classList.remove('open'); }

Â  Â  Â  window.applyTreeTypeSelection = function(id) {
Â  Â  Â  Â  currentLabel.textContent = id || 'â€” select â€”';
Â  Â  Â  Â  currentLabel.classList.toggle('category-none', !id);
Â  Â  Â  Â  hiddenSelect.value = id || '';
Â  Â  Â  Â  hiddenSelect.dispatchEvent(new Event('change'));
Â  Â  Â  };

Â  Â  Â  pickerBtn.addEventListener('click', openOverlay);
Â  Â  Â  closeBtn.addEventListener('click', closeOverlay);
Â  Â  Â  overlay.addEventListener('click', e => { if (e.target === overlay) closeOverlay(); });
Â  Â  Â  clearBtn.addEventListener('click', () => { window.applyTreeTypeSelection(''); closeOverlay(); });

Â  Â  Â  treeTypeList.querySelectorAll('.category-option').forEach(opt => {
Â  Â  Â  Â  opt.addEventListener('click', () => {
Â  Â  Â  Â  Â  window.applyTreeTypeSelection(opt.dataset.typeId);
Â  Â  Â  Â  Â  closeOverlay();
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  })();

Â  Â  // --- Capacitor-specific logic ---
Â  Â  (function requestLocationOnceBridgeIsReady(){
Â  Â  Â  const cap = window.Capacitor;
Â  Â  Â  const geo = cap?.Plugins?.Geolocation;

Â  Â  Â  if (!cap || !geo) {
Â  Â  Â  Â  return setTimeout(requestLocationOnceBridgeIsReady, 150);
Â  Â  Â  }
Â  Â  Â  if (!cap.isNativePlatform || !cap.isNativePlatform()) {
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  (async () => {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const s = await geo.checkPermissions();
Â  Â  Â  Â  Â  if (s.location !== 'granted') {
Â  Â  Â  Â  Â  Â  await geo.requestPermissions();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  console.warn('Location permission flow failed:', e);
Â  Â  Â  Â  }
Â  Â  Â  })();
Â  Â  })();

Â  Â  // Finally, after all popups are created, load the state for the whole form.
Â  Â  try { loadStateFromLogOrAutosave(); } catch(e) { console.warn(e); }
Â  });
</script>
</body>
</html>
