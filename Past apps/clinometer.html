<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ARA Clinometer Height (Beta)</title>
<style>
  :root{--radius:12px;--dark:#111;--light:#f2f2f2;--border:#ddd;--muted:#666;--danger:#d93c3c;}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;color:#111;background:#fff}
  h1{margin:0 0 6px;font-size:1.6rem}
  .sub{margin:0 0 12px;color:#666}

  .card{max-width:760px;margin:0 auto;border:1px solid var(--border);border-radius:var(--radius);background:#fff}
  .block{padding:14px 18px}
  .note{background:#fafafa;border:1px solid #eee;border-radius:12px;padding:10px 12px;color:#444}

  .unit-toggle{display:flex;gap:8px;margin:10px 0}
  .toggle-btn{padding:8px 12px;border:1px solid #ccc;border-radius:8px;background:var(--light);cursor:pointer}
  .toggle-btn.active{background:var(--dark);color:#fff;border-color:var(--dark)}
  .toggle-btn:focus-visible{outline:2px solid var(--dark);outline-offset:2px}

  .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:740px){.row{grid-template-columns:1fr}}

  label{display:block;margin:10px 0 6px;font-weight:600}
  input[type="number"],input[type="text"]{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;font-size:1rem;background:#fff}
  button{padding:10px 14px;border:0;border-radius:8px;cursor:pointer}
  .btn-primary{background:var(--dark);color:#fff}
  .btn-secondary{background:#e9e9e9;color:#111}
  .btn-ghost{background:#f5f5f5;color:#111}
  .danger{background:#f5e9e9}
  .danger:hover,.danger:active{background:#d93c3c;color:#fff}
  button[disabled]{opacity:.6;cursor:not-allowed}

  .readout{
    display:flex;align-items:flex-start;gap:16px;justify-content:space-between;
    border:1px solid #e7e7e7;background:#f7f7f7;border-radius:12px;padding:12px;margin:10px 0;
  }
  .angle{font-variant-numeric:tabular-nums;font-size:2.4rem;font-weight:800;letter-spacing:0.5px}
  .micro{color:#666;font-size:.9rem}

  .lock-area{display:flex;justify-content:center;margin:12px 0 6px}
  .lock-btn{
    width:160px;height:160px;border-radius:999px;border:none;background:var(--dark);color:#fff;
    font-size:1.2rem;font-weight:800;letter-spacing:.6px;box-shadow:0 10px 28px rgba(0,0,0,.18);
    display:flex;align-items:center;justify-content:center;
  }
  .lock-btn:active{transform:scale(0.98)}
  .lock-btn[disabled]{background:#bbb;color:#fff;box-shadow:none}

  .btn-row{display:flex;gap:10px;flex-wrap:wrap}
  .result{margin-top:10px;font-size:1.15rem;font-weight:700}
  .foot{margin-top:10px;color:#666;font-size:.9rem;line-height:1.35}
  code{background:#f1f1f1;padding:2px 6px;border-radius:6px}
</style>
</head>
<body>
  <h1>ARA Clinometer Height</h1>
  <p class="sub">Lock the angle from your phone’s sensors, then calculate height. Optional 0° calibration.</p>

  <div class="card">
    <div class="block">
      <div class="note">
        <strong>How to aim:</strong> Hold the phone in <em>portrait</em> and sight along the <em>top edge</em> at the treetop. Tap <strong>Start sensor</strong>, then hit the big <strong>LOCK</strong> circle to capture the angle.
      </div>

      <!-- Toggles -->
      <div class="unit-toggle" role="group" aria-label="Input units">
        <button type="button" id="unit-m"  class="toggle-btn active" aria-pressed="true">Meters (m)</button>
        <button type="button" id="unit-ft" class="toggle-btn" aria-pressed="false">Feet (ft)</button>
      </div>
      <div class="unit-toggle" role="group" aria-label="Options">
        <button type="button" id="sensorStart" class="toggle-btn">Start sensor</button>
        <button type="button" id="sensorReset" class="toggle-btn">Reset sensor</button>
        <button type="button" id="calSet" class="toggle-btn">Set 0°</button>
        <button type="button" id="calClear" class="toggle-btn">Clear 0°</button>
      </div>

      <!-- Live readout -->
      <div class="readout">
        <div>
          <div class="micro">Live angle</div>
          <div class="angle" id="liveAngle">—°</div>
          <div class="micro" id="liveMeta">Sensor: idle • Cal: 0.0°</div>
        </div>
      </div>

      <!-- BIG LOCK BUTTON -->
      <div class="lock-area">
        <button id="lockBig" class="lock-btn" disabled>LOCK</button>
      </div>

      <!-- Form values -->
      <div class="row">
        <div>
          <label for="angle">Locked angle (degrees)</label>
          <input id="angle" type="number" step="0.1" inputmode="decimal" placeholder="locked from sensor or enter manually">
        </div>
        <div></div>
        <div>
          <label for="distance">Distance to trunk (<span id="unit1">m</span>)</label>
          <input id="distance" type="number" step="0.01" inputmode="decimal" placeholder="e.g. 23.4">
        </div>
        <div>
          <label for="eye">Eye height (<span id="unit2">m</span>)</label>
          <input id="eye" type="number" step="0.01" inputmode="decimal" placeholder="e.g. 1.62">
        </div>
      </div>

      <div class="btn-row" style="margin-top:12px;">
        <button type="button" id="calc" class="btn-primary">Calculate height</button>
        <button type="button" id="copyM" class="btn-secondary" disabled>Copy result (m)</button>
        <button type="button" id="reset" class="btn-ghost">Reset</button>
      </div>

      <div class="result" id="out">—</div>
      <div class="micro" id="formula">height = tan(angle°) × distance + eye height</div>

      <div class="foot">
        <strong>Tips:</strong> Lock when the phone is steady. If your case/posture adds bias, tap <em>Set 0°</em> while aiming at true horizontal to calibrate, then <em>Lock</em> on the treetop.
      </div>
    </div>
  </div>

<script>
/* ---------- Utilities ---------- */
const FT_PER_M=3.28084, M_PER_FT=0.3048;
const $=s=>document.querySelector(s);
const clamp=(x,a,b)=>Math.min(b,Math.max(a,x));
const tanDeg=d=>Math.tan(d*Math.PI/180);
const fmt2=x=>Number.isFinite(x)?x.toFixed(2):'—', fmt1=x=>Number.isFinite(x)?x.toFixed(1):'—';

/* ---------- DOM ---------- */
const unitM=$('#unit-m'), unitFt=$('#unit-ft'), unit1=$('#unit1'), unit2=$('#unit2');

const sensorStart=$('#sensorStart'), sensorReset=$('#sensorReset');
const liveAngleEl=$('#liveAngle'), liveMeta=$('#liveMeta');
const lockBig=$('#lockBig');
const angleInp=$('#angle'), distInp=$('#distance'), eyeInp=$('#eye');
const calcBtn=$('#calc'), out=$('#out'), formula=$('#formula'), copyM=$('#copyM'), resetBtn=$('#reset');

const calSet=$('#calSet'), calClear=$('#calClear');

/* ---------- State ---------- */
let unit='m';
let lastRaw=null, locked=false;
let calOffset=0;        // degrees to subtract from raw pitch

/* ---------- Units ---------- */
function setUnit(u){
  if(u===unit) return;
  const conv=inp=>{
    const v=parseFloat(inp.value);
    if(Number.isFinite(v)){
      const m=(unit==='m')?v:(v*M_PER_FT);
      inp.value=(u==='m'?m:m*FT_PER_M).toFixed(2);
    }
  };
  [distInp,eyeInp].forEach(conv);
  unit=u;
  const isM=u==='m';
  unitM.classList.toggle('active',isM); unitFt.classList.toggle('active',!isM);
  unitM.setAttribute('aria-pressed',String(isM)); unitFt.setAttribute('aria-pressed',String(!isM));
  unit1.textContent=isM?'m':'ft';
  unit2.textContent=isM?'m':'ft';
}
unitM.onclick=()=>setUnit('m');
unitFt.onclick=()=>setUnit('ft');

/* ---------- Sensor (DeviceOrientation) ---------- */
function isLandscape(){
  const so = (screen.orientation && screen.orientation.type) || '';
  return so.includes('landscape') ||
         (window.matchMedia && window.matchMedia('(orientation: landscape)').matches) ||
         (window.innerWidth > window.innerHeight);
}
function pitchFromEvent(e){
  const beta = (typeof e.beta==='number') ? e.beta : null;   // front/back tilt
  const gamma= (typeof e.gamma==='number')? e.gamma: null;   // left/right
  let pitch = isLandscape() ? -gamma : beta;                 // portrait: beta; landscape: approx with -gamma
  if(!Number.isFinite(pitch)) return null;
  return clamp(pitch, -89, 89);
}
async function startSensor(){
  try{
    if (typeof DeviceOrientationEvent !== 'undefined' &&
        typeof DeviceOrientationEvent.requestPermission === 'function'){
      const state = await DeviceOrientationEvent.requestPermission();
      if (state !== 'granted'){ updateMeta('denied'); return; }
    }
    window.addEventListener('deviceorientation', onOrient, true);
    lockBig.disabled=false;
    updateMeta('running');
  }catch(err){
    console.error(err);
    updateMeta('unavailable');
  }
}
sensorStart.onclick=()=>{
  sensorStart.classList.add('active');
  startSensor();
};

function onOrient(e){
  const raw = pitchFromEvent(e);
  if(raw==null) return;
  lastRaw = raw;
  if(!locked){
    const adj = clamp(raw - calOffset, -89, 89);
    liveAngleEl.textContent = fmt1(adj) + '°';
  }
}

function updateMeta(state){
  const text = (state==='running') ? 'Sensor: running' :
               (state==='unavailable') ? 'Sensor: unavailable' :
               (state==='denied') ? 'Sensor: denied' : 'Sensor: idle';
  liveMeta.textContent = `${text} • Cal: ${fmt1(calOffset)}°`;
}

/* ---------- Calibration ---------- */
function setZero(){
  if(lastRaw==null){ updateMeta('running'); return; }
  calOffset = lastRaw;    // make current raw become 0°
  calSet.classList.add('active');
  calClear.classList.remove('active');
  updateMeta('running');
  if(!locked){
    const adj = clamp(lastRaw - calOffset, -89, 89);
    liveAngleEl.textContent = fmt1(adj) + '°';
  }
}
function clearZero(){
  calOffset = 0;
  calClear.classList.add('active');
  calSet.classList.remove('active');
  updateMeta('running');
  if(!locked && lastRaw!=null){
    liveAngleEl.textContent = fmt1(lastRaw) + '°';
  }
}
calSet.onclick=setZero;
calClear.onclick=clearZero;

/* ---------- Lock ---------- */
function lockAngle(){
  if(lastRaw==null){ updateMeta('running'); return; }
  const adj = clamp(lastRaw - calOffset, -89, 89);
  locked = true;
  angleInp.value = fmt1(adj);
  lockBig.textContent = 'LOCKED';
  liveAngleEl.textContent = fmt1(adj) + '° (locked)';
  // Haptic tap (if supported)
  if (navigator.vibrate) navigator.vibrate(14);
  // brief visual pulse
  lockBig.style.transform='scale(0.97)';
  setTimeout(()=>{ lockBig.style.transform=''; },120);
}
lockBig.onclick=lockAngle;

/* ---------- Reset SENSOR (new) ---------- */
function resetSensor(){
  // Stop listening
  window.removeEventListener('deviceorientation', onOrient, true);
  sensorStart.classList.remove('active');
  // Clear live state (keep calibration)
  lastRaw = null;
  locked = false;
  lockBig.textContent = 'LOCK';
  lockBig.disabled = true;
  liveAngleEl.textContent = '—°';
  updateMeta('idle');
}
sensorReset.onclick = resetSensor;

/* ---------- Calculation ---------- */
function calc(){
  const a = parseFloat(angleInp.value);
  const d = parseFloat(distInp.value);
  const eH= parseFloat(eyeInp.value);
  if(!Number.isFinite(a)||!Number.isFinite(d)||!Number.isFinite(eH)){
    out.textContent='—';
    copyM.disabled=true;
    formula.textContent='height = tan(angle°) × distance + eye height';
    return;
  }
  const dM = unit==='m' ? d : d*M_PER_FT;
  const eM = unit==='m' ? eH: eH*M_PER_FT;

  const hM = tanDeg(a) * dM + eM;
  const hFt= hM * FT_PER_M;

  out.textContent = `Height ≈ ${fmt2(hM)} m (${fmt2(hFt)} ft)`;
  formula.textContent = `height = tan(${fmt1(a)}°) × ${fmt2(dM)} m + ${fmt2(eM)} m = ${fmt2(hM)} m (${fmt2(hFt)} ft)`;
  copyM.disabled=false;
}
calcBtn.onclick=calc;
[angleInp,distInp,eyeInp].forEach(i=>i.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); calc(); }}));

/* ---------- Copy & Reset (full app reset) ---------- */
async function copyText(txt,btn){
  try{
    await navigator.clipboard.writeText(txt);
    const o=btn.textContent; btn.textContent='Copied ✓'; btn.classList.add('active');
    setTimeout(()=>{btn.textContent=o; btn.classList.remove('active');},1100);
  }catch{
    const t=document.createElement('input'); t.value=txt; document.body.appendChild(t); t.select(); document.execCommand('copy'); t.remove();
    const o=btn.textContent; btn.textContent='Copied ✓'; btn.classList.add('active');
    setTimeout(()=>{btn.textContent=o; btn.classList.remove('active');},1100);
  }
}
copyM.onclick=()=>{ const m = out.textContent.match(/Height ≈ ([\d.]+)/); if(m) copyText(m[1], copyM); };

resetBtn.onclick=()=>{
  // Reset ONLY the calculator fields & outputs (keep sensor calibration and state as-is)
  angleInp.value=''; distInp.value=''; eyeInp.value='';
  out.textContent='—'; formula.textContent='height = tan(angle°) × distance + eye height';
  copyM.disabled=true;
};

/* ---------- Boot ---------- */
updateMeta('idle');
</script>
</body>
</html>
