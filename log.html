<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ARA Tree Log</title>
<style>
  :root{
    /* Dark blue palette (same as app) */
    --bg:#0d1b2a;
    --bg-elev:#0f2236;
    --panel:#14253d;
    --panel-2:#172a47;
    --text:#e8eef6;
    --muted:#a9b7c7;
    --accent:#2ea3ff;
    --accent-2:#4db2ff;
    --ok:#1fa37a;
    --danger:#d93c3c;
    --border:#1f3553;
    --radius:14px;
    --gap:14px;
  }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg); color:var(--text);
  }

  /* Top bar */
  .topbar{
    position:sticky; top:0; z-index:50;
    background:linear-gradient(180deg,#0d1b2a,#0f2236);
    border-bottom:1px solid var(--border);
    padding:10px 14px;
  }
  .brand{ font-weight:800; letter-spacing:.2px; font-size:1.05rem; color:#eaf3ff; }

  /* Page container */
  .content{ padding:14px; max-width:1000px; margin:0 auto; }

  /* Controls row */
  .controls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:10px 0 14px; }
  .btn, button, a.btn{
    padding:10px 14px; border:0; border-radius:10px; cursor:pointer; color:#001528;
    background:var(--accent-2); font-weight:700; text-decoration:none; display:inline-block;
  }
  .btn-ghost{ background:var(--panel-2); color:var(--text); border:1px solid var(--border); }
  .btn-danger{ background:var(--danger); color:#fff; }
  .btn:disabled, .btn[aria-disabled="true"]{ opacity:.6; pointer-events:none; }

  /* Gallery grid */
  .grid{
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: var(--gap);
  }
  .card{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:14px;
    cursor:pointer;
    transition: transform .08s ease;
  }
  .card:active{ transform:scale(.99); }
  .card h3{
    margin:0 0 6px;
    font-size:1.05rem;
    display:flex; align-items:center; gap:8px;
  }
  .muted{ color:var(--muted); font-size:.92rem; }
  .row{ display:flex; align-items:center; justify-content:space-between; gap:8px; }

  /* Accuracy dot (same palette as app) */
  .acc-dot{ width:10px; height:10px; border-radius:50%; display:inline-block; border:1px solid rgba(0,0,0,.25); }
  .acc-grey{ background:#46505e; }
  .acc-amber{ background:#ffb300; }
  .acc-green{ background:#1b5e2b; }

  /* Empty state */
  .empty{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:18px;
    text-align:center;
    color:#cfe0ff;
  }

  /* Full-screen modal (detail view) */
  .modal{
    position:fixed; inset:0; display:none; z-index:100;
    background:rgba(4,10,18,.75);
    backdrop-filter: blur(2px);
  }
  .modal.show{ display:block; }
  .sheet{
    position:absolute; inset:0;
    max-width:1000px; margin:0 auto;
    background:var(--bg-elev);
    border-left:1px solid var(--border);
    border-right:1px solid var(--border);
    overflow:auto;
  }
  .sheet-header{
    position:sticky; top:0; z-index:5;
    background:linear-gradient(180deg,#0d1b2a,#0f2236);
    border-bottom:1px solid var(--border);
    padding:12px 14px;
  }
  .sheet-title{ font-weight:900; margin:0; }
  .sheet-body{ padding:14px; display:grid; gap:14px; }

  .box{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:16px 18px;
  }
  .box h4{ margin:0 0 8px; font-size:1.05rem; color:#d6e6ff; }
  .results{ background:#0b1a2f; border:1px solid var(--border); border-radius:12px; padding:12px; }
  .results p{ margin:6px 0; }

  .btn-row{ display:flex; gap:10px; flex-wrap:wrap; }

  /* Inline chips row under title in modal */
  .chips{ display:flex; gap:10px; flex-wrap:wrap; color:#cfe0ff; font-size:.95rem; }
  .chip{ background:#10253f; border:1px solid var(--border); border-radius:999px; padding:6px 10px; }

  /* Footer spacer so content doesn't hit bottom */
  .spacer{ height:16px; }
</style>
</head>
<body>

<!-- Top bar -->
<div class="topbar">
  <div class="brand">ARA Tree Log</div>
</div>

<div class="content">
  <div class="controls">
    <a class="btn-ghost" href="fieldtools.html">← Back to Field Tools</a>
    <button id="refreshBtn" class="btn-ghost">Refresh</button>
  </div>

  <div id="grid" class="grid"></div>
  <div id="empty" class="empty" style="display:none;">No entries yet. Save a tree from the Results page to see it here.</div>
</div>

<!-- Full-screen modal -->
<div id="detailModal" class="modal" aria-hidden="true">
  <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="detailTitle">
    <div class="sheet-header">
      <div class="row">
        <h2 id="detailTitle" class="sheet-title">Tree</h2>
        <button id="closeModal" class="btn-ghost">Close</button>
      </div>
    </div>

    <div class="sheet-body">
      <!-- Chips row -->
      <div class="chips" id="detailChips">
        <!-- filled dynamically -->
      </div>

      <!-- Key measurements -->
      <div class="box" id="detailKM" style="display:none;">
        <h4>Key measurements</h4>
        <div class="results" id="kmWrap">
          <p id="kmCirc">Circumference: —</p>
          <p id="kmHeight">Height: —</p>
          <p id="kmCanopy">Canopy spread: —</p>
        </div>
      </div>

      <!-- Description -->
      <div class="box">
        <h4>Tree description</h4>
        <div id="detailDesc" class="results">—</div>
        <div class="muted" style="margin-top:6px;">This is the same description you saw on the Results page.</div>
      </div>

      <!-- Actions -->
      <div class="box">
        <h4>Actions</h4>
        <div class="btn-row">
          <button id="copyBtn" class="btn-ghost" disabled>Copy description</button>
          <a id="emailBtn" class="btn btn-ghost" href="#" aria-disabled="true">Open email</a>
          <button id="removeBtn" class="btn-danger">Remove from log</button>
        </div>
      </div>

      <div class="spacer"></div>
    </div>
  </div>
</div>

<script>
/* ---------- Storage helpers ---------- */
const LOG_KEYS = ['ara_field_v1_logs','ara_field_v1_log']; // prefer plural; fall back to singular
function loadAllLogs(){
  for (const k of LOG_KEYS){
    try{
      const raw = localStorage.getItem(k);
      if (!raw) continue;
      const arr = JSON.parse(raw);
      if (Array.isArray(arr)) return { key:k, items:arr };
    }catch(e){}
  }
  return { key: LOG_KEYS[0], items: [] };
}
function saveAllLogs(key, items){
  try{ localStorage.setItem(key, JSON.stringify(items)); }catch(e){}
}

/* ---------- Accuracy bucket (same thresholds as app) ---------- */
function accBucket(m){
  if(!Number.isFinite(m)) return 'grey';
  if(m <= 5) return 'green';
  if(m < 20) return 'amber';
  return 'grey';
}

/* ---------- Plain text extractor for emails/copy ---------- */
function htmlToText(html){
  const div = document.createElement('div');
  div.innerHTML = html || '';
  // convert anchors to "text – URL"
  div.querySelectorAll('a').forEach(a=>{
    const url = a.getAttribute('href') || '';
    const txt = a.textContent || url;
    const span = document.createElement('span');
    span.textContent = txt + (url ? ' – ' + url : '');
    a.replaceWith(span);
  });
  const items = Array.from(div.querySelectorAll('li')).map(li => '- ' + li.textContent);
  const paras = Array.from(div.querySelectorAll('p')).map(p => p.textContent);
  return [...items, ...paras].join('\n').trim();
}

/* ---------- UI refs ---------- */
const grid = document.getElementById('grid');
const emptyEl = document.getElementById('empty');
const refreshBtn = document.getElementById('refreshBtn');

/* Modal refs */
const modal = document.getElementById('detailModal');
const closeModalBtn = document.getElementById('closeModal');
const detailTitle = document.getElementById('detailTitle');
const detailChips = document.getElementById('detailChips');
const detailDesc  = document.getElementById('detailDesc');
const detailKMBox = document.getElementById('detailKM');
const kmCirc = document.getElementById('kmCirc');
const kmHeight = document.getElementById('kmHeight');
const kmCanopy = document.getElementById('kmCanopy');
const copyBtn = document.getElementById('copyBtn');
const emailBtn = document.getElementById('emailBtn');
const removeBtn = document.getElementById('removeBtn');

/* ---------- Render gallery ---------- */
let STORE_KEY = LOG_KEYS[0];
let entries = [];

function render(){
  grid.innerHTML = '';
  // newest first
  const sorted = [...entries].sort((a,b)=> (b.ts||0) - (a.ts||0));
  if (sorted.length === 0){
    emptyEl.style.display = '';
    return;
  }
  emptyEl.style.display = 'none';

  sorted.forEach((e, idx)=>{
    const card = document.createElement('div');
    card.className = 'card';
    card.dataset.id = e.id || String(idx);

    // accuracy dot
    const acc = Number.isFinite(e.acc) ? e.acc : (Number.isFinite(e.locationAcc) ? e.locationAcc : NaN);
    const bucket = 'acc-' + accBucket(acc);

    const title = document.createElement('h3');
    title.innerHTML = `<span class="acc-dot ${bucket}"></span>${escapeHtml(e.name || 'Untitled tree')}`;

    const species = document.createElement('div');
    species.className = 'muted';
    species.textContent = e.species ? e.species : '—';

    const when = document.createElement('div');
    when.className = 'muted';
    const ts = e.ts || Date.now();
    when.textContent = new Date(ts).toLocaleString();

    card.appendChild(title);
    card.appendChild(species);
    card.appendChild(when);

    card.addEventListener('click', ()=>openDetail(e));
    grid.appendChild(card);
  });
}

function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

/* ---------- Detail view ---------- */
let currentId = null;

function openDetail(entry){
  currentId = entry.id;
  detailTitle.textContent = entry.name || 'Tree';

  // chips: species, timestamp, accuracy
  detailChips.innerHTML = '';
  const chip = (label, value) => {
    if (!value) return;
    const d = document.createElement('span');
    d.className = 'chip';
    d.textContent = `${label}: ${value}`;
    detailChips.appendChild(d);
  };
  chip('Species', entry.species || '—');
  chip('Recorded', new Date(entry.ts || Date.now()).toLocaleString());
  if (Number.isFinite(entry.acc)) chip('Accuracy', `±${entry.acc.toFixed(1)} m`);

  // key measurements (if present)
  const km = entry.km || entry.key || null;
  if (km && (km.circ || km.height || km.canopy)){
    detailKMBox.style.display = '';
    kmCirc.textContent   = 'Circumference: ' + (km.circ || '—');
    kmHeight.textContent = 'Height: ' + (km.height || '—');
    kmCanopy.textContent = 'Canopy spread: ' + (km.canopy || '—');
  } else {
    detailKMBox.style.display = 'none';
  }

  // description HTML
  const html = entry.descHtml || entry.desc || '';
  detailDesc.innerHTML = html && html.trim() ? html : '—';

  // actions state
  const hasDesc = !!(html && html.trim());
  copyBtn.disabled = !hasDesc;
  if (hasDesc){
    const subject = 'ARA Tree Log – ' + (entry.name || '');
    const body = htmlToText(html);
    emailBtn.href = 'mailto:?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body);
    emailBtn.removeAttribute('aria-disabled');
  } else {
    emailBtn.href = '#';
    emailBtn.setAttribute('aria-disabled','true');
  }

  modal.classList.add('show');
  modal.setAttribute('aria-hidden','false');
}

function closeDetail(){
  modal.classList.remove('show');
  modal.setAttribute('aria-hidden','true');
  currentId = null;
}

closeModalBtn.addEventListener('click', closeDetail);
modal.addEventListener('click', (e)=>{ if(e.target === modal) closeDetail(); });

copyBtn.addEventListener('click', ()=>{
  const html = detailDesc.innerHTML.trim();
  if(!html) return;
  const txt = htmlToText(html);
  (navigator.clipboard?.writeText ? navigator.clipboard.writeText(txt)
    : new Promise(res=>{ const t=document.createElement('textarea'); t.value=txt; document.body.appendChild(t); t.select(); document.execCommand('copy'); t.remove(); res(); })
  ).then(()=>{
    const old = copyBtn.textContent;
    copyBtn.textContent = 'Copied ✓';
    setTimeout(()=> copyBtn.textContent = old, 1000);
  });
});

removeBtn.addEventListener('click', ()=>{
  if (!currentId) return;
  if (!confirm('Remove this tree from the log? This cannot be undone.')) return;
  const idx = entries.findIndex(e => String(e.id) === String(currentId));
  if (idx >= 0){
    entries.splice(idx,1);
    saveAllLogs(STORE_KEY, entries);
  }
  closeDetail();
  render();
});

/* ---------- Boot ---------- */
function boot(){
  const loaded = loadAllLogs();
  STORE_KEY = loaded.key;
  // normalize: ensure each entry has an id
  entries = (loaded.items || []).map((e,i)=>{
    if (!e) return null;
    if (e.id === undefined || e.id === null) e.id = e.ts || (Date.now() + i);
    return e;
  }).filter(Boolean);
  render();
}

refreshBtn.addEventListener('click', boot);
document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeDetail(); });

boot();
</script>
</body>
</html>
