<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ARA Tree Log</title>
<style>
  :root{
    --bg:#0d1b2a;
    --bg-elev:#0f2236;
    --panel:#14253d;
    --panel-2:#172a47;
    --text:#e8eef6;
    --muted:#a9b7c7;
    --accent:#2ea3ff;
    --accent-2:#4db2ff;
    --ok:#1fa37a;
    --danger:#d93c3c;
    --border:#1f3553;
    --radius:14px;
    --gap:14px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg);
    color:var(--text);
  }

  /* Header bar */
  .topbar{
    position:sticky; top:0; z-index:50;
    background:linear-gradient(180deg,#0d1b2a,#0f2236);
    border-bottom:1px solid var(--border);
    padding:10px 14px;
    display:flex; align-items:center; justify-content:space-between;
    flex-wrap:wrap; gap:8px;
  }
  .brand{font-weight:800; font-size:1.05rem; color:#eaf3ff;}

  /* Header buttons */
  .btn,button,a.btn{
    padding:8px 14px;
    border-radius:10px;
    border:1px solid var(--border);
    background:var(--panel-2);
    color:var(--text);
    font-weight:700;
    text-decoration:none;
    cursor:pointer;
    transition:background .15s,color .15s,transform .1s;
  }
  .btn:hover{background:var(--accent-2); color:#001528;}
  .btn:active{transform:scale(.97);}
  .btn-danger{background:var(--danger); color:#fff;}
  .btn:disabled{opacity:.6; pointer-events:none;}

  /* Content */
  .content{padding:14px; max-width:1000px; margin:0 auto;}
  .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:var(--gap);}
  .card{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:14px;
    cursor:pointer;
    transition:transform .08s ease;
  }
  .card:active{transform:scale(.98);}
  .card h3{margin:0 0 6px; font-size:1.05rem; display:flex; align-items:center; gap:8px;}
  .muted{color:var(--muted); font-size:.9rem;}
  .acc-dot{width:10px; height:10px; border-radius:50%; border:1px solid rgba(0,0,0,.25);}
  .acc-grey{background:#46505e;}
  .acc-amber{background:#ffb300;}
  .acc-green{background:#1b5e2b;}
  .empty{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:18px;
    text-align:center;
    color:#cfe0ff;
  }

  /* Modal detail */
  .modal{position:fixed; inset:0; display:none; background:rgba(0,0,0,.6); backdrop-filter:blur(2px);}
  .modal.show{display:block;}
  .sheet{
    position:absolute; inset:0; max-width:1000px; margin:0 auto;
    background:var(--bg-elev); border-left:1px solid var(--border); border-right:1px solid var(--border);
    overflow:auto;
  }
  .sheet-header{
    position:sticky; top:0; background:linear-gradient(180deg,#0d1b2a,#0f2236);
    border-bottom:1px solid var(--border); padding:12px 14px;
    display:flex; justify-content:space-between; align-items:center;
  }
  .sheet-title{font-weight:900; margin:0;}
  .sheet-body{padding:14px; display:grid; gap:14px;}
  .box{background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:16px 18px;}
  .results{background:#0b1a2f; border:1px solid var(--border); border-radius:12px; padding:12px;}
  .btn-row{display:flex; flex-wrap:wrap; gap:10px;}
  .chip{background:#10253f; border:1px solid var(--border); border-radius:999px; padding:6px 10px; color:#cfe0ff;}
</style>
</head>
<body>

<!-- HEADER -->
<div class="topbar">
  <div class="brand">ARA Tree Log</div>
  <div class="btn-row">
    <a class="btn" href="index.html">Home</a>
    <a class="btn" href="fieldtools.html">Back to Field Tools</a>
    <button id="refreshBtn" class="btn">Refresh</button>
  </div>
</div>

<!-- CONTENT -->
<div class="content">
  <div id="grid" class="grid"></div>
  <div id="empty" class="empty" style="display:none;">No entries yet. Save a tree from the Results page to see it here.</div>
</div>

<!-- DETAIL MODAL -->
<div id="detailModal" class="modal">
  <div class="sheet">
    <div class="sheet-header">
      <h2 id="detailTitle" class="sheet-title">Tree</h2>
      <button id="closeModal" class="btn">Close</button>
    </div>
    <div class="sheet-body">
      <div id="detailChips" class="btn-row"></div>
      <div class="box">
        <h4>Description</h4>
        <div id="detailDesc" class="results">—</div>
      </div>
      <div class="box">
        <h4>Actions</h4>
        <div class="btn-row">
          <button id="copyBtn" class="btn">Copy description</button>
          <a id="emailBtn" class="btn" href="#" aria-disabled="true">Open email</a>
          <button id="removeBtn" class="btn-danger">Remove from log</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* -------- Load data -------- */
function loadLogs(){
  const keys=['ara_field_v1_log','ara_field_v1_logs'];
  for(const k of keys){
    try{
      const raw=localStorage.getItem(k);
      if(!raw) continue;
      const arr=JSON.parse(raw);
      if(Array.isArray(arr)) return {key:k,items:arr};
    }catch(e){}
  }
  return {key:'ara_field_v1_log',items:[]};
}

/* -------- Accuracy colors -------- */
function accClass(m){
  if(!Number.isFinite(m)) return 'acc-grey';
  if(m<=5) return 'acc-green';
  if(m<20) return 'acc-amber';
  return 'acc-grey';
}
function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}

/* -------- Render list -------- */
const grid=document.getElementById('grid');
const empty=document.getElementById('empty');
const modal=document.getElementById('detailModal');
const closeModal=document.getElementById('closeModal');
const detailTitle=document.getElementById('detailTitle');
const detailDesc=document.getElementById('detailDesc');
const detailChips=document.getElementById('detailChips');
const copyBtn=document.getElementById('copyBtn');
const emailBtn=document.getElementById('emailBtn');
const removeBtn=document.getElementById('removeBtn');

let logs=[],keyStore='ara_field_v1_log',current=null;

function render(){
  grid.innerHTML='';
  if(!logs.length){empty.style.display='';return;}
  empty.style.display='none';
  const sorted=[...logs].sort((a,b)=>(b.ts||0)-(a.ts||0));
  sorted.forEach((t,i)=>{
    const card=document.createElement('div');
    card.className='card';
    const acc=Number(t.acc)||Number(t.location?.acc)||NaN;
    card.innerHTML=`
      <h3><span class="acc-dot ${accClass(acc)}"></span>${escapeHtml(t.name||'Unnamed')}</h3>
      <div class="muted">${escapeHtml(t.species||'')}</div>
      <div class="muted">${new Date(t.ts||Date.now()).toLocaleString()}</div>`;
    card.onclick=()=>openDetail(t);
    grid.appendChild(card);
  });
}

/* -------- Detail modal -------- */
function openDetail(t){
  current=t;
  detailTitle.textContent=t.name||'Tree';
  detailChips.innerHTML='';
  if(t.species){const c=document.createElement('span');c.className='chip';c.textContent=t.species;detailChips.appendChild(c);}
  const ts=new Date(t.ts||Date.now()).toLocaleString();
  const c2=document.createElement('span');c2.className='chip';c2.textContent=ts;detailChips.appendChild(c2);
  const html=t.descHtml||t.desc||'—';
  detailDesc.innerHTML=html;
  const plain=detailDesc.textContent.trim();
  copyBtn.onclick=()=>navigator.clipboard.writeText(plain);
  emailBtn.href='mailto:?subject='+encodeURIComponent('ARA Tree Log – '+(t.name||''))+'&body='+encodeURIComponent(plain);
  removeBtn.onclick=()=>{if(confirm('Remove this entry?')){logs=logs.filter(x=>x!==t);localStorage.setItem(keyStore,JSON.stringify(logs));close();render();}};
  modal.classList.add('show');
}
function close(){modal.classList.remove('show');}
closeModal.onclick=close;
modal.onclick=e=>{if(e.target===modal)close();};

/* -------- Init -------- */
document.getElementById('refreshBtn').onclick=boot;
function boot(){
  const d=loadLogs();keyStore=d.key;logs=d.items||[];
  render();
}
boot();
</script>
</body>
</html>
