<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ARA Tree Log</title>
<style>
  :root{
    --bg:#0d1b2a; --bg-elev:#0f2236; --panel:#14253d; --panel-2:#172a47;
    --text:#e8eef6; --muted:#a9b7c7; --accent:#2ea3ff; --accent-2:#4db2ff;
    --ok:#1fa37a; --danger:#d93c3c; --border:#1f3553; --radius:14px; --gap:14px;
  }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); }

  /* Top bar */
  .topbar{
    position:sticky; top:0; z-index:50;
    background:linear-gradient(180deg, #0d1b2a, #0f2236);
    border-bottom:1px solid var(--border);
    padding:10px 14px;
  }
  .brand{ font-weight:800; letter-spacing:.2px; font-size:1.05rem; color:#eaf3ff; line-height:1.1; padding-left:2px; }
  .content{ padding:14px; max-width:1000px; margin:0 auto; }
  .card{ background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); margin-bottom:var(--gap); }
  .card .block{ padding:16px 18px; }
  h2{ margin:0 0 8px; font-size:1.2rem; }
  h3{ margin:0 0 8px; font-size:1.05rem; color:#d6e6ff; }
  label{ display:block; font-weight:700; margin:10px 0 6px; }
  input[type="text"], select{
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border);
    background:var(--panel-2); color:var(--text); font-size:1rem;
  }
  .btn{ padding:10px 14px; border:0; border-radius:10px; cursor:pointer; color:#001528; background:var(--accent-2); font-weight:700; text-decoration:none; display:inline-block; }
  .btn-ghost{ background:var(--panel-2); color:var(--text); border:1px solid var(--border); }
  .btn-danger{ background:var(--danger); color:#fff; }
  .btn:disabled, .btn[aria-disabled="true"]{ opacity:.6; pointer-events:none; }

  .row{ display:grid; grid-template-columns:1fr 1fr; gap:var(--gap); }
  @media (max-width:780px){ .row{ grid-template-columns:1fr } }

  /* Acc dots (reuse your classes/colors) */
  .acc-dot{ display:inline-block; width:10px; height:10px; margin-left:6px; border-radius:50%; border:1px solid rgba(0,0,0,.25); vertical-align:middle; }
  .acc-grey{ background:#46505e; color:#e2e8f0; }
  .acc-amber{ background:#ffb300; color:#2b1a00; }
  .acc-green{ background:#1b5e2b; color:#e6fff2; }
  .acc-red{ background:#7a2020; color:#ffdede; }

  /* Log layout */
  .log-header{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin:2px 0 10px; }
  .log-title{ font-weight:900; font-size:1.2rem; letter-spacing:.2px; }
  .log-actions{ display:flex; gap:8px; flex-wrap:wrap; }

  .log-grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: var(--gap); margin-top: 10px; }
  .log-card{ background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px; cursor: pointer; transition: transform .08s ease, border-color .2s ease, background .2s ease;}
  .log-card:hover{ transform: translateY(-1px); border-color:#2a4370; background:var(--panel-2); }
  .log-card .row1{ display:flex; align-items:center; gap:8px; margin-bottom:6px; }
  .log-card .name{ font-weight:800; font-size:1.02rem; line-height:1.2; }
  .log-card .meta{ color: var(--muted); font-size:.92rem; line-height:1.25; }
  .km{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  .km .chip{ background:#0f2236; border:1px solid var(--border); border-radius:999px; padding:3px 8px; font-size:.86rem; color:#d7e8ff; font-weight:700; }

  /* Detail */
  .hidden{ display:none !important; }
  .detail-wrap{ display:flex; flex-direction:column; gap:12px; }
  .detail-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .detail-title{ font-weight:900; font-size:1.35rem; }
  .detail-sub{ color:var(--muted); }
  .detail-actions{ display:flex; gap:8px; flex-wrap:wrap; }
  .detail-section{ background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); }
  .detail-section .block{ padding:16px 18px; }
  .results{ background:#0b1a2f; border:1px solid var(--border); border-radius:12px; padding:12px; }
  .kv{ display:grid; grid-template-columns: 180px 1fr; gap:8px; font-size:.98rem; }
  @media (max-width:600px){ .kv{ grid-template-columns:1fr; } }

  /* Connectivity card lookalike (optional) */
  .conn-card{ border: 2px solid var(--border); border-radius: var(--radius); background: var(--panel); }
  .conn-card .topline{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; }
  .conn-online{ border-color: var(--ok); }
  .conn-offline{ border-color: var(--danger); }
</style>
</head>
<body>
  <div class="topbar"><div class="brand">ARA Tree Log</div></div>
  <div class="content">

    <!-- LIST PAGE -->
    <section id="page-log">
      <div class="log-header">
        <div class="log-title">Ancient Roots Alberta — Tree Log</div>
        <div class="log-actions">
          <a href="index.html" class="btn-ghost">Back to tools</a>
          <button type="button" id="log-clear-all" class="btn-danger">Delete all</button>
        </div>
      </div>

      <div class="card">
        <div class="block">
          <div class="row" style="grid-template-columns:2fr 1fr;">
            <div>
              <label for="log-search">Search</label>
              <input id="log-search" type="text" placeholder="Search by name, species, notes…">
            </div>
            <div>
              <label for="log-sort">Sort</label>
              <select id="log-sort">
                <option value="newest">Newest first</option>
                <option value="oldest">Oldest first</option>
                <option value="alpha">A → Z</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div id="log-grid" class="log-grid"></div>

      <div id="conn-card-log" class="card conn-card" style="margin-top:12px;">
        <div class="block">
          <div class="topline">
            <h3 style="margin:0;">Connectivity</h3>
            <div class="tiny">Last checked: <span id="conn-checked-log">—</span></div>
          </div>
          <p id="conn-label-log" class="status tiny">—</p>
        </div>
      </div>
    </section>

    <!-- DETAIL PAGE -->
    <section id="page-log-detail" class="hidden">
      <div class="detail-wrap">
        <div class="detail-head">
          <div>
            <div id="detail-title" class="detail-title">Tree</div>
            <div id="detail-sub" class="detail-sub">—</div>
          </div>
          <div class="detail-actions">
            <button type="button" id="detail-back" class="btn-ghost">Back to log</button>
            <button type="button" id="detail-edit" class="btn">Open in editor</button>
            <button type="button" id="detail-copy" class="btn-ghost">Copy description</button>
            <a id="detail-email" class="btn btn-ghost" href="#" aria-disabled="true">Open email</a>
            <button type="button" id="detail-delete" class="btn-danger">Delete</button>
          </div>
        </div>

        <div class="detail-section">
          <div class="block">
            <h3 style="margin:0 0 8px;">Key measurements</h3>
            <div id="detail-kv" class="kv"></div>
          </div>
        </div>

        <div class="detail-section">
          <div class="block">
            <h3 style="margin:0 0 8px;">Description</h3>
            <div id="detail-desc" class="results">—</div>
          </div>
        </div>
      </div>
    </section>

  </div>

<script>
(function(){
  const GRID_ID = 'log-grid';
  const GRID = document.getElementById(GRID_ID);

  // 1) Load with key fallbacks (unchanged; keep your key list)
  function loadLog(){
    const keys = ['ara_tree_log_v1','ara_tree_log','ARA_TREE_LOG_V1'];
    for (const k of keys){
      try{
        const raw = localStorage.getItem(k);
        if(!raw) continue;
        const data = JSON.parse(raw);
        if(Array.isArray(data)) return data;
      }catch(e){ console.warn('Could not parse log for key', k, e); }
    }
    return [];
  }

  // REMOVE THESE TWO LINES IF PRESENT:
  // console.log('Loaded log data:', loadLog());
  // alert('Loaded items: ' + loadLog().length);

  // 2) Safe getters that understand both old and new schemas
  function getTitle(item){
    // new: item.title or item.basics.name
    const t = item.title ?? item?.basics?.name ?? item.name ?? item.treeName;
    return (t || 'Untitled').trim() || 'Untitled';
  }
  function getSpecies(item){
    // new: item.basics.species
    const s = item?.basics?.species ?? item.species ?? item.sp;
    return (s || '').trim();
  }
  function getWhen(item){
    // new: item.createdAt
    const t = Number.isFinite(item.createdAt) ? item.createdAt
            : Number.isFinite(item.ts)        ? item.ts
            : Number.isFinite(item.timestamp) ? item.timestamp
            : Number.isFinite(item?.meta?.ts) ? item.meta.ts
            : null;
    if (Number.isFinite(t)) return new Date(t).toLocaleString();
    const iso = item.when || item.date || '';
    return iso ? new Date(iso).toLocaleString() : '—';
  }
  function getAcc(item){
    // new: item.accuracy.meters
    const acc = Number(item?.accuracy?.meters);
    if (Number.isFinite(acc)) return acc;
    const legacy = Number(item?.location?.acc ?? item?.location?.accuracy ?? item.acc);
    return Number.isFinite(legacy) ? legacy : null;
  }
  function accClass(acc){
    if (!Number.isFinite(acc)) return 'acc-grey';
    if (acc <= 5)  return 'acc-green';
    if (acc < 20)  return 'acc-amber';
    return 'acc-grey';
  }

  // 3) Render cards (kept, but sort uses getWhen’s numeric source)
  function render(){
    if (!GRID){ console.warn(`#${GRID_ID} not found on log.html`); return; }

    const items = loadLog()
      .filter(Boolean)
      .map((it) => ({it, sortTs:
        Number.isFinite(it.createdAt) ? it.createdAt :
        Number.isFinite(it.ts)        ? it.ts :
        Number.isFinite(it.timestamp) ? it.timestamp :
        Number.isFinite(it?.meta?.ts) ? it.meta.ts : 0
      }))
      .sort((a,b) => b.sortTs - a.sortTs)
      .map(x => x.it);

    GRID.innerHTML = '';

    if (!items.length){
      GRID.innerHTML = `
        <div class="card" style="padding:14px; border:1px dashed var(--border); border-radius:12px;">
          <div class="tiny">No trees saved yet.</div>
          <div class="tiny" style="margin-top:6px;">Use <strong>Save to log</strong> on the Results page, then come back here.</div>
        </div>`;
      return;
    }

    const frag = document.createDocumentFragment();

    items.forEach((item, idx) => {
      const title   = getTitle(item);
      const species = getSpecies(item);
      const when    = getWhen(item);
      const acc     = getAcc(item);

      const card = document.createElement('button');
      card.type = 'button';
      card.className = 'card';
      card.style.cursor = 'pointer';
      card.style.textAlign = 'left';
      card.innerHTML = `
        <div class="block" style="padding:14px 16px;">
          <div style="display:flex; align-items:center; gap:8px;">
            <div class="brand" style="font-size:1rem; font-weight:800; letter-spacing:.2px;">
              ${escapeHtml(title)}
            </div>
            <span class="acc-dot ${accClass(acc)}" title="${Number.isFinite(acc) ? '±'+acc.toFixed(1)+' m' : 'No accuracy saved'}"></span>
          </div>
          <div class="tiny" style="margin-top:6px;">
            ${species ? escapeHtml(species) : '<span style="opacity:.6">Species —</span>'}
          </div>
          <div class="tiny" style="margin-top:2px; color: var(--muted);">
            ${when}
          </div>
        </div>
      `;
      card.addEventListener('click', () => {
        const q = new URLSearchParams();
        q.set('idx', String(idx));
        location.href = 'log.html?' + q.toString();
      });
      frag.appendChild(card);
    });

    GRID.appendChild(frag);
  }

  function escapeHtml(s){
    return String(s || '')
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  // kick off the render
  render();
})();
</script>

</body>
</html>
