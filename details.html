<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ARA – Tree</title>
<style>
  :root{
    /* Same palette as Field Tools */
    --bg:#0d1b2a;
    --bg-elev:#0f2236;
    --panel:#14253d;
    --panel-2:#172a47;
    --text:#e8eef6;
    --muted:#a9b7c7;
    --accent:#2ea3ff;
    --accent-2:#4db2ff;
    --ok:#1fa37a;
    --danger:#d93c3c;
    --border:#1f3553;
    --radius:14px;
    --gap:14px;
  }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg); color:var(--text);
  }

  /* Sticky header */
 /* Header layout */
.topbar{
  position: sticky; top: 0; z-index: 50;
  background: linear-gradient(180deg, #0d1b2a, #0f2236);
  border-bottom: 1px solid var(--border);
}
.topbar .wrap{ max-width:1000px; margin:0 auto; padding:12px 14px; }
.page-title{
  margin:0 0 8px; font-size:1.15rem; font-weight:800; color:#eaf3ff;
  letter-spacing:.2px;
}

/* Small action row under the title */
.subheader-actions{
  display:flex; gap:8px; flex-wrap:wrap;
}
.btn{ display:inline-flex; align-items:center; justify-content:center;
  font-weight:700; border-radius:10px; border:0; cursor:pointer;
  background:var(--accent-2); color:#001528; padding:10px 14px;
  text-decoration:none; user-select:none;
}
.btn-ghost{ background:var(--panel-2); color:var(--text); border:1px solid var(--border); }
.btn-sm{ padding:6px 10px; font-size:.92rem; }

/* Danger button (matches Reset style from Field Tools) */
.btn-danger{
  background:#e53935; color:#fff; border:3px solid #6b0e0e;
}
.btn-danger:hover{ background:#d32f2f; border-color:#8e0000; transform:translateY(-1px); }
.btn-danger:active{ background:#8e0000; border-color:#5c0000; transform:scale(.98); }

/* Make action rows in the page look tidy */
.actions-row{ display:flex; flex-wrap:wrap; gap:10px; }


  /* Page content */
  .content{ padding:14px; max-width:1000px; margin:0 auto; }

  /* Panel cards */
  .card{
    background:var(--panel); border:1px solid var(--border);
    border-radius:var(--radius); margin-bottom:var(--gap);
  }
  .card .block{ padding:16px 18px; }
  h2{ margin:0 0 8px; font-size:1.2rem; }
  h3{ margin:0 0 8px; font-size:1.05rem; color:#d6e6ff; }

  /* Measurement grid */
  .grid{
    display:grid; grid-template-columns:1fr 1fr; gap:12px;
  }
  @media (max-width:780px){ .grid{ grid-template-columns:1fr } }

  .row{
    padding:10px 12px; border:1px solid var(--border); border-radius:10px;
    background:var(--panel-2);
  }
  .label{ color:var(--muted); font-size:.92rem; margin-bottom:4px }
  .value{ font-weight:800; letter-spacing:.2px }

  .muted{ color:var(--muted) }
  .tiny{ font-size:.86rem; color:var(--muted) }

  /* Section header style for “Description” look */
  .section-title{
    font-size:1.15rem; font-weight:900; text-decoration:underline;
    text-underline-offset:3px; margin-bottom:8px; color:#eaf3ff;
  }

  /* Footer action bar (optional later) */
  .footer-actions{
    display:flex; gap:10px; flex-wrap:wrap;
  }

  /* ---- Accuracy text colors ---- */
.acc-text-green { color:#1b5e2b; }
.acc-text-amber { color:#ffb300; }
.acc-text-grey  { color:#a9b7c7; }

</style>
</head>
<body>

<!-- Header -->
<header class="topbar">
  <div class="wrap">
    <h1 class="page-title">
      ARA — <span id="treeNameHdr">Tree name</span>
    </h1>

    <div class="subheader-actions">
      <a id="btnBackToLog"  href="log.html"   class="btn btn-ghost btn-sm">← Return to Log</a>
      <a id="btnBackHome"   href="index.html" class="btn btn-ghost btn-sm">Return Home</a>
    </div>
  </div>
</header>


<!-- Content -->
<div class="content">

  <!-- GENERAL -->
  <section class="card">
    <div class="block">
      <div class="section-title">General</div>
      <div class="grid">
        <div class="row">
          <div class="label">Tree name</div>
          <div class="value" id="gen-name">—</div>
        </div>
        <div class="row">
          <div class="label">Species</div>
          <div class="value" id="gen-species">—</div>
        </div>
        <div class="row">
          <div class="label">Condition</div>
          <div class="value" id="gen-condition">—</div>
        </div>
        <div class="row">
          <div class="label">Type</div>
          <div class="value" id="gen-type">—</div>
        </div>
      </div>
    </div>
  </section>

  <!-- LOCATION -->
  <section class="card">
    <div class="block">
      <div class="section-title">Location</div>
      <div class="grid">
        <div class="row">
          <div class="label">DD (lat, lng)</div>
          <div class="value" id="loc-dd">—, —</div>
        </div>
        <div class="row">
          <div class="label">DMS</div>
          <div class="value" id="loc-dms">—</div>
        </div>
        <div class="row">
          <div class="label">Altitude</div>
          <div class="value" id="loc-alt">—</div>
        </div>
        <div class="row">
          <div class="label">Accuracy</div>
          <div class="value" id="loc-acc">±— m</div>
        </div>
        <div class="row">
          <div class="label">Recorded</div>
          <div class="value" id="loc-time">—</div>
        </div>
        <div class="row">
          <div class="label">Google Maps</div>
          <div class="value" id="loc-maps">—</div>
        </div>
      </div>
      <div class="tiny" style="margin-top:8px;">Map will appear below in a later pass.</div>
    </div>
  </section>

  <!-- CIRCUMFERENCE -->
  <section class="card">
    <div class="block">
      <div class="section-title">Circumference</div>
      <div class="grid">
        <div class="row">
          <div class="label">Entered/Equivalent circumference</div>
          <div class="value" id="c-circ">—</div>
        </div>
        <div class="row">
          <div class="label">Diameter (from circumference)</div>
          <div class="value" id="c-diam">—</div>
        </div>
        <div class="row">
          <div class="label">Average circumference (multi)</div>
          <div class="value" id="c-avg">—</div>
        </div>
        <div class="row">
          <div class="label">Largest trunk note</div>
          <div class="value" id="c-largest">—</div>
        </div>
      </div>
    </div>
  </section>

  <!-- HEIGHT -->
  <section class="card">
    <div class="block">
      <div class="section-title">Height</div>
      <div class="grid">
        <div class="row">
          <div class="label">Tree height</div>
          <div class="value" id="h-final">—</div>
        </div>
        <div class="row">
          <div class="label">Angle (°)</div>
          <div class="value" id="h-angle">—</div>
        </div>
        <div class="row">
          <div class="label">Distance to trunk</div>
          <div class="value" id="h-dist">—</div>
        </div>
        <div class="row">
          <div class="label">Eye height</div>
          <div class="value" id="h-eye">—</div>
        </div>
      </div>
    </div>
  </section>

  <!-- CANOPY -->
  <section class="card">
    <div class="block">
      <div class="section-title">Canopy spread</div>
      <div class="grid">
        <div class="row">
          <div class="label">Major axis</div>
          <div class="value" id="s-major">—</div>
        </div>
        <div class="row">
          <div class="label">Minor axis</div>
          <div class="value" id="s-minor">—</div>
        </div>
        <div class="row">
          <div class="label">Final canopy spread</div>
          <div class="value" id="s-final">—</div>
        </div>
      </div>
    </div>
  </section>

  <!-- NOTES -->
  <section class="card">
    <div class="block">
      <div class="section-title">Notes</div>
      <div class="row" style="padding:14px;">
        <div class="value" id="notes">—</div>
      </div>
    </div>
  </section>

  <!-- ACTIONS (future: copy/email/remove) -->
  <section class="card">
    <div class="block">
      <h3>Actions</h3>
      <div class="footer-actions" style="margin-top:8px;">
        <button class="btn btn-ghost" disabled>Copy description</button>
        <button class="btn btn-ghost" disabled>Open email</button>
        <button id="removeFromLog" class="btn btn-danger">Remove from log</button>
      </div>
      <div class="tiny" style="margin-top:6px;">(Buttons disabled for now – aesthetics first.)</div>
    </div>
  </section>

</div>

<script>
  // --- Header: set tree name from ?name= ---
  (function(){
    const params = new URLSearchParams(location.search);
    const name = (params.get('name') || '').trim();
    const hdr = document.getElementById('treeNameHdr');
    if (hdr && name) hdr.textContent = name;
  })();

  // --- Return to Log: prefer history back if you arrived from log.html ---
  (function(){
    const btnBackToLog = document.getElementById('btnBackToLog');
    if (!btnBackToLog) return;
    btnBackToLog.addEventListener('click', function(e){
      if (document.referrer && /log\.html(\?|#|$)/.test(document.referrer)){
        e.preventDefault();
        history.back();
      }
    });
  })();

  // --- Remove from log (with confirm) ---
  (function(){
    const removeBtn = document.getElementById('removeFromLog');
    if (!removeBtn) return;

    removeBtn.addEventListener('click', function(){
      const ok = confirm('Are you sure you want to remove this tree from the log? This cannot be undone.');
      if (!ok) return;

      try{
        const params = new URLSearchParams(location.search);
        const id = params.get('id');
        const KEY = 'ara_field_v1_log';  // must match log.html & field tools save code
        if (!id) throw new Error('No id in URL');

        const list = JSON.parse(localStorage.getItem(KEY) || '[]');
        const next = list.filter(entry => String(entry.id) !== String(id));
        localStorage.setItem(KEY, JSON.stringify(next));

        // back to log after deletion
        location.href = 'log.html';
      }catch(err){
        alert('Could not remove this entry. ' + (err && err.message ? err.message : err));
      }
    });
  })();
</script>
<script>
/* ---------- Utilities ---------- */
const FT_PER_M = 3.28084;
const mToFt = m => m * FT_PER_M;
const fmt2 = x => Number.isFinite(x) ? x.toFixed(2) : '—';
const fmt1 = x => Number.isFinite(x) ? x.toFixed(1) : '—';
const toDMS = (dec, isLat) => {
  if (!Number.isFinite(dec)) return '—';
  const hemi = dec >= 0 ? (isLat ? 'N' : 'E') : (isLat ? 'S' : 'W');
  let v = Math.abs(dec);
  const d = Math.floor(v); v = (v - d) * 60;
  const m = Math.floor(v); const s = (v - m) * 60;
  return `${d}° ${m}' ${s.toFixed(2)}" ${hemi}`;
};

// Get URL parameters and the log key
const params = new URLSearchParams(location.search);
const LOG_KEY = params.get('k') || 'ara_field_v1_log';

// Reference all the display elements once
const elements = {
  // Header
  treeNameHdr: document.getElementById('treeNameHdr'),

  // General
  genName: document.getElementById('gen-name'),
  genSpecies: document.getElementById('gen-species'),
  genCondition: document.getElementById('gen-condition'),
  genType: document.getElementById('gen-type'),

  // Location
  locDD: document.getElementById('loc-dd'),
  locDMS: document.getElementById('loc-dms'),
  locAlt: document.getElementById('loc-alt'),
  locAcc: document.getElementById('loc-acc'),
  locTime: document.getElementById('loc-time'),
  locMaps: document.getElementById('loc-maps'),

  // Circumference
  circCirc: document.getElementById('c-circ'),
  circDiam: document.getElementById('c-diam'),
  circAvg: document.getElementById('c-avg'),
  circLargest: document.getElementById('c-largest'),

  // Height
  hFinal: document.getElementById('h-final'),
  hAngle: document.getElementById('h-angle'),
  hDist: document.getElementById('h-dist'),
  hEye: document.getElementById('h-eye'),

  // Canopy
  sMajor: document.getElementById('s-major'),
  sMinor: document.getElementById('s-minor'),
  sFinal: document.getElementById('s-final'),

  // Notes
  notes: document.getElementById('notes'),

  // Actions
  emailBtn: document.querySelector('.footer-actions button:nth-child(2)'), 
  copyBtn: document.querySelector('.footer-actions button:nth-child(1)'),
  removeBtn: document.getElementById('removeFromLog'),
};


/* ---------- Load the record ---------- */
function loadSelectedEntry() {
  let all = [];
  try {
    all = JSON.parse(localStorage.getItem(LOG_KEY) || '[]');
    if (!Array.isArray(all)) all = [];
  } catch {}

  const id = params.get('id');
  const idxParam = params.get('idx');

  if (id != null) {
    // NOTE: We assume the 'id' is a string or number that matches entry.id
    const found = all.find(e => String(e.id) === String(id));
    return { entry: found || null, all };
  }

  if (idxParam != null) {
    // NOTE: This fallback relies on the index of the log entry array, which may not be stable
    const i = parseInt(idxParam, 10);
    const found = Number.isInteger(i) ? all[i] : null;
    return { entry: found || null, all, idx: i };
  }

  return { entry: null, all };
}

/* ---------- Accuracy color ---------- */
function paintAccText(el, meters) {
  if (!el) return;
  el.classList.remove('acc-text-green', 'acc-text-amber', 'acc-text-grey');
  if (!Number.isFinite(meters)) {
    el.classList.add('acc-text-grey');
    el.textContent = '±— m';
    return;
  }
  if (meters <= 5)       el.classList.add('acc-text-green');
  else if (meters < 20)  el.classList.add('acc-text-amber');
  else                   el.classList.add('acc-text-grey');

  el.textContent = `±${fmt1(meters)} m`;
}

/* ---------- Populate UI (The main fix) ---------- */
function fillDetails(entry) {
  const treeName = entry?.basics?.name || '—';

  // 1. Header
  if (elements.treeNameHdr) elements.treeNameHdr.textContent = treeName;

  // 2. General
  if (elements.genName) elements.genName.textContent      = entry?.basics?.name || '—';
  if (elements.genSpecies) elements.genSpecies.textContent   = entry?.basics?.species || '—';
  if (elements.genCondition) elements.genCondition.textContent = entry?.basics?.condition || '—';
  const type = entry?.basics?.type || '—';
  if (elements.genType) elements.genType.textContent = type;

  // 3. Location
  const lat = parseFloat(entry?.location?.lat);
  const lng = parseFloat(entry?.location?.lng);
  const acc = parseFloat(entry?.location?.acc);
  const alt = parseFloat(entry?.location?.alt);
  const ts  = entry?.location?.ts ? new Date(parseInt(entry.location.ts, 10)).toLocaleString() : '—'; // Fixed parseInt radix

  if (elements.locDD) elements.locDD.textContent  =
    (Number.isFinite(lat) && Number.isFinite(lng)) ? `${lat.toFixed(6)}, ${lng.toFixed(6)}` : '—';
  if (elements.locDMS) elements.locDMS.textContent =
    (Number.isFinite(lat) && Number.isFinite(lng)) ? `${toDMS(lat, true)} | ${toDMS(lng, false)}` : '—';
  if (elements.locAlt) elements.locAlt.textContent = Number.isFinite(alt) ? `${fmt1(alt)} m` : '—';
  
  paintAccText(elements.locAcc, acc);
  
  if (elements.locTime) elements.locTime.textContent  = ts;
  if (elements.locMaps) {
    if (Number.isFinite(lat) && Number.isFinite(lng)) {
      // NOTE: Using the correct Google Maps URL format
      elements.locMaps.innerHTML = `<a href="https://maps.google.com/?q=${lat},${lng}" target="_blank">View in Maps</a>`;
    } else {
      elements.locMaps.textContent = '—';
    }
  }

  // 4. Circumference (Single/Multi-trunk)
  const st = entry?.results?.lastSingle;
  const mt = entry?.results?.lastMulti;
  
  if (mt) { // Multi-trunk logic (uses equivalent/average fields)
    if (elements.circCirc) elements.circCirc.textContent = mt.cEqM ? `${fmt2(mt.cEqM)} m (${fmt2(mt.cEqFt)} ft)` : '—';
    if (elements.circDiam) elements.circDiam.textContent = mt.dEqM ? `${fmt2(mt.dEqM)} m (${fmt2(mt.dEqFt)} ft)` : '—';
    if (elements.circAvg) elements.circAvg.textContent = mt.cAvgM ? `${fmt2(mt.cAvgM)} m (${fmt2(mt.cAvgFt)} ft)` : 'N/A';
    if (elements.circLargest) elements.circLargest.textContent = mt.largestNote || '—';
  } else if (st) { // Single-trunk logic (uses single-trunk fields)
    if (elements.circCirc) elements.circCirc.textContent = st.cM ? `${fmt2(st.cM)} m (${fmt2(st.cFt)} ft)` : '—';
    if (elements.circDiam) elements.circDiam.textContent = st.dM ? `${fmt2(st.dM)} m (${fmt2(st.dFt)} ft)` : '—';
    if (elements.circAvg) elements.circAvg.textContent = 'N/A';
    if (elements.circLargest) elements.circLargest.textContent = '—';
  } else {
    // No data available
    if (elements.circCirc) elements.circCirc.textContent = '—';
    if (elements.circDiam) elements.circDiam.textContent = '—';
    if (elements.circAvg) elements.circAvg.textContent = '—';
    if (elements.circLargest) elements.circLargest.textContent = '—';
  }

  // 5. Height
  const ht = entry?.results?.lastHeight;
  if (ht) {
    if (elements.hFinal) elements.hFinal.textContent   = ht.hM ? `${fmt2(ht.hM)} m (${fmt2(ht.hFt)} ft)` : '—';
    if (elements.hAngle) elements.hAngle.textContent = ht.angleDeg ? `${fmt1(ht.angleDeg)}°` : '—';
    if (elements.hDist) elements.hDist.textContent  = ht.dM ? `${fmt2(ht.dM)} m` : '—';
    if (elements.hEye) elements.hEye.textContent   = ht.eM ? `${fmt2(ht.eM)} m` : '—';
  } else {
    if (elements.hFinal) elements.hFinal.textContent   = '—';
    if (elements.hAngle) elements.hAngle.textContent = '—';
    if (elements.hDist) elements.hDist.textContent  = '—';
    if (elements.hEye) elements.hEye.textContent   = '—';
  }

  // 6. Canopy
  const sp = entry?.results?.lastSpread;
  if (sp) {
    if (elements.sMajor) elements.sMajor.textContent = Number.isFinite(sp.majorM) ? `${fmt2(sp.majorM)} m (${fmt2(mToFt(sp.majorM))} ft)` : '—';
    if (elements.sMinor) elements.sMinor.textContent = Number.isFinite(sp.minorM) ? `${fmt2(sp.minorM)} m (${fmt2(mToFt(sp.minorM))} ft)` : '—';
    if (elements.sFinal) elements.sFinal.textContent = sp.meanM ? `${fmt2(sp.meanM)} m (${fmt2(sp.meanFt)} ft)` : '—';
  } else {
    if (elements.sMajor) elements.sMajor.textContent = '—';
    if (elements.sMinor) elements.sMinor.textContent = '—';
    if (elements.sFinal) elements.sFinal.textContent = '—';
  }

  // 7. Notes
  const notes = (entry?.notes || '').trim();
  if (elements.notes) {
    elements.notes.innerHTML = notes
      ? '<ul>' + notes.split(/\n+/).map(line => `<li>${escapeHtml(line)}</li>`).join('') + '</ul>'
      : '—';
  }
  
  // 8. Actions (Enable buttons and attach handlers)
  // These were missing from the previous attempt.
  if (elements.emailBtn) {
    elements.emailBtn.disabled = false;
    elements.emailBtn.addEventListener('click', () => {
      const subject = `ARA Field Nomination – ${treeName || 'Tree'}`;
      const body = (entry?.descText || 'No description available.').trim();
      const url = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      location.href = url;
    });
  }
  if (elements.copyBtn) {
    elements.copyBtn.disabled = false;
    elements.copyBtn.addEventListener('click', () => {
      const text = (entry?.descText || 'No description available.').trim();
      navigator.clipboard?.writeText(text).then(()=> {
        const prev = elements.copyBtn.textContent;
        elements.copyBtn.textContent = 'Copied ✓';
        setTimeout(()=> elements.copyBtn.textContent = prev, 900);
      });
    });
  }
}

// basic HTML escape for notes
function escapeHtml(s){
  return String(s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
}

/* ---------- Boot ---------- */
(function init(){
  const { entry } = loadSelectedEntry();
  if (!entry) {
    if (elements.treeNameHdr) elements.treeNameHdr.textContent = 'Entry Not Found';
    // alert('This entry was not found. It may have been removed or the link is invalid.');
    return;
  }
  fillDetails(entry);
})();
</script>

</body>
</html>
