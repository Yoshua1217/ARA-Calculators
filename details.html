<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ARA – Tree</title>
<style>
  :root{
    --bg:#0d1b2a; --bg-elev:#0f2236;
    --panel:#14253d; --panel-2:#172a47;
    --text:#e8eef6; --muted:#a9b7c7;
    --accent:#2ea3ff; --accent-2:#4db2ff;
    --ok:#1fa37a; --danger:#d93c3c;
    --border:#1f3553; --radius:14px; --gap:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg); color:var(--text);
  }

  /* Header */
  .topbar{
    position:sticky; top:0; z-index:50;
    background:linear-gradient(180deg,#0d1b2a,#0f2236);
    border-bottom:1px solid var(--border);
    padding:12px 14px;
  }
  .head-title{
    font-weight:800; letter-spacing:.2px; font-size:1.06rem; color:#eaf3ff; line-height:1.1;
  }
  .head-sub{ color:var(--muted); margin-top:4px; font-size:.92rem; }
  .head-actions{
    display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;
  }
  .btn{ padding:10px 14px; border-radius:10px; border:1px solid var(--border);
        background:var(--panel-2); color:var(--text); font-weight:700; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; }
  .btn:hover{ background:var(--accent-2); color:#001528; }
  .btn.small{ padding:8px 12px; font-weight:700; }
  .btn-danger{ background:var(--danger); color:#fff; border-color:#7b1d1d; }
  .btn-danger:hover{ filter:brightness(1.05); }
  .btn-danger:active{ background:#8e0000; }

  /* Content */
  .content{ padding:14px; max-width:1000px; margin:0 auto; }
  .card{ background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); margin-bottom:var(--gap); }
  .block{ padding:16px 18px; }
  h2{ margin:0 0 8px; font-size:1.2rem; }
  h3{ margin:0 0 8px; font-size:1.05rem; color:#d6e6ff; }

  .kv{ display:grid; grid-template-columns:170px 1fr; gap:10px 14px; }
  .kv dt{ color:#cfe0ff; font-weight:700; }
  .kv dd{ margin:0; color:var(--text); }
  .muted{ color:var(--muted) }
  .tiny{ color:var(--muted); font-size:.88rem; }

  /* Accuracy text buckets */
  .acc-grey{ color:#c1c9d6; }
  .acc-amber{ color:#ffb300; }
  .acc-green{ color:#4cd28b; }

  /* Trunk list */
  .list{ margin:4px 0 0 0; padding-left:18px; }
  .list li{ margin:4px 0; }

  /* Hide blocks when not applicable */
  .hide{ display:none; }
</style>
</head>
<body>

<!-- Header -->
<header class="topbar">
  <div class="head-title" id="hdr-title">ARA – <span id="hdr-name">Tree</span></div>
  <div class="head-sub" id="hdr-sub">Tree details</div>

  <div class="head-actions">
    <a href="index.html" class="btn small" id="btn-home">Return Home</a>
    <a href="log.html" class="btn small" id="btn-log">Return to Log</a>
    <button type="button" class="btn small btn-danger" id="btn-remove">Remove from log</button>
  </div>
</header>

<main class="content">

  <!-- GENERAL -->
  <section class="card">
    <div class="block">
      <h2>General</h2>
      <dl class="kv">
        <dt>Tree</dt><dd id="gen-name">—</dd>
        <dt>Species</dt><dd id="gen-species">—</dd>
        <dt>Condition</dt><dd id="gen-condition">—</dd>
        <dt>Type</dt><dd id="gen-type">—</dd>
        <dt>Recorded</dt><dd id="gen-recorded">—</dd>
      </dl>
    </div>
  </section>

  <!-- LOCATION -->
  <section class="card">
    <div class="block">
      <h2>Location</h2>
      <dl class="kv">
        <dt>DD</dt><dd id="loc-dd">—</dd>
        <dt>DMS</dt><dd id="loc-dms">—</dd>
        <dt>Altitude</dt><dd id="loc-alt">—</dd>
        <dt>Accuracy</dt><dd id="loc-acc" class="acc-grey">—</dd>
        <dt>Recorded</dt><dd id="loc-ts">—</dd>
        <dt>Google Maps</dt><dd><a id="loc-link" href="#" target="_blank" rel="noopener">—</a></dd>
      </dl>
    </div>
  </section>

  <!-- CIRCUMFERENCE -->
  <section class="card" id="sec-circ">
    <div class="block">
      <h2>Circumference</h2>

      <!-- Single trunk block -->
      <div id="circ-single" class="">
        <dl class="kv">
          <dt>Circumference</dt><dd id="c-single-c">—</dd>
          <dt>Diameter</dt><dd id="c-single-d">—</dd>
        </dl>
      </div>

      <!-- Multi trunk block -->
      <div id="circ-multi" class="hide">
        <h3>Individual trunks</h3>
        <ul class="list" id="c-trunks"></ul>

        <h3 style="margin-top:12px;">Full Tree</h3>
        <dl class="kv">
          <dt>Equivalent circ.</dt><dd id="c-eq-c">—</dd>
          <dt>Equivalent diam.</dt><dd id="c-eq-d">—</dd>
          <dt>Average circ.</dt><dd id="c-avg-c">—</dd>
          <dt>Average diam.</dt><dd id="c-avg-d">—</dd>
        </dl>
      </div>
    </div>
  </section>

  <!-- HEIGHT -->
  <section class="card">
    <div class="block">
      <h2>Height</h2>
      <dl class="kv">
        <dt>Tree height</dt><dd id="h-final">—</dd>
        <dt>Formula</dt><dd id="h-formula" class="tiny">—</dd>
      </dl>
    </div>
  </section>

  <!-- CANOPY -->
  <section class="card">
    <div class="block">
      <h2>Canopy</h2>
      <dl class="kv">
        <dt>Major axis</dt><dd id="s-major">—</dd>
        <dt>Minor axis</dt><dd id="s-minor">—</dd>
        <dt>Final spread</dt><dd id="s-final">—</dd>
      </dl>
    </div>
  </section>

  <!-- NOTES -->
  <section class="card">
    <div class="block">
      <h2>Notes</h2>
      <div id="notes-box" class="tiny">—</div>
    </div>
  </section>

</main>

<script>
/* ---------- helpers ---------- */
const fmt2 = x => (Number.isFinite(x) ? x.toFixed(2) : '—');
const fmt1 = x => (Number.isFinite(x) ? x.toFixed(1) : '—');
const FT_PER_M = 3.28084;
const mToFt = m => m * FT_PER_M;
function toDMS(dec, isLat){
  if (!Number.isFinite(dec)) return '—';
  const hemi = dec >= 0 ? (isLat ? 'N' : 'E') : (isLat ? 'S' : 'W');
  const v = Math.abs(dec);
  const d = Math.floor(v);
  const m = Math.floor((v - d) * 60);
  const s = ((v - d) * 60 - m) * 60;
  return `${d}° ${m}' ${s.toFixed(2)}" ${hemi}`;
}
function accBucket(m){
  if (!Number.isFinite(m)) return 'grey';
  if (m <= 5) return 'green';
  if (m < 20) return 'amber';
  return 'grey';
}
function setAccClass(el, meters){
  const bucket = accBucket(meters);
  el.classList.remove('acc-grey','acc-amber','acc-green');
  el.classList.add('acc-' + bucket);
}

/* ---------- storage readers (robust to key/case drift) ---------- */
function readJSON(key){
  try{
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : null;
  }catch(e){ return null; }
}

// Try all known variants
function loadLogArray(){
  return (
    readJSON('ara_field_v1_log') ||
    readJSON('ARA_FIELD_LOG_V1') ||
    [] // default
  );
}

function loadById(id){
  const arr = loadLogArray();
  if (!id) return null;
  return arr.find(x => String(x?.id) === String(id)) || null;
}

/* ---------- fill UI ---------- */
function setText(id, val){ const el = document.getElementById(id); if (el) el.textContent = (val ?? '—'); }
function setHTML(id, html){ const el = document.getElementById(id); if (el) el.innerHTML = (html ?? '—'); }

function fillGeneral(entry){
  const name = entry.name || 'Tree';
  document.getElementById('hdr-name').textContent = name;
  setText('gen-name', name);
  setText('gen-species', entry.species || '—');
  setText('gen-condition', entry.condition || '—');
  setText('gen-type', entry.treeType || '—');

  // Recorded (prefer location.ts, else entry.recorded, else now)
  let ts = entry?.location?.ts || entry?.recorded;
  let when = '—';
  if (Number.isFinite(+ts)) when = new Date(+ts).toLocaleString();
  setText('gen-recorded', when);
}

function fillLocation(entry){
  const loc = entry.location || {};
  const lat = Number(loc.lat), lng = Number(loc.lng);
  const acc = Number(loc.acc);
  const alt = (loc.alt==='' || loc.alt==null) ? NaN : Number(loc.alt);
  const ts  = Number(loc.ts);

  // DD
  if (Number.isFinite(lat) && Number.isFinite(lng)) {
    setText('loc-dd', `${lat.toFixed(6)}, ${lng.toFixed(6)}`);
    setText('loc-dms', `${toDMS(lat,true)}  |  ${toDMS(lng,false)}`);
    // maps link
    const a = document.getElementById('loc-link');
    if (a){
      const url = `https://maps.google.com/?q=${lat.toFixed(6)},${lng.toFixed(6)}`;
      a.href = url;
      a.textContent = url;
    }
  } else {
    setText('loc-dd','—'); setText('loc-dms','—');
    const a = document.getElementById('loc-link'); if (a){ a.href='#'; a.textContent='—'; }
  }

  // altitude
  setText('loc-alt', Number.isFinite(alt) ? `${alt.toFixed(1)} m` : '—');

  // accuracy (with color)
  const accEl = document.getElementById('loc-acc');
  if (accEl){
    accEl.textContent = Number.isFinite(acc) ? `±${acc.toFixed(1)} m` : '±—';
    setAccClass(accEl, acc);
  }

  // recorded
  setText('loc-ts', Number.isFinite(ts) ? new Date(ts).toLocaleString() : '—');
}

function fillCirc(entry){
  const type = (entry.treeType || '').toLowerCase();
  const res = entry.results || {};
  const single = res.lastSingle || null;
  const multi  = res.lastMulti  || null;

  const singleBlock = document.getElementById('circ-single');
  const multiBlock  = document.getElementById('circ-multi');

  // default visibility
  singleBlock.classList.remove('hide');
  multiBlock.classList.add('hide');

  if (type.includes('multi')){
    // Show multi panel
    singleBlock.classList.add('hide');
    multiBlock.classList.remove('hide');

    const list = document.getElementById('c-trunks');
    list.innerHTML = '';
    if (multi && Array.isArray(multi.trunks) && multi.trunks.length){
      multi.trunks.forEach(t=>{
        const li=document.createElement('li');
        const cM = fmt2(t.cM), cFt = fmt2(t.cFt);
        const dM = fmt2(t.dM), dFt = fmt2(t.dFt);
        li.innerHTML = (t.isLargest ? '<strong>' : '') +
          `T${t.index}: ${cM} m (${cFt} ft) → ${dM} m (${dFt} ft)` +
          (t.isLargest ? ' (largest)</strong>' : '');
        list.appendChild(li);
      });
    } else {
      const li=document.createElement('li'); li.textContent='—';
      list.appendChild(li);
    }

    // Equivalents / averages
    setText('c-eq-c',  (multi ? `${fmt2(multi.cEqM)} m (${fmt2(multi.cEqFt)} ft)` : '—'));
    setText('c-eq-d',  (multi ? `${fmt2(multi.dEqM)} m (${fmt2(multi.dEqFt)} ft)` : '—'));
    const dAvgM = multi ? multi.cAvgM/Math.PI : NaN;
    const dAvgFt= mToFt(dAvgM);
    setText('c-avg-c', (multi ? `${fmt2(multi.cAvgM)} m (${fmt2(multi.cAvgFt)} ft)` : '—'));
    setText('c-avg-d', (multi ? `${fmt2(dAvgM)} m (${fmt2(dAvgFt)} ft)` : '—'));

  } else {
    // Single trunk panel
    singleBlock.classList.remove('hide');
    multiBlock.classList.add('hide');
    setText('c-single-c', single ? `${fmt2(single.cM)} m (${fmt2(single.cFt)} ft)` : '—');
    setText('c-single-d', single ? `${fmt2(single.dM)} m (${fmt2(single.dFt)} ft)` : '—');
  }
}

function fillHeight(entry){
  const h = entry?.results?.lastHeight || null;
  if (!h){
    setText('h-final','—');
    setText('h-formula','—');
    return;
  }
  setText('h-final', `${fmt2(h.hM)} m (${fmt2(h.hFt)} ft)`);
  setText('h-formula', `height = tan(${fmt1(h.angleDeg)}°) × ${fmt2(h.dM)} m + ${fmt2(h.eM)} m = ${fmt2(h.hM)} m (${fmt2(h.hFt)} ft)`);
}

function fillSpread(entry){
  const s = entry?.results?.lastSpread || null;
  if (!s){
    setText('s-major','—');
    setText('s-minor','—');
    setText('s-final','—');
    return;
  }
  setText('s-major', Number.isFinite(s.majorM) ? `${fmt2(s.majorM)} m (${fmt2(mToFt(s.majorM))} ft)` : '—');
  setText('s-minor', Number.isFinite(s.minorM) ? `${fmt2(s.minorM)} m (${fmt2(mToFt(s.minorM))} ft)` : '—');
  setText('s-final', `${fmt2(s.meanM)} m (${fmt2(s.meanFt)} ft)`);
}

function fillNotes(entry){
  const n = (entry.notes || '').trim();
  if (!n){ setHTML('notes-box','—'); return; }
  const html = n.split(/\n+/).map(line => `<div>• ${line.replace(/</g,'&lt;')}</div>`).join('');
  setHTML('notes-box', html);
}

/* ---------- removal ---------- */
function removeFromLog(id){
  const arr = loadLogArray();
  const idx = arr.findIndex(x => String(x?.id) === String(id));
  if (idx === -1) return false;

  // write back to the same key we loaded from (prefer lowercase)
  const key = localStorage.getItem('ara_field_v1_log') ? 'ara_field_v1_log' : 'ARA_FIELD_LOG_V1';
  arr.splice(idx,1);
  localStorage.setItem(key, JSON.stringify(arr));
  return true;
}

/* ---------- main ---------- */
(function init(){
  const params = new URLSearchParams(location.search);
  const id = params.get('id');

  const entry = loadById(id);
  if (!entry){
    document.getElementById('hdr-sub').textContent = 'Not found';
    alert('This entry was not found in your log.');
    return;
  }

  // Fill sections
  fillGeneral(entry);
  fillLocation(entry);
  fillCirc(entry);
  fillHeight(entry);
  fillSpread(entry);
  fillNotes(entry);

  // Remove button
  const btnRemove = document.getElementById('btn-remove');
  btnRemove.addEventListener('click', ()=>{
    const name = entry.name || 'this tree';
    if (!confirm(`Remove “${name}” from the log? This cannot be undone.`)) return;
    if (removeFromLog(id)){
      alert('Removed from log.');
      location.href = 'log.html';
    } else {
      alert('Could not remove; entry not found.');
    }
  });
})();
</script>
</body>
</html>
