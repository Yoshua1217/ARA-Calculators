<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ARA Field Tools — Nomination Form</title>
  <style>
    :root { --radius:12px; --dark:#111; --light:#f2f2f2; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:24px; color:#111; }
    .wrap { max-width: 960px; margin: 0 auto; }
    .card { border:1px solid #ddd; border-radius: var(--radius); background:#fff; }
    header { display:flex; align-items:center; gap:10px; margin-bottom:14px; }
    h1 { margin:0; font-size:1.6rem; }
    .sub { color:#666; margin:0; }

    /* Tabs */
    .tabs { display:flex; gap:8px; margin: 0 0 14px; }
    .tab {
      padding:10px 14px; border:1px solid #ddd; background:#fafafa; border-radius:10px; cursor:default; user-select:none;
    }
    .tab.active { background:#111; color:#fff; border-color:#111; }
    .tab.disabled { opacity:.5; }

    /* Sections */
    .section { padding:18px; }
    .section + .section { border-top:1px solid #eee; }
    .section h2 { margin:0 0 10px; font-size:1.15rem; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    @media (max-width: 720px) { .row { grid-template-columns: 1fr; } }

    label { display:block; font-weight:600; margin:10px 0 6px; }
    input[type="text"], input[type="number"], select, textarea {
      width:100%; padding:10px; border:1px solid #ccc; border-radius:8px; font-size:1rem;
    }
    textarea { min-height: 80px; resize: vertical; }

    .help { margin:8px 0 6px; color:#444; font-size:.95rem; }
    .unit-toggle { display:flex; gap:8px; margin: 8px 0 10px; }
    .toggle-btn { padding:8px 12px; border:1px solid #ccc; border-radius:8px; background: var(--light); cursor:pointer; user-select:none; }
    .toggle-btn.active { background: var(--dark); color:#fff; border-color: var(--dark); }
    .toggle-btn:focus-visible { outline:2px solid var(--dark); outline-offset:2px; }

    .btn-row { display:flex; gap:10px; flex-wrap:wrap; }
    button, a.button { padding:10px 14px; border:0; border-radius:8px; cursor:pointer; text-decoration:none; display:inline-block; }
    .btn-primary { background: var(--dark); color:#fff; }
    .btn-secondary { background:#e9e9e9; color:#111; }
    .btn-ghost { background:#f5f5f5; color:#111; }
    .btn-secondary.active { background: var(--dark); color:#fff; }
    button[disabled], a.button[aria-disabled="true"]{ opacity:.6; cursor:not-allowed; }

    /* Multi-trunk widget */
    .hint { font-size:.86rem; color:#b2271a; display:none; }
    .hint.show { display:block; }
    .largest-label { font-weight:800; }
    .badge { display:inline-block; margin-left:8px; padding:2px 8px; border-radius:999px; background:#111; color:#fff; font-size:.75rem; vertical-align:middle; }
    .badge.hide { display:none; }
    input.error { border-color:#e11900; box-shadow:0 0 0 3px rgba(225,25,0,.15); outline:none; }

    /* Description area */
    .descwrap { margin-top:10px; }
    .descwrap .btn-row { margin-bottom:10px; }
    .descbox {
      width:100%; min-height:120px; background:#fafafa;
      border:1px solid #e6e6e6; border-radius:10px; padding:12px;
      white-space:normal; font-family: inherit;
    }
    .descbox p { margin: 0 0 6px; }
    .descbox ul { margin: 6px 0 6px 20px; }

    /* Results panel */
    .results { background:#f7f7f7; border:1px solid #e7e7e7; border-radius:12px; padding:12px; }
    .results h3 { margin:0 0 8px; font-size:1.05rem; }
    .results p { margin:6px 0; }

    .note { background:#fafafa; border:1px solid #eee; border-radius:12px; padding:10px 12px; color:#444; }
    .tiny { color:#666; font-size:.88rem; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ARA Field Tools</h1>
      <p class="sub">Nomination Form</p>
    </header>

    <nav class="tabs" aria-label="Primary">
      <div class="tab active" role="tab" aria-selected="true" tabindex="0">Nomination Form</div>
      <div class="tab disabled" role="tab" aria-selected="false" aria-disabled="true" tabindex="-1" title="Coming soon">Calculators</div>
      <div class="tab disabled" role="tab" aria-selected="false" aria-disabled="true" tabindex="-1" title="Coming soon">QR Tools</div>
    </nav>

    <div class="card">

      <!-- BASICS -->
      <section class="section" id="sec-basics">
        <h2>Basic details</h2>
        <div class="row">
          <div>
            <label for="treeName">Tree name</label>
            <input id="treeName" type="text" placeholder="e.g., Rossdale Poplar">
          </div>
          <div>
            <label for="species">Species</label>
            <input id="species" type="text" placeholder="e.g., Populus balsamifera">
          </div>
          <div>
            <label for="condition">Tree condition</label>
            <select id="condition">
              <option value="">— optional —</option>
              <option>Excellent</option>
              <option>Good</option>
              <option>Fair</option>
              <option>Poor</option>
              <option>Dead</option>
            </select>
          </div>
          <div>
            <label for="treeType">Tree type</label>
            <select id="treeType">
              <option value="">— select —</option>
              <option>Single trunk tree</option>
              <option>Multi trunked tree</option>
              <option>Grove</option>
              <option>Forest</option>
              <option>Clonal aspen</option>
            </select>
          </div>
        </div>
      </section>

      <!-- MEASUREMENTS -->
      <section class="section" id="sec-measure">
        <h2>Measurements</h2>

        <!-- Global unit toggle -->
        <p class="help"><strong>Input units:</strong> applies to all measurements on this page.</p>
        <div class="unit-toggle" role="group" aria-label="Input units">
          <button type="button" id="unit-m"  class="toggle-btn active" aria-pressed="true">Meters (m)</button>
          <button type="button" id="unit-ft" class="toggle-btn" aria-pressed="false">Feet (ft)</button>
        </div>

        <!-- Calc mode toggle -->
        <p class="help"><strong>Calculation mode:</strong></p>
        <div class="unit-toggle" role="group" aria-label="Calculation mode">
          <button type="button" id="mode-manual" class="toggle-btn active" aria-pressed="true">Manual (buttons)</button>
          <button type="button" id="mode-auto"   class="toggle-btn" aria-pressed="false">Auto (on change)</button>
        </div>

        <!-- Single-trunk circumference -->
        <div id="single-circ-block" style="display:none; margin-top:10px;">
          <label for="singleC">Circumference (<span class="unit-tag">m</span>)</label>
          <input id="singleC" type="number" step="0.01" inputmode="decimal" placeholder="e.g. 3.10">
          <div class="tiny">Diameter will be calculated automatically (D = C / π).</div>
        </div>

        <!-- Multi-trunk circumference widget -->
        <div id="multi-block" style="display:none; margin-top:10px;">
          <div class="note" style="margin-bottom:10px;">
            <strong>Multi-trunk entry:</strong> Add each trunk’s <em>circumference</em>.
          </div>
          <div class="row" style="align-items:start;">
            <div>
              <div id="mt-list" style="display:flex; flex-direction:column; gap:10px;"></div>
              <div class="btn-row" style="margin-top:8px;">
                <button type="button" id="mt-add" class="btn-secondary">Add trunk</button>
                <button type="button" id="mt-remove" class="btn-secondary">Remove last</button>
                <button type="button" id="mt-sort" class="btn-ghost" title="Sort by diameter (desc)">Sort by diameter</button>
                <button type="button" id="mt-calc" class="btn-primary">Calculate multi-trunk</button>
              </div>
            </div>
            <div>
              <label for="mt-bulk">Bulk paste (numbers + repeaters)</label>
              <textarea id="mt-bulk" placeholder="Examples:
1.72, 0.98 1.10
12x0.78   (12 repeats of 0.78)
3×1.50    (× also works)"></textarea>
              <div class="tiny">Uses current unit (<span class="unit-tag">m</span>). Ignores text; keeps positive numbers only. Supports <strong>NxVALUE</strong> like <strong>12x0.78</strong> or <strong>3×1.5</strong>.</div>
              <div class="btn-row" style="margin-top:8px;">
                <button type="button" id="mt-fill"  class="btn-ghost">Fill from bulk</button>
                <button type="button" id="mt-clear" class="btn-ghost">Clear bulk</button>
              </div>
            </div>
          </div>
          <div id="mt-result" class="tiny" style="margin-top:8px; color:#333;">—</div>
          <div class="tiny" style="margin-top:4px;">* Largest trunk counts 100%, others 50%.</div>
        </div>

        <!-- Height -->
        <div id="height-block" style="margin-top:18px;">
          <label for="h-angle">Angle to top of the tree (degrees)</label>
          <input id="h-angle" type="number" step="0.1" inputmode="decimal" placeholder="e.g. 37.5">

          <div class="row">
            <div>
              <label for="h-dist">Distance to trunk (<span class="unit-tag">m</span>)</label>
              <input id="h-dist" type="number" step="0.01" inputmode="decimal" placeholder="e.g. 23.40">
            </div>
            <div>
              <label for="h-eye">Eye height (<span class="unit-tag">m</span>)</label>
              <input id="h-eye" type="number" step="0.01" inputmode="decimal" placeholder="e.g. 1.62">
            </div>
          </div>

          <div class="btn-row" style="margin-top:10px;">
            <button type="button" id="h-calc" class="btn-secondary">Calculate height</button>
          </div>
        </div>

        <!-- Canopy spread (optional two entries) -->
        <div id="spread-block" style="margin-top:18px;">
          <div class="row">
            <div>
              <label for="spreadMajor">Canopy spread (major) (<span class="unit-tag">m</span>)</label>
              <input id="spreadMajor" type="number" step="0.01" inputmode="decimal" placeholder="optional">
            </div>
            <div>
              <label for="spreadMinor">Canopy spread (minor) (<span class="unit-tag">m</span>)</label>
              <input id="spreadMinor" type="number" step="0.01" inputmode="decimal" placeholder="optional">
            </div>
          </div>
          <div class="btn-row" style="margin-top:8px;">
            <button type="button" id="spread-calc" class="btn-secondary">Calculate canopy spread</button>
          </div>
        </div>
      </section>

      <!-- COPY ROW -->
      <section class="section" id="sec-copiers">
        <h2>Quick copy (ARA form pure numbers in meters)</h2>
        <div class="btn-row">
          <button type="button" id="copyHeight"  class="btn-secondary" disabled title="Copy height (m)">Copy Height (m)</button>
          <button type="button" id="copyEqCirc"  class="btn-secondary" disabled title="Copy equivalent/entered circumference (m)">Copy Eq. Circ (m)</button>
          <button type="button" id="copyAvgCirc" class="btn-secondary" disabled title="Copy average circumference (m)">Copy Avg Circ (m)</button>
          <button type="button" id="copySpread"  class="btn-secondary" disabled title="Copy Canopy (m)">Copy Canopy (m)</button>
        </div>
      </section>

      <!-- RESULTS -->
      <section class="section" id="sec-results">
        <h2>Results</h2>
        <div class="results">
          <h3>Calculated values</h3>
          <p id="res-height">Height: —</p>
          <p id="res-eqcirc">Equivalent / Entered circumference: —</p>
          <p id="res-avgcirc" style="display:none;">Average circumference (multi): —</p>
          <p id="res-spread">Final canopy spread: —</p>
        </div>
      </section>

      <!-- DESCRIPTION -->
      <section class="section" id="sec-desc">
        <h2>Description</h2>
        <div class="btn-row">
          <button type="button" id="genDesc"  class="btn-secondary">Generate description</button>
          <button type="button" id="copyDesc" class="btn-ghost" disabled>Copy description</button>
          <a id="emailBtn" class="button btn-ghost" href="#" aria-disabled="true" title="Opens your email app with this description" >Open email (optional)</a>
        </div>
        <div class="descwrap">
          <div id="desc" class="descbox" aria-live="polite">—</div>
        </div>
        <div class="tiny" style="margin-top:8px;">Timestamp uses local 24-hour time.</div>
      </section>

    </div>
  </div>

  <script>
    // --------- Globals & helpers ----------
    const PI = Math.PI, FT_PER_M = 3.28084, M_PER_FT = 0.3048;
    const $  = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    function fmt2(x){ return Number.isFinite(x) ? x.toFixed(2) : '—'; }
    function fmt1(x){ return Number.isFinite(x) ? x.toFixed(1) : '—'; }
    const tanDeg = d => Math.tan(d * Math.PI/180);

    function toM(val, unit){ return unit === 'm' ? val : val * M_PER_FT; }
    function mToFt(m){ return m * FT_PER_M; }
    function nowLocal24(){
      const d = new Date();
      const y = d.getFullYear();
      const mo = String(d.getMonth()+1).padStart(2,'0');
      const da = String(d.getDate()).padStart(2,'0');
      const h = String(d.getHours()).padStart(2,'0');
      const mi = String(d.getMinutes()).padStart(2,'0');
      return `${y}-${mo}-${da} ${h}:${mi}`;
    }
    function escapeHtml(s){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // --------- DOM refs ----------
    const unitM = $('#unit-m'), unitFt = $('#unit-ft');
    const unitTags = $$('.unit-tag');
    const modeManualBtn = $('#mode-manual'), modeAutoBtn = $('#mode-auto');

    const treeName = $('#treeName'), species = $('#species'), condition = $('#condition'), treeType = $('#treeType');

    const singleBlock = $('#single-circ-block');
    const singleC = $('#singleC');

    // Multi-trunk block
    const mtBlock = $('#multi-block');
    const mtList = $('#mt-list');
    const mtAdd = $('#mt-add'), mtRemove = $('#mt-remove'), mtSort = $('#mt-sort');
    const mtCalc = $('#mt-calc');
    const mtBulk = $('#mt-bulk'); const mtFill = $('#mt-fill'); const mtClear = $('#mt-clear');
    const mtResult = $('#mt-result');

    // Height
    const hAngle = $('#h-angle'), hDist = $('#h-dist'), hEye = $('#h-eye');
    const hCalc  = $('#h-calc');

    // Spread
    const spreadMajor = $('#spreadMajor'), spreadMinor = $('#spreadMinor');
    const spreadCalc  = $('#spread-calc');

    // Copy row
    const copyHeight = $('#copyHeight'), copyEqCirc = $('#copyEqCirc'), copyAvgCirc = $('#copyAvgCirc'), copySpread = $('#copySpread');

    // Results
    const resHeight = $('#res-height'), resEqCirc = $('#res-eqcirc'), resAvgCirc = $('#res-avgcirc'), resSpread = $('#res-spread');

    // Description
    const genDesc = $('#genDesc'), copyDesc = $('#copyDesc'), descBox = $('#desc'), emailBtn = $('#emailBtn');

    // --------- State ----------
    let inputUnit = 'm';
    let calcMode = 'manual'; // 'manual' | 'auto'
    let mtCount = 0; const MT_MAX = 60;

    // Last computed values (meters-based)
    let lastHeight = null;
    let lastSingle = null;
    let lastMulti  = null;
    let lastSpread = null;
    let descDirty  = true;

    // --------- Unit toggle ----------
    function setUnit(newU){
      if (newU === inputUnit) return;

      // convert single circ
      const vS = parseFloat(singleC.value);
      if (!Number.isNaN(vS)) singleC.value = (newU === 'm' ? toM(vS, inputUnit) : toM(vS, inputUnit)*FT_PER_M).toFixed(2);

      // convert multi rows
      $$('#mt-list input[type="number"]').forEach(inp => {
        const v = parseFloat(inp.value);
        if (!Number.isNaN(v)) {
          const m = toM(v, inputUnit);
          inp.value = (newU === 'm' ? m : m*FT_PER_M).toFixed(2);
        }
      });

      // convert height inputs
      [hDist, hEye].forEach(inp => {
        const v = parseFloat(inp.value);
        if (!Number.isNaN(v)) {
          const m = toM(v, inputUnit);
          inp.value = (newU === 'm' ? m : m*FT_PER_M).toFixed(2);
        }
      });

      // convert spreads
      [spreadMajor, spreadMinor].forEach(inp => {
        const v = parseFloat(inp.value);
        if (!Number.isNaN(v)) {
          const m = toM(v, inputUnit);
          inp.value = (newU === 'm' ? m : m*FT_PER_M).toFixed(2);
        }
      });

      inputUnit = newU;
      const isM = newU === 'm';
      unitM.classList.toggle('active', isM);
      unitFt.classList.toggle('active', !isM);
      unitM.setAttribute('aria-pressed', String(isM));
      unitFt.setAttribute('aria-pressed', String(!isM));
      unitTags.forEach(t => t.textContent = isM ? 'm' : 'ft');

      markDescDirty();
      saveState();

      // Auto recalc if needed
      if (calcMode === 'auto'){
        if (treeType.value === 'Single trunk tree') recomputeSingle();
        if (treeType.value === 'Multi trunked tree') calcMulti();
        calcHeight(); calcSpread();
      }
    }
    unitM.addEventListener('click', () => setUnit('m'));
    unitFt.addEventListener('click', () => setUnit('ft'));

    // --------- Calc mode toggle ----------
    function setCalcMode(mode){
      calcMode = mode;
      const isManual = mode === 'manual';
      modeManualBtn.classList.toggle('active', isManual);
      modeAutoBtn.classList.toggle('active', !isManual);
      modeManualBtn.setAttribute('aria-pressed', String(isManual));
      modeAutoBtn.setAttribute('aria-pressed', String(!isManual));
      saveState();
    }
    modeManualBtn.addEventListener('click', () => setCalcMode('manual'));
    modeAutoBtn.addEventListener('click', () => setCalcMode('auto'));

    // --------- Basics & type gating ----------
    function updateTypeVisibility(){
      const t = treeType.value;
      singleBlock.style.display = (t === 'Single trunk tree') ? '' : 'none';
      mtBlock.style.display     = (t === 'Multi trunked tree') ? '' : 'none';
      markDescDirty(); saveState(); updateResultsPanel(); updateCopyButtons();
    }
    treeType.addEventListener('change', updateTypeVisibility);

    // --------- Single trunk logic ----------
    function recomputeSingle(){
      const v = parseFloat(singleC.value);
      if (Number.isFinite(v) && v > 0){
        const cM = toM(v, inputUnit);
        const dM = cM / PI;
        lastSingle = { cM, cFt: mToFt(cM), dM, dFt: mToFt(dM) };
      } else {
        lastSingle = null;
      }
      markDescDirty(); updateResultsPanel(); updateCopyButtons(); saveState();
    }
    singleC.addEventListener('input', () => { recomputeSingle(); if (calcMode==='auto') updateResultsPanel(); });

    // --------- Multi-trunk widget ----------
    function addMtRow(value=''){
      if (mtCount >= MT_MAX) return;
      mtCount++;
      const row = document.createElement('div');
      row.className = 'row';
      row.style.gridTemplateColumns = '1fr';
      row.dataset.index = String(mtCount);

      const labelWrap = document.createElement('div');
      labelWrap.style.display = 'flex'; labelWrap.style.alignItems = 'center';

      const label = document.createElement('label');
      label.htmlFor = `mt-${mtCount}`;
      label.className = 'mt-label';
      label.textContent = `Trunk ${mtCount} circumference (${inputUnit})`;

      const badge = document.createElement('span');
      badge.className = 'badge hide';
      badge.textContent = 'Largest';

      labelWrap.appendChild(label); labelWrap.appendChild(badge);

      const inp = document.createElement('input');
      inp.id = `mt-${mtCount}`;
      inp.type = 'number'; inp.step = '0.01'; inp.inputMode = 'decimal';
      inp.placeholder = inputUnit === 'm' ? 'e.g. 1.75' : 'e.g. 5.74';
      if (value !== '') inp.value = value;

      const hint = document.createElement('div'); hint.className = 'hint';

      row.appendChild(labelWrap); row.appendChild(inp); row.appendChild(hint);
      mtList.appendChild(row);

      inp.addEventListener('input', () => {
        inp.classList.remove('error'); hint.classList.remove('show'); markDescDirty(); saveState();
        if (calcMode === 'auto') calcMulti();
      });
      inp.addEventListener('blur', () => {
        const v = parseFloat(inp.value);
        maybeMtOutlierHint(v, hint);
      });
    }
    function maybeMtOutlierHint(val, h){
      if (!Number.isFinite(val) || val<=0){ h.classList.remove('show'); return; }
      if (inputUnit === 'm'){
        if (val < 0.20) { h.textContent = 'Unusually small — check units/decimal?'; h.classList.add('show'); }
        else if (val > 12) { h.textContent = 'Unusually large — check units?'; h.classList.add('show'); }
        else h.classList.remove('show');
      } else {
        if (val < 0.66) { h.textContent = 'Unusually small — check units/decimal?'; h.classList.add('show'); }
        else if (val > 40) { h.textContent = 'Unusually large — check units?'; h.classList.add('show'); }
        else h.classList.remove('show');
      }
    }
    function removeMtRow(){
      if (mtCount <= 1) return;
      mtList.lastElementChild?.remove();
      mtCount--;
      renumberMtLabels();
      markDescDirty(); saveState();
      if (calcMode==='auto') calcMulti();
    }
    function renumberMtLabels(){
      Array.from(mtList.querySelectorAll('.mt-label')).forEach((lab,i)=>{
        lab.textContent = `Trunk ${i+1} circumference (${inputUnit})`;
      });
    }
    function parseMtBulk(text, limit = MT_MAX){
      const vals = [];
      if (!text) return vals;
      let s = String(text).replace(/[×X]/g,'x');
      const repRE = /(\d+)\s*x\s*([-+]?\d*\.?\d+)/g;
      s = s.replace(repRE, (_, nStr, vStr) => {
        const n = parseInt(nStr,10), v = parseFloat(vStr);
        if (Number.isFinite(n) && n>0 && Number.isFinite(v) && v>0){
          for(let i=0;i<n && vals.length<limit;i++) vals.push(v);
        }
        return ' ';
      });
      const singles = s.match(/[-+]?\d*\.?\d+/g) || [];
      for(const m of singles){
        if (vals.length>=limit) break;
        const v = parseFloat(m);
        if (Number.isFinite(v) && v>0) vals.push(v);
      }
      return vals;
    }
    function mtFillFromBulk(){
      const vals = parseMtBulk(mtBulk.value, MT_MAX);
      if (vals.length === 0) return;
      mtList.innerHTML=''; mtCount=0;
      vals.forEach(v=>addMtRow(v.toFixed(2)));
      mtResult.textContent='—';
      markDescDirty(); saveState();
      if (calcMode==='auto') calcMulti();
    }
    function mtSortByDiameter(){
      const rows = Array.from(mtList.children);
      const valid=[], invalid=[];
      rows.forEach(row=>{
        const inp=row.querySelector('input[type="number"]'); const v=parseFloat(inp.value);
        if (Number.isFinite(v) && v>0){
          const cM = toM(v, inputUnit), dM = cM/PI;
          valid.push({row,dM});
        } else invalid.push(row);
      });
      if (valid.length<2) return;
      valid.sort((a,b)=>b.dM-a.dM);
      const frag = document.createDocumentFragment();
      valid.forEach(v=>frag.appendChild(v.row)); invalid.forEach(r=>frag.appendChild(r));
      mtList.innerHTML=''; mtList.appendChild(frag);
      renumberMtLabels(); clearMtLargest();
      markDescDirty(); saveState();
      if (calcMode==='auto') calcMulti();
    }
    function clearMtLargest(){
      mtList.querySelectorAll('.largest-label').forEach(el => el.classList.remove('largest-label'));
      mtList.querySelectorAll('.badge').forEach(b=>{ b.classList.add('hide'); b.textContent='Largest'; });
    }
    function calcMulti(){
      clearMtLargest();
      const items = Array.from(mtList.querySelectorAll('input[type="number"]'));
      const valid = items
        .map(inp => ({ inp, val: parseFloat(inp.value), row: inp.closest('.row') }))
        .filter(o => Number.isFinite(o.val) && o.val > 0);

      if (valid.length === 0){
        lastMulti=null; mtResult.textContent='Enter at least one trunk circumference.'; updateResultsPanel(); updateCopyButtons(); saveState(); return;
      }

      const withD = valid.map((r,i)=>{
        const cM = toM(r.val, inputUnit);
        const dM = cM / PI;
        return {row:r.row, cM, dM, idx:i+1};
      });

      const eps=1e-9;
      const dmax = Math.max(...withD.map(x=>x.dM));
      const maxRows = withD.filter(x=>Math.abs(x.dM-dmax)<eps);
      const sumAll = withD.reduce((a,x)=>a+x.dM,0);
      const dEqM = dmax + 0.5*(sumAll - dmax);
      const cEqM = dEqM * PI;
      const cAvgM = withD.reduce((a,x)=>a+x.cM,0) / withD.length;

      // highlight
      const badgeText = (maxRows.length>1)?'Tied for largest':'Largest';
      maxRows.forEach(r=>{
        const lab = r.row.querySelector('.mt-label');
        const badge = r.row.querySelector('.badge');
        lab?.classList.add('largest-label');
        if (badge){ badge.textContent=badgeText; badge.classList.remove('hide'); }
      });

      lastMulti = {
        trunks: withD.map(t=>({
          index:t.idx,
          cM:t.cM, cFt:mToFt(t.cM),
          dM:t.dM, dFt:mToFt(t.dM),
          isLargest: Math.abs(t.dM - dmax) < eps
        })),
        dEqM, cEqM, dEqFt:mToFt(dEqM), cEqFt:mToFt(cEqM),
        cAvgM, cAvgFt: mToFt(cAvgM),
        tie: maxRows.length>1
      };

      mtResult.textContent = `Calculated ${withD.length} trunk${withD.length>1?'s':''}.`;
      markDescDirty(); updateResultsPanel(); updateCopyButtons(); saveState();
    }
    mtAdd.addEventListener('click', ()=>{ addMtRow(); markDescDirty(); saveState(); });
    mtRemove.addEventListener('click', ()=>{ if (mtCount>1) removeMtRow(); });
    mtSort.addEventListener('click', mtSortByDiameter);
    mtCalc.addEventListener('click', calcMulti);
    mtFill.addEventListener('click', mtFillFromBulk);
    mtClear.addEventListener('click', ()=>{ mtBulk.value=''; });

    // --------- Height calc ----------
    function calcHeight(){
      const a = parseFloat(hAngle.value), d=parseFloat(hDist.value), e=parseFloat(hEye.value);
      if (!Number.isFinite(a) || !Number.isFinite(d) || !Number.isFinite(e)){ lastHeight=null; updateResultsPanel(); updateCopyButtons(); saveState(); return; }
      const dM = toM(d, inputUnit); const eM = toM(e, inputUnit);
      const hM = tanDeg(a)*dM + eM;
      lastHeight = { hM, hFt: mToFt(hM), angleDeg: Number(a.toFixed(1)), dM, eM };
      markDescDirty(); updateResultsPanel(); updateCopyButtons(); saveState();
    }
    hCalc.addEventListener('click', calcHeight);
    [hAngle,hDist,hEye].forEach(inp=>inp.addEventListener('input', ()=>{ markDescDirty(); if (calcMode==='auto') calcHeight(); }));
    [hAngle,hDist,hEye].forEach(i=>i.addEventListener('keydown', (e)=>{ if (e.key==='Enter'){ e.preventDefault(); calcHeight(); }}));

    // --------- Spread calc ----------
    function calcSpread(){
      const maj = parseFloat(spreadMajor.value); const min = parseFloat(spreadMinor.value);
      const haveMaj = Number.isFinite(maj); const haveMin = Number.isFinite(min);
      if (!haveMaj && !haveMin){ lastSpread=null; }
      else {
        const mMaj = haveMaj ? toM(maj, inputUnit) : null;
        const mMin = haveMin ? toM(min, inputUnit) : null;
        const meanM = ( (mMaj??0) + (mMin??0) ) / ( (haveMaj?1:0) + (haveMin?1:0) );
        lastSpread = { majorM:mMaj, minorM:mMin, meanM, meanFt:mToFt(meanM) };
      }
      markDescDirty(); updateResultsPanel(); updateCopyButtons(); saveState();
    }
    spreadCalc.addEventListener('click', calcSpread);
    [spreadMajor, spreadMinor].forEach(inp=>inp.addEventListener('input', ()=>{ markDescDirty(); if (calcMode==='auto') calcSpread(); }));

    // --------- Results panel & copy buttons ----------
    function updateResultsPanel(){
      // Height
      if (lastHeight){
        resHeight.textContent = `Height: ${fmt2(lastHeight.hM)} m (${fmt2(lastHeight.hFt)} ft)`;
      } else {
        resHeight.textContent = 'Height: —';
      }

      // Eq/Entered circumference
      const t = treeType.value;
      if (t === 'Multi trunked tree' && lastMulti){
        resEqCirc.textContent = `Equivalent circumference: ${fmt2(lastMulti.cEqM)} m (${fmt2(lastMulti.cEqFt)} ft)`;
        resAvgCirc.style.display = '';
        resAvgCirc.textContent = `Average circumference (multi): ${fmt2(lastMulti.cAvgM)} m (${fmt2(lastMulti.cAvgFt)} ft)`;
      } else if (t === 'Single trunk tree' && lastSingle){
        resEqCirc.textContent = `Entered circumference: ${fmt2(lastSingle.cM)} m (${fmt2(lastSingle.cFt)} ft)`;
        resAvgCirc.style.display = 'none';
        resAvgCirc.textContent = 'Average circumference (multi): —';
      } else {
        resEqCirc.textContent = 'Equivalent / Entered circumference: —';
        resAvgCirc.style.display = (t==='Multi trunked tree')?'':'none';
        resAvgCirc.textContent = 'Average circumference (multi): —';
      }

      // Spread
      if (lastSpread){
        resSpread.textContent = `Final canopy spread: ${fmt2(lastSpread.meanM)} m (${fmt2(lastSpread.meanFt)} ft)`;
      } else {
        resSpread.textContent = 'Final canopy spread: —';
      }
    }

    function updateCopyButtons(){
      copyHeight.disabled = !(lastHeight && Number.isFinite(lastHeight.hM));
      if (treeType.value === 'Multi trunked tree'){
        copyEqCirc.disabled = !(lastMulti && Number.isFinite(lastMulti.cEqM));
        copyAvgCirc.disabled = !(lastMulti && Number.isFinite(lastMulti.cAvgM));
      } else if (treeType.value === 'Single trunk tree'){
        copyEqCirc.disabled = !(lastSingle && Number.isFinite(lastSingle.cM));
        copyAvgCirc.disabled = true;
      } else {
        copyEqCirc.disabled = true; copyAvgCirc.disabled = true;
      }
      copySpread.disabled = !(lastSpread && Number.isFinite(lastSpread.meanM));
    }

    async function copyText(txt, btn){
      try {
        await navigator.clipboard.writeText(txt);
        const old = btn.textContent; btn.textContent = 'Copied ✓';
        setTimeout(()=>btn.textContent=old, 1200);
      } catch {
        const t = document.createElement('input'); t.value = txt; document.body.appendChild(t);
        t.select(); document.execCommand('copy'); document.body.removeChild(t);
        const old = btn.textContent; btn.textContent = 'Copied ✓';
        setTimeout(()=>btn.textContent=old, 1200);
      }
    }
    copyHeight.addEventListener('click', ()=>{ if (lastHeight) copyText(fmt2(lastHeight.hM), copyHeight); });
    copyEqCirc.addEventListener('click', ()=>{
      const t = treeType.value;
      if (t==='Multi trunked tree' && lastMulti) copyText(fmt2(lastMulti.cEqM), copyEqCirc);
      if (t==='Single trunk tree' && lastSingle) copyText(fmt2(lastSingle.cM), copyEqCirc);
    });
    copyAvgCirc.addEventListener('click', ()=>{ if (lastMulti) copyText(fmt2(lastMulti.cAvgM), copyAvgCirc); });
    copySpread.addEventListener('click', ()=>{ if (lastSpread) copyText(fmt2(lastSpread.meanM), copySpread); });

    // --------- Description generation ----------
    function markDescDirty(){
      descDirty = true;
      copyDesc.disabled = true;
      emailBtn.setAttribute('aria-disabled','true');
      emailBtn.href = '#';
      genDesc.classList.remove('active');
    }

    function ensureCalcsOnDemand(){
      if (treeType.value === 'Multi trunked tree'){
        const anyVal = $$('#mt-list input[type="number"]').some(i=>Number.isFinite(parseFloat(i.value)));
        if (anyVal && !lastMulti) calcMulti();
      }
      const a=parseFloat(hAngle.value), d=parseFloat(hDist.value), e=parseFloat(hEye.value);
      if (Number.isFinite(a) && Number.isFinite(d) && Number.isFinite(e) && !lastHeight) calcHeight();
      if (!lastSpread && (Number.isFinite(parseFloat(spreadMajor.value)) || Number.isFinite(parseFloat(spreadMinor.value)))) calcSpread();
      if (treeType.value === 'Single trunk tree' && !lastSingle && Number.isFinite(parseFloat(singleC.value))) recomputeSingle();
    }

    function buildDescription(){
      const parts = [];
      const name = treeName.value?.trim();
      const sp   = species.value?.trim();
      const cond = condition.value?.trim();
      const type = treeType.value?.trim();

      const head = document.createElement('div');
      if (name) head.innerHTML += `<p><strong>Tree</strong>: ${escapeHtml(name)}</p>`;
      if (sp)   head.innerHTML += `<p><strong>Species</strong>: ${escapeHtml(sp)}</p>`;
      if (cond) head.innerHTML += `<p><strong>Condition</strong>: ${escapeHtml(cond)}</p>`;
      if (type) head.innerHTML += `<p><strong>Type</strong>: ${escapeHtml(type)}</p>`;
      if (head.innerHTML) parts.push(head);

      // Measurements
      const meas = document.createElement('div');
      let hasMeas = false;

      // Single trunk
      if (type === 'Single trunk tree' && lastSingle){
        hasMeas = true;
        const p1 = document.createElement('p'); p1.innerHTML = '<strong>Measurements</strong>';
        const ul = document.createElement('ul');
        const li = document.createElement('li');
        li.textContent = `Circumference: ${fmt2(lastSingle.cM)} m (${fmt2(lastSingle.cFt)} ft) → Diameter: ${fmt2(lastSingle.dM)} m (${fmt2(lastSingle.dFt)} ft)`;
        ul.appendChild(li);
        meas.appendChild(p1); meas.appendChild(ul);
      }

      // Multi trunk
      if (type === 'Multi trunked tree'){
        const trunks = lastMulti?.trunks ?? [];
        if (trunks.length>0){
          hasMeas = true;
          const p1 = document.createElement('p'); p1.innerHTML = '<strong>Individual trunks (circumference → diameter)</strong>';
          const ul1 = document.createElement('ul');
          trunks.forEach(t=>{
            const li = document.createElement('li');
            const txt = `T${t.index}: ${fmt2(t.cM)} m (${fmt2(t.cFt)} ft) → ${fmt2(t.dM)} m (${fmt2(t.dFt)} ft)`;
            if (t.isLargest){ li.innerHTML = `<strong>${txt}</strong>`; } else { li.textContent = txt; }
            ul1.appendChild(li);
          });

          const p2 = document.createElement('p'); p2.innerHTML = '<strong>Full Tree Circumference</strong>';
          const ul2 = document.createElement('ul');
          const liC = document.createElement('li');
          liC.textContent = `Equivalent circumference: ${fmt2(lastMulti.cEqM)} m (${fmt2(lastMulti.cEqFt)} ft) → ${fmt2(lastMulti.dEqM)} m (${fmt2(lastMulti.dEqFt)} ft)`;
          const liA = document.createElement('li');
          const dAvgM = lastMulti.cAvgM / PI, dAvgFt = mToFt(dAvgM);
          liA.textContent = `Average circumference: ${fmt2(lastMulti.cAvgM)} m (${fmt2(lastMulti.cAvgFt)} ft) → ${fmt2(dAvgM)} m (${fmt2(dAvgFt)} ft)`;
          ul2.appendChild(liC); ul2.appendChild(liA);

          meas.appendChild(p1); meas.appendChild(ul1); meas.appendChild(p2); meas.appendChild(ul2);
        }
      }

      // Height
      if (lastHeight){
        hasMeas = true;
        const p = document.createElement('p'); p.innerHTML = '<strong>Height</strong>';
        const ul = document.createElement('ul');
        const liH = document.createElement('li'); liH.textContent = `Tree height: ${fmt2(lastHeight.hM)} m (${fmt2(lastHeight.hFt)} ft)`;
        const liF = document.createElement('li');
        liF.textContent = `height = tan(${fmt1(lastHeight.angleDeg)}°) × ${fmt2(lastHeight.dM)} m + ${fmt2(lastHeight.eM)} m = ${fmt2(lastHeight.hM)} m (${fmt2(lastHeight.hFt)} ft)`;
        ul.appendChild(liH); ul.appendChild(liF);
        meas.appendChild(p); meas.appendChild(ul);
      }

      // Canopy spread
      if (lastSpread){
        hasMeas = true;
        const p = document.createElement('p'); p.innerHTML = '<strong>Canopy spread</strong>';
        const ul = document.createElement('ul');
        if (Number.isFinite(lastSpread.majorM)){
          const li = document.createElement('li'); li.textContent = `Major: ${fmt2(lastSpread.majorM)} m (${fmt2(mToFt(lastSpread.majorM))} ft)`;
          ul.appendChild(li);
        }
        if (Number.isFinite(lastSpread.minorM)){
          const li = document.createElement('li'); li.textContent = `Minor: ${fmt2(lastSpread.minorM)} m (${fmt2(mToFt(lastSpread.minorM))} ft)`;
          ul.appendChild(li);
        }
        const liMean = document.createElement('li'); liMean.innerHTML = `<strong>Final canopy spread:</strong> ${fmt2(lastSpread.meanM)} m (${fmt2(lastSpread.meanFt)} ft)`;
        ul.appendChild(liMean);
        meas.appendChild(p); meas.appendChild(ul);
      }

      if (hasMeas) parts.push(meas);

      // Observation
      const obs = document.createElement('div');
      const when = nowLocal24();
      obs.innerHTML = `<p><strong>Observation</strong></p><ul><li>Recorded: ${when}</li></ul>`;
      parts.push(obs);

      const out = document.createElement('div');
      parts.forEach(p => out.appendChild(p));
      return out.innerHTML;
    }

    function generateDescription(){
      ensureCalcsOnDemand();
      const html = buildDescription();
      descBox.innerHTML = html || '—';
      genDesc.classList.add('active');
      copyDesc.disabled = !html;
      if (html){
        const plain = extractPlainText(descBox);
        const subjName = treeName.value?.trim();
        const subject = `ARA Field Nomination${subjName ? ' – ' + subjName : ''}`;
        const href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(plain)}`;
        emailBtn.href = href;
        emailBtn.removeAttribute('aria-disabled');
      } else {
        emailBtn.setAttribute('aria-disabled', 'true'); emailBtn.href = '#';
      }
    }
    genDesc.addEventListener('click', generateDescription);

    function extractPlainText(container){
      const items = Array.from(container.querySelectorAll('li')).map(li => `- ${li.innerText}`);
      const paras = Array.from(container.querySelectorAll('p')).map(p => p.innerText);
      const lines = [...paras, ...items];
      return (lines.join('\n')).trim();
    }

    async function copyDescription(){
      const html = descBox.innerHTML.trim();
      if (!html || html === '—') return;
      const text = extractPlainText(descBox);
      if (navigator.clipboard && window.ClipboardItem){
        try{
          await navigator.clipboard.write([
            new ClipboardItem({
              'text/html': new Blob([html], {type:'text/html'}),
              'text/plain': new Blob([text], {type:'text/plain'})
            })
          ]);
          const old = copyDesc.textContent; copyDesc.textContent='Copied ✓';
          setTimeout(()=>copyDesc.textContent=old,1200);
          return;
        } catch(e){}
      }
      const tmp = document.createElement('div');
      tmp.contentEditable='true'; tmp.style.position='fixed'; tmp.style.left='-9999px'; tmp.innerHTML = html;
      document.body.appendChild(tmp);
      const r = document.createRange(); r.selectNodeContents(tmp);
      const s = window.getSelection(); s.removeAllRanges(); s.addRange(r);
      document.execCommand('copy');
      s.removeAllRanges(); document.body.removeChild(tmp);
      const old = copyDesc.textContent; copyDesc.textContent='Copied ✓';
      setTimeout(()=>copyDesc.textContent=old,1200);
    }
    copyDesc.addEventListener('click', copyDescription);

    // --------- Autosave ----------
    const SAVE_KEY = 'ara_field_v1';
    function saveState(){
      const state = {
        inputUnit, calcMode,
        basics: {
          name: treeName.value || '',
          species: species.value || '',
          condition: condition.value || '',
          type: treeType.value || ''
        },
        singleC: singleC.value || '',
        height: { angle: hAngle.value || '', dist: hDist.value || '', eye: hEye.value || '' },
        spread: { major: spreadMajor.value || '', minor: spreadMinor.value || '' },
        multi: {
          values: $$('#mt-list input[type="number"]').map(i => i.value || '')
        }
      };
      try { localStorage.setItem(SAVE_KEY, JSON.stringify(state)); } catch(e){}
    }
    function loadState(){
      let st=null; try { st = JSON.parse(localStorage.getItem(SAVE_KEY)||'null'); } catch(e){}
      if (!st) {
        addMtRow(); addMtRow(); // default two rows
        return;
      }
      setUnit(st.inputUnit === 'ft' ? 'ft' : 'm');
      setCalcMode(st.calcMode === 'auto' ? 'auto' : 'manual');

      treeName.value = st.basics?.name ?? '';
      species.value = st.basics?.species ?? '';
      condition.value = st.basics?.condition ?? '';
      treeType.value = st.basics?.type ?? '';
      updateTypeVisibility();

      singleC.value = st.singleC ?? '';

      hAngle.value = st.height?.angle ?? '';
      hDist.value  = st.height?.dist ?? '';
      hEye.value   = st.height?.eye ?? '';

      spreadMajor.value = st.spread?.major ?? '';
      spreadMinor.value = st.spread?.minor ?? '';

      mtList.innerHTML=''; mtCount=0;
      const arr = Array.isArray(st.multi?.values) ? st.multi.values : [];
      if (arr.length>0) arr.forEach(v=>addMtRow(v));
      else { addMtRow(); addMtRow(); }

      markDescDirty(); updateResultsPanel(); updateCopyButtons();
    }
    [treeName,species,condition,treeType,singleC,hAngle,hDist,hEye,spreadMajor,spreadMinor].forEach(el=>el.addEventListener('input', saveState));

    // Init
    loadState();

  </script>
</body>
</html>
