<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ARA Field Tools — Nomination Form</title>
<style>
  :root{--radius:12px;--dark:#111;--light:#f2f2f2;--border:#ddd;--muted:#666;--danger:#d93c3c;}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;color:#111;background:#fff}
  /* Wider main, slightly narrower sidebar */
  .wrap{max-width:1320px;margin:0 auto;display:grid;grid-template-columns:260px 1fr;gap:20px}
  @media (max-width:980px){.wrap{grid-template-columns:1fr}}

  header{grid-column:1/-1;display:flex;align-items:center;gap:10px;margin-bottom:6px}
  h1{margin:0;font-size:1.6rem}
  .sub{color:#666;margin:0}
  .tabs{grid-column:1/-1;display:flex;gap:8px;margin:0 0 12px}
  .tab{padding:10px 14px;border:1px solid var(--border);background:#fafafa;border-radius:10px}
  .tab.active{background:#111;color:#fff;border-color:#111}
  .tab.disabled{opacity:.5}

  /* LEFT: Session Log panel now flex column with footer pinned bottom */
  .side{border:1px solid var(--border);border-radius:var(--radius);background:#fafafa;padding:12px;display:flex;flex-direction:column;min-height:420px}
  .side>header{display:flex;justify-content:space-between;align-items:center;margin:0 0 8px}
  .side h2{margin:0;font-size:1.1rem}
  .view-toggle{display:flex;gap:6px}
  .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer}
  .pill.active{background:#111;color:#fff;border-color:#111}
  .groups-head{display:flex;align-items:center;gap:6px;margin:6px 0 6px}
  .small{font-size:.9rem;color:#444}

  .side-scroller{flex:1;min-height:120px;overflow:auto}
  .side-footer{margin-top:10px;border-top:1px solid #e7e7e7;padding-top:10px;display:flex;gap:8px;flex-wrap:wrap}
  .button,button{padding:10px 14px;border:0;border-radius:8px;cursor:pointer;text-decoration:none;display:inline-block}
  .btn-primary{background:var(--dark);color:#fff}
  .btn-secondary{background:#e9e9e9;color:#111}
  .btn-ghost{background:#f5f5f5;color:#111}
  .danger{background:#f5e9e9}
  .danger:hover,.danger:active{background:var(--danger);color:#fff}
  .tiny{color:#666;font-size:.86rem}

  /* Cards: tighter top padding, small gaps between stacked boxes */
  .card{border:1px solid var(--border);border-radius:var(--radius);background:#fff;margin-bottom:14px}
  .card .block{padding:12px 18px}
  .card .block + .block{border-top:1px solid #eee} /* used only when we deliberately want a divider */
  .card h2{margin:6px 0 10px;font-size:1.15rem} /* smaller forehead */
  .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:720px){.row{grid-template-columns:1fr}}

  label{display:block;font-weight:600;margin:10px 0 6px}
  input[type="text"],input[type="number"],select,textarea{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;font-size:1rem;background:#fff}
  textarea{min-height:80px;resize:none;overflow:hidden}
  .unit-toggle{display:flex;gap:8px;margin:8px 0 10px}
  .toggle-btn{padding:8px 12px;border:1px solid #ccc;border-radius:8px;background:var(--light);cursor:pointer}
  .toggle-btn.active{background:var(--dark);color:#fff;border-color:var(--dark)}
  .toggle-btn:focus-visible{outline:2px solid var(--dark);outline-offset:2px}
  .note{background:#fafafa;border:1px solid #eee;border-radius:12px;padding:10px 12px;color:#444}

  .results{background:#f7f7f7;border:1px solid #e7e7e7;border-radius:12px;padding:12px}
  .results h3{margin:0 0 8px;font-size:1.05rem}
  .results p{margin:6px 0}

  .descbox{width:100%;min-height:120px;background:#fafafa;border:1px solid #e6e6e6;border-radius:10px;padding:12px;white-space:normal;font-family:inherit}
  .descbox p{margin:0 0 6px}.descbox ul{margin:6px 0 6px 20px}

  .hint{font-size:.86rem;color:#b2271a;display:none}.hint.show{display:block}
  .largest-label{font-weight:800}.badge{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;background:#111;color:#fff;font-size:.75rem;vertical-align:middle}
  .badge.hide{display:none}
  input.error{border-color:#e11900;box-shadow:0 0 0 3px rgba(225,25,0,.15)}

  /* Log list / buckets */
  .bucket{margin:8px 0 10px}
  .bucket-title{font-weight:700;margin:10px 0 6px}
  .bucket-body{min-height:42px} /* keeps height while dragging */
  .entry{border:1px solid #e1e1e1;border-radius:10px;background:#fff;padding:8px;margin-bottom:8px;cursor:grab}
  .entry:hover{background:#f7f7f7}
  .entry .name{font-weight:700}
  .entry .ts{font-size:.86rem;color:#666;margin-top:2px}
  .drop-target{outline:2px dashed #bbb;outline-offset:4px;border-radius:8px;padding:4px}
  /* Modals */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:999}
  .modal.show{display:flex}
  .modal .sheet{max-width:520px;background:#fff;border-radius:12px;padding:16px;border:1px solid #ddd}
  .modal h3{margin:0 0 8px}.modal p{margin:4px 0 12px}
  .modal .btn-row{display:flex;gap:10px;justify-content:flex-end}
</style>
</head>
<body>
<div class="wrap">
  <!-- LEFT: SESSION LOG -->
  <aside class="side" id="logPanel">
    <header>
      <h2>Session Log</h2>
      <div class="view-toggle" role="tablist">
        <button class="pill active" id="viewDate">By date</button>
        <button class="pill" id="viewGroup">By group</button>
      </div>
    </header>

    <div class="groups-head" id="groupsHead">
      <span class="small">Groups:</span>
      <button class="pill" id="addGroupBtn">+ Group</button>
    </div>

    <div class="side-scroller" id="logList" class="tiny">No saved trees yet.</div>

    <div class="side-footer">
      <button id="copyAllBtn" class="btn-ghost tiny" title="Copy all descriptions as backup">Copy all (backup)</button>
      <button id="clearLogBtn" class="danger tiny" title="Remove all saved trees">Clear log</button>
      <div class="tiny" style="margin-left:auto;">Private to this device.</div>
    </div>
  </aside>

  <!-- RIGHT: APP -->
  <main>
    <header>
      <h1>ARA Field Tools</h1>
      <p class="sub">Nomination Form</p>
    </header>
    <nav class="tabs" aria-label="Primary">
      <div class="tab active">Nomination Form</div>
      <div class="tab disabled" title="Coming soon">Calculators</div>
      <div class="tab disabled" title="Coming soon">QR Tools</div>
    </nav>

    <!-- CARD 1: FORM (Basic details + Measurements + Notes) -->
    <section class="card" id="card-form">
      <div class="block">
        <h2>Basic details</h2>
        <div class="row">
          <div>
            <label for="treeName">Tree name</label>
            <input id="treeName" type="text" placeholder="e.g., Rossdale Poplar">
          </div>
          <div>
            <label for="species">Species</label>
            <input id="species" type="text" placeholder="e.g., Populus balsamifera">
          </div>
          <div>
            <label for="condition">Tree condition</label>
            <select id="condition">
              <option value="">— optional —</option>
              <option>Excellent</option><option>Good</option><option>Fair</option><option>Poor</option><option>Dead</option>
            </select>
          </div>
          <div>
            <label for="treeType">Tree type</label>
            <select id="treeType">
              <option value="">— select —</option>
              <option>Single trunk tree</option><option>Multi trunked tree</option><option>Grove</option><option>Forest</option><option>Clonal aspen</option>
            </select>
          </div>
        </div>
      </div>

      <div class="block">
        <h2>Measurements</h2>
        <p class="small"><strong>Input units:</strong> applies to all measurements on this page.</p>
        <div class="unit-toggle" role="group" aria-label="Input units">
          <button type="button" id="unit-m"  class="toggle-btn active" aria-pressed="true">Meters (m)</button>
          <button type="button" id="unit-ft" class="toggle-btn" aria-pressed="false">Feet (ft)</button>
        </div>

        <p class="small"><strong>Calculation mode:</strong></p>
        <div class="unit-toggle" role="group" aria-label="Calculation mode">
          <button type="button" id="mode-manual" class="toggle-btn active" aria-pressed="true">Manual (buttons)</button>
          <button type="button" id="mode-auto"   class="toggle-btn" aria-pressed="false">Auto (on change)</button>
        </div>

        <!-- Single-trunk circumference -->
        <div id="single-circ-block" style="display:none;margin-top:10px;">
          <label for="singleC">Circumference (<span class="unit-tag">m</span>)</label>
          <input id="singleC" type="number" step="0.01" inputmode="decimal" placeholder="e.g. 3.10">
          <div class="tiny">Diameter will be calculated automatically (D = C / π).</div>
        </div>

        <!-- Multi-trunk -->
        <div id="multi-block" style="display:none;margin-top:10px;">
          <div class="note" style="margin-bottom:10px;">
            <strong>Multi-trunk entry:</strong> Add each trunk’s <em>circumference</em>.
          </div>
          <div class="row" style="align-items:start;">
            <div>
              <div id="mt-list" style="display:flex;flex-direction:column;gap:10px;"></div>
              <div class="unit-toggle" style="margin-top:8px;">
                <button type="button" id="mt-add" class="btn-secondary">Add trunk</button>
                <button type="button" id="mt-remove" class="btn-secondary">Remove last</button>
                <button type="button" id="mt-sort" class="btn-ghost" title="Sort by diameter (desc)">Sort by diameter</button>
                <button type="button" id="mt-calc" class="btn-primary">Calculate multi-trunk</button>
              </div>
            </div>
            <div>
              <label for="mt-bulk">Bulk paste (numbers + repeaters)</label>
              <textarea id="mt-bulk" placeholder="Examples:
1.72, 0.98 1.10
12x0.78   (12 repeats of 0.78)
3×1.50    (× also works)"></textarea>
              <div class="tiny">Uses current unit (<span class="unit-tag">m</span>). Ignores text; keeps positive numbers only. Supports <strong>NxVALUE</strong> like <strong>12x0.78</strong> or <strong>3×1.5</strong>.</div>
              <div class="unit-toggle" style="margin-top:8px;">
                <button type="button" id="mt-fill" class="btn-ghost">Fill from bulk</button>
                <button type="button" id="mt-clear" class="btn-ghost">Clear bulk</button>
              </div>
            </div>
          </div>
          <div id="mt-result" class="tiny" style="margin-top:8px;color:#333;">—</div>
          <div class="tiny" style="margin-top:4px;">* Largest trunk counts 100%, others 50%.</div>
        </div>

        <!-- Height -->
        <div id="height-block" style="margin-top:18px;">
          <label for="h-angle">Angle to top of the tree (degrees)</label>
          <input id="h-angle" type="number" step="0.1" inputmode="decimal" placeholder="e.g. 37.5">
          <div class="row">
            <div>
              <label for="h-dist">Distance to trunk (<span class="unit-tag">m</span>)</label>
              <input id="h-dist" type="number" step="0.01" inputmode="decimal" placeholder="e.g. 23.40">
            </div>
            <div>
              <label for="h-eye">Eye height (<span class="unit-tag">m</span>)</label>
              <input id="h-eye" type="number" step="0.01" inputmode="decimal" placeholder="e.g. 1.62">
            </div>
          </div>
          <div class="unit-toggle" style="margin-top:10px;">
            <button type="button" id="h-calc" class="btn-secondary">Calculate height</button>
          </div>
        </div>
      </div>

      <div class="block">
        <h2>Notes</h2>
        <textarea id="notes" placeholder="Any observations, access notes, nearby landmarks, hazards, etc."></textarea>
        <div class="tiny" style="margin-top:6px;">Notes are included in the description (and share link) if filled.</div>
      </div>
    </section>

    <!-- CARD 2: RESULTS + QUICK COPY -->
    <section class="card" id="card-results">
      <div class="block">
        <h2>Results</h2>
        <div class="results">
          <h3>Calculated values</h3>
          <p id="res-height">Height: —</p>
          <p id="res-eqcirc">Equivalent / Entered circumference: —</p>
          <p id="res-avgcirc" style="display:none;">Average circumference (multi): —</p>
          <p id="res-spread">Final canopy spread: —</p>
        </div>
      </div>

      <div class="block">
        <h2 style="margin-bottom:4px;">Quick copy</h2>
        <div class="tiny" style="margin:0 0 8px;">ARA form pure numbers in meters</div>
        <div class="unit-toggle">
          <button type="button" id="copyHeight"  class="btn-secondary" disabled title="Copy height (m)">Copy Height (m)</button>
          <button type="button" id="copyEqCirc"  class="btn-secondary" disabled title="Copy equivalent/entered circumference (m)">Copy Eq. Circ (m)</button>
          <button type="button" id="copyAvgCirc" class="btn-secondary" disabled title="Copy average circumference (m)">Copy Avg Circ (m)</button>
          <button type="button" id="copySpread"  class="btn-secondary" disabled title="Copy final canopy spread (m)">Copy Canopy (m)</button>
        </div>
      </div>
    </section>

    <!-- CARD 3: DESCRIPTION -->
    <section class="card" id="card-desc">
      <div class="block">
        <h2>Description</h2>
        <div class="unit-toggle">
          <button type="button" id="genDesc"  class="btn-secondary">Generate description</button>
          <button type="button" id="saveLog" class="btn-ghost">Save to log</button>
          <button type="button" id="copyDesc" class="btn-ghost" disabled>Copy description</button>
          <button type="button" id="shareLink" class="btn-ghost" disabled>Copy share link</button>
          <a id="emailBtn" class="button btn-ghost" href="#" aria-disabled="true">Open email (optional)</a>
          <button type="button" id="resetForm" class="btn-ghost danger" title="Reset the form (does not touch the log)">Reset form</button>
        </div>
        <div class="descbox" id="desc" aria-live="polite">—</div>
        <div class="tiny" style="margin-top:8px;">Timestamp uses local 24-hour time.</div>
      </div>
    </section>
  </main>
</div>

<!-- MODALS -->
<div class="modal" id="confirmClear">
  <div class="sheet">
    <h3>Clear log?</h3>
    <p>This will remove all saved trees from this device. Please double-check they’re nominated to ARA.</p>
    <div class="btn-row">
      <button class="btn-ghost" id="clCancel">Cancel</button>
      <button class="danger" id="clConfirm">Delete</button>
    </div>
  </div>
</div>

<div class="modal" id="confirmSwitch">
  <div class="sheet">
    <h3>Replace current form?</h3>
    <p>You have unsaved changes.</p>
    <div class="btn-row">
      <button class="btn-ghost" id="swCancel">Cancel</button>
      <button class="btn-secondary" id="swSave">Save current to log</button>
      <button class="btn-primary" id="swReplace">Replace</button>
    </div>
  </div>
</div>

<script>
/* ---------- Utilities ---------- */
const PI=Math.PI, FT_PER_M=3.28084, M_PER_FT=0.3048;
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const tanDeg=d=>Math.tan(d*Math.PI/180);
const fmt2=x=>Number.isFinite(x)?x.toFixed(2):'—', fmt1=x=>Number.isFinite(x)?x.toFixed(1):'—';
const toM=(v,u)=>u==='m'?v:v*M_PER_FT, mToFt=m=>m*FT_PER_M;
const nowLocal24=()=>{const d=new Date();const pad=n=>String(n).padStart(2,'0');return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`};
const uid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
const escapeHtml=s=>s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

/* ---------- DOM refs (form) ---------- */
const unitM=$('#unit-m'), unitFt=$('#unit-ft'), unitTags=$$('.unit-tag');
const modeManualBtn=$('#mode-manual'), modeAutoBtn=$('#mode-auto');
const treeName=$('#treeName'), species=$('#species'), condition=$('#condition'), treeType=$('#treeType');
const singleBlock=$('#single-circ-block'), singleC=$('#singleC');
const mtBlock=$('#multi-block'), mtList=$('#mt-list'), mtAdd=$('#mt-add'), mtRemove=$('#mt-remove'), mtSort=$('#mt-sort'), mtCalc=$('#mt-calc'), mtBulk=$('#mt-bulk'), mtFill=$('#mt-fill'), mtClear=$('#mt-clear'), mtResult=$('#mt-result');
const hAngle=$('#h-angle'), hDist=$('#h-dist'), hEye=$('#h-eye'), hCalc=$('#h-calc');
const notesEl=$('#notes');
const spreadMajor=$('#spreadMajor'), spreadMinor=$('#spreadMinor'), spreadCalc=$('#spread-calc');
const copyHeight=$('#copyHeight'), copyEqCirc=$('#copyEqCirc'), copyAvgCirc=$('#copyAvgCirc'), copySpread=$('#copySpread');
const resHeight=$('#res-height'), resEqCirc=$('#res-eqcirc'), resAvgCirc=$('#res-avgcirc'), resSpread=$('#res-spread');
const genDesc=$('#genDesc'), copyDesc=$('#copyDesc'), shareBtn=$('#shareLink'), descBox=$('#desc'), emailBtn=$('#emailBtn'), resetFormBtn=$('#resetForm'), saveLogBtn=$('#saveLog');

/* ---------- DOM refs (log) ---------- */
const logList=$('#logList'), viewDate=$('#viewDate'), viewGroup=$('#viewGroup'), groupsHead=$('#groupsHead'), addGroupBtn=$('#addGroupBtn'), copyAllBtn=$('#copyAllBtn'), clearLogBtn=$('#clearLogBtn');
const modalClear=$('#confirmClear'), clCancel=$('#clCancel'), clConfirm=$('#clConfirm');
const modalSwitch=$('#confirmSwitch'), swCancel=$('#swCancel'), swSave=$('#swSave'), swReplace=$('#swReplace');

/* ---------- State ---------- */
let inputUnit='m', calcMode='manual', mtCount=0;
let lastHeight=null, lastSingle=null, lastMulti=null, lastSpread=null;
let descDirty=true, formDirty=false, openTargetEntryId=null;
const SAVE_KEY='ara_field_v1', LOG_KEY='ara_field_log_v1', GROUPS_KEY='ara_field_groups_v1';
const DEFAULT_GROUPS=['Favourite Trees','Big Trees','Unique Trees'];

/* ---------- Unit toggle & calc mode ---------- */
function setUnit(u){
  if(u===inputUnit) return;
  const conv=(inp)=>{const v=parseFloat(inp.value); if(!Number.isNaN(v)){ const m=toM(v,inputUnit); inp.value=(u==='m'?m:m*FT_PER_M).toFixed(2); }};
  [singleC,hDist,hEye,spreadMajor,spreadMinor].forEach(conv);
  $$('#mt-list input[type="number"]').forEach(conv);
  inputUnit=u; const isM=u==='m';
  unitM.classList.toggle('active',isM); unitFt.classList.toggle('active',!isM);
  unitM.setAttribute('aria-pressed',String(isM)); unitFt.setAttribute('aria-pressed',String(!isM));
  unitTags.forEach(t=>t.textContent=isM?'m':'ft');
  markDescDirty(); formDirty=true; saveState();
  if(calcMode==='auto'){ if(treeType.value==='Single trunk tree') recomputeSingle(); if(treeType.value==='Multi trunked tree') calcMulti(); calcHeight(); calcSpread(); }
}
unitM.onclick=()=>setUnit('m'); unitFt.onclick=()=>setUnit('ft');

function setCalcMode(m){ calcMode=m; const man=m==='manual'; modeManualBtn.classList.toggle('active',man); modeAutoBtn.classList.toggle('active',!man); modeManualBtn.setAttribute('aria-pressed',String(man)); modeAutoBtn.setAttribute('aria-pressed',String(!man)); saveState();}
modeManualBtn.onclick=()=>setCalcMode('manual'); modeAutoBtn.onclick=()=>setCalcMode('auto');

/* ---------- Type gating ---------- */
function ensureTwoMtRows(){ if(mtCount===0){ addMtRow(); addMtRow(); } }
function updateTypeVisibility(){
  const t=treeType.value;
  singleBlock.style.display=(t==='Single trunk tree')?'':'none';
  mtBlock.style.display=(t==='Multi trunked tree')?'':'none';
  if (t==='Multi trunked tree') ensureTwoMtRows();
  markDescDirty(); updateResultsPanel(); updateCopyButtons(); formDirty=true; saveState();
}
treeType.onchange=updateTypeVisibility;

/* ---------- Auto-expanding Notes ---------- */
function autoGrow(el){ el.style.height='auto'; el.style.height=(el.scrollHeight+2)+'px'; }
notesEl.addEventListener('input',()=>{ autoGrow(notesEl); markDescDirty(); formDirty=true; saveState(); });

/* ---------- Single trunk ---------- */
function recomputeSingle(){
  const v=parseFloat(singleC.value);
  if(Number.isFinite(v)&&v>0){ const cM=toM(v,inputUnit); const dM=cM/PI; lastSingle={cM,cFt:mToFt(cM),dM,dFt:mToFt(dM)}; }
  else lastSingle=null;
  markDescDirty(); updateResultsPanel(); updateCopyButtons(); formDirty=true; saveState();
}
singleC.oninput=()=>{recomputeSingle(); if(calcMode==='auto') updateResultsPanel();};

/* ---------- Multi-trunk ---------- */
const MT_MAX=60;
function addMtRow(val=''){ if(mtCount>=MT_MAX) return; mtCount++; const row=document.createElement('div'); row.className='row'; row.style.gridTemplateColumns='1fr'; row.dataset.index=String(mtCount);
  const labelWrap=document.createElement('div'); labelWrap.style.display='flex'; labelWrap.style.alignItems='center';
  const lab=document.createElement('label'); lab.htmlFor=`mt-${mtCount}`; lab.className='mt-label'; lab.textContent=`Trunk ${mtCount} circumference (${inputUnit})`;
  const badge=document.createElement('span'); badge.className='badge hide'; badge.textContent='Largest';
  labelWrap.appendChild(lab); labelWrap.appendChild(badge);
  const inp=document.createElement('input'); inp.id=`mt-${mtCount}`; inp.type='number'; inp.step='0.01'; inp.inputMode='decimal'; if(val!=='') inp.value=val;
  const hint=document.createElement('div'); hint.className='hint';
  row.appendChild(labelWrap); row.appendChild(inp); row.appendChild(hint); mtList.appendChild(row);
  inp.addEventListener('input',()=>{inp.classList.remove('error'); hint.classList.remove('show'); markDescDirty(); formDirty=true; saveState(); if(calcMode==='auto') calcMulti();});
  inp.addEventListener('blur',()=>maybeMtOutlierHint(parseFloat(inp.value),hint));
}
function maybeMtOutlierHint(val,h){ if(!Number.isFinite(val)||val<=0){h.classList.remove('show');return}
  if(inputUnit==='m'){ if(val<0.20){h.textContent='Unusually small — check units/decimal?';h.classList.add('show');}
    else if(val>12){h.textContent='Unusually large — check units?';h.classList.add('show');} else h.classList.remove('show');}
  else{ if(val<0.66){h.textContent='Unusually small — check units/decimal?';h.classList.add('show');}
    else if(val>40){h.textContent='Unusually large — check units?';h.classList.add('show');} else h.classList.remove('show');} }
function removeMtRow(){ if(mtCount<=1) return; mtList.lastElementChild?.remove(); mtCount--; renumberMtLabels(); markDescDirty(); formDirty=true; saveState(); if(calcMode==='auto') calcMulti(); }
function renumberMtLabels(){ $$('#mt-list .mt-label').forEach((lab,i)=>lab.textContent=`Trunk ${i+1} circumference (${inputUnit})`); }
function parseMtBulk(text,limit=MT_MAX){ const vals=[]; if(!text) return vals; let s=String(text).replace(/[×X]/g,'x'); const repRE=/(\d+)\s*x\s*([-+]?\d*\.?\d+)/g; s=s.replace(repRE,(_,nStr,vStr)=>{const n=parseInt(nStr,10), v=parseFloat(vStr); if(Number.isFinite(n)&&n>0&&Number.isFinite(v)&&v>0){for(let i=0;i<n&&vals.length<limit;i++) vals.push(v);} return ' ';}); const singles=s.match(/[-+]?\d*\.?\d+/g)||[]; for(const m of singles){ if(vals.length>=limit) break; const v=parseFloat(m); if(Number.isFinite(v)&&v>0) vals.push(v);} return vals; }
function mtFillFromBulk(){ const vals=parseMtBulk(mtBulk.value,MT_MAX); if(vals.length===0)return; mtList.innerHTML=''; mtCount=0; vals.forEach(v=>addMtRow(v.toFixed(2))); mtResult.textContent='—'; markDescDirty(); formDirty=true; saveState(); if(calcMode==='auto') calcMulti(); }
function mtSortByDiameter(){ const rows=Array.from(mtList.children); const valid=[], invalid=[]; rows.forEach(row=>{ const inp=row.querySelector('input'); const v=parseFloat(inp.value); if(Number.isFinite(v)&&v>0){const cM=toM(v,inputUnit), dM=cM/PI; valid.push({row,dM});} else invalid.push(row);}); if(valid.length<2) return; valid.sort((a,b)=>b.dM-a.dM); const frag=document.createDocumentFragment(); valid.forEach(v=>frag.appendChild(v.row)); invalid.forEach(r=>frag.appendChild(r)); mtList.innerHTML=''; mtList.appendChild(frag); renumberMtLabels(); clearMtLargest(); markDescDirty(); formDirty=true; saveState(); if(calcMode==='auto') calcMulti(); }
function clearMtLargest(){ mtList.querySelectorAll('.largest-label').forEach(el=>el.classList.remove('largest-label')); mtList.querySelectorAll('.badge').forEach(b=>{b.classList.add('hide'); b.textContent='Largest';}); }
function calcMulti(){ clearMtLargest(); const items=Array.from(mtList.querySelectorAll('input')); const valid=items.map(inp=>({inp,val:parseFloat(inp.value),row:inp.closest('.row')})).filter(o=>Number.isFinite(o.val)&&o.val>0); if(valid.length===0){lastMulti=null; mtResult.textContent='Enter at least one trunk circumference.'; updateResultsPanel(); updateCopyButtons(); formDirty=true; saveState(); return;}
  const withD=valid.map((r,i)=>{const cM=toM(r.val,inputUnit); const dM=cM/PI; return {row:r.row,cM,dM,idx:i+1};});
  const eps=1e-9; const dmax=Math.max(...withD.map(x=>x.dM)); const maxRows=withD.filter(x=>Math.abs(x.dM-dmax)<eps); const sumAll=withD.reduce((a,x)=>a+x.dM,0);
  const dEqM=dmax+0.5*(sumAll-dmax); const cEqM=dEqM*PI; const cAvgM=withD.reduce((a,x)=>a+x.cM,0)/withD.length;
  const badgeText=(maxRows.length>1)?'Tied for largest':'Largest'; maxRows.forEach(r=>{const lab=r.row.querySelector('.mt-label'); const badge=r.row.querySelector('.badge'); lab?.classList.add('largest-label'); if(badge){badge.textContent=badgeText; badge.classList.remove('hide');}});
  lastMulti={ trunks:withD.map(t=>({index:t.idx,cM:t.cM,cFt:mToFt(t.cM),dM:t.dM,dFt:mToFt(t.dM),isLargest:Math.abs(t.dM-dmax)<eps})), dEqM,cEqM,dEqFt:mToFt(dEqM),cEqFt:mToFt(cEqM), cAvgM,cAvgFt:mToFt(cAvgM), tie:maxRows.length>1 };
  mtResult.textContent=`Calculated ${withD.length} trunk${withD.length>1?'s':''}.`;
  markDescDirty(); updateResultsPanel(); updateCopyButtons(); formDirty=true; saveState();
}
mtAdd.onclick=()=>{addMtRow(); markDescDirty(); formDirty=true; saveState();};
mtRemove.onclick=()=>{if(mtCount>1) removeMtRow();};
mtSort.onclick=mtSortByDiameter;
mtCalc.onclick=calcMulti;
mtFill.onclick=mtFillFromBulk;
mtClear.onclick=()=>{mtBulk.value='';};

/* ---------- Height ---------- */
function calcHeight(){ const a=parseFloat(hAngle.value), d=parseFloat(hDist.value), e=parseFloat(hEye.value);
  if(!Number.isFinite(a)||!Number.isFinite(d)||!Number.isFinite(e)){ lastHeight=null; updateResultsPanel(); updateCopyButtons(); formDirty=true; saveState(); return;}
  const dM=toM(d,inputUnit), eM=toM(e,inputUnit); const hM=tanDeg(a)*dM+eM; lastHeight={hM,hFt:mToFt(hM),angleDeg:Number(a.toFixed(1)),dM,eM};
  markDescDirty(); updateResultsPanel(); updateCopyButtons(); formDirty=true; saveState();
}
hCalc.onclick=calcHeight;
[hAngle,hDist,hEye].forEach(inp=>inp.addEventListener('input',()=>{markDescDirty(); formDirty=true; saveState(); if(calcMode==='auto') calcHeight();}));
[hAngle,hDist,hEye].forEach(i=>i.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();calcHeight();}}));

/* ---------- Spread ---------- */
function calcSpread(){ const maj=parseFloat(spreadMajor.value), min=parseFloat(spreadMinor.value); const haveMaj=Number.isFinite(maj), haveMin=Number.isFinite(min);
  if(!haveMaj&&!haveMin){ lastSpread=null; } else { const mMaj=haveMaj?toM(maj,inputUnit):null, mMin=haveMin?toM(min,inputUnit):null; const meanM=((mMaj??0)+(mMin??0))/((haveMaj?1:0)+(haveMin?1:0)); lastSpread={majorM:mMaj,minorM:mMin,meanM,meanFt:mToFt(meanM)};}
  markDescDirty(); updateResultsPanel(); updateCopyButtons(); formDirty=true; saveState();
}
spreadCalc.onclick=calcSpread;
[spreadMajor,spreadMinor].forEach(inp=>inp.addEventListener('input',()=>{markDescDirty(); formDirty=true; saveState(); if(calcMode==='auto') calcSpread();}));

/* ---------- Results & copy buttons ---------- */
function updateResultsPanel(){
  resHeight.textContent = lastHeight ? `Height: ${fmt2(lastHeight.hM)} m (${fmt2(lastHeight.hFt)} ft)` : 'Height: —';
  const t=treeType.value;
  if(t==='Multi trunked tree' && lastMulti){
    resEqCirc.textContent=`Equivalent circumference: ${fmt2(lastMulti.cEqM)} m (${fmt2(lastMulti.cEqFt)} ft)`;
    resAvgCirc.style.display=''; resAvgCirc.textContent=`Average circumference (multi): ${fmt2(lastMulti.cAvgM)} m (${fmt2(lastMulti.cAvgFt)} ft)`;
  } else if(t==='Single trunk tree' && lastSingle){
    resEqCirc.textContent=`Entered circumference: ${fmt2(lastSingle.cM)} m (${fmt2(lastSingle.cFt)} ft)`;
    resAvgCirc.style.display='none'; resAvgCirc.textContent='Average circumference (multi): —';
  } else {
    resEqCirc.textContent='Equivalent / Entered circumference: —';
    resAvgCirc.style.display=(t==='Multi trunked tree')?'':'none';
    resAvgCirc.textContent='Average circumference (multi): —';
  }
  resSpread.textContent = lastSpread ? `Final canopy spread: ${fmt2(lastSpread.meanM)} m (${fmt2(lastSpread.meanFt)} ft)` : 'Final canopy spread: —';
}
function updateCopyButtons(){
  copyHeight.disabled=!(lastHeight&&Number.isFinite(lastHeight.hM));
  if(treeType.value==='Multi trunked tree'){ copyEqCirc.disabled=!(lastMulti&&Number.isFinite(lastMulti.cEqM)); copyAvgCirc.disabled=!(lastMulti&&Number.isFinite(lastMulti.cAvgM)); }
  else if(treeType.value==='Single trunk tree'){ copyEqCirc.disabled=!(lastSingle&&Number.isFinite(lastSingle.cM)); copyAvgCirc.disabled=true; }
  else { copyEqCirc.disabled=true; copyAvgCirc.disabled=true; }
  copySpread.disabled=!(lastSpread&&Number.isFinite(lastSpread.meanM));
}
async function copyText(txt,btn){ try{ await navigator.clipboard.writeText(txt); const o=btn.textContent; btn.textContent='Copied ✓'; setTimeout(()=>btn.textContent=o,1200);}catch{ const t=document.createElement('input'); t.value=txt; document.body.appendChild(t); t.select(); document.execCommand('copy'); t.remove(); const o=btn.textContent; btn.textContent='Copied ✓'; setTimeout(()=>btn.textContent=o,1200);} }
copyHeight.onclick=()=>{ if(lastHeight) copyText(fmt2(lastHeight.hM),copyHeight); };
copyEqCirc.onclick=()=>{ const t=treeType.value; if(t==='Multi trunked tree'&&lastMulti) copyText(fmt2(lastMulti.cEqM),copyEqCirc); if(t==='Single trunk tree'&&lastSingle) copyText(fmt2(lastSingle.cM),copyEqCirc); };
copyAvgCirc.onclick=()=>{ if(lastMulti) copyText(fmt2(lastMulti.cAvgM),copyAvgCirc); };
copySpread.onclick=()=>{ if(lastSpread) copyText(fmt2(lastSpread.meanM),copySpread); };

/* ---------- Description ---------- */
function markDescDirty(){ descDirty=true; copyDesc.disabled=true; shareBtn.disabled=true; emailBtn.setAttribute('aria-disabled','true'); emailBtn.href='#'; }
function ensureCalcsOnDemand(){
  if(treeType.value==='Multi trunked tree'){ const any=$$('#mt-list input').some(i=>Number.isFinite(parseFloat(i.value))); if(any&&!lastMulti) calcMulti(); }
  const a=parseFloat(hAngle.value), d=parseFloat(hDist.value), e=parseFloat(hEye.value); if(Number.isFinite(a)&&Number.isFinite(d)&&Number.isFinite(e)&&!lastHeight) calcHeight();
  if(!lastSpread && (Number.isFinite(parseFloat(spreadMajor.value))||Number.isFinite(parseFloat(spreadMinor.value)))) calcSpread();
  if(treeType.value==='Single trunk tree' && !lastSingle && Number.isFinite(parseFloat(singleC.value))) recomputeSingle();
}
function buildDescription(){
  const parts=[]; const name=treeName.value?.trim(), sp=species.value?.trim(), cond=condition.value?.trim(), type=treeType.value?.trim();
  const head=document.createElement('div'); if(name) head.innerHTML+=`<p><strong>Tree</strong>: ${escapeHtml(name)}</p>`; if(sp) head.innerHTML+=`<p><strong>Species</strong>: ${escapeHtml(sp)}</p>`; if(cond) head.innerHTML+=`<p><strong>Condition</strong>: ${escapeHtml(cond)}</p>`; if(type) head.innerHTML+=`<p><strong>Type</strong>: ${escapeHtml(type)}</p>`; if(head.innerHTML) parts.push(head);
  const meas=document.createElement('div'); let has=false;

  if(type==='Single trunk tree' && lastSingle){ has=true; const p1=document.createElement('p'); p1.innerHTML='<strong>Measurements</strong>'; const ul=document.createElement('ul'); const li=document.createElement('li'); li.textContent=`Circumference: ${fmt2(lastSingle.cM)} m (${fmt2(lastSingle.cFt)} ft) → Diameter: ${fmt2(lastSingle.dM)} m (${fmt2(lastSingle.dFt)} ft)`; ul.appendChild(li); meas.appendChild(p1); meas.appendChild(ul); }

  if(type==='Multi trunked tree'){ const trunks=lastMulti?.trunks??[]; if(trunks.length>0){ has=true;
      const p1=document.createElement('p'); p1.innerHTML='<strong>Individual trunks (circumference → diameter)</strong>'; const ul1=document.createElement('ul');
      trunks.forEach(t=>{ const li=document.createElement('li'); const txt=`T${t.index}: ${fmt2(t.cM)} m (${fmt2(t.cFt)} ft) → ${fmt2(t.dM)} m (${fmt2(t.dFt)} ft)`; if(t.isLargest){ li.innerHTML=`<strong>${txt}</strong>`;} else { li.textContent=txt;} ul1.appendChild(li);});
      const p2=document.createElement('p'); p2.innerHTML='<strong>Full Tree Circumference (circumference → diameter)</strong>'; const ul2=document.createElement('ul');
      const liC=document.createElement('li'); liC.textContent=`Equivalent circumference: ${fmt2(lastMulti.cEqM)} m (${fmt2(lastMulti.cEqFt)} ft) → ${fmt2(lastMulti.dEqM)} m (${fmt2(lastMulti.dEqFt)} ft)`;
      const liA=document.createElement('li'); const dAvgM=lastMulti.cAvgM/PI, dAvgFt=mToFt(dAvgM); liA.textContent=`Average circumference: ${fmt2(lastMulti.cAvgM)} m (${fmt2(lastMulti.cAvgFt)} ft) → ${fmt2(dAvgM)} m (${fmt2(dAvgFt)} ft)`;
      ul2.appendChild(liC); ul2.appendChild(liA);
      meas.appendChild(p1); meas.appendChild(ul1); meas.appendChild(p2); meas.appendChild(ul2);
  }}

  if(lastHeight){ has=true; const p=document.createElement('p'); p.innerHTML='<strong>Height</strong>'; const ul=document.createElement('ul');
    const liH=document.createElement('li'); liH.textContent=`Tree height: ${fmt2(lastHeight.hM)} m (${fmt2(lastHeight.hFt)} ft)`;
    const liF=document.createElement('li'); liF.textContent=`height = tan(${fmt1(lastHeight.angleDeg)}°) × ${fmt2(lastHeight.dM)} m + ${fmt2(lastHeight.eM)} m = ${fmt2(lastHeight.hM)} m (${fmt2(lastHeight.hFt)} ft)`;
    ul.appendChild(liH); ul.appendChild(liF); meas.appendChild(p); meas.appendChild(ul);
  }

  if(lastSpread){ has=true; const p=document.createElement('p'); p.innerHTML='<strong>Canopy spread</strong>'; const ul=document.createElement('ul');
    if(Number.isFinite(lastSpread.majorM)){ const li=document.createElement('li'); li.textContent=`Major: ${fmt2(lastSpread.majorM)} m (${fmt2(mToFt(lastSpread.majorM))} ft)`; ul.appendChild(li); }
    if(Number.isFinite(lastSpread.minorM)){ const li=document.createElement('li'); li.textContent=`Minor: ${fmt2(lastSpread.minorM)} m (${fmt2(mToFt(lastSpread.minorM))} ft)`; ul.appendChild(li); }
    const liMean=document.createElement('li'); liMean.innerHTML=`<strong>Final canopy spread: ${fmt2(lastSpread.meanM)} m (${fmt2(lastSpread.meanFt)} ft)</strong>`; ul.appendChild(liMean);
    meas.appendChild(p); meas.appendChild(ul);
  }

  if(has) parts.push(meas);

  const nTxt=notesEl.value.trim();
  if(nTxt){ const n=document.createElement('div'); n.innerHTML='<p><strong>Notes</strong></p>'; const ul=document.createElement('ul'); nTxt.split(/\n+/).forEach(line=>{ const li=document.createElement('li'); li.textContent=line; ul.appendChild(li); }); n.appendChild(ul); parts.push(n); }

  const obs=document.createElement('div'); const when=nowLocal24(); obs.innerHTML=`<p><strong>Observation</strong></p><ul><li>Recorded: ${when}</li></ul>`; parts.push(obs);
  const out=document.createElement('div'); parts.forEach(p=>out.appendChild(p)); return out.innerHTML;
}
function extractPlainText(container){ const items=Array.from(container.querySelectorAll('li')).map(li=>`- ${li.innerText}`); const paras=Array.from(container.querySelectorAll('p')).map(p=>p.innerText); return [...paras,...items].join('\n').trim();}

function generateDescription(){
  ensureCalcsOnDemand();
  const html=buildDescription(); descBox.innerHTML=html||'—'; copyDesc.disabled=!html; shareBtn.disabled=!html;
  if(html){ const plain=extractPlainText(descBox); const nm=treeName.value?.trim(); const subject=`ARA Field Nomination${nm?' – '+nm:''}`; emailBtn.href=`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(plain)}`; emailBtn.removeAttribute('aria-disabled'); }
  else { emailBtn.setAttribute('aria-disabled','true'); emailBtn.href='#'; }
  descDirty=false; formDirty=false;
}
genDesc.onclick=generateDescription;

/* ---------- Share link (hash Base64) ---------- */
function getFormState(){
  return {
    inputUnit, calcMode,
    basics:{name:treeName.value||'',species:species.value||'',condition:condition.value||'',type:treeType.value||''},
    singleC: singleC.value||'',
    height:{angle:hAngle.value||'',dist:hDist.value||'',eye:hEye.value||''},
    spread:{major:spreadMajor.value||'', minor:spreadMinor.value||''},
    notes: notesEl.value||'',
    multi: { values: $$('#mt-list input').map(i=>i.value||'') },
    desc: descBox.innerHTML && descBox.innerHTML!=='—' ? descBox.innerHTML : ''
  };
}
function setFormState(st){
  if(!st) return;
  setUnit(st.inputUnit==='ft'?'ft':'m'); setCalcMode(st.calcMode==='auto'?'auto':'manual');
  treeName.value=st.basics?.name??''; species.value=st.basics?.species??''; condition.value=st.basics?.condition??''; treeType.value=st.basics?.type??''; updateTypeVisibility();
  singleC.value=st.singleC??''; hAngle.value=st.height?.angle??''; hDist.value=st.height?.dist??''; hEye.value=st.height?.eye??''; spreadMajor.value=st.spread?.major??''; spreadMinor.value=st.spread?.minor??'';
  notesEl.value=st.notes??''; autoGrow(notesEl);
  mtList.innerHTML=''; mtCount=0; const arr=Array.isArray(st.multi?.values)?st.multi.values:[]; if(arr.length>0) arr.forEach(v=>addMtRow(v)); else {addMtRow(); addMtRow();}
  markDescDirty(); updateResultsPanel(); updateCopyButtons(); formDirty=false;
  if(st.desc){ descBox.innerHTML=st.desc; copyDesc.disabled=false; shareBtn.disabled=false; }
}
function encodeShare(state){ const json=JSON.stringify(state); const b64=btoa(unescape(encodeURIComponent(json))); return location.origin+location.pathname+'#data='+b64; }
function decodeShare(hash){ try{ const b64=hash.replace(/^#?data=/,''); const json=decodeURIComponent(escape(atob(b64))); return JSON.parse(json);}catch{ return null; } }
shareBtn.onclick=async ()=>{ const url=encodeShare(getFormState()); if(url.length>2000) alert('Heads up: this link is quite long. It will still work, but some apps may truncate it.'); await copyText(url, shareBtn); };

/* ---------- Autosave ---------- */
function saveState(){ try{ localStorage.setItem(SAVE_KEY, JSON.stringify(getFormState())); }catch{} }
function loadState(){ let st=null; try{ st=JSON.parse(localStorage.getItem(SAVE_KEY)||'null'); }catch{}; if(st) setFormState(st); else { addMtRow(); addMtRow(); } }
[treeName,species,condition,treeType,singleC,hAngle,hDist,hEye,spreadMajor,spreadMinor,notesEl].forEach(el=>el.addEventListener('input',saveState));

/* ---------- Reset form (not log) ---------- */
resetFormBtn.onclick=()=>{ localStorage.setItem(SAVE_KEY, JSON.stringify({inputUnit,calcMode})); location.reload(); };

/* ---------- Session Log storage ---------- */
function getLog(){ try{ return JSON.parse(localStorage.getItem(LOG_KEY)||'[]'); }catch{ return []; } }
function setLog(arr){ try{ localStorage.setItem(LOG_KEY, JSON.stringify(arr)); }catch{} }
function getGroups(){ try{ const g=JSON.parse(localStorage.getItem(GROUPS_KEY)||'null'); if(Array.isArray(g)&&g.length) return g; return DEFAULT_GROUPS.slice(); }catch{ return DEFAULT_GROUPS.slice(); } }
function setGroups(g){ try{ localStorage.setItem(GROUPS_KEY, JSON.stringify(g)); }catch{} }

/* ---------- Render log ---------- */
let viewMode='date'; // 'date' | 'group'
viewDate.onclick=()=>{viewMode='date'; viewDate.classList.add('active'); viewGroup.classList.remove('active'); groupsHead.style.display='none'; renderLog();};
viewGroup.onclick=()=>{viewMode='group'; viewGroup.classList.add('active'); viewDate.classList.remove('active'); groupsHead.style.display='flex'; renderLog();};
addGroupBtn.onclick=()=>{ const name=prompt('New group name'); if(!name) return; const groups=getGroups(); if(!groups.includes(name)) {groups.push(name); setGroups(groups); renderLog();} };

function renderLog(){
  const entries=getLog(); const groups=getGroups();
  const host=logList; host.innerHTML='';
  if(entries.length===0){ host.innerHTML='<span class="tiny">No saved trees yet.</span>'; return; }

  if(viewMode==='date'){
    const buckets={}; entries.forEach(e=>{ const d=new Date(e.ts); const key=d.toISOString().slice(0,10); (buckets[key]=buckets[key]||[]).push(e); });
    Object.keys(buckets).sort((a,b)=>b.localeCompare(a)).forEach(date=>{
      const sec=document.createElement('div'); sec.className='bucket';
      const h=document.createElement('div'); h.className='bucket-title'; h.textContent=date; sec.appendChild(h);
      const body=document.createElement('div'); body.className='bucket-body';
      buckets[date].sort((a,b)=>b.ts-a.ts).forEach(e=>body.appendChild(renderEntry(e)));
      sec.appendChild(body); host.appendChild(sec);
    });
  } else {
    const byGroup={ 'No group':[] }; groups.forEach(g=>byGroup[g]=[]);
    entries.forEach(e=>{ const g=e.group && groups.includes(e.group) ? e.group : 'No group'; byGroup[g].push(e); });
    Object.keys(byGroup).forEach(g=>{
      const sec=document.createElement('div'); sec.className='bucket';
      const h=document.createElement('div'); h.className='bucket-title'; h.textContent=g; sec.appendChild(h);

      const body=document.createElement('div'); body.className='bucket-body'; body.dataset.group=g;
      body.ondragover=(ev)=>{ev.preventDefault(); body.classList.add('drop-target');};
      body.ondragleave=()=>body.classList.remove('drop-target');
      body.ondrop=(ev)=>{ ev.preventDefault(); body.classList.remove('drop-target'); const id=ev.dataTransfer.getData('text/plain'); moveEntryToGroup(id, g); };

      if(byGroup[g].length===0){
        const empty=document.createElement('div'); empty.className='tiny'; empty.innerHTML='<em>No trees in this group.</em>';
        body.appendChild(empty);
      } else {
        byGroup[g].sort((a,b)=>b.ts-a.ts).forEach(e=>body.appendChild(renderEntry(e,true)));
      }
      sec.appendChild(body); host.appendChild(sec);
    });
  }
}
function renderEntry(e,draggable=false){
  const card=document.createElement('div'); card.className='entry'; if(draggable){ card.draggable=true; card.ondragstart=(ev)=>ev.dataTransfer.setData('text/plain', e.id); }
  const name=document.createElement('div'); name.className='name'; name.textContent=e.basics?.name || 'Untitled';
  const ts=document.createElement('div'); ts.className='ts'; ts.textContent=new Date(e.ts).toISOString().slice(0,16).replace('T',' ');
  card.appendChild(name); card.appendChild(ts);
  card.onclick=()=>handleEntryClick(e.id);
  const row=document.createElement('div'); row.className='unit-toggle'; row.style.marginTop='6px';
  const btnCopy=document.createElement('button'); btnCopy.className='btn-ghost tiny'; btnCopy.textContent='Copy'; btnCopy.onclick=(ev)=>{ ev.stopPropagation(); const tmp=document.createElement('div'); tmp.innerHTML=e.desc||'(no description)'; const text=tmp.innerText; navigator.clipboard.writeText(text); };
  const btnShare=document.createElement('button'); btnShare.className='btn-ghost tiny'; btnShare.textContent='Share'; btnShare.onclick=(ev)=>{ ev.stopPropagation(); const url=encodeShare(e); navigator.clipboard.writeText(url); };
  const btnDel=document.createElement('button'); btnDel.className='danger tiny'; btnDel.textContent='Delete'; btnDel.onclick=(ev)=>{ ev.stopPropagation(); deleteEntry(e.id); };
  row.appendChild(btnCopy); row.appendChild(btnShare); row.appendChild(btnDel); card.appendChild(row);
  return card;
}
function moveEntryToGroup(id,g){ const entries=getLog(); const i=entries.findIndex(x=>x.id===id); if(i>=0){ entries[i].group=(g==='No group')?'':g; setLog(entries); renderLog(); } }
function deleteEntry(id){ const arr=getLog().filter(e=>e.id!==id); setLog(arr); renderLog(); }

/* ---------- Entry click with confirm ---------- */
function handleEntryClick(id){
  const entries=getLog(); const entry=entries.find(e=>e.id===id); if(!entry) return;
  openTargetEntryId=id;
  if(formDirty){ modalSwitch.classList.add('show'); return; }
  loadEntry(entry);
}
swCancel.onclick=()=>{ openTargetEntryId=null; modalSwitch.classList.remove('show'); };
swReplace.onclick=()=>{ const e=getLog().find(x=>x.id===openTargetEntryId); if(e){ loadEntry(e); } openTargetEntryId=null; modalSwitch.classList.remove('show'); };
swSave.onclick=()=>{ saveCurrentToLog(); const e=getLog().find(x=>x.id===openTargetEntryId); if(e){ loadEntry(e); } openTargetEntryId=null; modalSwitch.classList.remove('show'); };
function loadEntry(e){ setFormState(e); descBox.innerHTML=e.desc||'—'; copyDesc.disabled=!e.desc; shareBtn.disabled=false; formDirty=false; }

/* ---------- Save to log & copy all ---------- */
function saveCurrentToLog(){
  const st=getFormState(); st.id = st.id || uid(); st.ts = Date.now();
  const arr=getLog(); const idx=arr.findIndex(x=>x.id===st.id);
  if(idx>=0) arr[idx]=st; else arr.push(st);
  setLog(arr); renderLog(); formDirty=false;
}
saveLogBtn.onclick=saveCurrentToLog;

copyAllBtn.onclick=async ()=>{
  const entries=getLog().sort((a,b)=>a.ts-b.ts);
  if(!entries.length){ alert('No entries to copy.'); return; }
  const blocks=entries.map(e=>{
    const d=new Date(e.ts).toISOString().slice(0,16).replace('T',' ');
    const tmp=document.createElement('div'); tmp.innerHTML=e.desc||''; const text=tmp.innerText||'(no description)';
    return `# ${e.basics?.name||'Untitled'}\n${d}\n${text}\n`;
  }).join('\n');
  await navigator.clipboard.writeText(blocks);
};

/* ---------- Clear log with confirm ---------- */
clearLogBtn.onclick=()=>modalClear.classList.add('show');
clCancel.onclick=()=>modalClear.classList.remove('show');
clConfirm.onclick=()=>{ setLog([]); modalClear.classList.remove('show'); renderLog(); };

/* ---------- Boot (safe) ---------- */
(function boot(){
  try{
    // initial: By date view => hide groups header
    groupsHead.style.display='none';

    // If there is a share hash, prefer it; otherwise load autosave.
    const hashData = location.hash.startsWith('#data=') ? decodeShare(location.hash) : null;
    if (hashData) {
      setFormState(hashData);
      if(hashData.desc){ descBox.innerHTML=hashData.desc; copyDesc.disabled=false; shareBtn.disabled=false; }
    } else {
      loadState();
    }

    // Ensure two default rows exist if user switches to multi later
    // (loadState already adds rows on empty, but this is a safety net)
    if (treeType.value==='Multi trunked tree') ensureTwoMtRows();

    // Bind email state
    emailBtn.setAttribute('aria-disabled','true');

    // First render
    renderLog();
  }catch(err){
    console.error('Boot error:', err);
    alert('Something went wrong initializing the page. Try a hard refresh.');
  }
})();
</script>

</body>
</html>
