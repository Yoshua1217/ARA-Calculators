<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ARA QR Tag Generator</title>
  <style>
    :root { --radius: 12px; --dark:#111; --light:#f2f2f2; }
    .card, .card * { box-sizing: border-box; }

    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    .card { max-width: 720px; margin: 0 auto; padding: 20px; border: 1px solid #ddd; border-radius: var(--radius); }
    h1 { margin: 0 0 10px; font-size: 1.6rem; }
    .sub { margin: 0 0 16px; color: #555; }
    .note { background:#f7f7f7; padding: 10px 12px; border: 1px solid #e7e7e7; border-radius: var(--radius); margin-bottom: 16px; }

    label { display:block; margin: 12px 0 6px; font-weight:600; }
    input[type="text"], input[type="number"], select {
      width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; background: #fff;
    }
    input.error { border-color:#e11900; box-shadow:0 0 0 3px rgba(225,25,0,.15); outline: none; }

    .row3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }

    .btn-row { display:flex; gap:10px; flex-wrap:wrap; margin-top: 14px; }
    button, a.button { padding:10px 14px; border:0; border-radius:8px; cursor:pointer; display:inline-block; text-decoration:none; text-align:center; }
    .btn-primary { background: var(--dark); color:#fff; }
    .btn-secondary { background:#e9e9e9; color:#111; }
    .disabled { opacity:.6; pointer-events:none; }

    .preview { margin-top: 18px; display: grid; grid-template-columns: 220px 1fr; gap: 16px; align-items: start; }
    .qrcard { border:1px solid #ddd; border-radius: 12px; padding: 12px; display:flex; align-items:center; justify-content:center; background:#fff; min-height: 220px; }
    .meta { color:#444; font-size: .95rem; word-break: break-all; }
    .foot { margin-top:18px; font-size:.9rem; color:#666; line-height:1.35; }
  </style>
</head>
<body>
  <div class="card">
    <h1>ARA QR Tag Generator</h1>
    <p class="sub">Ancient Roots Alberta</p>

    <div class="note">
      Paste a full URL, choose size/error-correction, then Generate. Image-only endpoints are used so it works inside Notion embeds.
    </div>

    <form id="qr-form" action="#">
      <label for="fullUrl">URL to encode</label>
      <input id="fullUrl" type="text" placeholder="e.g. https://ancientrootsab.ca/tree/12345" />

      <div class="row3">
        <div>
          <label for="size">Size (px)</label>
          <input id="size" type="number" min="128" max="1024" step="16" value="256" />
        </div>
        <div>
          <label for="margin">White margin (px)</label>
          <input id="margin" type="number" min="0" max="32" step="1" value="8" />
        </div>
        <div>
          <label for="ecl">Error correction</label>
          <select id="ecl">
            <option value="L">L (~7%)</option>
            <option value="M" selected>M (~15%)</option>
            <option value="Q">Q (~25%)</option>
            <option value="H">H (~30%)</option>
          </select>
        </div>
      </div>

      <div class="btn-row">
        <button type="submit" class="btn-primary">Generate</button>
        <a id="openpng" class="button btn-secondary disabled" href="#" target="_blank" rel="noopener">Open PNG</a>
        <button type="reset"  id="reset" class="btn-secondary">Reset</button>
      </div>
    </form>

    <div class="preview">
      <div class="qrcard" id="qr-box"><span style="color:#999">Preview</span></div>
      <div class="meta">
        <p><strong>Encoded text:</strong> <span id="encoded">—</span></p>
        <p><strong>Tip:</strong> For rugged field tags, use <strong>H</strong> and margin ≥ 8 px.</p>
      </div>
    </div>

    <div class="foot">
      If one QR host is blocked by the network, this tool automatically falls back to another. You can right-click the preview to save, or use <strong>Open PNG</strong>.
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);

    const form = $('#qr-form');
    const fullUrl = $('#fullUrl');
    const sizeInp = $('#size');
    const marginInp = $('#margin');
    const eclSel = $('#ecl');

    const qrBox = $('#qr-box');
    const encodedEl = $('#encoded');
    const openPng = $('#openpng');

    let triedFallback = false;

    function sanitizeUrl(u){
      if (!u) return '';
      let v = u.trim();
      if (!/^https?:\/\//i.test(v)) v = 'https://' + v; // ensure protocol
      return v;
    }
    function clearErrors(){ fullUrl.classList.remove('error'); }
    function markError(el){ el.classList.add('error'); el.focus(); }

    function setPreview(src, fallbackText){
      qrBox.innerHTML = '';
      if (src) {
        const img = document.createElement('img');
        img.alt = 'QR preview';
        img.decoding = 'async';
        img.loading = 'lazy';
        img.src = src;
        img.onerror = () => {
          if (triedFallback) {
            setPreview(null, 'Could not load QR (network blocked?)');
            openPng.classList.add('disabled');
            openPng.href = '#';
          } else {
            triedFallback = true;
            const fb = buildFallbackUrl(encodedEl.textContent, getSize(), getMargin(), getEcl());
            img.src = fb;
            openPng.href = fb;
          }
        };
        qrBox.appendChild(img);
      } else {
        qrBox.innerHTML = `<span style="color:#999">${fallbackText}</span>`;
      }
    }

    function getSize(){
      const n = parseInt(sizeInp.value, 10);
      if (Number.isNaN(n)) return 256;
      return Math.max(128, Math.min(1024, n));
    }
    function getMargin(){
      const n = parseInt(marginInp.value, 10);
      if (Number.isNaN(n)) return 8;
      return Math.max(0, Math.min(32, n));
    }
    function getEcl(){
      const v = (eclSel.value || 'M').toUpperCase();
      return ['L','M','Q','H'].includes(v) ? v : 'M';
    }

    function buildPrimaryUrl(txt, size, ecl, margin){
      // QuickChart: https://quickchart.io/qr?text=...&size=256&margin=8&ecLevel=M
      const u = new URL('https://quickchart.io/qr');
      u.searchParams.set('text', txt);
      u.searchParams.set('size', String(size));
      u.searchParams.set('margin', String(margin));
      u.searchParams.set('ecLevel', ecl);
      return u.toString();
    }

    function buildFallbackUrl(txt, size, margin, ecl){
      // goqr: https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=...&margin=8&ecc=M
      const u = new URL('https://api.qrserver.com/v1/create-qr-code/');
      u.searchParams.set('size', `${size}x${size}`);
      u.searchParams.set('data', txt);
      u.searchParams.set('margin', String(margin));
      u.searchParams.set('ecc', ecl);
      u.searchParams.set('format', 'png');
      return u.toString();
    }

    function generate(e){
      e.preventDefault();
      clearErrors();
      triedFallback = false;

      const txt = sanitizeUrl(fullUrl.value);
      if (!txt) { markError(fullUrl); return; }

      const size = getSize();
      const margin = getMargin();
      const ecl = getEcl();

      const imgUrl = buildPrimaryUrl(encodeURI(txt), size, ecl, margin);

      encodedEl.textContent = txt;
      openPng.classList.remove('disabled');
      openPng.href = imgUrl;
      openPng.target = '_blank';
      openPng.rel = 'noopener';

      setPreview(imgUrl, 'Generating…');
    }

    form.addEventListener('submit', generate);
    form.addEventListener('reset', () => {
      setTimeout(() => {
        clearErrors();
        encodedEl.textContent = '—';
        setPreview(null, 'Preview');
        openPng.classList.add('disabled');
        openPng.href = '#';
        triedFallback = false;
      }, 0);
    });
  </script>
</body>
</html>
