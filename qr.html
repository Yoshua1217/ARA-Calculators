<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ARA QR Tag Generator</title>
  <style>
    :root { --radius: 12px; --dark:#111; --light:#f2f2f2; }
    .card, .card * { box-sizing: border-box; }

    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    .card { max-width: 720px; margin: 0 auto; padding: 20px; border: 1px solid #ddd; border-radius: var(--radius); }
    h1 { margin: 0 0 10px; font-size: 1.6rem; }
    .sub { margin: 0 0 16px; color: #555; }
    .note { background:#f7f7f7; padding: 10px 12px; border: 1px solid #e7e7e7; border-radius: var(--radius); margin-bottom: 16px; }

    label { display:block; margin: 12px 0 6px; font-weight:600; }
    input[type="text"], input[type="number"], select {
      width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; background: #fff;
    }
    input.error { border-color:#e11900; box-shadow:0 0 0 3px rgba(225,25,0,.15); outline: none; }

    .mode { display:flex; gap:8px; margin: 0 0 8px; }
    .toggle-btn { padding:8px 12px; border:1px solid #ccc; border-radius:8px; background: var(--light); cursor:pointer; user-select:none; }
    .toggle-btn.active { background: var(--dark); color:#fff; border-color: var(--dark); }
    .toggle-btn:focus-visible { outline:2px solid var(--dark); outline-offset:2px; }

    .row3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }

    .btn-row { display:flex; gap:10px; flex-wrap:wrap; margin-top: 14px; }
    button, a.button { padding:10px 14px; border:0; border-radius:8px; cursor:pointer; display:inline-block; text-decoration:none; text-align:center; }
    .btn-primary { background: var(--dark); color:#fff; }
    .btn-secondary { background:#e9e9e9; color:#111; }
    .disabled { opacity:.6; pointer-events:none; }

    .preview { margin-top: 18px; display: grid; grid-template-columns: 220px 1fr; gap: 16px; align-items: start; }
    .qrcard { border:1px solid #ddd; border-radius: 12px; padding: 12px; display:flex; align-items:center; justify-content:center; background:#fff; min-height: 220px; }
    .meta { color:#444; font-size: .95rem; word-break: break-all; }
    .foot { margin-top:18px; font-size:.9rem; color:#666; line-height:1.35; }
  </style>
</head>
<body>
  <div class="card">
    <h1>ARA QR Tag Generator</h1>
    <p class="sub">Ancient Roots Alberta</p>

    <div class="note">
      No external libraries. Paste a URL (or Base URL + Tree ID), choose size/error-correction, then Generate. Use <strong>H</strong> and a white margin for rugged field tags.
    </div>

    <!-- Mode -->
    <div class="mode" role="group" aria-label="QR content mode">
      <button type="button" id="mode-url" class="toggle-btn active" aria-pressed="true">Full URL</button>
      <button type="button" id="mode-id"  class="toggle-btn" aria-pressed="false">Tree ID + Base URL</button>
    </div>

    <form id="qr-form" action="#">
      <!-- URL mode -->
      <div id="url-fields">
        <label for="fullUrl">URL to encode</label>
        <input id="fullUrl" type="text" placeholder="e.g. https://ancientrootsab.ca/tree/12345" />
      </div>

      <!-- ID mode -->
      <div id="id-fields" style="display:none;">
        <label for="baseUrl">Base URL (prefix)</label>
        <input id="baseUrl" type="text" placeholder="e.g. https://ancientrootsab.ca/t/" />
        <label for="treeId">Tree ID (suffix)</label>
        <input id="treeId" type="text" placeholder="e.g. ARA-000123" />
      </div>

      <div class="row3">
        <div>
          <label for="size">Size (px)</label>
          <input id="size" type="number" min="128" max="1024" step="16" value="256" />
        </div>
        <div>
          <label for="margin">White margin (modules)</label>
          <input id="margin" type="number" min="0" max="16" step="1" value="4" />
        </div>
        <div>
          <label for="ecl">Error correction</label>
          <select id="ecl">
            <option value="L">L (~7%)</option>
            <option value="M" selected>M (~15%)</option>
            <option value="Q">Q (~25%)</option>
            <option value="H">H (~30%)</option>
          </select>
        </div>
      </div>

      <div class="btn-row">
        <button type="submit" class="btn-primary">Generate</button>
        <a id="download" class="button btn-secondary disabled" href="#" target="_blank" rel="noopener">Open PNG</a>
        <button type="reset"  id="reset" class="btn-secondary">Reset</button>
      </div>
    </form>

    <div class="preview">
      <div class="qrcard" id="qr-box"><span style="color:#999">Preview</span></div>
      <div class="meta">
        <p><strong>Encoded text:</strong> <span id="encoded">—</span></p>
        <p><strong>Tip:</strong> For small tags (&lt;30&nbsp;mm), prefer size ≥ 256 px, ECL = H, and margin ≥ 4.</p>
      </div>
    </div>

    <div class="foot">
      Scanning opens the encoded page. Using a Notion link is fine — we encode the text only. If the PNG doesn’t download directly, the button opens it in a new tab; save from there.
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);

    const form = $('#qr-form');
    const modeUrl = $('#mode-url');
    const modeId  = $('#mode-id');
    const urlFields = $('#url-fields');
    const idFields  = $('#id-fields');

    const fullUrl = $('#fullUrl');
    const baseUrl = $('#baseUrl');
    const treeId  = $('#treeId');

    const sizeInp   = $('#size');
    const marginInp = $('#margin');
    const eclSel    = $('#ecl');

    const qrBox = $('#qr-box');
    const encodedEl = $('#encoded');
    const downloadBtn = $('#download');

    let mode = 'url'; // 'url' or 'id'
    let lastImgUrl = '';

    function setMode(next){
      if (mode === next) return;
      mode = next;
      const isUrl = mode === 'url';
      modeUrl.classList.toggle('active', isUrl);
      modeId.classList.toggle('active', !isUrl);
      modeUrl.setAttribute('aria-pressed', String(isUrl));
      modeId.setAttribute('aria-pressed', String(!isUrl));
      urlFields.style.display = isUrl ? '' : 'none';
      idFields.style.display  = isUrl ? 'none' : '';
      clearErrors();
      setPreview(null, 'Preview');
    }

    modeUrl.addEventListener('click', () => setMode('url'));
    modeId .addEventListener('click', () => setMode('id'));

    function sanitizeUrl(u){
      if (!u) return '';
      let v = u.trim();
      if (!/^https?:\/\//i.test(v)) v = 'https://' + v; // ensure protocol
      return v;
    }

    function buildText(){
      if (mode === 'url') {
        const u = sanitizeUrl(fullUrl.value);
        return u;
      } else {
        const base = sanitizeUrl(baseUrl.value);
        const id = (treeId.value || '').trim();
        if (!base || !id) return '';
        const joiner = base.endsWith('/') ? '' : '/';
        return base + joiner + encodeURIComponent(id);
      }
    }

    function clearErrors(){
      [fullUrl, baseUrl, treeId].forEach(el => el && el.classList.remove('error'));
    }
    function markError(el){
      el.classList.add('error');
      el.focus();
    }

    function setPreview(src, fallbackText){
      qrBox.innerHTML = '';
      if (src) {
        const img = document.createElement('img');
        img.alt = 'QR preview';
        img.src = src;
        img.decoding = 'async';
        img.loading = 'lazy';
        qrBox.appendChild(img);
      } else {
        qrBox.innerHTML = `<span style="color:#999">${fallbackText}</span>`;
      }
    }

    function buildQrUrl(txt, size, ecl, margin){
      // Google Chart QR: cht=qr&chs=SIZE&chl=TEXT&chld=ECL|MARGIN
      const base = 'https://chart.googleapis.com/chart';
      const params = new URLSearchParams({
        cht: 'qr',
        chs: `${size}x${size}`,
        chl: txt,
        chld: `${ecl}|${margin}`
      });
      return `${base}?${params.toString()}`;
    }

    function generate(e){
      e.preventDefault();
      clearErrors();

      const txt = buildText();
      if (!txt) {
        if (mode === 'url') markError(fullUrl);
        else { if (!baseUrl.value.trim()) markError(baseUrl); else markError(treeId); }
        return;
      }

      const size = clampInt(sizeInp.value, 128, 1024, 256);
      const margin = clampInt(marginInp.value, 0, 16, 4);
      const ecl = (eclSel.value || 'M').toUpperCase();

      const imgUrl = buildQrUrl(txt, size, ecl, margin);
      lastImgUrl = imgUrl;

      setPreview(imgUrl, 'Generating…');
      encodedEl.textContent = txt;

      // Enable "Open PNG"
      downloadBtn.classList.remove('disabled');
      downloadBtn.href = imgUrl;
      downloadBtn.target = '_blank';
      downloadBtn.rel = 'noopener';
    }

    function clampInt(v, min, max, def){
      const n = parseInt(v, 10);
      if (Number.isNaN(n)) return def;
      return Math.max(min, Math.min(max, n));
    }

    form.addEventListener('submit', generate);
    form.addEventListener('reset', () => {
      setTimeout(() => {
        clearErrors();
        encodedEl.textContent = '—';
        setPreview(null, 'Preview');
        lastImgUrl = '';
        downloadBtn.classList.add('disabled');
        downloadBtn.href = '#';
      }, 0);
    });
  </script>
</body>
</html>
