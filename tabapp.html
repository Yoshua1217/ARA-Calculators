<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ARA Field Tools</title>
  <style>
    :root{
      --bg:#0f1520;            /* deep slate */
      --card:#121821;          /* instrument card */
      --edge:#1d2633;          /* card border */
      --text:#e6eef7;          /* primary text */
      --muted:#94a7ba;         /* muted text */
      --blue:#6bb8ff;          /* accent */
      --green:#35d399;         /* success */
      --amber:#ffcc66;         /* warn */
      --pill:#192334;          /* chips */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:900px;margin:0 auto;padding:12px 12px 64px}

    /* Header */
    .header{position:sticky;top:0;background:linear-gradient(180deg, rgba(15,21,32,.96), rgba(15,21,32,.85));backdrop-filter:blur(6px);z-index:50;border-bottom:1px solid var(--edge)}
    .header-inner{max-width:900px;margin:0 auto;display:flex;align-items:center;gap:10px;padding:10px 12px}
    .brand{display:flex;align-items:center;gap:8px;font-weight:800}
    .brand .logo{width:22px;height:22px;border-radius:6px;background:linear-gradient(180deg,#203149,#162234);border:1px solid var(--edge);display:inline-flex;align-items:center;justify-content:center}
    .brand .logo::after{content:"ðŸŒ²";font-size:14px}
    .name{font-size:18px;letter-spacing:.2px}
    .spacer{flex:1}
    .pill{background:var(--pill);border:1px solid var(--edge);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
    .btn{appearance:none;border:1px solid var(--edge);background:#172235;color:var(--text);padding:10px 12px;border-radius:12px;font-weight:600;cursor:pointer}
    .btn:active{transform:translateY(1px)}

    /* HUD */
    .hud{display:flex;align-items:center;gap:8px}
    .gps-dot{width:10px;height:10px;border-radius:999px;border:1px solid var(--edge);background:#485464}
    .gps-dot.green{background:var(--green)}
    .gps-dot.amber{background:var(--amber)}
    .gps-dot.gray{background:#59697c}
    .hud-pill{background:var(--pill);border:1px solid var(--edge);border-radius:999px;padding:6px 10px;font-size:12px}

    /* Tabs */
    .tabs{display:flex;gap:8px;padding:8px 12px;max-width:900px;margin:0 auto;border-bottom:1px solid var(--edge);background:rgba(18,24,33,.6)}
    .tab-btn{appearance:none;border:1px solid var(--edge);background:#121821;color:var(--text);padding:10px 12px;border-radius:999px;cursor:pointer;font-weight:600}
    .tab-btn.active{outline:2px solid var(--blue);outline-offset:1px}

    /* Panels */
    .panel{display:none;padding:12px}
    .panel.active{display:block}

    /* Cards & form elements */
    .card{background:var(--card);border:1px solid var(--edge);border-radius:18px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h2{font-size:16px;margin:6px 0 10px}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
    input,select,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid var(--edge);background:#0f1520;color:var(--text)}
    textarea{min-height:96px;resize:vertical}
    .row{display:flex;gap:10px}
    .row > *{flex:1}
    .mt{margin-top:12px}
    .right{display:flex;gap:8px;align-items:center}
    .action{display:inline-flex;align-items:center;gap:8px}

    .metric-note{font-size:11px;color:var(--muted)}

    /* Outputs */
    .out{font-weight:700;font-size:18px}
    .copy{margin-left:8px}

    @media (max-width:640px){
      .row{flex-direction:column}
      .name{font-size:16px}
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-inner">
      <div class="brand"><span class="logo"></span><span class="name">ARA Field Tools</span></div>
      <div class="pill" style="min-width:140px;white-space:nowrap;">
        <span class="metric-note">Tree:</span>
        <input id="treeName" aria-label="Tree name" style="background:transparent;border:none;color:var(--text);width:90px" placeholder="New tree" />
      </div>
      <div class="spacer"></div>

      <!-- Units + HUD (top mounted) -->
      <div class="action">
        <button class="btn" id="unitToggle">Meters (m)</button>
        <div class="hud">
          <div class="gps-dot gray" id="gpsDot"></div>
          <div class="hud-pill" id="hudText">GPS Â± â€” m â€¢ 00:00</div>
        </div>
      </div>

      <!-- New / Recent / Clear -->
      <div class="action">
        <button class="btn" id="btnNew">New Tree</button>
        <button class="btn" id="btnClear">Clear</button>
      </div>
    </div>
    <div class="tabs">
      <button class="tab-btn active" data-tab="general">General</button>
      <button class="tab-btn" data-tab="circ">Circumference</button>
      <button class="tab-btn" data-tab="height">Height</button>
      <button class="tab-btn" data-tab="canopy">Canopy</button>
      <button class="tab-btn" data-tab="location">Location</button>
      <button class="tab-btn" data-tab="results">Results</button>
    </div>
  </div>

  <div class="wrap">
    <!-- General -->
    <section class="panel active" id="tab-general">
      <div class="card">
        <h2>Basic details</h2>
        <label>Species</label>
        <input id="species" placeholder="e.g., Plains Cottonwood" />
        <label>Condition</label>
        <select id="condition">
          <option value="">Selectâ€¦</option>
          <option>Excellent</option>
          <option>Good</option>
          <option>Fair</option>
          <option>Poor</option>
          <option>Dead</option>
        </select>
        <label class="mt">Notes</label>
        <textarea id="notes" placeholder="Site, history, hazards, contextâ€¦"></textarea>
      </div>
    </section>

    <!-- Circumference -->
    <section class="panel" id="tab-circ">
      <div class="card">
        <h2>Circumference</h2>
        <div class="row">
          <div>
            <label>Tree type</label>
            <select id="trunkType">
              <option>Single trunk</option>
              <option>Multi-trunk</option>
            </select>
          </div>
          <div>
            <label>Measurement height</label>
            <input id="measureHt" placeholder="e.g., 1.4 m" />
          </div>
        </div>
        <div id="singleCirc">
          <label class="mt">Circumference (<span id="circUnit">m</span>)</label>
          <input id="circVal" placeholder="e.g., 3.10" inputmode="decimal" />
          <div class="metric-note mt">Diameter auto: <span class="out" id="diamOut">â€”</span></div>
        </div>
        <div id="multiCirc" style="display:none" class="mt">
          <label>Stems (enter each circumference; same unit)</label>
          <div id="stems"></div>
          <button class="btn mt" id="addStem">+ Add stem</button>
          <div class="metric-note mt">Effective circumference: <span class="out" id="effCirc">â€”</span></div>
        </div>
        <div class="right mt">
          <button class="btn" id="copyCirc">Copy summary</button>
        </div>
      </div>
    </section>

    <!-- Height -->
    <section class="panel" id="tab-height">
      <div class="card">
        <h2>Height</h2>
        <div class="row">
          <div>
            <label>Method</label>
            <select id="heightMethod">
              <option>Clinometer</option>
              <option>Laser</option>
              <option>Estimate</option>
            </select>
          </div>
          <div>
            <label>Distance (<span id="distUnit">m</span>)</label>
            <input id="dist" placeholder="e.g., 25" inputmode="decimal" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Angle to top (Â°)</label>
            <input id="angleTop" placeholder="e.g., 32" inputmode="decimal" />
          </div>
          <div>
            <label>Angle to base (Â°)</label>
            <input id="angleBase" placeholder="e.g., -3" inputmode="decimal" />
          </div>
        </div>
        <div class="metric-note mt">Computed height: <span class="out" id="heightOut">â€”</span></div>
        <div class="right mt"><button class="btn" id="copyHeight">Copy height</button></div>
      </div>
    </section>

    <!-- Canopy -->
    <section class="panel" id="tab-canopy">
      <div class="card">
        <h2>Canopy spread</h2>
        <div class="row">
          <div>
            <label>Spread Aâ€“B (<span id="canUnitA">m</span>)</label>
            <input id="canAB" placeholder="e.g., 18.4" inputmode="decimal" />
          </div>
          <div>
            <label>Spread Câ€“D (<span id="canUnitB">m</span>)</label>
            <input id="canCD" placeholder="e.g., 20.1" inputmode="decimal" />
          </div>
        </div>
        <div class="metric-note mt">Average: <span class="out" id="canAvg">â€”</span></div>
        <div class="right mt"><button class="btn" id="copyCanopy">Copy canopy</button></div>
      </div>
    </section>

    <!-- Location -->
    <section class="panel" id="tab-location">
      <div class="card">
        <h2>Location</h2>
        <div class="row">
          <div class="pill">Status: <span id="locStatus">Idle</span></div>
          <div class="pill">Accuracy: <span id="accPill">Â± â€” m</span></div>
          <div class="pill">Last fix: <span id="timer">00:00</span></div>
          <button class="btn" id="btnLive">Live Track</button>
        </div>
        <div class="row mt">
          <div>
            <label>Latitude</label>
            <input id="lat" placeholder="â€”" />
          </div>
          <div>
            <label>Longitude</label>
            <input id="lon" placeholder="â€”" />
          </div>
        </div>
        <div class="right mt">
          <button class="btn" id="copyCoords">Copy coords</button>
        </div>
      </div>
    </section>

    <!-- Results -->
    <section class="panel" id="tab-results">
      <div class="card">
        <h2>Results</h2>
        <div class="metric-note">Quick summary (tap Copy All to share or store)</div>
        <pre id="summary" style="white-space:pre-wrap;background:#0f1520;padding:12px;border-radius:12px;border:1px solid var(--edge);margin-top:8px">â€”</pre>
        <div class="right mt">
          <button class="btn" id="copyAll">Copy All</button>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ===== Utilities =====
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);
    const num = v => { const n = parseFloat(String(v).replace(',', '.')); return isFinite(n) ? n : null; };
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
    const fmt = (n, d=2) => (n==null || !isFinite(n)) ? 'â€”' : n.toFixed(d);
    const copyText = async (t)=> { try{ await navigator.clipboard.writeText(t); } catch(e){} };

    // ===== Tabs (mount-once, just hide/show) =====
    $$('.tab-btn').forEach(btn=>btn.addEventListener('click', e=>{
      $$('.tab-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const id = btn.dataset.tab;
      $$('.panel').forEach(p=>p.classList.remove('active'));
      $('#tab-'+id).classList.add('active');
      flushSave();
      renderSummary();
    }));

    // ===== Global state (session-based autosave) =====
    const SESSION_KEY = 'ara_current_session_id';
    const STORE_PREFIX = 'ara_session_';
    let sessionId = localStorage.getItem(SESSION_KEY) || newSessionId();
    localStorage.setItem(SESSION_KEY, sessionId);

    let state = loadSession(sessionId) || blankState();

    function newSessionId(){
      const d = new Date();
      return `sess_${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}_${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}${String(d.getSeconds()).padStart(2,'0')}`;
    }
    function blankState(){ return { units:'m', name:'', species:'', condition:'', notes:'', 
      trunkType:'Single trunk', measureHt:'1.4', circVal:'', stems:[], effCirc:null, diam:null,
      heightMethod:'Clinometer', dist:'', angleTop:'', angleBase:'', height:null,
      canAB:'', canCD:'', canAvg:null,
      coords:{ lat:'', lon:'', acc:null, ts:null }, live:false } }

    function loadSession(id){ const raw = localStorage.getItem(STORE_PREFIX+id); return raw? JSON.parse(raw): null; }
    let saveTimer=null;
    function scheduleSave(){ clearTimeout(saveTimer); saveTimer = setTimeout(flushSave, 750); }
    function flushSave(){ localStorage.setItem(STORE_PREFIX+sessionId, JSON.stringify(state)); /* could show saved indicator */ }

    // ===== Units =====
    function setUnits(newU){ state.units = newU; $('#unitToggle').textContent = newU==='m'? 'Meters (m)' : 'Feet (ft)';
      $('#circUnit').textContent = newU; $('#distUnit').textContent = newU; $('#canUnitA').textContent = newU; $('#canUnitB').textContent = newU;
      renderDerived(); scheduleSave(); }

    // ===== Bind inputs to state =====
    const binds = [
      ['#treeName','name'], ['#species','species'], ['#condition','condition'], ['#notes','notes'],
      ['#trunkType','trunkType'], ['#measureHt','measureHt'], ['#circVal','circVal'],
      ['#heightMethod','heightMethod'], ['#dist','dist'], ['#angleTop','angleTop'], ['#angleBase','angleBase'],
      ['#canAB','canAB'], ['#canCD','canCD'], ['#lat','lat','coords'], ['#lon','lon','coords']
    ];
    binds.forEach(([sel,key,scope])=>{
      const el = $(sel); if(!el) return;
      el.value = scope==='coords'? (state.coords[key]||'') : (state[key]||'');
      el.addEventListener('input', ()=>{
        if(scope==='coords'){ state.coords[key] = el.value; } else { state[key] = el.value; }
        renderDerived(); scheduleSave();
      });
    });

    // ===== Multi-trunk UI =====
    const stemsEl = $('#stems');
    function renderStems(){
      stemsEl.innerHTML = (state.stems||[]).map((v,i)=>`
        <div class="row mt">
          <div><input data-idx="${i}" class="stem" placeholder="Stem ${i+1}" value="${v}"></div>
          <div style="max-width:120px"><button class="btn" data-del="${i}">Remove</button></div>
        </div>`).join('');
      stemsEl.querySelectorAll('input.stem').forEach(inp=>{
        inp.addEventListener('input', ()=>{ const i = +inp.dataset.idx; state.stems[i] = inp.value; renderDerived(); scheduleSave(); });
      });
      stemsEl.querySelectorAll('button[data-del]').forEach(btn=>{
        btn.addEventListener('click', ()=>{ const i = +btn.dataset.del; state.stems.splice(i,1); renderStems(); renderDerived(); scheduleSave(); });
      });
    }
    $('#addStem').addEventListener('click', ()=>{ state.stems.push(''); renderStems(); scheduleSave(); });

    // Toggle between single/multi
    function applyTrunkMode(){ const multi = state.trunkType !== 'Single trunk';
      $('#singleCirc').style.display = multi? 'none':'block';
      $('#multiCirc').style.display  = multi? 'block':'none';
    }

    // ===== Calculations =====
    function computeDiameterFromCirc(circ){ if(circ==null) return null; const c = num(circ); if(c==null) return null; return (state.units==='m')? (c/Math.PI) : (c/Math.PI); }
    function computeEffectiveCirc(stems){
      const vals = (stems||[]).map(num).filter(x=>x!=null);
      if(!vals.length) return null;
      // Effective circumference of multiple stems approximated via summed areas
      // area = (c^2)/(4Ï€); sum areas -> total circumference = sqrt(sum(c^2))  (approx for equal heights)
      const sumSq = vals.reduce((s,c)=> s + c*c, 0); return Math.sqrt(sumSq);
    }
    function computeHeight(){
      if(state.heightMethod==='Estimate'){ return num(state.dist); }
      const d = num(state.dist), aTop = num(state.angleTop), aBase = num(state.angleBase);
      if(d==null || aTop==null) return null;
      const rad = Math.PI/180;
      const top = Math.tan(aTop*rad) * d;
      const base = (aBase!=null)? Math.tan((aBase)*rad) * d : 0;
      return (top - base);
    }
    function computeCanopyAvg(){ const ab=num(state.canAB), cd=num(state.canCD); if(ab==null||cd==null) return null; return (ab+cd)/2; }

    function renderDerived(){
      // Trunk mode
      applyTrunkMode();
      renderStems();
      // Circumference / diameter
      const circ = num(state.circVal);
      const eff = computeEffectiveCirc(state.stems);
      state.effCirc = eff; state.diam = computeDiameterFromCirc(circ);
      $('#diamOut').textContent = fmt(state.diam, 2) + ' ' + state.units;
      $('#effCirc').textContent = fmt(state.effCirc, 2) + ' ' + state.units;

      // Height
      state.height = computeHeight();
      $('#heightOut').textContent = fmt(state.height, 2) + ' ' + state.units;

      // Canopy
      state.canAvg = computeCanopyAvg();
      $('#canAvg').textContent = fmt(state.canAvg, 2) + ' ' + state.units;

      // Units labels already handled in setUnits
      renderSummary();
    }

    // ===== Copy buttons =====
    $('#copyCirc').addEventListener('click', ()=>{
      const t = (state.trunkType==='Single trunk')
        ? `Circumference: ${fmt(num(state.circVal),2)} ${state.units} (Dâ‰ˆ${fmt(state.diam,2)} ${state.units})`
        : `Multi-trunk effective circumference: ${fmt(state.effCirc,2)} ${state.units}`;
      copyText(t);
    });
    $('#copyHeight').addEventListener('click', ()=> copyText(`Height: ${fmt(state.height,2)} ${state.units}`));
    $('#copyCanopy').addEventListener('click', ()=> copyText(`Canopy avg: ${fmt(state.canAvg,2)} ${state.units}`));
    $('#copyCoords').addEventListener('click', ()=> copyText(`Lat ${state.coords.lat}, Lon ${state.coords.lon} (Â± ${fmt(state.coords.acc,1)} m)`));
    $('#copyAll').addEventListener('click', ()=> copyText($('#summary').textContent));

    // ===== Units toggle =====
    $('#unitToggle').addEventListener('click', ()=> setUnits(state.units==='m'?'ft':'m'));

    // ===== New / Clear =====
    $('#btnNew').addEventListener('click', ()=>{
      flushSave();
      sessionId = newSessionId();
      localStorage.setItem(SESSION_KEY, sessionId);
      state = blankState();
      hydrateUI();
      flushSave();
    });
    $('#btnClear').addEventListener('click', ()=>{
      state = blankState();
      hydrateUI();
      scheduleSave();
    });

    function hydrateUI(){
      $('#treeName').value = state.name||'';
      $('#species').value = state.species||'';
      $('#condition').value = state.condition||'';
      $('#notes').value = state.notes||'';
      $('#trunkType').value = state.trunkType||'Single trunk';
      $('#measureHt').value = state.measureHt||'';
      $('#circVal').value = state.circVal||'';
      $('#heightMethod').value = state.heightMethod||'Clinometer';
      $('#dist').value = state.dist||'';
      $('#angleTop').value = state.angleTop||'';
      $('#angleBase').value = state.angleBase||'';
      $('#canAB').value = state.canAB||'';
      $('#canCD').value = state.canCD||'';
      $('#lat').value = state.coords.lat||'';
      $('#lon').value = state.coords.lon||'';
      setUnits(state.units||'m');
      renderDerived();
    }

    // ===== Location / HUD (browser geolocation demo) =====
    let watchId = null, lastPaint=0, liveStart=0, timerInt=null, bestAcc=Infinity;
    function setHud(acc){
      const dot = $('#gpsDot');
      const cls = !isFinite(acc) ? 'gray' : (acc<=5? 'green' : (acc<=20? 'amber':'gray'));
      dot.className = 'gps-dot '+cls;
      $('#hudText').textContent = `GPS Â± ${fmt(acc,1)} m â€¢ ${timerStr()}`;
      $('#accPill').textContent = `Â± ${fmt(acc,1)} m`;
    }
    function timerStr(){ if(!liveStart) return '00:00'; const s = Math.floor((Date.now()-liveStart)/1000); const mm=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${mm}:${ss}`; }
    function updateTimer(){ $('#timer').textContent = timerStr(); $('#hudText').textContent = `GPS Â± ${fmt(state.coords.acc,1)} m â€¢ ${timerStr()}`; }

    function paintPosition(pos){
      const now = Date.now(); if(now-lastPaint<250) return; lastPaint=now;
      const { latitude, longitude, accuracy } = pos.coords;
      state.coords.lat = latitude.toFixed(6); state.coords.lon = longitude.toFixed(6); state.coords.acc = accuracy; state.coords.ts = Date.now();
      $('#lat').value = state.coords.lat; $('#lon').value = state.coords.lon;
      // timer reset on each fix
      liveStart = Date.now(); if(!timerInt){ timerInt = setInterval(updateTimer,500); }
      setHud(accuracy);
      if(isFinite(accuracy) && accuracy+0.5 < bestAcc){ bestAcc = accuracy; }
      $('#locStatus').textContent = 'Live';
      scheduleSave();
    }

    function startLive(){
      if(!('geolocation' in navigator)){ alert('Geolocation not supported'); return; }
      if(watchId!==null) return;
      bestAcc = Infinity; liveStart = Date.now(); updateTimer(); if(!timerInt) timerInt=setInterval(updateTimer,500);
      watchId = navigator.geolocation.watchPosition(paintPosition, (err)=>{ $('#locStatus').textContent='Error'; }, { enableHighAccuracy:true, maximumAge:0, timeout:15000 });
      state.live = true; $('#btnLive').textContent = 'Stop'; $('#locStatus').textContent='Live';
    }
    function stopLive(){ if(watchId!==null){ navigator.geolocation.clearWatch(watchId); watchId=null; }
      state.live=false; $('#btnLive').textContent='Live Track'; $('#locStatus').textContent='Paused'; liveStart=0; updateTimer(); if(timerInt){ clearInterval(timerInt); timerInt=null; } setHud(NaN); }

    $('#btnLive').addEventListener('click', ()=>{ (watchId===null)? startLive(): stopLive(); });

    // ===== Summary =====
    function renderSummary(){
      const parts = [];
      if(state.name) parts.push(`Tree: ${state.name}`);
      if(state.species) parts.push(`Species: ${state.species}`);
      if(state.condition) parts.push(`Condition: ${state.condition}`);
      const circStr = (state.trunkType==='Single trunk')
        ? (state.circVal? `${fmt(num(state.circVal),2)} ${state.units} (Dâ‰ˆ${fmt(state.diam,2)} ${state.units})` : null)
        : (state.effCirc? `${fmt(state.effCirc,2)} ${state.units} (multi)` : null);
      if(circStr) parts.push(`Circumference: ${circStr}`);
      if(state.height!=null) parts.push(`Height: ${fmt(state.height,2)} ${state.units}`);
      if(state.canAvg!=null) parts.push(`Canopy avg: ${fmt(state.canAvg,2)} ${state.units}`);
      if(state.coords.lat && state.coords.lon) parts.push(`Coords: ${state.coords.lat}, ${state.coords.lon} (Â± ${fmt(state.coords.acc,1)} m)`);
      if(state.notes) parts.push(`Notes: ${state.notes}`);
      $('#summary').textContent = parts.join('\n');
    }

    // ===== Init =====
    hydrateUI();
    renderSummary();

  </script>
</body>
</html>
